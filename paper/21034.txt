NBER WORKING PAPER SERIES

QUANTILE REGRESSION WITH PANEL DATA
Bryan S. Graham
Jinyong Hahn
Alexandre Poirier
James L. Powell
Working Paper 21034
http://www.nber.org/papers/w21034

NATIONAL BUREAU OF ECONOMIC RESEARCH
1050 Massachusetts Avenue
Cambridge, MA 02138
March 2015

Earlier versions of this paper, with an initial draft date of March 2008, were presented under a
variety of titles. We would like to thank seminar participants at Berkeley, CEMFI, Duke, UIUC,
University of Michigan, Université de Montréal, NYU, Northwestern and at the 2009 North
American Winter Meetings of the Econometric Society, the 2009 All-California Econometrics
Conference at UC - Riverside, the 2014 Midwest Econometrics Group at the University of Iowa,
and the 2nd annual IAAE Conference. We also thank the co-editors and two anonymous referees
for their comments and insights. Financial support from the National Science Foundation (SES
#0921928) is gratefully acknowledged. All the usual disclaimers apply. The views expressed
herein are those of the authors and do not necessarily reflect the views of the National Bureau of
Economic Research.
NBER working papers are circulated for discussion and comment purposes. They have not been
peer-reviewed or been subject to the review by the NBER Board of Directors that accompanies
official NBER publications.
© 2015 by Bryan S. Graham, Jinyong Hahn, Alexandre Poirier, and James L. Powell. All rights
reserved. Short sections of text, not to exceed two paragraphs, may be quoted without explicit
permission provided that full credit, including © notice, is given to the source.

Quantile Regression with Panel Data
Bryan S. Graham, Jinyong Hahn, Alexandre Poirier, and James L. Powell
NBER Working Paper No. 21034
March 2015, Revised August 2016
JEL No. C23,C31,J31
ABSTRACT
We propose a generalization of the linear quantile regression model to accommodate possibilities
afforded by panel data. Specifically, we extend the correlated random coefficients representation
of linear quantile regression (e.g., Koenker, 2005; Section 2.6). We show that panel data allows
the econometrician to (i) introduce dependence between the regressors and the random
coefficients and (ii) weaken the assumption of comonotonicity across them (i.e., to enrich the
structure of allowable dependence between different coefficients). We adopt a “fixed effects”
approach, leaving any dependence between the regressors and the random coefficients
unmodelled. We motivate different notions of quantile partial effects in our model and study their
identification. For the case of discretely-valued covariates we present analog estimators and
characterize their large sample properties. When the number of time periods (T) exceeds the
number of random coefficients (P), identification is regular, and our estimates are √N-consistent.
When T=P, our identification results make special use of the subpopulation of stayers – units
whose regressor values change little over time – in a way which builds on the approach of
Graham and Powell (2012). In this just-identified case we study asymptotic sequences which
allow the frequency of stayers in the population to shrink with the sample size. One purpose of
these “discrete bandwidth asymptotics” is to approximate settings where covariates are
continuously-valued and, as such, there is only an infinitesimal fraction of exact stayers, while
keeping the convenience of an analysis based on discrete covariates. When the mass of stayers
shrinks with N, identification is irregular and our estimates converge at a slower than √N rate,
but continue to have limiting normal distributions. We apply our methods to study the effects of
collective bargaining coverage on earnings using the National Longitudinal Survey of Youth
1979 (NLSY79). Consistent with prior work (e.g., Chamberlain, 1982; Vella and Verbeek, 1998),
we find that using panel data to control for unobserved worker heteroegeneity results in sharply
lower estimates of union wage premia. We estimate a median union wage premium of about 9
percent, but with, in a more novel finding, substantial heterogeneity across workers. The 0.1
quantile of union effects is insignificantly different from zero, whereas the 0.9 quantile effect is
of over 30 percent. Our empirical analysis further suggests that, on net, unions have an equalizing
effect on the distribution of wages.
Bryan S. Graham
University of California - Berkeley 530
Evans Hall #3880
Berkeley, CA 94720-3880
and NBER
bgraham@econ.berkeley.edu

Alexandre Poirier
Department of Economics
University of Iowa
W210 John Pappajohn Business Building
Iowa City, IA 52242
alexandre-poirier@uiowa.edu

Jinyong Hahn
University of California at Los Angeles
Box 951477
Los Angeles, CA 90095-1477.
hahn@econ.ucla.edu

James L. Powell
University of California at Berkeley
Department of Economics
508-1 Evans Hall #3880
Berkeley, CA 94720-3880
powell@econ.berkeley.edu

A online appendix is available at http://www.nber.orgappendix/w21034

Linear quantile regression analysis is a proven complement to least squares methods. Chamberlain (1994) and Buchinsky (1994) represent important applications of these methods to
the analysis of earnings distributions, an area where continued application has proved especially fruitful (e.g., Angrist, Chernozhukov and Fernández-Val, 2006; Kline and Santos,
2013). Recent work has applied quantile regression methods to counterfactual and decomposition analysis (e.g., Machado and Mata, 2005; Firpo, Fortin and Lemieux, 2009; Chernozhukov, Fernández-Val and Melly, 2013), program evaluation (Athey and Imbens, 2006;
Firpo, 2007) and triangular systems with endogenous regressors (e.g., Ma and Koenker, 2006;
Chernozhukov and Hansen, 2007; Imbens and Newey, 2009).
The application of quantile regression methods to panel data analysis has proven to be especially challenging (e.g., Koenker, 2004 and Koenker, 2005, Section 8.7). The non-linearity
and non-smoothness of the quantile regression criterion function in its parameters is a key
obstacle. In an important paper, Kato, Galvao and Montes-Rojas (2012) show that a linear
quantile regression model with individual and quantile-specific intercepts is consistent and
asymptotically normal in an asymptotic sequence where both N and T grow. Unfortunately
T must grow quickly relative to rates required in other large-N , large-T panel data analyses
(e.g., Hahn and Newey, 2004). In a recent working paper, Arellano and Bonhomme (2016),
develop correlated random effects estimators for panel data quantile regression. They extend
a method of Wei and Carroll (2009), developed for mismeasured regressors, to operationalize their identification results. Other recent attempts to integrate quantile regression and
panel data include Abrevaya and Dahl (2008), Rosen (2012), Chernozhukov, Fernández-Val,
Hahn and Newey (2013), Harding and Lamarche (2014) and Chernozhukov, Fernández-Val,
Hoderlein, Holzmann and Newey (2015). We return to the relationship between our own
and prior work in the supplemental appendix to our paper: see Graham, Hahn, Poirier and
Powell (2016).
Our contribution is a quantile regression method that accommodates some of the possibilities afforded by panel data. A key attraction of panel data for empirical researchers is its
ability to control for unobserved correlated heteroegeneity (e.g., Chamberlain, 1984). A key
attraction of quantile regression, in turn, is its ability to accommodate heterogeneous effects
(e.g., Abrevaya, 2001). Our method incorporates both of these attractions. Our approach
is a “fixed effects” one: it leaves the structure of dependence between the regressors and
unobserved heterogeneity unrestricted. We further study identification and estimation in
settings where T is small and N is large.
The starting point of our analysis is the textbook linear quantile regression model of Koenker
and Bassett (1978). This model admits a (one-factor) random coefficients representation
(e.g., Koenker, 2005, Section 2.6). While this representation provides a structural interpre1

tation for the slope coefficients associated with different regression quantiles, it also requires
strong maintained assumptions. We show how panel data may be used to substantially
weaken these assumptions in ways likely to be attractive to empirical researchers. In evaluating the strengths and weakness of our approach, we emphasize that our model is a strict
generalization of the textbook quantile regression model.
In the next section we introduce our notation and model. Section 2 motivates several quantile
partial effects associated with our model and discusses their identification. Section 3 presents
our estimation results. Our formal results are confined to the case of discretely-valued
regressors. This is an important special case, accommodating our empirical application,
as well as applications in, for example, program evaluation as we describe below. The
assumption of discrete regressors simplifies our asymptotic analysis, allowing us to present
rigorous results in a relatively direct way.1 Each of our estimators begins by estimating the
conditional quantiles of the dependent variable in each period given all leads and lags of the
regressors. This is a high-dimensional regression function and our asymptotic analysis needs
to properly account for sampling error in our estimate of it. With discretely-valued regressors,
we do not need to worry about the effects of bias in this first stage of estimation. This is
convenient and substantially simplifies what nevertheless remains a complicated analysis of
the asymptotic properties of our estimators.
While our theorems only apply to the discrete regressor case, we conjecture that our ratesof-convergence calculations and asymptotic variance expressions, would continue to hold in
the continuous regressor case. This would, of course, require additional regularity conditions
and assumptions on the first stage estimator. We elaborate on this argument in Section 5
below.
We present large sample results for two key cases. First, the regular case, where the number
of time periods (T ) exceeds the number of regressors (P ). Our analysis in this case parallels
that given by Chamberlain (1992) for average effects with panel data. Second, the irregular
case, where T = P . This is an important special case, arising, for example, in a two
period analysis with a single policy variable. Our analysis in this case makes use of so-called
‘stayers’, units whose regressor values do not change over time. Stayer units serve as a type
of control group, allowing the econometrician to identify aggregate time trends (as in the
textbook difference-in-differences research design).
With continuously-valued regressors there will generally be only an infinitesimal fraction of
stayers in the population. Graham and Powell (2012) show that this results in slower than
√
N rates of convergence for average effects. We mimic this continuous case in our quantile
1

Chernozhukov, Fernández-Val, Hahn and Newey (2013) study identification in discrete choice panel data
models with discrete regressors.

2

effects context by considering asymptotic sequences which place a shrinking mass on stayer
regressor realizations as the sample size grows. We argue that these “discrete bandwidth
asymptotics” approximate settings where covariates are continuously-valued and, as such,
there is only an infinitesimal fraction of exact stayers, while keeping the convenience of an
analysis based on discrete covariates. This tool may be of independent interest to researchers
interested in studying identification and estimation in irregularly identified semiparametric
models.2 Our approach is similar in spirit to Chamberlain’s (1987, 1992) use of multinomial
approximations in the context of semiparametric efficiency bound analysis.
Section 4 illustrates our methods in a study of the effect of collective bargaining coverage on
the distribution of wages using an extract from the National Longitudinal Survey of Youth
1979 (NLSY79). The relationship between unions and wage inequality is a long-standing area
of analysis in labor economics. Card, Lemieux and Riddell (2004) provide a recent survey of
research. Like prior researchers we find that allowing a worker’s unobserved characteristics
to be correlated with their union status sharply reduces the estimated union wage premium
(e.g., Chamberlain, 1982; Jakubson, 1991; Card, 1995; Vella and Verbeek, 1998). This work
has focused on models admitting intercept heterogeneity in earnings functions. Our model
incorporates slope heterogeneity as well. It further allows for the recovery of quantiles of
these slope coefficients. We find a median union wage effect of 9 percent, close to the mean
effect found by, for example, Chamberlain (1982). In a more novel finding, however, we
find substantial heterogeneity in this effect across workers. For many workers the returns to
collective bargaining coverage are close to, and insignificantly different from, zero. While,
for a smaller proportion of workers, the returns to coverage are quite high, in excess of 20
percent.
We are only able to identify quantile effects for the subpopulation of workers that move
in and/or out of the union sector during our sample period (i.e., “mover” units). Movers
constitute just over 25 percent of our sample. For this group we can study inequality in a
world of universal collective bargaining coverage versus one with no such coverage. We find
that the average conditional 90-10 log earnings gap would be over 20 percent lower in the
universal coverage counterfactual. Our results are consistent with unions having a substantial
compressing effect on the distribution of wages (at least within the subpopulation of movers).
While the asymptotic analysis of our estimators is non-trivial, their computation is straightforward.3 The first two steps of our procedure are similar to those outlined in Chamberlain
2

Examples include sample selection models with “identification at infinity”, (smoothed) maximum score
and regression discontinuity models.
3
A short STATA script which replicates our empirical application is available for download from the first
authors’ website.

3

(1994), consisting of sorting and weighted least squares operations. The final step of our
procedures consist of either averaging, or a second sorting step, depending on the target
estimand. While we do not provide a formal justification for doing so, we recommend the
use of the bootstrap as a convenient tool for inference (the results of, for example, Chernozhukov, Fernández-Val and Melly (2013), suggest that the use of the bootstrap is valid in
our setting).
Section 5 outlines a few simple extensions of our basic approach. Section 6 concludes with
some suggestions for further research and application. All proofs are relegated to the appendix.

1

Setup and model

The econometrician observes N independently and identically distributed random draws of
the T × 1 outcome vector Y = (Y1 , . . . , YT )0 and T × P regressor matrix X = (X1 , . . . , XT )0 .
Here Yt corresponds to a random unit’s period t outcome and Xt ∈ XtN ⊂ RP to a corresponding vector of period t regressors.4 The outcome is continuously-valued with a conditional cumulative distribution function (CDF), given the entire regressor sequence X = x,
of FYt |X (yt |x). This CDF is invertible in yt , yielding the conditional quantile function
QYt |X (τ |x) = FY−1
(y|x).
t |X
0
Let QY|X (τ |x) = QY1 |X (τ |x) , ..., QYT |X (τ |x) be the T × 1 stacked vector of period-specific
conditional quantile functions. Let W = w (X) denote a T × R matrix of deterministic
functions of X (and w = w (x)). We assume that QY|X (τ |x) takes the semiparametric form
QY|X (τ |x) = x0 β (τ ; x) + w0 δ (τ )

(1)

for all x ∈ XTN = ×t∈{1,...,T } XtN and all τ ∈ (0, 1). While a subset of our estimands only
require (1) to hold for a single (known) τ , for convenience, we maintain the stronger requirement that (1) holds for all τ ∈ (0, 1).
A key feature of (1) is that the coefficients multiplying the elements of Xt – β (τ ; x) –
are nonparametric functions of x, while those multiplying the elements of Wt – δ (τ ) – are
constant in x (Wt corresponds to the transpose of the tth row of W). In what follows we
will refer to δ (τ ) as the common coefficients and β (τ ; x) as, depending on the context, the
4

The first element of this vector is a constant unless noted otherwise. The notation XtN reflects the fact
that we allow the support of X to vary with the sample size N in a way that is specified later on.

4

correlated, heterogenous or individual-specific coefficients.5
The model of equation (1) is closely related to the class of varying coefficient (or functional)
quantile regression models, studied in Honda (2004) and Kim (2007). In particular, the
fact that the coefficient on w does not depend on x implies that our model is a partially
varying coefficient quantile regression model: see Wang et al. (2009) and Cai and Xiao (2012).
Letting V be an additional observed covariate, we can write that model as
QY|X,V (τ |x, v) = x0 β(τ ; v) + w0 δ(τ ),
and letting V = X yields our model as a special case. Despite this connection, the identification of our model cannot be established using results from this literature since they
require non-degeneracy of the conditional distribution of V|X: see for example assumptions
(C2) and (C3) in Cai and Xiao (2012) or condition 2 in Kim (2007). This implies the necessary exclusion restriction that V cannot be a subset of the matrix X. We will use the
panel structure of our model will allow us to achieve identification of the distribution of the
varying coefficients.
Model (1), with conditional expectations replacing conditional quantiles, was introduced by
Chamberlain (1992) and further analyzed by Graham and Powell (2012) and Arellano and
Bonhomme (2012). The quantile formulation is new.
A direct justification for (1) is provided by the one-factor random coefficients model
Yt = Xt0 β (Ut ; X) + Wt0 δ(Ut ), Ut | X ∼ U [0, 1] .

(2)

Validity of the resulting linear quantile representation (1) – which must be nondecreasing in
the argument τ almost surely in X – requires further restrictions on the functions β (τ ; x)
and δ (τ ) and the regressors Xt and Wt = wt (X) (cf., Koenker (2005)), which we implicitly
assume throughout.
We provide two, more primitive, derivations of (1) immediately below. The first follows from
a generalization of the linear quantile regression model for cross sectional data (e.g., Koenker
and Bassett, 1978; Koenker, 2005). The second follows from a generalization of the textbook
linear panel data model (e.g., Chamberlain, 1984).
5

We will be interested in identifying and estimating functionals of β(τ ; x), the correlated random coefficients, and therefore we do not consider the object of interest to be the nonparametric function x0 β(τ ; x),
as it would be in a partially linear quantile regression model, e.g. Lee (2003).

5

Generalizing the linear quantile regression model
The strongest interpretation of the estimands we introduce below occurs when we can characterize the relationship between the quantile regression coefficients in (1) and quantiles of
the individual components of Bt in the random coefficients model:
Yt = Xt0 Bt .

(3)

The τ th quantile of Bpt – FB−1
(τ ) – has a simple economic interpretation: the “return” to a
pt
th
unit increase in the p component of Xt is smaller for 100τ percent of units, and greater for
100(1 − τ ) percent of units. In what follows we call FB−1
(τ ) the τ th unconditional quantile
pt
effect (UQE) of a (period t) unit change in Xpt .
In the cross-section setting (T = 1) we can construct a mapping between quantiles of the
individual elements of B1 in (3) and their corresponding quantile regression coefficients in
the linear quantile regression of Y1 onto X1 if (i) X1 is independent of B1 , (ii) there exists
a non-singular rotation B1∗ = A−1 B1 such that the elements of B1∗ are comonotonic (i.e.,
perfectly concordant) and (iii) the elements of x01 A are non-negative for all x1 ∈ X1 .
Under (i) through (iii) we have
Q Y1 |X1 ( τ | x1 ) = x01 b (τ )
for all x1 ∈ X1 and τ ∈ (0, 1) and, critically, that
bp (U ) ∼ Bp1 , U ∼ U [0, 1] .

(4)

Under (4) quantiles of Bp1 (i.e, the UQE of a unit change in Xp1 ) are identified by the
rearranged quantile regression coefficients on Xp1 :
βp (τ ) = inf {c ∈ R : Pr (Bp1 ≤ c) ≥ τ }
= inf {c ∈ R : Pr (bp (U ) ≤ c) ≥ τ } ,
where βp (τ ) equals the τ th unconditional quantile effect (UQE) of a unit change in Xp1 .
Requirement (iii) is related to the quality of the linear approximation of the quantile regression process. Requirements (i) and (ii) are economic in nature and restrictive.6 Assuming
independence of X1 and B1 is very strong outside of particular settings (e.g., randomized
6

The requirement that comonotonicity of the random coefficients needs to hold for only a single rotation
is an implication of equivariance of quantile regression to reparametrization of design (e.g., Koenker and
Bassett, 1978).

6

control trials), but the issues involved, and how to reason about them, are familiar. The
requirement of comonotonicity of the random coefficients, possibly after rotation, is more
subtle and less familiar. It too has strong economic content.
To illustrate some of the issues associated with the comonotonicity requirement, as well as
how panel data may be used to weaken it (as well as the assumption of independence), it
is helpful to consider, as we do in the empirical application below, the relationship between
the distribution of wages and collective bargaining coverage.
If we let Yt equal the logarithm of period t wages, and UNIONt be a binary variable indicating
whether a worker’s wages are covered by a collective bargaining agreement in period t or
not, we can write, without loss of generality,
Yt = B1t + B2t UNIONt , t = 1, . . . , T.

(5)

The the τ th quantile of B2t – FB−1
(τ ) – has a simple economic interpretation: the “return”
2t
to collective bargaining coverage is smaller for 100τ percent of workers, and greater for
100(1 − τ ) percent of workers.
Now consider the coefficient on UNION1 in the τ th linear quantile regression of log wages in
period 1 onto a constant and UNION1 . This coefficient, b2 (τ ), equals
b2 (τ ) = F B−111 +B21 |X1 ( τ | UNION1 = 1) − F B−111 |X1 ( τ | UNION1 = 0) ,
which, without further assumptions, is not a quantile effect.
Requirement (i) – independence – yields the simplification
b2 (τ ) = FB−1
(τ ) − FB−1
(τ ) .
11 +B21
11
Requirement (ii) – comonotonicity – implies that there exists at least one rotation B1∗ =
∗
∗
A−1 B1 such that B11
and B21
are comonotonic. Different rotations have different economic
content. For example if B11 and B11 + B21 are comonotonic, then the workers with the
highest potential earnings in the union sector coincide with those with the highest potential
earnings in the non-union sector and vice versa. This rules out comparative advantage.
If, instead, B11 and B21 are comonotonic, then those workers which benefit the most from
collective bargaining coverage are also those who earn the most in its absence. Both of these
comonotonicity assumptions imply (4). As a final example, if B1t and -B2t are comonotonic,

7

such that low earners in the absence of coverage gain the most from acquiring it, then
b2 (τ ) = F B−111 |Xt (τ ) + F B−121 |Xt (1 − τ ) − F B−111 |Xt (τ )
= F B−121 |Xt (1 − τ ) ,
which also implies (4).
These examples illustrate both the flexibility and restrictiveness of the comonotonicity requirement. Depending on the setting, it may be reasonable to assume comonotonicity of
Bt∗ = A−1 Bt for some non-singular rotation A. Certain rotations may be more plausible
than others. Nevertheless the assumption is often difficult to justify. Even in the program
evaluation context, where independence of X1 and B1 may hold by design, researchers are
often reluctant to interpret quantile treatment effects as anything more than the difference
in two marginal survival functions (e.g., Koenker, 2005, pp. 30-31; Firpo, 2007).
At the same time, it is worth noting that textbook linear models with additive heterogeneity
imply stronger rank invariance properties. For example, the basic models fitted by Chamberlain (1982), Jakubson (1991) and Card (1995) all have the implication that those workers
with the highest potential earnings in the union sector coincide with those with the highest
potential earnings in the non-union sector (cf., Vella and Verbeek (1998) for discussion).
The availability of panel data may be used to substantially weaken the assumptions of both
comonotonicity and independence of the random coefficients. In particular we can replace (i)
and (ii) above, with the requirement that the elements of Bt∗ = A (x)−1 Bt are comonotonic
within the subpopulation of workers with common history X = x:7
D

A (x)−1 Bt X = x =




F B−11t |X ( Ut | x) , . . . , F B−1P t |X (Ut | x) , U ∼ U [0, 1] ,

(6)

for some non-singular A (x). Under (5) and (6) we have
Q Yt |X ( τ | x) = x0t βt (τ ; x)
and, critically, also that
βpt (U ; x) ∼ Bpt | X = x, U ∼ U [0, 1] .
Note that the rotation of Bt that ensures conditional comonotonicity can vary with X = x.8
In addition to conditional comonotonicity, we also, as is typical in panel data models, need
7
8

We also require that x0t A (x) is non-negative for all xt ∈ Xt .
Clotilde and Napp (2004) present basic results on conditionally comonotonic random variables.

8

to impose some form of stationarity in the distribution of Bt over time. A convenient, but
flexible, assumption is to require that the distribution of Bp1 and Bpt , for t > 1, are related
according to
βpt (τ ; x) − βp1 (τ ; x) ≡ δpt (τ ) ,

t = 2, . . . , T,

p = 1, . . . , P.

(7)

Restriction (7) corresponds to a “common trends” assumption. Under assumption (7) it is
convenient to define, in a small abuse of notation, βp (τ ; x) = βp1 (τ ; x).
Under restriction (7) differences in the conditional quantile functions of Bpt and Bps for t 6= s
do not depend on X. Under (3), (6) and (7) the conditional quantiles for Y given X satisfy
(1) with




00P · · · 00P
δ
(τ
)

 0
2


 X2 · · · 00P 
..
 , δ (τ ) = 
,
W=
.
.
.
 . ...


.. 

 .
δ
(τ
)
T
00P · · · X0T
where 0P denotes a P × 1 vector of zeroes. Here dim (δ (τ )) = R = (T − 1) P , since we allow
the entire coefficient vector multiplying Xt to vary across periods. In practice, additional
exclusion restrictions might be imposed or tested. For example one could impose the restriction that all components of δt (τ ) corresponding
to the

 non-constant components of Xt are
0

zero. In that case we could set W =

0T −1 , IT −1

.

To understand the generality embodied in (5), (6) and (7) relative to the cross-section case,
it is again helpful to return to our empirical example. Suppose that Xt = (1, UNIONt )0 with
T = 2, so that there are just four possible sequences of collective bargaining coverage:
(UNION1 , UNION2 ) ∈ {(0, 0) , (0, 1) , (1, 0) , (1, 1)} .
With panel data we can assume, for example, that B1t and B1t + B2t are comonotonic
within the subpopulation of union joiners (i.e., (UNION1 , UNION2 ) = (0, 1)), while B1t and
−B2t are comonotonic within the subpopulation of union leavers (i.e., (UNION1 , UNION2 ) =
(1, 0)). There may be no rotation of B1 in which comonotonicity holds unconditionally on
X = x. Other than the assumption of conditional comonotonicity, all other features of the
joint distribution of Bt and X are unrestricted. This allows for dependence between Xt and
B t . For example it may be that the distribution of B2t , the returns to collective bargaining
coverage, across workers in the union sector both periods, stochastically dominates that
across workers not in the union sector both periods (cf., Card, Lemieux and Riddell, 2004).
Equations (5), (6) and (7) show how our semiparametric model arises as a strict general9

ization of the textbook linear quantile regression model. Here, relative to the cross section
case, the presence of panel data allows for (i) a relaxation of comonotonicity of the random
coefficients, (ii) the introduction of correlated heterogeneity and (iii) a structured form of
non-stationarity over time.
Generalizing the linear panel data model
In our exposition, for reasons of clarity, we emphasize an interpretation of (1) based on the
data generating process defined by (5), (6) and (7). However it is also straightforward to
derive variants of (1) from a generalization of the textbook linear panel data model (e.g.,
Chamberlain, 1984):
Yit = Xit0 β + Ai + Vit , E [Vit | Xi1 , . . . , XiT , Ai ] = 0, t = 1, . . . , T.

(8)

In this model, the “fixed effects” Ai are treated as an incidental, individual-specific parameter
that can be estimated or differenced out. The strict exogeneity condition allows us to identify
the common coefficients β.
We modify this model with respect to multiple dimensions. First, we allow the common
coefficients β to vary with the time index t, and we also assume that Ai follows a distribution
that is identical for each individual.9 Omitting the i subscript, the resulting model is
Yt = Xt0 βt + A + Vt , E [Vt | X1 , . . . , XT , A] = 0, t = 1, . . . , T.

(9)

Second, we further generalize this model by considering a location-scale version of (9) (cf.,
Arellano and Bonhomme, 2011)
Yt = Xt0 βt + Xt0 g (A + Vt ) ,

(10)

with x0t g (a + vt ) strictly increasing in a + vt for all a + vt ∈ A + Vt and all xt ∈ XtN and Vt
obeying the marginal stationarity restriction of Manski (1987):
d

V1 | X = Vt | X, t = 2, . . . , T.

(11)

Relative to the textbook model, (10) allows for the marginal effect of a unit change in Xtp to
be heterogenous across units and correlated with X since the individual effects’ dependence
on X is left unrestricted. The textbook model imposes homogeneity of marginal effects, a
9

The formulation of the model in equation (8) allows for an i.n.i.d. distribution of the individual effects.

10

strong restriction which is useful to relax. Equations (10) and (11) generate the period t
conditional quantile function
Q Yt |X ( τ | x) = x0t (β (τ ; x) + δt )

for β (τ ; x) = β1 + g Q A+V1 |X ( τ | x) and δt = βt − β1 . This model implies that the time
effects take a pure location-shift form, which is not a implication of (1).
Our semiparametric model (1) therefore nests both the textbook quantile regression and
linear panel data models as special cases. It also strictly generalizes those models, introducing
heterogenous effects and/or the dependence of these effects on the regressors.

2

Estimands and identification

In this section we introduce three estimands based on (1). We motivate these estimands visa-vis the correlated random coefficients model defined by (5), (6) and (7) above, although
this is not essential to our formal results. Indeed a subset of our estimands only require that
(1) hold for a single known τ .
Our first estimand is the R × 1 vector of common coefficients δ (τ ). Recall that in our
motivating data generating process the elements of δ (τ ) coincide with time effects.
Our second estimand is the P × 1 vector of average conditional quantile effects (ACQEs):
β̄ (τ ) = E [β (τ ; X)] .

(12)

Equation (12) coincides with an average of the conditional quantiles of B1 in (5) over X.
It is similar to the average derivative quantile regression coefficients studied in Chaudhuri,
Doksum and Samarov (1997).
The ACQE is also closely related to a measure of conditional inequality used by labor
economists. Angrist, Chernozhukov and Fernández-Val (2006; Table 1) report estimates
of the average E [X1 ]0 (β (0.9) − β (0.1)), with β (τ ) the coefficient on X1 in the τ th linear
quantile regression of log earnings Y1 on worker characteristics X1 . They interpret this as
a measure of average conditional earnings inequality or ‘residual’ wage inequality.10 In our
panel data set-up the analogous measure of period t conditional earnings inequality would
10

This measure captures a notion of ‘residual’ wage inequality in that it measures the average amount of
inequality in earnings that is left-over after first conditioning on covariates (cf., Autor, Katz and Kearney,
2008).

11

be
E [Xt0 (β (0.9; X) − β (0.1; X))] + E [Wt ]0 (δ (0.9) − δ (0.1)) .

(13)

Equation (13) measures the average period t conditional 90-10 earnings gap across all subpopulations of workers defined in terms of their covariate histories X. It is a “residual”
inequality measure because it is an average of earnings dispersion measures which condition
on observed covariates. Under our assumptions (13) has counterfactual content. To see
this consider the average conditional period t 90-10 earnings gap that we would observe if,
contrary to fact, worker characteristics remained fixed at their base year values:
E [X10 (β (0.9; X) − β (0.1; X))] + E [W1 ]0 (δ (0.9) − δ (0.1)) .

(14)

The difference between (13) and (14) is a measure of the increase in ‘residual’ earnings
inequality due to changes in worker characteristics between periods 1 and t. Similar reasoning
leads to more complicated decomposition estimands.
Our final estimand, which makes full use of our set-up, is the unconditional quantile effect
(UQE), defined implicitly by, for p = 1, . . . , P,
βp (τ ) = QB1p (τ )
= inf {b ∈ R : Pr (B1p ≤ b) ≥ τ }
= inf {b ∈ R : Pr (βp (U1 , X) ≤ b) ≥ τ }
where U1 ∼ U [0, 1], independent of X. The UQE βp (τ ) corresponds to the τ th quantile of
the pth component of the random coefficient vector B1 . If we took a random draw from the
population and increased her pth regressor value by one unit, then with probability τ the
effect on Y1 would be less than or equal to βp (τ ), while with probability 1 − τ it would be
greater. To get the total effect for a tth period intervention, we would need to take into
account the effect on Wt0 δ(τ ) of the change in regressor Wt (as a function of Xt ).
The UQE is the quantile analog of an average partial effect (APE).

Identification
We present two sets of identification results. The first requires that the time dimension of the
panel (T ) strictly exceed the number of regressors (P ). We refer to this as the “regular” case.
Chamberlain (1992) studied identification of average partial effects in this setting. Second
we study identification when T = P . This is the case studied in Graham and Powell (2012).
We refer to this case as “irregular”. Both are empirically relevant (cf., Graham and Powell,
12

2012). Throughout this section we assume that the joint distribution of the observable data
matrix (Y, X) is known – in particular, that the T × 1 vector Q Y|X ( τ | X) is known for all
τ ∈ (0, 1) and X ∈ XTN .
Regular case (T > P )
Let A (X) be any T × T positive definite matrix, possibly a function of X, and define the
residual-maker matrix
MA (X) = IT − X (X0 A (X) X)

−1

X0 A (X) .

(15)

If E [kXk2 + kWk2 ] < ∞ and E [W0 MA (X)W] is invertible we can recover δ (τ ) by
δ (τ ) = E [W0 MA (X) W]

−1



× E W0 MA (X) Q Y|X ( τ | X) .

(16)

Equation (16) shows that δ (τ ) indexes a (generalized) within-unit, double residual, linear
regression function. The dependent variable associated with this regression is Q Yt |X ( τ | X)
deviated from its unit-specific “mean” and the independent variable the deviation of Wt
about its corresponding “mean” .
Once δ(τ ) is identified, we can also identify the τ th conditional quantile of the random
coefficient, for X realizations with full rank, through the relation
−1

β(τ ; X) = (X0 A (X) X)

X0 A (X) (QY|X (τ |X) − Wδ(τ )).

(17)

If all realizations of X are of full rank, we can directly recover the average conditional quantile
effect (ACQE) from (17) by
β̄(τ ) = E [β(τ ; X)]
h
i
−1
= E (X0 A (X) X) X0 A (X) (QY|X (τ |X) − Wδ(τ )) ,

(18)

while the unconditional quantile βp (τ ) of the pth component of B1 is identified as the solution
to the equation
E [1(βp (U ; X) ≤ βp (τ )) − τ ] = 0,
(19)
with U uniformly distributed on (0, 1), independently from X. The UQE βp (τ ) will be
uniquely identified if the distribution of β(U ; X) is continuous around its τ th quantile with
positive density.
Equations (18) and (19) do not follow if the probability π0 that X is rank deficient is non13

zero. Denote by XM the region of the support of X where its rank is full, and denote by π0
the probability that the rank of X is less than P . Similarly, denote by XS the region of the
support where X is rank deficient. When π0 > 0 it is still possible to identify δ(τ ), by using
the observations where X ∈ XM , via

−1


δ(τ ) = E W0 MA (X)W|X ∈ XM
× E W0 MA (X)QY|X (τ |X)|X ∈ XM ,


if we now assume that E W0 MA (X)W|X ∈ XM is invertible and under the same moments
existence requirements. It is also possible to identify β(τ ; X) through the same argument,
but only for the subpopulation of units where X has full rank. These full rank units represent
fraction 1 − π0 of the population, as opposed to its entirety. Despite the non-identification
of β(τ ; X) for units with non-full rank, it is clearly possible to point identify the “movers’
ACQE” and the “movers’ UQE”, defined as


β̄ M (τ ) = E β(τ ; X)|X ∈ XM
h
i
−1
= E (X0 A (X) X) X0 A (X) (QY|X (τ |X) − Wδ(τ ))|X ∈ XM

(20)

and the solution βpM (τ ) to the equation


E 1(βp (U ; X) ≤ βpM (τ )) − τ |X ∈ XM = 0.

(21)

Although β̄(τ ) and βp (τ ), the full population average and unconditional quantile effects, are
not point identified when π0 > 0, it is possible to construct bounds for them. The Law of
Total Probability gives
β̄(τ ) = β̄ M (τ ) Pr(X ∈ XM ) + E[β(τ ; X)|X ∈ XS ] Pr(X ∈ XS ).
Let [bp , b̄p ] denote bounds on the support of βp (τ ; X). The existence of such bounds, although
not their magnitude, is implied by Assumption 5 below. The identified set for β̄p (τ ) is then

 M
β̄p (τ ) Pr(X ∈ XM ) + bp Pr(X ∈ XS ), β̄pM (τ ) Pr(X ∈ XM ) + b̄p Pr(X ∈ XS )
for any p = 1, . . . , P . This result requires us to assume that b̄p and bp are known.
A somewhat more satisfying result is available for βp (τ ). We give this result as a Theorem,
although the required assumptions are not stated until the next section.
Theorem 1. (Partial Identification of βp (τ )) Under Assumptions 1 through 5 stated


below and E W0 MA (X)W|X ∈ XM invertible, the UQE for the pth coefficient is partially
14

identified with identification region:





τ − Pr(X ∈ XS )
τ
M
M
βp (τ ) ∈ βp
, βp
.
Pr(X ∈ XM )
Pr(X ∈ XM )

(22)

where βpM (τ ) ≡ bp for τ < 0 and βpM (τ ) ≡ b̄p for τ > 1.
Since the movers’ UQE is identified, as well as Pr(X ∈ XM ) and Pr(X ∈ XS ) = 1 − Pr(X ∈
XM ), the analog estimators for the lower and upper bounds of the identified set given in
(22) are easy to compute.11 If prior bounds on the random coefficient are unknown, these
bounds are only meaningful for τ in a subset of (0, 1). The width of this subset depends on
the fraction of stayers. When τ is close to either 0 or 1, we must rely on prior bounds b̄p and
bp to set identify the UQE, as is the case for the ACQE.
Irregular case (T = P )
We now consider the T = P case. Our approach builds on that of Graham and Powell (2012)
for average effects in a conditional mean variant of (1). While identification in the regular
case is based solely on the subpopulation of movers, the irregular case utilizes both movers
and stayers. The role of stayers is to identify the common parameter δ (τ ), which in our
motivating data generating process, captures aggregate time effects. Stayers, as we detail
below, serve as a type of control group, allowing the econometrician to identify “common
trends” affecting all units.
Let D = det(X), X∗ denote the adjugate (or adjoint) matrix of X (i.e., the matrix such that
X−1 = D1 X∗ when D 6= 0), and W∗ = X∗ W. Premultiplying equation (1) by X∗ gives
X∗ QY|X (τ |X) = W∗ δ(τ ) + Dβ(τ ; X).

(23)

Assuming that zero is in the support of the determinant, D, E [kW∗ k2 ] < ∞ and that
E[W∗0 W∗ |D = 0] is of full rank, we can identify δ(τ ), using only stayer (i.e., D = 0)
observations, by:
−1

δ(τ ) = E [W∗0 W∗ | D = 0]



× E W∗0 X∗ QY|X (τ |X)|D = 0 .

(24)

Given identification of δ(τ ), we can then recover β(τ ; X) by
β(τ ; X) = X−1 (QY|X (τ |X) − Wδ(τ ))
11

(25)

The endpoints’ joint asymptotic distribution can be readily inferred from the process convergence of the
UQE process established below.

15

for all X where X−1 =

1
X∗
D

is well-defined (i.e., for “mover” realizations of X).

As long as Pr (D = 0) = 0 it follows that the conditional effect β(τ ; X) will be identified
with probability one. However, the identification of the ACQE and UQE estimands is more
delicate than in the regular case, due to the fact that if the density of D is positive in
a neighborhood of 0 (which we require for identification of δ(τ )), expectations involving
X−1 = D1 X∗ will not exist in general (e.g., Khan and Tamer (2010) and Graham and Powell
(2012)). In order to identify the ACQE, β̄(τ ), we write it as the limit of a sequence of
“trimmed” expectations
β̄(τ ) = E[β(τ ; X)]
= lim E[β(τ ; X)1(|D| > h)]
h↓0

= lim E[X−1 (QY|X (τ |X) − Wδ(τ ))1(|D| > h)],
h↓0

(26)

where the second equality holds because
β̄(τ ) − E[β(τ ; X)1(|D| > h)] = E[β(τ ; X)1(|D| ≤ h)] = O(h)
under sufficient smoothness conditions. This trimming is not strictly necessary at the identification stage, under the maintained assumption that β̄(τ ) exists, but is introduced in
anticipation of its estimation. In particular, replacing QY|X (τ |X) with a nonparametric estimate introduces noise into the numerator of the sample analog of (26). This sampling error
may cause the expectation of the estimated conditional effect
β̂(τ ; X) = X−1 (Q̂Y|X (τ |X) − Wδ̂(τ ))
to be undefined due to a lack of moments of the remainder term


β̂(τ ; X) − β(τ ; X) = X−1 Q̂Y|X (τ |X) − QY|X (τ |X) − W(δ̂(τ ) − δ(τ )) .
We can also characterize the identification of βp (τ ), the UQE associated with the pth regressor, in terms of a sequence of trimmed means. Assuming that the distribution of β(U ; X)
given D = t is continuously differentiable in a neighborhood of t = 0, we can write βp (τ ) as
the solution to
0 = E [1(βp (U ; X) ≤ βp (τ )) − τ ]
= lim E [(1(βp (U ; X) ≤ βp (τ )) − τ )1(|D| > h)] .
h↓0

16

Our approach to estimation exploits this characterization.
If there is a point mass of stayer units with D = 0 (i.e. π0 > 0), the same identification
issues arise here as in the regular (T > P ) case. In this case we can continue to identify δ(τ )
as before, but β(τ ; X) will be unidentified for a set of X values with positive probability. It
is still possible identify the movers’ ACQE and UQE using straightforward modifications of
the arguments given for the regular case in the previous subsection.
As a simple example of irregular identification consider a two period version of (1) with a
single time-varying regressor (X2t ) and an intercept time shift.12 This setup yields conditional
quantiles for each period of
QY1 |X (τ |x) = β1 (τ ; x) + β2 (τ ; x) X21
QY2 |X (τ |x) = δ (τ ) + β1 (τ ; x) + β2 (τ ; x) X22 .
Here X2t might be a policy variable, such as an individuals’ workers compensation benefit
level, which depends on own earnings as well as state-specific benefit schedules, and Yt an
outcome of interest to a policymaker, such as time out of work following an injury.
Evaluating (24) we get


δ (τ ) = E ω (X21 ) QY2 |X (τ |X) − QY1 |X (τ |X)


D=0 ,

ω (X1 ) =

2
1 + X21
,
2
E [1 + X21
| D = 0]

so that δ (τ ) is identified by a weighted average of changes in the τ th quantile of Yt between
periods 1 and 2 across the subpopulation of stayers. Stayer units, who in this case correspond
to units where X21 = X22 (i.e., the nonconstant regressor stays fixed over time), serve as a
type of “control group”, identifying aggregate time effects or “common trends”.
The conditional quantile effect of a unit change in X2t is given by the second element of (25),
which evaluates to
QY2 |X (τ |x) − QY1 |X (τ |x) − δ (τ )
βp (τ ; x) =
,
4x2
for all x with x22 −x21 = 4x2 6= 0. Hence βp (τ ; x) is identified by a “difference-in-differences”.
12

This corresponds to (1) with T = P = 2 and W and X equal to
 


0
1 X21
W=
, X=
1
1 X22

so that D = X22 − X21 = 4X2 .

17

3

Estimation

In this section we present analog estimators, based upon the identification results presented
above. Our estimators utilize preliminary nonparametric estimates of the conditional quantiles of Yt given X for t = 1, . . . , T. Our formal results cover the case where X is discretely
valued with M points of support: X ∈ XTN = {x1N , . . . , xM N }. This case covers many empirical applications of interest, including the one developed below. It is also, as described in
the introduction, technically simpler, allowing analysis to proceed conditional on discrete,
non-overlapping, cells. However, by considering asymptotic sequences where the location
and probability mass attached to the different support points of X changes with N , we show
how our results would extend to the case of continuously-valued regressors (albeit under
additional regularity conditions).
After stating our main assumption we discuss estimation in the regular case (T > P ) and
irregular case (T = P ).

Assumptions
Assumption 1. (Data Generating Process) The conditional quantiles of Y1 , . . . , YT
given X are of the form (1) for all X ∈ XTN and τ ∈ (0, 1) .
For estimation of the common parameter, δ (τ ), and the ACQE, β̄p (τ ), we only require that
(1) hold at τ . The stronger implications of Assumption 1 are required for estimation of the
UQE, βp (τ ), p = 1, . . . , P .
Assumption 2. (Support and Support Convergence) (i) X ∈ XTN = {x1N , . . . , xM N }
with plN = Pr (X = xlN ) for l = 1, . . . , N ; (ii) as N → ∞, we have xlN → xl , plN → pl
and N plN → ∞ for any l = 1, . . . , M for some well defined xl and pl ; (iii) the elements of
X = {x1 , . . . , xM } are bounded.
Assumption 2 has two non-standard features. First, while it restricts the number of support
points of X, the location of these points is allowed to vary with N . Second, the probability
mass attached to each support point may also vary with N . Both of these sequences have
well-defined limits. An important feature of Assumption 2 is that it allows the probability
mass attached to some points of support to shrink to zero. The rate at which this occurs is
limited by the requirement that N plN → ∞. This assumption ensures that the conditional
quantile of Yt given X = xl is consistently estimable for all l = 1, . . . , M . However the rate of

18

convergence of these estimates will be slower for points of support with shrinking probability
mass as N grows large.13
For the analysis which follows it is convenient to partition the support of X as follows.
1. Units with X = xmN for m = 1, . . . , L1 < M correspond to movers. Movers correspond to units where, recalling that xmN → xm , xm and xmN are of full rank.
Intuitively movers are units whose covariate values “vary a lot” over time.
2. Units with X = xmN for m = L1 + 1, . . . , L < M correspond to near stayers. Near
stayers correspond to units where xmN is of full rank, but its limit xm is not. We will
be more precise about the behavior of these units’ design matrices along the path to
the limit below. Intuitively near stayers are units who covariate values change “very
little” over time.
3. Units with X = xmN for m = L + 1, . . . , M correspond to stayers. Stayers are units
where xmN is neither of full rank along the path nor in the limit. Stayers correspond
to units where the number of distinct rows of X is less than P (i.e., whose regressor
sequences display substantial persistence).
We let XM
N = {x1N , . . . xLN } denote the set of mover support points (including near stayers).
The set of stayer support points is denoted by XSN = {xL+1N , . . . xM N }. We introduce more
structure to this basic set-up (as needed) below.
Assumption 3. (Random Sampling) {Yi , Xi }N
i=1 is a random (i.i.d.) sample from the
population of interest.

Assumption 4. (Bounded and Continuous Densities) The conditionaldistribution
;x)
F Yt |X ( yt | x) has density f Yt |X ( yt | x) such that ψ (τ ; x) = f Yt |X F Y−1
(τ | x) x and ∂ψ(τ
∂τ
t |X
are uniformly bounded and bounded away from zero for all τ ∈ (0, 1), all x ∈ XTN , and
all t = 1, . . . , T. Also, this conditional distribution does not vary with the sample size N .
Finally, f Yt |X ( yt | x), F Yt |X ( yt | x) and F Y−1
( yt | x) are all continuous in x.
t |X
Assumption 5. (Bounded Coefficients) The support of Btp is compact and its density
is bounded away from 0 for any p = 1, . . . , P and t = 1, . . . , T .
Also note that, since W is a function of X alone, it too has M points of support: W ∈ WTN =
{w1N , . . . , wM N } .
13

19

Assumptions 3 is standard, as is Assumption 4 is the quantile regression context. Assumption
5, in conjunction with Assumption 2 ensures that Y has bounded support.
The first step of our estimation procedure involves computing estimates of the conditional
quantiles of Yt given X for all X ∈ XTN and all t = 1, . . . , T . This must be done for a single τ
in the case of the common coefficients, δ (τ ) and the movers’ Average Conditional Quantile
Effect (ACQE), β̄ M (τ ), and for a uniform grid of τ ∈ (0, 1) in the case of the movers’
Unconditional Quantile Effect (UQE), βpM (τ ). When X is discretely valued this first step of
estimation is very simple (cf., Chamberlain, 1994).
Under Assumption 2 preliminary estimation of the conditional quantiles of Yt given X is
straightforward. Let
"
FbYt |X ( yt | xmN ) =

N
X

#−1
1 (Xi = xmN )

i=1

×

" N
X

#
1 (Xi = xmN ) 1 (Yit ≤ yt ) ,

i=1

be the empirical cumulative distribution function of Yt for the subsample of units with
X = xmN . Our estimate of the τ th conditional quantile of Yt equals
n
o
bYt |X (τ |xmN ) = Fb−1 ( yt | xmN ) = inf yt : FbYt |X ( yt | xmN ) ≥ τ .
Q
Yt |X
bY|X (τ ; xlN ) and Q
bY|X (τ |xmN ) for l 6= m are conditionally uncorrelated given
Note that Q
{Xi }N
i=1 .
bY|X (τ ; xmN ) is very simple (cf., Chamberlain, 1994). Let Nm =
In practice estimation of Q
PN
(j,m)
denote the j th
i=1 1 (Xi = xmN ) equal the number of units in cell X = xmN . Let Yt
(j,m)
order statistic of Yt in the X = xmN subsample. We estimate QYt |X ( τ | xmN ) by Yt
where
j satisfies
j+1
j
<τ ≤
.
Nm + 1
Nm + 1
(j,m)

(j+1,m)

)/2 as our estimate.
bY|X (τ ; xmN ) we require some additional
To characterize the large sample properties of Q
notation. Let

Pr Ys ≤ QYs |X (τ |X) , Yt ≤ QYt |X (τ |X) − τ τ 0
0
ρst (τ, τ ; X) =
, s, t = 1, . . . , T
(27)
min (τ, τ 0 ) − τ τ 0
Alternatively we could use (Yt

+ Yt

20

and Λ (τ, τ 0 ; X) equal






1
f Y1 |X (QY1 |X (τ |X)|X)f Y1 |X (QY1 |X (τ |X)|X)

ρ1T (τ,τ 0 ;X)
f Y1 |X (QY1 |X (τ |X)|X)f Y |X (QYT |X (τ |X)|X)

···

T

..
.

...

..
.

ρ1T (τ,τ 0 ;X)
f Y1 |X (QY1 |X (τ |X)|X)f Y |X (QYT |X (τ |X)|X)

···

1
f Y |X (QYT |X (τ |X)|X)f Y |X (QYT |X (τ |X)|X)
T
T

T




 . (28)


Using this notation, an adaptation of standard results on quantile processes in the cross
sectional context, to allow for both moving support points and probabilities, gives our first
result:
Lemma 1. Suppose that Assumptions 1 through 5 are satisfied, then
p



bY|X (τ |xmN ) − QY|X (τ |xmN )
N pmN Q

converges in distribution to a mean zero Gaussian process ZQ (·, ·) on τ ∈ (0, 1) and xm ∈ X,


where ZQ (·, ·) is defined by its covariance function ΣQ (τ, xl ,τ 0 , xm ) = E ZQ (τ, xl ) ZQ (τ 0 , xm )0
with
ΣQ (τ, xl ,τ 0 , xm ) = (min (τ, τ 0 ) − τ τ 0 )Λ (τ, τ 0 ; xl ) · 1 (l = m)
(29)
for l, m = 1, . . . , M.
Lemma 1 generalizes textbook process convergence results for unconditional quantiles. Consider a support point with pmN = hN with hN → 0 and N hN → ∞. The rate-of-convergence
√
for such support points will be order N hN , since the effective sample size used for estimation is proportional to N hN rather than N . Convergence here is on τ ∈ (0, 1) since Yt
has compact support (by Assumptions 2 and 5 and that Yt is the product of Xt and Bt ). If
Yt ’s support was unbounded, Lemma 1 would instead hold uniformly for τ ∈ [, 1 − ] with
arbitrary  satisfying 0 <  < 1/2.

Regular case (T > P )
We initially develop results for the fixed support case with xmN = xm for all m = 1, . . . , L.
In this setting there are no near stayers so that L1 = L. There may or may not be pure
stayers in this case. This changes the identified effect, but not our approach to estimation –
which utilizes movers alone – as explained below.
Let Π(τ ) = (QY|X (τ |x1 )0 , . . . , QY|X (τ |xL )0 )0 be a T L × 1 vector with movers’ conditional

21

quantiles and notice that, under (1),
Π(τ ) = Gγ(τ )
for τ ∈ (0, 1) with



γ (τ ) = 

(R+P L)×1


δ (τ )
β (τ ; x1 )
..
.




,



β (τ ; xL )



w1
x1 · · ·
 .
..
..

G
=  ..
.
.
T L×(R+P L)
wL 0T 00P · · ·

0T 00P



.. 
. 
.
xL

(30)

Since rank (G) = dim (γ (τ )) we have
γ (τ ) = (G0 AG)

−1

G0 AΠ (τ ) ,

(31)

for any T L × T L positive-definite weight matrix A.
When A is block diagonal with mth T × T block pm A (xm ) , it is straightforward to demonstrate that the first R elements of γ(τ ) in (31) can be expressed as

−1


δ(τ ) = E W0 MA (X)W|X ∈ XM
× E W0 MA (X)QY|X (τ |X)|X ∈ XM ,
which coincides with (16) above. Manipulation of (31) also yields, for all X ∈XM ,
β (τ ; X) = [X0 A (X) X]

−1


X0 A (X) QY|X (τ |X) − Wδ (τ ) ,

which coincides with (17) above.
Our analog estimator is
b )
γ̂(τ ) = (G0 ÂG)−1 G0 ÂΠ(τ

(32)

b ) is as defined
where Â is a consistent estimator of a positive definite weight matrix and Π(τ
above. To get precise results we make the following assumption on the weight matrix.
P
Assumption 6. (Weight Matrix) Â = diag{p̂1N , . . . , p̂LN }⊗IT where p̂l = N1 N
i=1 1(Xi =
xlN ).
This assumption is made to simplify the analysis and because weighting each support point
by its relative frequency is often a reasonable choice. Although we do not develop this point
here, it is straightforward to show, by adapting the argument given by Chamberlain (1994),
that this choice of weight matrix also allows for easy characterization of the large sample
properties of γ̂(τ ) under misspecification (i.e., when (1) does not hold).
22

Define
−1

MI (X) = IT − X (X0 X) X0
h 0
i
−1
K (X) = (X0 X) X0 W,
Γ = E W W X ∈ XM .
W = MI (X) W,

Theorem 2.h Suppose that Assumptions
1 through 6 are
satisfied, the
i
 distribution of X is
√ 
0
M
b
is invertible, then (i) N δ (·) − δ (·) converges in distribufixed, and E W W|X ∈ X
tion to a mean zero Gaussian process Zδ (·), where Zδ (·) is defined by its covariance function
−1

0

0 0

0

0

Σδ (τ, τ ) = E[Zδ (τ ) Zδ (τ ) ] = (min (τ, τ ) − τ τ )

h

0

0

Γ E W Λ (τ, τ ; X) W X ∈ X
Pr(X ∈ XM )

M

i

Γ−1
,

(33)

√ 
and (ii) N βb (·; ·) − β (·; ·) also converges in distribution to a mean zero Gaussian process
Z (·, ·), where Z (·, ·) is defined by its covariance function

0
Σ(τ, xl , τ 0 , xm ) = E Z (τ, xl ) Z (τ 0 , xm )
(x0l xl )−1 x0l Λ (τ, τ 0 ; xl ) xl (x0l xl )−1
· 1 (l = m)
pl
+K (xl ) Σδ (τ, τ 0 )K (xm )0 ,
(34)

= (min (τ, τ 0 ) − τ τ 0 )

for l, m = 1, . . . , L.
When X has finite support and, as maintained here, the location and probability mass
attached to this support does not change with N , the rate of convergence of βb (τ ; xm ) and
√
δb (τ ) is N . At the same time it is not possible to identify β(τ ; xm ) for the stayer realizations
m = L + 1, . . . , M . Hence under the fixed support assumption β̄(τ ), the average conditional
quantile effect, is not point identified. However, the movers’ ACQE, defined as β̄ M (τ ) =
E[β(τ ; X)|X ∈ XM ], is consistently estimable by
bM (τ ) =
β

PN


1 Xi ∈ XM βb (τ ; Xi )
.
PN
M)
1
(X
∈
X
i
i=1

i=1

(35)

√ bM
M
Theorem 3. Under the assumptions maintained in Theorem 2 above, N (β
(·) − β (·))
converges in distribution to a mean zero Gaussian process Zβ̄ (·), where Zβ̄ (·) is defined by

23

its covariance function

0
Σβ̄ (τ, τ 0 ) = E Zβ̄ (τ ) Zβ̄ (τ 0 )

C β (τ ; X) , β (τ 0 ; X)0 X ∈ XM
=
+ Υ1 (τ, τ 0 ) + K M Σδ (τ, τ 0 )K M 0
Pr (X ∈ XM )

(36)

where
i
(min (τ, τ 0 ) − τ τ 0 ) h 0 −1 0
−1
0
0
M
Υ1 (τ, τ ) =
E (X X) X Λ (τ, τ ; X) X (X X) |X ∈ X ,
Pr(X ∈ XM )
0

K M = E[K(X)|X ∈ XM ].
bM (τ ) arises from variation in the random
The first term in the asymptotic distribution of β
coefficients across the subpopulation of movers. It would be zero if FX were known. The
second and third terms reflect sampling uncertainty in β̂(τ ; x) and δ̂(τ ) respectively (which
arises because the conditional distribution of Y given X is unknown). The form of Σβ̄ (τ, τ 0 )
mirrors that derived by Chamberlain (1992) for averages of random coefficients.
As with the ACQE, unconditional quantile effects are only identified across the subpopulation
of movers. Our estimate of βpM (τ ) is given by the solution to the empirical counterpart of
(21) above
N
X

1 Xi ∈ X

M



ˆ

u=1

h
i 
M
1(β̂p (u; Xi ) ≤ β̂p (τ )) − τ du = 0.

(37)

u=0

i=1

The integral in (37) can be calculated exactly since β̂p (u; xl ) is piecewise linear for each
xl with finitely many pieces. Alternatively it may be approximated by a finite sum of the
integrand evaluated at H evenly spaced points u1 , . . . , uH between zero and one. In that case

P
M
β̂pM (τ ) has a simple order statistic representation. Let NMOVER = N
1
X
∈
X
equal
i
i=1
n
oH NMOVER
the number of movers in the sample and construct the list
β̂p (uh ; Xi )
.14 The
h=1

j

th

order statistic of this list is our estimate of
j
HNMOVER + 1

βpM (τ )

<τ ≤

j+1
HNMOVER + 1

.

Theorem 4. Under the assumptions maintained in Theorem 2 above
14

i=1

where j satisfies

√




M
M
b
N βp (·) − βp (·)

We assume, without loss of generality, that the sample is ordered such that mover realizations appear
first with indices i = 1, . . . , NMOVER .

24

converges in distribution to a mean zero Gaussian process Zβp (·), where Zβp (·) is defined by
its covariance function, Σβp (τ, τ 0 )
Σβp (τ, τ 0 ) =

Υ2 (τ, τ 0 ) + Υ3 (τ, τ 0 ) + Υ4 (τ, τ 0 )
1

 , (38)
Pr (X ∈ XM ) f Bp |X∈XM βpM (τ ) X ∈ XM f Bp |X∈XM βpM (τ 0 ) X ∈ XM

where

C FBp |X (βpM (τ )|X), FBp |X (βpM (τ 0 )|X)|X ∈ XM
,
Υ2 (τ, τ ) =
Pr (X ∈ XM )
0

Υ3 (τ, τ 0 ) = Pr X ∈ XM

−1

(39)


min FBp |X (βpM (τ )|X), FBp |X (βpM (τ 0 )|X)

−FBp |X (βpM (τ )|X)FBp |X (βpM (τ 0 )|X)

−1
−1
× e0p (X0 X) X0 Λ FBp |X (βpM (τ )|X), FBp |X (βpM (τ 0 )|X); X X (X0 X) ep

×fBp |X (βpM (τ )|X)fBp |X (βpM (τ 0 )|X) X ∈ XM ,
(40)
E



and
0

Υ4 (τ, τ ) =

e0p

ˆ ˆ



fBp |X (βpM (τ )|x)fBp |X (βpM (τ 0 )|x̃)



×K (x) Σδ FBp |X (βpM (τ )|x), FBp |X (βpM (τ 0 )|x̃) K (x̃)0



×f X|X∈XM x| x ∈ XM f X|X∈XM x̃| x̃ ∈ XM dxdx̃ ep

(41)

with ep a P × 1 vector with a 1 in its pth row and zeros elsewhere.
While the form of the covariance function Σβp (τ, τ 0 ) is complicated, each term in it has
a straightforward interpretation. The Υ2 (·) term reflects sampling variability arising from
the econometrician’s lack of knowledge of the marginal distribution of X. It would also be
zero if the distribution of Bp | X = x were constant across all x ∈ XM (i.e., no correlated
heterogeneity). This term is analogous to the first term appearing the covariance expression
for the ACQE in Theorem 3 above. The Υ3 (·) term measures estimation error associated with
a lack of knowledge of the distribution of Y given X; specifically it captures the influence
of sampling error in conditional quantiles of Yt on the sampling variability of the estimated
UQE. The Υ4 (·) term is due to the estimation of the common coefficient δ(·).

25

Irregular case (T = P )
Our estimation procedure for the regular T > P case only utilizes information on movers.
Our analysis of the irregular T = P case additionally utilizes information on stayers and near
stayers, making full use of the possibilities implied by Assumption 2. In the irregular case,
similar to Graham and Powell (2012), estimation of the common coefficient, δ (τ ), requires
the availability of stayers.
We introduce the presence of near stayers to illustrate how the population-wide ACQE and
UQE, not just their movers’ counterparts, may be consistently estimated.
Our analysis relies on “discrete bandwidth asymptotics”, we argue that our approach, in
addition to being of value on its own terms, approximates many features of an analysis with
continuously-valued covariates. To motivate this claim we begin by reproducing the results
of Graham and Powell (2012).
Discrete bandwidth framework
With T = P , the X matrix is square, with full rank if and only if det X 6= 0. Let D = det X
with D ∈ DN = {d1 , . . . , dK , −hN , hN , 0}, the support of the determinant of X. The first
K elements of DN correspond to the L1 mover support points of X. The next two elements
of DN correspond to the L−L1 near stayer support points of X. The final element of DN
corresponds to the M − L stayer support points of X.
We let Pr(D = hN ) = Pr(D = −hN ) = φ0 hN for some φ0 ≥ 0, defining dK+1,N = −hN ,
dK+2,N = hN and dK+3 = 0. The mover support points dk for k = 1, . . . , K are bounded
away from 0 for all N .
We also let the probability of observing a singular X be Pr(D = 0) = 2φ0 hN . Finally,
P
N
Pr(D = dk ) = πkN for k = 1, . . . , K with K
k=1 πk = 1 − 4φ0 hN , with 4φ0 hN < 1 for all N .
P
15
We also let πk = limN →∞ πkN , so that K
k=1 πk = 1.
In this setup, observations with D = 0 are stayers, D = ±hN are near-stayers, while those
with D = dk for k = 1, . . . , K correspond to movers. The inclusion of near-stayers is a way
to approximate a continuous distribution of D, letting near stayers (those with D = ±hN )
have characteristics very similar to those of stayers (D = 0).
Let qmN |k = Pr(X = xmN |D = dk ), qmN |−h = Pr(X = xmN |D = −hN ), qmN |h = Pr(X =
xmN |D = hN ) and qmN |0 = Pr(X = xmN |D = 0). For simplicity, we assume that qmN |· does
not vary with N , so that conditional on the value of the determinant, which has varying
15

The πk are well defined limits by Assumption 2.

26

support, the distribution of X does not depend on the sample size. We also assume that
lim qm|h = lim qm|−h = qm|0 for all m = 1, . . . , M . This is a smoothness assumption.
N →∞

N →∞
∗

Recall that X = adj (X) denote the adjoint of X such that X−1 =
We also let Y∗ = X∗ Y and W∗ = X∗ W.

1
X∗ ,when
D

X−1 exists.

Average partial effects under discrete bandwidth asymptotics
To illustrate the operation of our discrete bandwidth framework in a familiar setting we
revisit the conditional mean model studied by Graham and Powell (2012):
E[Y|X] = Wδ0 + Xβ0 (X).
For the case where Xt is continuously-valued, T = P , and other maintained assumptions,
Graham and Powell (2012) estimate δ0 and the average β0 = E[β(X)] by (cf., equations (24)
and (25) in their paper).
!−1
!
N
N
1 X ∗0 ∗
1 X ∗0 ∗
δ̂ =
W Wi 1(|Di | < hN )
W Y 1(|Di | < hN )
N hN i=1 i
N hN i=1 i i
PN
−1
1
i=1 Xi (Yi − Wi δ̂)1(|Di | ≥ hN )
N
β̂ =
PN
1
i=1 1(|Di | ≥ hN )
N

(42)
(43)

where Yi∗ = X∗i Yi .16
We now compute the asymptotic distribution of δ̂ and β̂ under discrete bandwidth asympP
p PM
∗0 ∗
∗0
∗
totics. First, the numerator of term (42) is equal to h1N M
l=L+1 wl wl ql|0 2φ0 =
l=L+1 wlN wlN p̂lN →
2E[W∗0 W∗ |D = 0]φ0 .
Let U∗i = X∗i (Yi − Wi δ0 − Xi β0 (Xi )). As in equation (46) of Graham and Powell (2012),
the numerator of δ̂ − δ0 is equal to
N
N
1 X ∗0
1 X ∗0 ∗
∗
W (Di β0 (Xi ) + Ui )1(|Di | < hN ) =
W U 1(Di = 0).
N hN i=1 i
N hN i=1 i i

This expression has mean zero since E[U∗ |X] = 0, and, letting Σ(X) denote V(U|X), we can
√
verify that its asymptotic variance when premultiplied by N hN is 2E [W∗0 X∗ Σ(X)X∗0 W∗ |D = 0] φ0
16

Note that, relative to their expressions, we have changed the definition of stayers from units with
|Di | ≤ hN to units with |Di | < hN and conversely for movers. This change has no impact when D is
continuously distributed, and is made here to allow the near-stayers in our framework to be categorized as
movers rather than stayers.

27

through a simple analysis. Therefore, we have
d

p

N hN (δ̂ − δ0 ) → N



Λ0
0,
2φ0



where Λ0 = E[W∗0 W∗ |D = 0]−1 × E [W∗0 X∗ Σ(X)X∗0 W∗ |D = 0] × E[W∗0 W∗ |D = 0]−1 .
In an analogy to Graham and Powell (2012), we see that φ0 in this setup plays the exact
same role as the density function of the determinant evaluated at 0. When a larger fraction
of the sample is concentrated near or at D = 0, we can obtain more precision in our estimate
of the common coefficient δ0 . We now decompose β̂ into an infeasible version
I

β̂ =

1
N

PN

i=1

X−1
i (Yi − Wi δ0 )1(|Di | ≥ hN )
PN
1
i=1 1(|Di | ≥ hN )
N

and a second term that contains the estimate of the common coefficient δ0 :
β̂ = β̂ I + Ξ̂N (δ̂ − δ0 )
where Ξ̂N =

1
N

−1 ∗
i=1 Di Xi Wi 1(|Di |≥h)
1 PN
i=1 1(|Di |≥h)
N

PN

. Since they are computed with different subsamples, β̂ I

and δ̂ are independent.
The denominator of Ξ̂N converges in probability to 1 since hN → 0. The numerator can be
PL1 −1
PL1 −1
decomposed in two separate terms:
l=1 xlN wlN p̂lN , which converges to
l=1 xl wl pl and
PL
−1 ∗
−1
−1
l=L1 +1 DlN wlN p̂lN which converges to a finite limit since DlN is either ±hN and p̂lN is
of order Op (hN ), and these two orders will cancel out. Therefore, as in Graham and Powell
(2012), Ξ̂N converges to well defined probability limit we denote by Ξ0 .
Finally, we see that
I

β̂ − β0 =
+

1
N

PN

i=1 (β0 (Xi ) − β0 )1(|Di | ≥ hN )
PN
1
i=1 1(|Di | ≥ hN )
N
P
PN
N
−1 ∗
−1 ∗
1
1
i=1 Di Ui 1(|Di | > hN )
i=1 Di Ui 1(|Di | = hN )
N
N
+
.
P
P
N
N
1
1
1(|D
|
≥
h
)
1(|D
|
≥
h
)
i
N
i
N
i=1
i=1
N
N

P
The denominators of all terms above, N1 N
i=1 1(|Di | ≥ h), converges to 1 since the fraction of
P
movers converges to 1. The numerator of the first term is equal to Ll=1 β0 (xlN )(p̂lN − plN ).
√
√
√
This term will be of order N since N (p̂lN − plN ) = Op (1) for l = 1, . . . , L1 and Op ( hN )
for l = L1 + 1, . . . , L by equation (61) in the appendix.
√
The numerator of the second term will be of order N since it concerns strict movers only,
which have non-shrinking probabilities and Di bounded away from 0. For these reasons, the
28

usual limit theorem can be applied to show this term exhibits a standard rate of convergence.
The numerator of the third term’s convergence is more delicate. Premultiplying this term
√
by N hN , its variance is equal to


∗

EN X Σ(X)X

∗0 h1(|D|

= hN )

D2





∗

= EN X Σ(X)X

∗0 1(|D|

= hN )



hN

= EN [X∗ Σ(X)X∗0 ||D| = hN ]

Pr(|D| = hN )
hN

→ 2E [X∗ Σ(X)X∗0 |D = 0] φ0
= 2Υ0 φ0
since Pr(|D| = hN ) = 2φ0 hN and by the continuity of the conditional distribution of X|D in
D near 0. Combining results for these terms, we get that
p
d
N hN (β̂ I − β0 ) → N (0, 2Υ0 φ0 ) ,
and using the independence of β̂ I and δ̂, we see that


p
Ξ0 Λ0 Ξ00
d
N hN (β̂ − β0 ) → 0, 2Υ0 φ0 +
,
2φ0
exactly as in Graham and Powell (2012, Theorem 2.1).
To make these results coincide, it is important to let Pr(|D| = hN ) = Pr(D = 0). We
make this assumption for the following reason: in the continuous setup, the fraction of the
sample considered as stayers is approximately 2φ0 hN , and these stayers solely determine the
asymptotic distribution of δ̂ − δ0 . For the estimation of β0 , we consider individuals with
|D| ≥ hN , but the asymptotic behavior of β̂ − β0 is solely driven by individuals with |D|
arbitrarily close to hN . This is due to the D−1 term which diverges for individuals where
|D| = hN . In both cases, the set of individuals considered converges to the infinitesimal set
of individuals with D = 0, since hN → 0 as N → ∞, therefore, in a sense, the subsamples
that generate the asymptotic variation in δ̂ − δ0 and β̂ − β0 are the same. This is why we
place the same discrete probabilities on |D| = hN and on D = 0.
Quantile effects under discrete bandwidth asymptotics
We now study the estimation of the various quantile estimands introduced in Section 2 in the
irregular T = P case. To begin, we estimate δ(τ ), proceeding in analogy to the identification

29

analysis given above, by
"

N
1 X ∗0 ∗
b
δ(τ ) =
W i W i 1(Di < hN )
N i=1

#−1

"

#
N
1 X ∗0 ∗ b
W i Xi Q Y|X ( τ | Xi ) 1(Di < hN ) . (44)
×
N i=1

b ) in hand, we estimate the conditional quantiles of the random coefficients for all
With δ(τ
mover and near stayer support points by17


β̂(τ ; xlN ) = x−1
Q̂
(
τ
|
x
)
−
w
δ̂
(τ
)
for l = 1, . . . , L.
lN
lN
Y|X
lN
To develop a formal result on the sampling properties of these two estimates we add the
following assumption.
Assumption 7. (Irregular Case) (i) E[W∗0 W∗ |D = 0] is invertible, (ii) kEN [β(τ ; X)|D =
hN ] − EN [β(τ ; X)|D = 0]k converges to 0 as N → ∞, (iii) N hN → ∞ and hN → 0 as
N → ∞.
The second part of Assumption 7 implies that we can learn about the conditional distribution of random coefficients across stayers by studying that observed across near stayers; a
smoothness condition.
Our first result for the irregular case is:
Theorem 5. Suppose that
 Assumptions 1 through 5 and 7 are satisfied, then
√
(i) N hN δb (·) − δ (·) converges in distribution to a mean zero Gaussian process Zδ (·),
where Zδ (·) is defined by its covariance function
0

Σδ (τ, τ 0 ) = E[Zδ (τ ) Zδ (τ 0 ) ]
−1
(min(τ, τ 0 ) − τ τ 0 )  ∗ 0 ∗
E W W |D = 0
×
=
2φ0

 
−1
E W∗ 0 X∗ Λ(τ, τ 0 ; X)X∗ 0 W∗ |D = 0 E W∗ 0 W∗ |D = 0
,
√

(45)




b
(ii) N hN β (·; xlN ) − β (·; xlN ) also converges in distribution for each l = 1, . . . , L1 to a
mean zero Gaussian process Z (·, xl ), where Z (·, xl ) is defined by its covariance function

0
0
0
−10
Σ(τ, xl , τ 0 , xm ) = E Z (τ, xl ) Z (τ 0 , xm ) = x−1
l wl Σδ (τ, τ )wm xm
17

(46)

Note that, in our set-up, 1(|Di | < hN ) = 1(Di = 0). We use the former representation to highlight
how our results would extend to settings with continuously-valued covariates. Since (44) conditions √
on a
subpopulation with mass shrinking to zero, estimation of δ(τ ) will not be possible at the regular rate of N .

30

for l, m = 1, 
. . . , L1 and

p
(iii) N h3N βb (·; xlN ) − β (·; xlN ) also converges in distribution for each l = L1 + 1, . . . , L
to a mean zero Gaussian process Z (·, xl ), where Z (·, xl ) is defined by its covariance function

0
Σ(τ, xl , τ 0 , xm ) = E Z (τ, xl ) Z (τ 0 , xm )
= (min (τ, τ 0 ) − τ τ 0 )

(47)

x∗l Λ (τ, τ 0 ; xl ) x∗0
l
ql|0 2φ0

· 1 (l = m)

∗0
+ wl∗ Σδ (τ, τ 0 )wm

for l, m = L1 + 1, . . . , L.
The rate of convergence for δ̂(τ ) coincide with that which would be expected when X has
a continuous distribution, as in Graham and Powell (2012). The δ(τ ) estimator relies on
the sample with D = 0, which has fraction equal to 2φ0 hN giving an effective sample size
of approximately 2N φ0 hN for estimation. As φ0 increases, more effective observations are
available for estimation, and therefore the asymptotic precision increases. The influence of
the preliminary quantile estimator appears through the Λ(τ, τ 0 ; X) matrix.
The conditional coefficient estimates, βb (τ ; xlN ), converge at different rates depending on
whether xlN has shrinking mass or not. Since these estimates depend linearly on δ̂(τ ), their
√
fastest possible rate of convergence is N hN , the rate of convergence of δ̂(τ ). This rate
is achieved for (strict) movers, whose population frequencies are bounded away from zero.
In fact, for movers, the only component of the asymptotic variance of βb (τ ; xlN ) is due to
sampling variability in δ̂(τ ), since the other ingredient to the estimator, the conditional
√
quantiles of Yt , are estimated at rate N .
For units whose covariate sequences have shrinking mass, that is, for near-stayers, the rate
p
of convergence of βb (τ ; xlN ) is N h3N . For near stayers, X−1 = X∗ D−1 , which diverges since
D = hN → 0 as N → ∞. To account for, and cancel, this shrinking denominator term, the
extra hN term is present. Note that we do not require that N h3N → ∞ as N → ∞, and
in fact these conditional betas will not be consistently estimated if N h3N → 0. This is not
a problem, since their consistent estimation is not the goal. Rather, we will show that the
ACQE and UQE estimators can incorporate these inconsistent estimates and still deliver a
consistent and asymptotically normal estimator for these functionals.
We now turn to the estimation of the average conditional quantile effect (ACQE). The
ACQE is consistently estimable under our discrete bandwidth setup because the mass of
stayers shrinks to zero as N → ∞. Specifically, the ACQE is identified by the limit β̄(τ ) =


M
limN →∞ EN β(τ ; X)|X ∈ XM
N since β(τ ; X) is identified on XN and the probability mass of
31

stayers vanishes as N goes to infinity. Our estimate of the ACQE in the T = P case is

b̄ (τ ) =
β
N

1
N



−1 b
b
X
Q
(
τ
|
X
)
−
W
δ(τ
)
1(Xi ∈ XM
i
i
Y|X
N)
i
i=1
.
PN
1
M
i=1 1(Xi ∈ XN )
N

PN

Theorem 6. Under Assumptions 1 through 5, Assumption 7, and N h3N → 0, we have that:


p
d
b̄
N hN β N (τ ) − β̄N (τ ) → Zβ̄ (τ ),
a zero mean Gaussian process, on τ ∈ (0, 1). The variance of the Gaussian process Zβ̄ (·) is
defined as


E Zβ̄ (τ )Zβ̄ (τ 0 )0 = Υ1 (τ, τ 0 ) + Ξ0 Σδ (τ, τ 0 )Ξ00

(48)

with
Υ1 (τ, τ 0 ) = 2φ0 (min (τ, τ 0 ) − τ τ 0 ) E [X∗ Λ(τ, τ 0 , X)X∗0 |D = 0]


Ξ0 = lim EN X−1 W||D| ≥ hN .
N →∞

b̄ (τ ) is √N h , as is the case for the average effect studied by
The rate of convergence of β
N
N
Graham and Powell (2012). The asymptotic variance depends only on terms with D = 0,
since only stayers and near stayers contribute to the asymptotic distribution of the estimator.
If φ0 increases, it is possible to estimate the term Ξ0 Σδ (τ, τ 0 )Ξ00 with more precision since
δ̂(τ ) is more precisely determined when there are many units with D = 0. On the other
hand, term Υ1 (τ, τ 0 ) increases with φ0 . The intuition behind this increase is that there are
b̄ (τ ) are estimated at a
more near-stayers when φ0 is large, and their contributions to β
N
slower rate than those of movers.
Finally we turn to the unconditional quantile effect, βp (τ ), the τ th quantile of Bp . As in the
regular case our estimate is the solution to (37). The only difference between the regular
and irregular case is the method used to estimate the conditional quantile effects βp (τ, x).
Theorem 7. Fix p ∈ {1, . . . , P }. Under the assumptions maintained in Theorem 6 we have
that


p
d
b
N hN βp (τ ) − βp (τ ) → Zβp (τ )
on τ ∈ (0, 1) with Zβp (·) being a zero mean Gaussian process. The covariance of this Gaussian

32

process is equal to:


Υ3 (τ, τ 0 ) + Υ4 (τ, τ 0 )
E Zβp (τ )Zβp (τ 0 )0 =
fBp (βp (τ ))fBp (βp (τ 0 ))
where

Υ3 (τ, τ 0 ) = 2φ0 E e0p X−1 Λ(FBp |X (βp (τ )|X), FBp |X (βp (τ 0 )|X), X)X−10 ep
× (min(FBp |X (βp (τ )|X), FBp |X (βp (τ 0 )|X)) − FBp |X (βp (τ )|X)FBp |X (βp (τ 0 )|X))

×fBp |X (βp (τ )|X)fBp |X (βp (τ 0 )|X)|D = 0
0

Υ4 (τ, τ ) =

L X
L
X

e0p (x−1
l wl pl 1(l ≤ L1 )

l=1 l0 =1

+ wl∗ ql|0 2φ0 1(l > L1 ))Σδ (FBp |X (βp (τ )|xl ), FBp |X (βp (τ 0 )|Xl0 ))
0
∗
0
0
0
× (x−1
l0 wl0 pl0 1(l ≤ L1 ) + wl0 ql0 |0 2φ0 1(l > L1 )) ep fBp |X (βp (τ )|xl )fBp |X (βp (τ )|xl0 ).

The asymptotic distribution of the UQE depends on the conditional density of Bp |X evaluated at βp (τ ). The term Υ3 (·) reflects the estimation error for the near-stayers’ conditional
quantile effects. The overall rate of convergence is (N hN )−1/2 . Although the conditional
quantile effects of near stayers converge at rate (N h3N )−1/2 , they enter the UQE with a
weight which is of order O(hN ), leading to the (N hN )−1/2 rate. The Υ4 (·) term reflects
the influence of estimation error in δ̂(τ ). Both these terms are divided by the density of
Bp evaluated at βp (τ ), meaning that a larger density of the random coefficient around the
estimated quantile will lead to a smaller asymptotic variance. How the constant φ0 enters
these equation tells us that a smaller density of stayers and near-stayers will lead to smaller
asymptotic contribution of term Υ3 (·) since there are less stayers excluded from the UQE
estimator. On the other hand, a lower φ0 can increase Υ4 (·) since it reduces the precision of
the estimator of δ(τ ), due to a lower relative sample size.

4

Union wage premium

The effect of collective bargaining coverage on the distribution of earnings is a question of
longstanding interest to labor economists (e.g., Card, Lemieux and Riddell, 2004). This is
also an area where both panel data and quantile regression methods have played important
roles in empirical work (e.g., Chamberlain, 1982; Jakubson, 1991; Card, 1995; Chamberlain,
1994), making an analysis which combines both approaches of particular interest.
We begin with a target sample consisting of the 4,837 male NLSY79 respondents in the cross33

Table 1: Summary statistics
Full
Stayers
Movers
Sample
Never
Always
Entire Sample (N=2,444)
·
0.6579
0.1100
0.2322
Black (N=2,444)
0.1168
0.0864
0.1510
0.1868
Hispanic (N=2,444)
0.0602
0.0568
0.0616
0.0692
12.99
13.24
12.59
12.50
Years of Schooling (N=2,437)
(2.17)
(2.31)
(1.50)
(1.92)
52.00
56.57
47.72
40.87
AFQT percentile (N=2,351)
(29.88)
(29.91)
(25.86)
(28.34)
19.48
19.79
22.47
17.15
1988 Hourly Wage (N=2,444)
(25.29)
(30.40)
(7.06)
(10.15)
Source: National Longitudinal Survey of Youth 1979 and authors’ calculations.
Notes: Analysis based of the balanced panel of NLSY79 2,444 male respondents (in 2,104
households) described in the main text. AFQT corresponds to Armed Force Qualification
Test. Stayers consist of workers who are never covered by a collective bargaining agreement
as well as those who are always covered. Movers consist of individuals who move in and/or
out of coverage during the sample period. The first row calculates the fraction of individuals
corresponding to each of the three subgroups. Sample sizes are smaller for some covariates
due to item non-response.
sectional and supplemental Black and Hispanic subsamples. Our frame excludes respondents
in the supplementary samples of poor whites and military personnel (cf., MaCurdy, Mroz
and Gritz, 1998). We constructed a balanced panel of respondents who were (i) engaged
in paid private sector or government employment in each of the years 1988 to 1992 and (ii)
had complete wage and union coverage information. Exclusion from the estimation sample
occurred for several reasons. We excluded all self-employed individuals, individuals with
stated hourly wages less than $1, or greater than $1,000, in 2010 prices, and individuals who
were not surveyed in all five calendar years. We use the hourly wage measure associated with
each respondent’s “CPS” job. Our measure of collective bargaining coverage is also defined
vis-a-vis the CPS job.18 Respondents were between the ages of 24 and 33 in 1988 and hence
past the normal school-leaving age.
Our estimation sample is similar to that used by Chernozhukov, Fernández-Val, Hahn and
Newey (2013), who also study the union wage premia using the NLSY79. Our subsample
includes slightly more individuals, primarily by virtue of the fact that we follow respondents
for five instead of eight years, reducing attrition.
Table 1 reports a selection of worker attributes known to be predictive of wages by collec18

The “CPS” job coincides with a respondents primary employment as determined by the same criteria
used in the Current Population Survey (CPS).

34

tive bargaining coverage status. Column 1 reports the mean of these characteristics across
all individuals in our sample (standard deviations are in parentheses for non-binary-valued
variables). Column 2 reports the corresponding statistics for workers who are never covered
by a collective bargaining agreement during the sample period, column 3 for those who are
always covered, and column 4 for those who move in and/or out of coverage during the sample period. Movers are more likely to be minority and have lower years of completed school,
AFQT scores and hourly wages. Workers who are never covered, have the lowest minority
share, the greatest years of completed schooling, and highest AFQT scores.
Table 2 reports out main results. All specifications allow for shifts in the intercept over time,
but maintain homogeneity of slope coefficients across time. Column 1 reports the coefficient
on the union dummy in a simple pooled least squares fit of log wages onto the union dummy
and a vector of year dummies. Column 2 reports the union coefficient in a specification
that additionally adds a vector of covariates for race, education and AFQT (see the notes
to Table 2 for details). Column 3 reports the union wage premium in a specification which
includes worker-specific intercepts. The estimator is as described by Arellano and Bover
(1995), which is a GMM variant of Chamberlain’s (1984) minimum distance estimator for
linear panel data models. Column 4 reports an estimate of the movers’ average union wage
premium using the variant of Chamberlain’s (1992) correlated random coefficients estimator
described in Graham and Powell (2012, Section 3.3). The movers average union effect is
between one-half and two-thirds of the OLS estimates of Columns 1 and 2. It is also very
close to the Column 3 effect which allows for intercept heterogeneity in the earnings function,
but assumes a homogenous union effect.
A researcher studying Columns 1 through 4 might conclude that, while the incorporation
of correlated intercept heterogeneity into earnings functions is important, allowing for slope
heterogeneity is less so. We report movers’ unconditional quantile partial effects of collective
bargaining coverage for τ = 0.25, 0.5, 0.75 in Column 5. Here we find evidence of substantial
heterogeneity in the effect of collective bargaining coverage on wages. For over 25 percent of
workers, the effect of coverage is estimated to be less than 5 percent, whereas it is in excess
of 15 percent for a similar proportion of workers. Our movers’ UQE are relatively precisely
determined, with estimated standard errors only modestly larger than the Column 3 model
which assumes a homogenous effect.
Figure 1 plots our estimated movers’ unconditional quantile effects as well as 95 percent
point-wise confidence bands. The figure also includes quantile effects associated with a
model which does not incorporate correlated heteroegeneity. These effects are estimated
by a linear quantile regression of wages onto a constant, the union dummy and four time
dummies. The coefficients on the union dummy, rearranged to be monotonic, are plotted as
35

Table 2: Union wage premium
(1)
(2)
(3)
(4)
(5)
Pooled
Pooled
GMM
CRC
CRC
OLS
OLS
Ch/AB
Avg.
τ = 0.25
τ = 0.5
τ = 0.75
0.1566
0.2225
0.0982
0.0936
0.0460
0.0891
0.1778
Union
(0.0186)
(0.0180)
(0.0134)
(0.0169)
(0.0141)
(0.0135)
(0.0186)
Covariates?
No
Yes
No
No
No
22.31(19)
J(df )
(0.2691)
Source: National Longitudinal Survey of Youth 1979 and authors’ calculations.
Notes: All specifications include four time dummies capturing intercept shifts across periods. Column 2 additionally conditions on respondent’s race (Black, Hispanic or non-Black,
non-Hispanic), years of completed schooling at age 24, and AFQT percentile. Due to item
non-response, this specification uses 2,348 respondents (in 2,023 households). Column 3
reports the union coefficient from a two-step GMM “fixed effects” specification where each
respondent’s individual-specific intercept is projected onto their entire union history and
this history (plus a constant) are used as instruments for each time period. This generates
T (T + 1) = 30 moment restrictions for 2T +1 = 11 parameters (and hence T (T − 1)−1 = 19
over-identifying restrictions). See Arellano and Bover (1995) for estimation details. The
Sargan-Hansen test statistic (and its p-value) for this specification is reported in the last
row of the table. Columns 4 and 5 report correlated random coefficients specifications.
Column 4 reports the movers’ average union wage premium using Chamberlain’s (1992)
estimator following the specific implementation described in Graham and Powell (2012).
Column 5 reports the movers unconditional quantile effect (UQE) using the estimator introduced here for τ = 0.25, 0.5, 0.75. Standard errors reported in parentheses. For Columns
1 - 3 standard errors were analytically computed. For Columns 4 and 5 they were computed using the Bayesian Bootstrap. To be specific let β̂ be the parameter estimate and
(b)
(b)
th
(b)
β̂
 its b bootstrap value. Let TN  = β̂ − β̂. A 1 − α bootstrap confidence interval is
−1
β̂ − F −1
(e.g., Hansen, 2014). The length of this interval di(b) (1 − α/2) , β̂ − F (b) (α/2)
TN

TN

vided by 2Φ (1 − α/2) is the reported standard error estimate. Reported Column 4 and 5
point estimates were also biased corrected using the bootstrap.

36

Figure 1:

−.2

0

.2

.4

Quantile Partial Effect of Union Coverage

.1

.2

.3

.4

.5
Quantile

.6

.7

.8

.9

UQE
95% CI
w/o heterogeneity

Source: National Longitudinal Survey of Youth 1979 and authors’ calculations.
Notes: Blue line corresponds to the movers’ unconditional quantile effect for τ ∈ (0.1, 0.9).
Dashed grey lines are 95 percent point wise confidence intervals based on the Bayesian
Bootstrap as described in the notes to Table 2 above. The dashed red line corresponds
to the UQE associated with a simple pooled linear quantile regression of log wages onto a
constant, the union dummy and four time dummies.

37

the dashed red line. As is the case for mean effects, quantile partial effects of union coverage
are severely overstated in models which do not allow unobserved worker attributes to covary
with union status.
Our empirical analysis also allows for assessment of the impact of collective bargaining
coverage on inequality, at least within the subpopulation of movers. The counterfactual
1992 average 90-10 log wage gap in a world with no collective bargaining coverage is given
by
"
!0
#
1
E
([β (0.9; X) + δ92 (0.9)] − [β (0.1; X) + δ92 (0.9)]) X ∈ XM .
0
The corresponding gap in a world of universal coverage is given by
"
E

1
1

!0

#
([β (0.9; X) + δ92 (0.9)] − [β (0.1; X) + δ92 (0.9)]) X ∈ XM .

We estimate an average 90-10 gap in the no coverage counterfactual of 1.28. The corresponding gap in the universal coverage case is 1.07. The difference is 0.22 with a standard
error of 0.08. Our analysis implies that unions have a substantially compressing effect on
the distribution of wages, at least within the movers subpopulation.

5

Extensions

We briefly discuss a few extensions to our work. A longer discussion of each of these points
can be found in the supplemental appendix.
Using stayers to estimate time effects when T > P
When identification is regular, as outlined above, δ (τ ) is estimable using mover units alone.
However, it may nevertheless be advantageous to incorporate stayer units into the estimation
procedure. This can improve the precision of δ̂ (τ ). It can also increase the precision with
which the movers’ ACQE and UQE are estimated, through the influence of sampling error
in δ̂ (τ ) on the asymptotic variance of both of these objects (see Theorems 3 and 4 above).
A description of the implementation procedure is described in the supplemental appendix.
Non-shrinking mass of stayers in the irregular case
In some applications, it is common to observe a positive mass of stayers at D = 0 along with
a small number of near-stayers. We can model this in our discrete bandwidth framework by
38

letting Pr(D = 0) = π0 + 2φ0 hN where π0 > 0 and keeping Pr(D = hN ) = Pr(D = −hN ) =
φ0 hN . We show how this mass of stayers requires us to modify the estimators for the ACQE
p
and UQE and induces a slower rate of convergence of N h3N .
Continuous regressors and bandwidth selection
While not developed in this paper, the application of these models to continuously distributed
X is an interesting research question. In the irregular case (T = P ) we argue that the discrete bandwidth asymptotics represent a good approximation to the asymptotics when X is
continuous. The main difficulty in extending our work to continuous X is the nonparametric
estimation of the first-stage conditional quantiles, uniformly over τ and X. Although not
shown in this paper, prior preliminary work using the calorie and expenditure data from
Graham and Powell (2012) showed that results for the continuous case were similar to results where the continuous variable was discretized.19 We discuss the potential application
of existing nonparametric conditional quantile estimators (Qu and Yoon, 2015, Yu and Jones
1998, and Lee, 2013) to our framework in the supplemental appendix, and further develop
the relationship between this case and the discrete bandwidth case covered earlier. We also
establish a MSE-minimizing bandwidth selection rule for the tuning parameter hN .
Trimming extremal quantiles
Estimation of quantiles can become problematic when the quantile considered is close to 0
or 1. As an example, the estimation of unconditional quantiles of a scalar random variable
does not converge in process over τ ∈ (0, 1) when the support of the random variable is
unbounded: see for example Lemma 21.4 in van der Vaart (2000). On the other hand, it
does converge when considering τ ∈ [, 1 − ] for any 0 <  < 1/2. Whether the support is
bounded or not, trimming extremal quantiles is common practice since estimators for them
may be poorly approximated by the same asymptotic distribution as non-extremal quantiles.
This could lead to a problem for the identification of β(τ ) since it requires the use of β(τ ; X)
for all τ ∈ (0, 1). Trimming any fixed amount of quantiles will result in a loss of point
identification, but we show in the supplemental appendix that partial identification of the
UQE can be shown with tractable bounds which depend on the trimming parameter .
19

A locally linear quantile regression estimator was used in the non-parametric first stage.

39

6

Conclusion

The extension of quantile regression methods to panel data has proved to be especially
challenging. Our approach to this challenge generalizes both the textbook linear quantile
regression and linear panel data models. Relative to these benchmarks our set-up allows for
richer types of correlated (unobserved) heterogeneity, while still offering positive identification results. While the technical analysis of our estimators is non-trivial, their computation
is not, requiring only sorting and weighted least squares operations. Our empirical analysis
illustrates some of the possibilities of our approach.
One area of application where our methods may be especially attractive to researchers is for
program and policy evaluation. As a concrete example consider a researcher who wishes to
study the effect of minimum wage laws on the distribution of earnings using several waves of
the Current Population Survey (CPS). Here X would encode the minimum wage level over
time within a state. Since we observe many workers per state in each period, and hence
per realization of X, our discrete covariate results apply. Specifically F Yt |X ( y| x) may be
estimated by the empirical distribution function of period t wages in states with minimum
wage sequence X = x. Applications in educational policy, where the entire distribution of
test scores may be of interest, are also natural.

References
[1] Abrevaya, Jason. (2001). “The effects of demographics and maternal behavior on the distribution of
birth outcomes,” Empirical Economics 26 (1): 247 - 257.
[2] Abrevaya, Jason and Christian M. Dahl. (2008). “The effects of birth inputs on birthweight,” Journal
of Business & Economic Statistics 26 (4): 379 - 397.
[3] Angrist, Joshua, Victor Chernozhukov, and Iván Fernández-Val. (2006). “Quantile regression under
misspecification, with an application to the U.S. wage structure,” Econometrica 74 (2): 539 - 563.
[4] Arellano, Manuel and Stéphane Bonhomme. (2011). “Nonlinear panel data analysis,” Annual Review of
Economics 3: 395 - 424.
[5] Arellano, Manuel and Stéphane Bonhomme. (2012). “Identifying distributional characteristics in random
coefficients panel data models,” Review of Economic Studies 79 (3): 987 - 1020.
[6] Arellano, Manuel and Stéphane Bonhomme. (2016). “Nonlinear panel data estimation via quantile
regressions,” Econometrics Journal, forthcoming.
[7] Arellano, Manuel and Olympia Bover. (1995). “Another look at the instrumental variable estimation of
error-components models,” Journal of Econometrics 68 (1): 29 - 51.
[8] Athey, Susan and Guido W. Imbens. (2006). “Identification and inference in nonlinear difference-indifferences models,” Econometrica 74 (2): 431 - 497.

40

[9] Autor David H., Lawrence F. Katz and Melissa S. Kearney. (2008). “Trends in U.S. wage inequality:
revising the revisionists,” Review of Economics and Statistics 90 (2): 300 - 323.
[10] Buchinsky, Moshe. (1994). “Changes in the U.S. wage structure 1963-1987: application of quantile
regression,” Econometrica 62 (2): 405 - 458.
[11] Cai, Zongwu, and Zhijie Xiao. (2012) "Semiparametric quantile regression estimation in dynamic models
with partially varying coefficients," Journal of Econometrics 167 (2): 413-425.
[12] Card, David. (1995). “The effects of unions on the structure of wages: a longitudinal analysis,” Econometrica 64 (4): 957 - 979.
[13] Card, David, Thomas Lemieux and W. Craig Riddell. (2004). “Unions and wage inequality,” Journal of
Labor Research 25 (4): 519 - 559.
[14] Chamberlain, Gary. (1982). “Multivariate regression models for panel data,” Journal of Econometrics
18 (1): 5 - 46.
[15] Chamberlain, Gary. (1984). “Panel data,” Handbook of Economics 2: 1247 - 1318 (Z. Griliches & M.
Intriligator, Eds.). Amsterdam: North-Holland.
[16] Chamberlain, Gary. (1987). “Asymptotic efficiency in estimation with conditional moment restrictions,”
Journal of Econometrics 34 (3): 305 - 334.
[17] Chamberlain, Gary. (1992). “Efficiency bounds for semiparametric regression,” Econometrica 60 (3):
567 - 596.
[18] Chamberlain, Gary. (1994). “Quantile regression, censoring, and the structure of wages,” Advances in
Econometrics: Sixth World Congress 2: 171 - 209.
[19] Chaudhuri, Probal, Kjell Doksum and Alexander Samarov. (1997). “On average derivative quantile
regression,” Annals of Statistics 25 (2): 715 - 744.
[20] Chernozhukov, Victor, Iván Fernández-Val and Blaise Melly. (2013). “Inference on Counterfactual Distributions,” Econometrica 81 (6): 2205 - 2268.
[21] Chernozhukov, Victor, Iván Fernández-Val, Jinyong Hahn and Whitney Newey. (2013). “Average and
quantile effects in nonseparable panel models,” Econometrica 81 (2): 535 - 580.
[22] Chernozhukov, Victor, Iván Fernández-Val, Stefan Hoderlein, Hajo Holzmann and Whitney K. Newey.
(2015). “Nonparametric identification in panels using quantiles,” Journal of Econometrics 188 (2): 378
- 392.
[23] Chernozhukov, Victor and Christian Hansen. (2007). “Instrumental variable quantile regression: a robust
inference approach,” Journal of Econometrics 142 (1): 379 - 398.
[24] Clotilde, Elyès and Jouini Napp. (2004). “Conditional comonotonicity,” Decisions in Economics and
Finance 27 (2): 153 - 166.
[25] Firpo, Sergio. (2007). “Efficient semiparametric estimation of quantile treatment effects,” Econometrica
75 (1): 259 – 276.
[26] Firpo, Sergio, Nicole M. Fortin and Thomas Lemieux. (2009). “Unconditional quantile regressions,”
Econometrica 77 (3): 953 – 973.

41

[27] Graham, Bryan S. and James L. Powell. (2012). "Identification and estimation of average partial effects
in ‘irregular’ correlated random coefficient panel data models," Econometrica 80 (5): 2105 - 2152.
[28] Graham, Bryan S., Jinyong Hahn, Alexandre Poirier and James L. Powell. (2016). “Supplemental appendix to A quantile correlated random coefficients panel data model,” Mimeo.
[29] Hahn, Jingyong and Whitney K. Newey. (2004). “Jackknife and analytical bias reduction for nonlinear
panel models,” Econometrica 72 (4): 1295 – 1319.
[30] Hansen, Bruce E. (2014). Econometrics. http : //www.ssc.wisc.edu/ bhansen/econometrics/Econometrics.pdf.
[31] Harding, Matthew and Carlos Lamarche. (2014). “Estimating and testing a quantile regression model
with interactive effects,” Journal of Econometrics 178: 101 - 113.
[32] Honda, Toshio. (2004). "Quantile regression in varying coefficient models," Journal of statistical planning and inference 121 (1): 113-125.
[33] Imbens, Guido. W. and Whitney K. Newey. (2009). “Identification and estimation of triangular simultaneous equations models without additivity,” Econometrica 77 (5): 1481 – 1512.
[34] Jakubson, George. (1991). “Estimation and testing of the union wage effect using panel data,” Review
of Economic Studies 58 (5): 971 - 991.
[35] Kato, Kengo, Antonio F. Galvao Jr., Gabriel V. Montes-Rojas. (2012). “Asymptotics for panel quantile
regression models with individual effects,” Journal of Econometrics 170 (1): 76 - 91.
[36] Khan, Shakeeb and Elie Tamer. (2010). “Irregular identification, support conditions, and inverse weight
estimation,” Econometrica 78 (6): 2021 – 2042.
[37] Kim, Mi-Ok. (2007). "Quantile regression with varying coefficients," The Annals of Statistics 35 (1):
92-108.
[38] Kline, Patrick and Andres Santos. (2013). “Sensitivity to missing data assumptions: Theory and an
evaluation of the U.S. wage structure,” Quantitative Economics 4 (2): 231 – 267.
[39] Koenker, Roger. (2004). “Quantile regression for longitudinal data,” Journal of Multivariate Analysis
91 (1): 74 - 89.
[40] Koenker, Roger. (2005). Quantile Regression. Cambridge: Cambridge University Press.
[41] Koenker, Roger and Gilbert Bassett, Jr. (1978). “Regression quantiles,” Econometrica 46 (1): 33 - 50.
[42] Lee, Sokbae (2003). “Efficient semiparametric estimation of a partially linear quantile regression model,”
Econometric Theory, 19 (1): 1-31.
[43] Lee, Ying-Ying. (2013). “Nonparametric weighted average quantile derivative,” Mimeo, Nuffield College,
Oxford University.
[44] Lemieux, Thomas. (2006). “Postsecondary education and increasing wage inequality,” American Economic Review 96 (2): 195 - 199.
[45] Ma, Lingjie and Roger Koenker. (2006). “Quantile regression methods for recursive structural equation
models,” Journal of Econometrics 134 (2): 471 - 506.
[46] MaCurdy, Thomas, Thomas Mroz and R. Mark Gritz. (1998). “An evaluation of the National Longitudinal Survey on Youth,” Journal of Human Resources 33 (2): 345 - 436.

42

[47] Machado, Jose. A. F. and Jose Mata. (2005). “Counterfactual decomposition of changes in wage distributions using quantile regression,” Journal of Applied Econometrics 20 (4): 445 – 465.
[48] Manski, Charles F. (1987). “Semiparametric analysis of random effects linear models from binary panel
data,” Econometrica 55 (2): 357 - 362.
[49] Qu, Zhongjun and Jungmo Yoon. (2015) “Nonparametric estimation and inference on conditional quantile processes,” Journal of Econometrics 185 (1): 1 - 19.
[50] Rosen, Adam. (2012). “Set identification via quantile restrictions in short panels,” Journal of Econometrics 166 (1):127 - 137.
[51] van der Vaart, Aad W. Asymptotic Statistics. Cambridge University Press, 2000.
[52] Vella, Francis and Marno Verbeek. (1998). “Whose wages do unions raise? A dynamic model of unionism
and wage rate determination for young men?” Journal of Applied Econometrics 13 (2): 163 - 183.
[53] Wang, Huixia Judy, Zhongyi Zhu, and Jianhui Zhou. (2009) "Quantile regression in partially linear
varying coefficient models," The Annals of Statistics 37 (6B): 3841-3866.
[54] Wei, Ying and Raymond J. Carroll. (2009). “Quantile regression with measurement error,” Journal of
the American Statistical Association 104 (487): 1129 - 1143.
[55] Yu, Keming amd Jones, M. C. (1998). “Local linear quantile regression.” Journal of the American
statistical Association 93 (441): 228-237.

Proof of Lemmas and Theorems
Proof of Lemma 1
First consider the asymptotic distribution of the conditional CDF estimate
FbYt |X (c|xmN ) =

1
N

PN

i=1 1(Yit ≤ c, Xi = xmN )
.
PN
1
i=1 1(Xi = xmN )
N



√ 1
1(X
=
x
)
−
p
=
O
and
i
mN
mN
p
N pmN

i=1
. Using the delta method we get
c, X = xmN ) = Op √N1p
We have that

1
N

PN

1
N

PN

i=1

(49)

1(Yit ≤ c, Xi = xmN ) − Pr(Yit ≤

mN


N 
1 X 1(Yit ≤ c, Xi = xmN ) PrN (Yt ≤ c|X = xmN )
FbYt |X (c|xmN ) − FYt |X (c|xmN ) =
−
1(Xi = xmN )
N i=1
pmN
pmN
(50)

+ Op

1
N pmN


.

By Lyapunov’s Central
Limit Theorem, and Assumptions
2 to 5, we have that, for fixed c, the normalized


√
difference N pmN FbYt |X (c|xmN ) − FYt |X (c|xmN ) is asymptotically normal with limiting variance equal
to
lim Pr(Yt ≤ c|X = xmN )(1 − Pr(Yt ≤ c|X = xmN )) = Pr(Yt ≤ c|X = xm )(1 − Pr(Yt ≤ c|X = xm )).

N →∞

43

Note that continuity of the conditional CDF of Yit given X, a component of Assumption 4, is important for
this result.
The next step is to show that the convergence of the normalized difference is uniform in c ∈ R and that
=xmN )
mN )
√ i
√
− Pr(Yt ≤c|X=x
1(Xi = xmN )
the limiting process is Gaussian. The normalized summand 1(Yit ≤c,X
pmN
pmN
can be shown to have a finite bracketing integral for any N (since indicator functions have finite bracketing
integrals) and Pr(Yt ≤ c|X = xmN ) has bounded derivatives in c since the conditional density of Yt given X
mN )
and notice
is uniformly bounded in all arguments by Assumption 4. Consider the function GN = 1(X√ip=x
mN
it is an envelope function for
1(Yit ≤ c, Xi = xmN ) Pr(Yt ≤ c|X = xmN )
−
1(Xi = xmN ).
√
√
pmN
pmN

(51)

√
This envelope function has the following properties: E[G2N ] = 1 and for ε > 0, E[G2N 1(GN > ε N )] → 0 as
√
the conditions
long as N pmN → ∞, which is assumed (Assumption 2).
 Therefore, this estimator satisfies

√
of Theorem 19.28 in van der Vaart (2000) and N pmN FbYt |X (c|xmN ) − FYt |X (c|xmN ) is P-Donsker and
therefore converges in process over c ∈ R for any t = 1, . . . , T and any m = 1, . . . , M .
Next we use the fact that Yt is bounded, its positive density, and Corollary 21.5 in van der Vaart (2000) (or
Lemma 12.8 (ii) in Kosorok (2007)) to show that the inverse of the conditional CDF process, i.e. the conditional quantile process, converges over τ ∈ (0, 1) to a mean zero Gaussian process with the asymptotically
linear representation:
p

b Y |X ( τ | xmN ) − QY |X ( τ | xmN ))
N pmN (Q
t
t




N
X
1(Yit ≤ QYt |X ( τ | xmN )) − τ 1(Xi = xmN )
−1
1
=√
+ Op √
.
fYt |X (QYt |X ( τ | xmN )|xmN )
N pmN i=1
N pmN
Since both t and m have finite range, the convergence of this process is uniform over all values of t and
m (as well as on τ ∈ (0, 1)). Using the continuity of fYt |X (QYt |X ( τ | xmN )|xmN ) and the boundedness of
indicator functions, we apply Lyapunov’s Central Limit Theorem to show that the covariance kernel of the
√
b Y |X ( τ | xmN ) − QY |X ( τ | xmN )) is equal to ΣQ (τ, xl , τ 0 , xm ) = (min(τ, τ 0 ) −
limiting process of N pmN (Q
t
t
τ τ 0 )Λ(τ, τ 0 ; xl )1(l = m) as claimed.

Proof of Theorem 1
By the Law of Total Probability
τ = Pr(Bp ≤ βp (τ )) = Pr(Bp ≤ βp (τ )|X ∈ XM ) Pr(X ∈ XM ) + Pr(Bp ≤ βp (τ )|X ∈ XS ) Pr(X ∈ XS ).
The quantities Pr(X ∈ XM ), Pr(X ∈ XS ) and the conditional distribution of Bp given X ∈ XM are identified
by arguments detailed above. The quantity Pr(Bp ≤ βp (τ )|X ∈ XS ) can take arbitrary values in the [0, 1]
interval. Therefore, the identified set of βp (τ ) is defined by:


bp (τ ) : Pr(Bp ≤ bp (τ )|X ∈ XM ) Pr(X ∈ XM ) + q Pr(X ∈ XS ) = τ, q ∈ [0, 1] .

44

Since Pr(Bp ≤ bp (τ )|X ∈ XM ) is monotone in bp (τ ), we can get bounds on βp (τ ) by inverting this region at
q = 0 and q = 1:

τ − 1 × Pr(X ∈ XS ) τ − 0 × Pr(X ∈ XS )
Pr(Bp ≤ βp (τ )|X ∈ X ) ∈
,
Pr(X ∈ XM )
Pr(X ∈ XM )





S
τ − Pr(X ∈ X )
τ
M
M
⇒ βp (τ ) ∈ βp
, βp
.
Pr(X ∈ XM )
Pr(X ∈ XM )


M

S

−Pr(X∈X )
τ
M
< 0 or if, Pr(X∈X
are not defined.
Finally observe that if τ Pr(X∈X
M)
M ) > 1, the quantiles of Bp |X ∈ X
For these cases, the inversion leads to bounds of bp and b̄p respectively.

Proof of Theorem 2
Recall that γ(τ ) = (δ(τ )0 , β(τ ; x1 )0 , . . . , β(τ ; xL )0 )0 , manipulating (32) of the main text yields
√
√
b ) − Π(τ )).
b −1 G0 A
b N (Π(τ
N (γ̂(τ ) − γ(τ )) = (G0 AG)

(52)

p
b→
By a Law of Large Numbers, A
A = diag{p1 , . . . , pL } ⊗ IT and by the Continuous Mapping Theorem
p
b −1 →
(G0 AG)−1 which can be shown to be equal to
(G0 AG)


(G0 AG)−1 = 

Γ−1
Pr(X∈XM )
Γ−1
−K Pr(X∈X
M)

0
−Γ−1
M)K
Pr(X∈X
n 0 −1
o
0
−1
(x x )
(x1 x1 )
, . . . , L pLL
diag
p1


−1

0
Γ
+ K Pr(X∈X
M)K



(53)

where K = (K(x1 )0 , . . . , K(xL )0 )0 .
√
b − Π(·)), converges in distribution, by Slutsky’s theorem, to G0 AZ̃Q (·) where
b N (Π(·)
The numerator, G0 A

0
0
ZQ (·,x1 )
ZQ (·,xL ) 0
√
√
Z̃Q (·) =
,
.
.
.
,
with ZQ (·, xl ) as defined in the statement of Lemma 1. The variancep1
pL
covariance matrix of Z̃Q (·) is
0

0

0



Σ̃Q (τ, τ ) = (min(τ, τ ) − τ τ )diag
This gives an asymptotic covariance of

Λ(τ, τ 0 ; x1 )
Λ(τ, τ 0 ; xL )
,...,
p1
pL


.

(54)

√
√
N (γ̂(τ ) − γ(τ )) and N (γ̂(τ 0 ) − γ(τ 0 )) equal to

(G0 AG)−1 G0 AΣ̃Q (τ, τ 0 )AG(G0 AG)−1 .
Partitioning this matrix yields an asymptotic covariance of

Σδ (τ, τ 0 ) = (min (τ, τ 0 ) − τ τ 0 )

(55)

√
√
N (δ̂(τ ) − δ(τ )) and N (δ̂(τ 0 ) − δ(τ 0 )) equal

h 0
i
Γ−1 E W Λ (τ, τ 0 ; X) W X ∈ XM Γ−1
Pr(X ∈ XM )

,

(56)

as claimed in the statement of the theorem.
√
√
The asymptotic covariance of N (β̂(τ, xl ) − β(τ, xl )) and N (β̂(τ 0 , xm ) − β(τ 0 , xm )) is
i
h
0
E Z (τ, xl ) Z (τ 0 , xm )
=

−1

(min (τ, τ 0 ) − τ τ 0 )

(x0l xl )

0

+K (xl ) Σδ (τ, τ 0 )K (xm ) ,

45

x0l Λ (τ, τ 0 ; xl ) xl (x0l xl )
pl

−1

· 1 (l = m)

as claimed.

Proof of Theorem 3
Manipulating (35) of the main text yields
b̄ M (τ ) − β̄ M (τ ) =
β
+

1
N

PN

M
i=1 (β̂(τ ; Xi ) − β(τ ; Xi ))1(Xi ∈ X )
P
N
1
M
i=1 1(Xi ∈ X )
N
P
N
1
M
i=1 β(τ ; Xi )1(Xi ∈ X )
N
− E[β(τ ; X)|X
P
N
1
M
i=1 1(Xi ∈ X )
N

(57)
∈ XM ].

(58)

PN
Consider term (57) in this expansion. Its denominator N1 i=1 (Xi ∈ XM ) converges, by a Law of Large
√
Numbers to Pr(X ∈ XM ). The numerator will converge when normalized by N to the following Gaussian
process:
N
L
L
X
X
√
1 X√
d
N (β̂(τ ; Xi ) − β(τ ; Xi ))1(Xi ∈ XM ) =
N (β̂(τ ; xl ) − β(τ ; Xl ))p̂l →
Z(τ, xl )pl .
N i=1
l=1

(59)

l=1

The asymptotic covariance of (59) equals
L X
L
X

E [Z(τ, xl )Z(τ 0 , x0l )] pl pl0

l=1 l0 =1

=

L
L X
X

−1

(min (τ, τ 0 ) − τ τ 0 )

(x0l xl )

l=1 l0 =1

+

L X
L
X
l=1

−1

x0l Λ (τ, τ 0 ; xl ) xl (x0l xl )
pl

· 1 (l = l0 ) pl pl0

0

K (xl ) Σδ (τ, τ 0 )K (xl0 ) pl pl0

l0 =1

h
i
−1
−1
= (min (τ, τ 0 ) − τ τ 0 ) E (X0 X) X0 Λ (τ, τ 0 ; X) X (X0 X) |X ∈ XM Pr(X ∈ XM )
+ K M Σδ (τ, τ 0 )K M 0 Pr(X ∈ XM )2 .
Now consider term (58). Replacing the sample average by empirical probabilities yields
√
N

1
N

!
M
√
β(τ
;
X
)1(X
∈
X
)
i
i
i=1
M
−
E[β(τ
;
X)|X
∈
X
]
=
N
P
N
1
M
i=1 1(Xi ∈ X )
N

PN

=

L
X

L
X

β(τ ; xl )q̂lM −

l=1

L
X

!
β(τ ; xl )qlM

l=1

√

β(τ ; xl ) N q̂lM − qlM

(60)

l=1
1

PN

1(X =x )

where qlM denotes the conditional probability Pr(X = xl |X ∈ XM ) and q̂lM = 1N PNi=11(X i∈XMl ) its estimate.
i
i=1
N
To derive the asymptotic distribution of this term, we must first derive the asymptotic distribution of

46

q̂lM − qlM . Begin with the fact that
1
N



PN


1(Xi = x1 ) − p1


..
√ 

.

N
P


N
1


1(X
=
x
)
−
p
i
L
L
i=1
N
PN
1
M
M
1(X
∈
X
)
−
Pr(X
∈
X
)
i
i
i=1
N
  
p1 (1 − p1 )
···
−p1 pL
0
 .  
.
..
.
..
..
 ..  
d
.
 ,
→N
  
 0  
−p1 pL
···
pL (1 − pL )
p1 (1 − Pr(X ∈ XM )) · · · pL (1 − Pr(X ∈ XM ))
0
i=1

p1 (1 − Pr(X ∈ XM ))
..
.
pL (1 − Pr(X ∈ XM ))
Pr(X ∈ XM )(1 − Pr(X ∈ XM ))







(61)

and use the delta method to show

q̂1M − q1M
√ 
 d

..
 → N 0L , ΣqM
N
.


M
M
− qL
q̂L


(62)

where


ΣqM

q1M (1 − q1M ) · · ·

1
..
..

=
.
.
Pr(X ∈ XM ) 
M M
−q1 qL
···


M
−q1M qL

..
.
.

M
M
qL (1 − qL )

(63)

Note that some of these limiting variance matrices are singular. Combining these results yields an asymptotic
variance-covariance for (60) of
L X
L
X

β(τ ; xl )ΣqM (l, l0 )β(τ 0 ; xl0 )0

(64)

l=1 l0 =1
L

L

XX
1
0
0
β(τ ; xl )(qlM 1(l = l0 ) − qlM qlM
0 )β(τ ; xl0 )
M
Pr(X ∈ X )
0
l=1 l =1
 


 
0 
1
=
E β(τ ; X)β(τ 0 ; X)0 |X ∈ XM − E β(τ ; X)|X ∈ XM E β(τ 0 ; X)|X ∈ XM
M
Pr(X ∈ X )
C(β(τ ; X), β(τ 0 ; X)|X ∈ XM )
=
.
Pr(X ∈ XM )

=

(65)

Terms (59) and (60) are asymptotically independent, since the variation of (59) is conditional on X, while
b̄ M (τ ) is the sum of the
the variation of (60) depends on X alone. Therefore, the limiting covariance of β
covariances of its two components, which yields the claimed result.

Proof of Theorem 4
There are two main steps to the proof. The first is to recover an estimate of the distribution function of
the random coefficient Bp (within the subpopulation of movers). The second is to invert this distribution

47

function to recover the quantile function of the movers’ random coefficients.
For the first step, let c ∈ R and consider the asymptotic
distribution of the iestimated distribution function
PL h´ 1
evaluated at c, denoted by F̂β̂p (U ;X)|X∈XM (c) = l=1 0 1(β̂p (u; xl ) ≤ c)du q̂lM :

√ 
N F̂β̂p (U ;X)|X∈XM (c) − FBp |X∈XM (c)

ˆ 1
ˆ 1
L
X
√
1(β̂p (u; xl ) ≤ c)du −
1(βp (u; xl ) ≤ c)du q̂lM
N
=
0

l=1

+

L ˆ
X
l=1

1

(66)

0


√

1(βp (u; xl ) ≤ c)du
N q̂lM − qlM .

(67)

0

Both of these two terms converge uniformly over c ∈ R. For the first term, we have that

√ 
d
N β̂p (τ ; xl ) − β̂p (τ ; xl ) → (Z(τ, xl ))p = Zp (τ, xl )
over τ ∈ (0, 1) and all l = 1, . . . , L (here Zp (τ, xl ) is as defined in the statement of Theorem 4 and (·)p
denotes the pth element of the vector). Let Fpc (·) : C[0, 1] → R be a functional such that Fc (β(·, x)) =
´1
1(βp (u; x) ≤ c)du. By Lemma 8 of Chernozhukov, Fernández-Val and Melly (2012), this functional is
0
Hadamard differentiable and we can apply the functional delta method, yielding
√
N

ˆ

ˆ

1

1


1(β̂p (u; xl ) ≤ c)du −
1(βp (u; xl ) ≤ c)du
0
0


√
d
= N β̂p (FBp |X (c|xl ); xl ) − β̂p (FBp |X (c|xl ); xl ) fBp |X (c|xl ) + op (1) → Zp (FBp |X (c|xl ), xl )fBp |X (c|xl ).
(68)

This convergence is uniform in c ∈ R since FBp |X (c|xl ) ranges between 0 and 1, and uniformly in xl (since
there are finitely many possible values for xl ). Therefore,
L
X
√

ˆ
0

l=1

ˆ

1

1

1(β̂p (u; xl ) ≤ c)du −

N


L
X
d
1(βp (u; xl ) ≤ c)du q̂lM →
Zp (FBp |X (c|xl ), xl )fBp |X (c|xl )qlM

0

l=1

√

PL ´ 1
for c ∈ R. Also, similar to (65) above, l=1 0 1(βp (u; xl ) ≤ c)du N q̂lM − qlM will converge over c ∈ R
to a mean zero Gaussian process Z2p (c) with asymptotic covariance

C FBp |X (c|X), FBp |X (c0 |X)|X ∈ XM
E [Z2p (c)Z2p (c ) ] =
.
Pr (X ∈ XM )
0 0

(69)

PL
M
are uncorrelated since the variation in the
Note that Z2p (c) and
l=1 Zp (FBp |X (c|xl ), xl )fBp |X (c|xl )ql
latter is conditional on X while that in the former depends on X only. Therefore,
L

X
√ 
d
N F̂β̂p (U ;X)|X∈XM (c) − FBp |X∈XM (c) →
Zp (FBp |X (c|xl ), xl )fBp |X (c|xl )qlM + Z2p (c)

(70)

l=1

over c ∈ R.
We now turn to step two of the proof: inverting the distribution of the random coefficient to recover the
distribution of its quantiles. By assumption 5, Bp is assumed to have bounded support and fBp |X∈XM (c)

48

is strictly positive for all c ∈ R. Therefore by Kosorok (2007), Lemma 12.8 part (ii) the inverse functional is Hadamard differentiable into D̃(0, 1), the space of left-continuous functions with right-hand limits.
Evaluating this inverse at c = βpM (τ ) yields

√  M
d
N β̂p (τ ) − βpM (τ ) →

PL

l=1

Zp (FBp |X (βpM (τ )|xl ), xl )fBp |X (βpM (τ )|xl )qlM + Z2p (βpM (τ ))
fBp |X∈XM (βpM (τ ))

= Zβp (τ )

(71)
(72)


0
uniformly over τ ∈ (0, 1). To conclude the proof, we evaluate E Zβp (τ ) Zβp (τ 0 ) , the asymptotic covariance
of this Gaussian process:
h
i
0
E Zβp (τ ) Zβp (τ 0 )
PL PL
fB |X (βpM (τ )|xl )e0p Σ(τ, FBp |X (βpM (τ )|xl ), xl ), τ 0 , FBp |X (βpM (τ 0 )|xl0 ), xl0 ))ep fBp |X (βpM (τ 0 )|xl0 )qlM qlM
0
0
= l=1 l =1 p
M
M
0
fBp |X∈XM (βp (τ ))fBp |X∈XM (βp (τ ))


0
M
M
E Z2p (βp (τ ))Z2p (βp (τ ))
+
fBp |X∈XM (βpM (τ ))fBp |X∈XM (βpM (τ 0 ))
where
PL PL

fBp |X (βpM (τ )|xl )qlM e0p Σ(τ, FBp |X (βpM (τ )|xl ), xl ), τ 0 , FBp |X (βpM (τ 0 )|xl0 ), xl0 )ep fBp |X (βpM (τ 0 )|xl0 )qlM
0
fBp |X∈XM (βpM (τ ))fBp |X∈XM (βpM (τ 0 ))



1
=
E min FBp |X (βpM (τ )|X), FBp |X (βpM (τ 0 )|X) − FBp |X (βpM (τ )|X)FBp |X (βpM (τ 0 )|X)
M
Pr (X ∈ X )

−1
−1
× e0p (X0 X) X0 Λ FBp |X (βpM (τ )|X), FBp |X (βpM (τ 0 )|X); X X (X0 X) ep

fBp |X (βpM (τ )|X)fBp |X (βpM (τ 0 )|X) X ∈ XM
(73)
h
+ E fBp |X (βpM (τ )|X)fBp |X (βpM (τ 0 )|X̃)


  0
M
M
0
M
M
0
(74)
ep K (X) Σδ FBp |X (βp (τ )|X), FBp |X (βp (τ )|X̃) K X̃ ep X ∈ X , X̃ ∈ X
l=1

l0 =1

= Υ3 (τ, τ 0 ) + Υ4 (τ, τ 0 ),
where X̃ is an independent copy of X. Also,

 C FBp |X (βpM (τ )|X), FBp |X (βpM (τ 0 )|X)|X ∈ XM
E Z2p (βpM (τ ))Z2p (βpM (τ 0 )) =
Pr (X ∈ XM )
= Υ2 (τ, τ 0 ),
which agrees with the expressions in the statement of the Theorem.

49


(75)

Proof of Theorem 5
From (42) we get the following asymptotically linear representation


p
N hN δ̂(τ ) − δ(τ )
=

=

(76)

!−1
N
N


1 X ∗0 ∗
1 X ∗0 ∗ p
b Y|X (τ |Xi ) − QY|X (τ |Xi ) 1(Di = 0)
Wi Wi 1(Di = 0)
Wi Xi N hN Q
N hN i=1
N hN i=1
!
−1
M
M


X
X
p̂lN p
∗0
∗ p̂lN
∗0 ∗
b Y|X (τ |xlN ) − QY|X (τ |xlN ) .
N plN Q
wlN
wlN
wlN
xlN √
hN
hN plN

l=L+1

l=L+1

with

M
X

∗0
∗
wlN
wlN

l=L+1
∗
since wlN
→ wl∗ and
M
X

∗0 ∗
wlN
xlN √

l=L+1

p̂lN
hN

p̂lN p
→ E [W∗0 W∗ |D = 0] 2φ0
hN

p

→ ql|0 2φ0 as N → ∞. Similarly, we get

M

 p p
X
p̂lN p
√
b Y|X (τ |xlN ) − QY|X (τ |xlN ) →
N plN Q
2φ0
wl∗0 x∗l ql|0 ZQ (τ, xl )
hN plN
l=L+1

by Slutsky’s theorem since
equal to

√ p̂lN
hN plN

p

→

p

(77)

2φ0 ql|0 . The limiting distribution (77) has asymptotic covariance


!0 
M
M
X
X
p
p
√
√
wl∗0 x∗l ql|0 ZQ (τ, xl )
2φ0
wl∗00 x∗l0 ql0 |0 pZQ (τ 0 , xl0 ) 
E  2φ0
l0 =L+1

l=L+1

= 2φ0

M
X

M
X

∗
wl∗0 x∗l (min (τ, τ 0 ) − τ τ 0 )Λ (τ, τ 0 ; xl ) · 1 (l = l0 ) x∗0
l wl ql|0

l=L+1 l0 =L+1



= 2φ0 (min (τ, τ 0 ) − τ τ 0 )E W∗ 0 X∗ Λ(τ, τ 0 ; X)X∗ 0 W∗ |D = 0 .
To derive the asymptotic distribution of
that

√

(78)



N hN βb (·; ·) − β (·; ·) for strict movers (l = 1, . . . , L1 ), we note



p
N hN βb (τ ; xlN ) − β (τ ; xlN )




p
p
b Y|X (τ |xlN ) − QY|X (τ |xlN ) + x−1 wlN N hN δ̂(τ ) − δ(τ )
= x−1
N hN Q
lN
lN
s




p
hN p
b Y|X (τ |xlN ) − QY|X (τ |xlN ) + x−1 wlN N hN δ̂(τ ) − δ(τ )
= x−1
N plN Q
lN
lN
plN
d

→ x−1
l wl Zδ (τ )

(79)

(80)

50

since

hN
plN

→ 0 for strict mover realizations. Finally, for near-stayers (l = L1 + 1, . . . , L) with DlN = hN :

q


N h3N βb (τ ; xlN ) − β (τ ; xlN )
s




p
h3N p
b Y|X (τ |xlN ) − QY|X (τ |xlN ) + x−1 wlN hN N hN δ̂(τ ) − δ(τ )
= x−1
N plN Q
lN
lN
plN
s




p
hN p
∗ hN
b Y|X (τ |xlN ) − QY|X (τ |xlN ) + w∗ hN N hN δ̂(τ ) − δ(τ )
= xlN
N plN Q
lN
DlN plN
DlN
∗
d xl ZQ (τ, xl )
→ p
+ wl∗ Zδ (τ )
ql|0 2φ0

(81)

(82)

since hN /DlN = 1 and by Slutsky’s Theorem. For near-stayers with DlN = −hN ,
q


x∗l ZQ (τ, xl )
d
N h3N βb (τ ; xlN ) − β (τ ; xlN ) → − p
− wl∗ Zδ (τ ).
ql|0 2φ0

(83)

Since ZQ (·, xl ) and Zδ (·) are independent for l = 1, . . . , L, we can add the individual covariances of these
processes and get the desired result.

Proof of Theorem 6
We begin with the decomposition


 p
p




 p
M
b̄ (τ ) − β̄ (τ ) = N h
b̄
N hN β
+ N hN E β(τ ; X)|X ∈ XM
N β N (τ ) − E β(τ ; X)|X ∈ XN
N
N
N − E [β(τ ; X)]
=

L
X

p

M
M
− qlN
β(τ ; xlN ) N hN q̂lN

(84)

l=1

+

L p
X



M
N hN β̂(τ ; xlN ) − β(τ ; xlN ) q̂lN

(85)

l=1

+

p




N hN E β(τ ; X)|X ∈ XM
N − E [β(τ ; X)] .

(86)


√
M
M
We first consider the joint asymptotic distribution of N hN q̂lN
− qlN
for all l = 1, . . . , L. We start by
considering the asymptotic distribution of unconditional probabilities, which are normalized differently for
near-stayers and strict-movers:


√
N IL1
0L−L1 +1 00L1

0 00
qL1 L−L1 +1
N
hN IL−L1 +1





!










1
N

PN

i=1 1(Xi = x1N ) − p1N
..
.
PN
1
1(X
=
xL1 N ) − pL1 N
i
PNN i=1
1
i=1 1(Xi = x(L1 +1)N ) − p(L1 +1)N
N
..
.
PN
1
1(Xi = xLN ) − pLN
PNN i=1
1
M
M
1(X
i ∈ XN ) − Pr(X ∈ XN )
i=1
N

51























√ 

= N







1
N

PN



i=1
















1(Xi = x1N ) − p1N
..
.
PN
1
i=1 1(Xi = xL1 N ) − pL1 N
N
PN 1(Xi =x(L1 +1)N )−p(L1 +1)N
1
N

i=1

√
hN

..
.
PN

1(Xi =xLN )−pLN
√
i=1
hN
M
P
1(X
∈X
)−Pr(X∈XM
N
i
1
N√
N )
i=1
N
hN
1
N

















d


→ N 0L+1 , 













p1 (1 − p1 )
..
.
−p1 pL1
0
..
.
0
0

···
..
.
···
···
..
.
···
···

−p1 pL1
0
..
..
.
.
pL1 (1 − pL1 )
0
0
qL1 +1|0 2φ0
..
..
.
.
0
0
0
0

···
..
.
···
···
..
.
···
···

0
..
.
0
0
..
.
qL|0 2φ0
0

0
..
.
0
0
..
.
0
2φ0

















(87)

by the Lyapunov’s Multivariate Central Limit Theorem. The conditions of the theorem are trivially satisfied
since indicator functions have bounded moments. Note that the top left L1 × L1 submatrix is singular since
it contains probabilities that sum to 1. This is not a problem here since we do not invert that 
matrixlater
q


hN
1
M
M
on. By the Delta method, we get that q̂lN − qlN = Op √N for any l = 1, . . . , L1 and Op
for
N

√
√
PL
M
M
is of order Op ( hN ) and therefore
− qlN
l = L1 + 1, . . . , L. Therefore, the term l=1 β(τ ; xlN ) N hN q̂lN
converges to 0.
Term 85 can be decomposed into its strict-movers and near-stayers components:
L1 p
L p




X
X
M
M
N hN β̂(τ ; xlN ) − β(τ ; xlN ) q̂lN
N hN β̂(τ ; xlN ) − β(τ ; xlN ) q̂lN
=
l=1

(88)

l=1
L
q

 q̂ M
X
N h3N β̂(τ ; xlN ) − β(τ ; xlN ) lN .
+
hN

(89)

l=L1 +1

For term (88), we can see that



PL1 √
PL1 −1
M d
l=1 N hN β̂(τ ; xlN ) − β(τ ; xlN ) q̂lN →
l=1 xl wl Zδ (τ )pl . This asymp-

totic distribution is due to the presence of δ̂(τ ). Term (89) will have a non-degenerate limiting distribution:
L
L
q

 q̂ M
X
X
d
N h3N β̂(τ ; xlN ) − β(τ ; xlN ) lN →
Z(τ, xl )ql|0 2φ0
hN

since

M
q̂lN
h

(90)

l=L1 +1

l=L1 +1
p

→ 2φ0 ql|0 . The asymptotic covariance of (85) will then be
0

0

= (min (τ, τ ) − τ τ )

+

L
X
l=L1 +1

L
X

L
X

l=L1 +1

l0 =L1 +1

wl∗ ql|0 2φ0 +

L1
X

0
x∗l Λ (τ, τ 0 ; xl ) x∗0
l · 1 (l = l ) ql|0 2φ0

!
x−1
l wl pl

Σδ (τ, τ 0 )

L
X
l0 =L

l=1

52

1 +1

wl∗0 ql0 |0 2φ0 +

L1
X
l0 =1

!
0
0
x−1
l0 wl pl

.


 PL
PL1 −1
xl wl pl :
We now show that Ξ0 = lim EN X−1 W||D| ≥ hN = l=L1 +1 wl∗ ql|0 2φ0 + l=1
N →∞

L
X


M
lim EN X−1 W||D| ≥ hN = lim
x−1
lN wlN qlN

N →∞

N →∞

l=1

N →∞

=

L

L
X

= lim

∗
wlN

l=1

l=L1 +1

L
X

1
X
plN
Pr(X = xlN |D = |hN |)
2φ0 + lim
x−1
wlN
lN
N →∞
1 − 2φ0 hN
1 − 2bhN

wl∗ ql|0 2φ0 +

l=L1 +1

L1
X

x−1
l wl pl

l=1

by continuity in N . Finally, we consider the bias term (86). We see that
p


 p
N hN EN β(τ ; X)|X ∈ XM
N hN
N − EN [β(τ ; X)] =

L
X

M
β(τ ; xlN )qlN

l=1
L
X

=

−

M
X

!
β(τ ; xlN )plN

l=1

M
X
p
p

M
− plN −
β(τ ; xlN ) N hN plN .
β(τ ; xlN ) N hN qlN
l=L+1

l=1

√
√

2φ0 N h3
M
We see that for l = 1, . . . , L, N h qlN
− plN = plN 1−2φ0 hNN → 0 since plN = O(1) and N h3N → 0. For
√
PM
stayer realizations l = L + 1, . . . , M , we have N hN plN → 0 since l=L+1 plN = 2φ0 hN and N h3N → 0.
Therefore, term (86) converges to 0.

Proof of Theorem 7
We start by deriving the asymptotic distribution of the empirical cumulative distribution function of βbp (U ; X)
with U distributed uniformly on [0, 1] independently of X, while conditioning on X ∈ XM
N . The CDF estimand
at c ∈ R is denoted as FBp (c) and the estimator is

N

PN ´ 1

1
N

1(βbp (u, Xi ) ≤ c)du1(Xi ∈ XM
N)
PN
1
M
i=1 1(Xi ∈ XN )
N
ˆ

L
1
X
M
=
1(βbp (u, xlN ) ≤ c)du qblN
.

Fbβbp (U ;X)|X∈XM (c) =

i=1 0

0

l=1

The integration over u ∈ (0, 1) can be done exactly since βbp (u, xlN ) is piecewise linear for each l ∈ {1, . . . , L}
with finitely many pieces. This asymptotic distribution can be written as the sum of four terms:
Fbβbp (U ;X)|X∈XM (c) − FBp |X∈XN (c) =

L1 ˆ
X

N

+

0

ˆ
L
X
l=L1 +1

L ˆ 1
X
l=1

0

1

1(βbp (u, xlN ) ≤ c)du −

0

l=1

+

ˆ

1


M
1(βp (u, xlN ) ≤ c)du qblN

ˆ

1

1

1(βbp (u, xlN ) ≤ c)du −

0

0

M
M
1(βp (u, xl ) ≤ c)du qblN
− qlN

+ FBp |X∈XM
(c) − FBp (c).
N

53



(91)


M
1(βp (u, xlN ) ≤ c)du qblN
(92)
(93)
(94)

The first two terms represent the contribution of the estimation of the conditional coefficients for strictmovers and near-stayers respectively, while term three is due to the randomness of the coefficient across
subpopulations defined in terms
vanishes asymptotically.
 of X.
 Term four is the bias term, which we will show √
1
√
Term (93) will be of order Op
and therefore vanishes when premultiplied by N hN .
N
Using Hadamard differentiability and the functional delta method discussed more fully in the proof of
Theorem 4, we see that:
q

N h3N

ˆ

1

ˆ

1

1(β̂p (u; xlN ) ≤ c)du −
0


d
1(βp (u; xlN ) ≤ c)du → Zp (FBp |X (c|xl ), xl )fBp |X (c|xl ).

(95)

0

for l = L1 + 1, . . . , L.
This convergence is uniform in c ∈ R since FBp |X (c|xl ) ranges between 0 and 1, and also uniform in xl since
there are finitely many possible values for xl . Therefore, term (92) will converge in process to the following
√
limit when normalized by N hN :
ˆ
L
q
X
N h3N

ˆ

1

0

0

l=L1 +1

1

1(β̂p (u; xlN ) ≤ c)du −
d

→

L
X

 M
q̂
1(βp (u; xlN ) ≤ c)du lN
hN

Zp (FBp |X (c|xl ), xl )fBp |X (c|xl )ql|0 2φ0

l=L1 +1

for c ∈ R since
L1 p
X
l=1

ˆ

M
q̂lN
hN

p

→ ql|0 2φ0 as N → ∞. Term (91) will converge in distribution to:
ˆ

1

1(βbp (u, xlN ) ≤ c)du −

N hN
0

We also verify that

0

1


L1
X
M d
1(βp (u, xlN ) ≤ c)du qblN
→
Zp (FBp |X (c|xl ), xl )fBp |X (c|xl )pl .
l=1

√
N hN times term (94), the bias term, asymptotically vanishes. We see that

FBp |X∈XM
(c) − FBp (c) =
N

L ˆ
X
l=1

≤

M
1(βp (u, xlN ) ≤ c)duqlN
−

0

L ˆ
X
l=1

1

M ˆ
X
l=1

1

1
M
1(βp (u, xlN ) ≤ c)du qlN
− plN +

0

1(βp (u, xlN ) ≤ c)duplN

0
M
X

1(βp (u, xlN ) ≤ c)duplN

l=L+1

M
X
2φ0 hN
+
plN
1 − 2φ0 hN
l=1
l=L+1


1
= 2φ0 hN + 2φ0 hN = op √
N hN

≤

L
X

plN

since N h3N → 0. We can conclude this proof in a manner similar to that of Theorem 4.

54

