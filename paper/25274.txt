NBER WORKING PAPER SERIES

RATIONALIZING RATIONAL EXPECTATIONS? TESTS AND DEVIATIONS
Xavier D'Haultfoeuille
Christophe Gaillac
Arnaud Maurel
Working Paper 25274
http://www.nber.org/papers/w25274

NATIONAL BUREAU OF ECONOMIC RESEARCH
1050 Massachusetts Avenue
Cambridge, MA 02138
November 2018

We thank Peter Arcidiacono, Federico Bugni, Zhuoli Chen, Valentina Corradi, Gregory Jolivet,
Jia Li, Matt Masten, Andrew Patton, Basit Zafar, Yichong Zhang and seminar participants at
Amsterdam, Arizona State, Bocconi, CREST, Duke, Helsinki, Mannheim, National University of
Singapore, Singapore Management University, Surrey, Toulouse School of Economics, and
attendees of the 2017 Econometric Study Group (Bristol), the Conference on the Intersection of
Econometrics and Applied Micro (Toronto, Oct. 17), the 2017 Triangle Econometrics
Conference, the 2018 International Association for Applied Econometrics Conference (Montreal),
and the 2018 CEME NSF-NBER conference on ‚ÄúInference in Nonstandard Problems‚Äù (Duke) for
useful comments and suggestions. The views expressed herein are those of the authors and do not
necessarily reflect the views of the National Bureau of Economic Research.
NBER working papers are circulated for discussion and comment purposes. They have not been
peer-reviewed or been subject to the review by the NBER Board of Directors that accompanies
official NBER publications.
¬© 2018 by Xavier D'Haultfoeuille, Christophe Gaillac, and Arnaud Maurel. All rights reserved.
Short sections of text, not to exceed two paragraphs, may be quoted without explicit permission
provided that full credit, including ¬© notice, is given to the source.

Rationalizing Rational Expectations? Tests and Deviations
Xavier D'Haultfoeuille, Christophe Gaillac, and Arnaud Maurel
NBER Working Paper No. 25274
November 2018
JEL No. C12,D15,D84
ABSTRACT
In this paper, we build a new test of rational expectations based on the marginal distributions of
realizations and subjective beliefs. This test is widely applicable, including in the common
situation where realizations and beliefs are observed in two different datasets that cannot be
matched. We show that whether one can rationalize rational expectations is equivalent to the
distribution of realizations being a mean-preserving spread of the distribution of beliefs. The null
hypothesis can then be rewritten as a system of many moment inequality and equality constraints,
for which tests have been recently developed in the literature. Next, we go beyond testing by
defining and estimating the minimal deviations from rational expectations that can be rationalized
by the data. In the context of structural models, we build on this concept to propose an easy-toimplement way to conduct a sensitivity analysis on the assumed form of expectations. Finally, we
apply our framework to test for and quantify deviations from rational expectations about future
earnings, and examine the consequences of such departures in the context of a life-cycle model of
consumption.
Xavier D'Haultfoeuille
CREST
5 avenue Henry Le Chatelier
91764 Palaiseau cedex
FRANCE
xavier.dhaultfoeuille@ensae.fr
Christophe Gaillac
CREST
5 avenue Henry Le Chatelier
Palaiseau 91764
France
christophe.gaillac@ensae.fr

Arnaud Maurel
Department of Economics
Duke University
213 Social Sciences Building
Box 90097
Durham, NC 27708
and NBER
apm16@duke.edu

1

Introduction

How individuals form their beliefs about uncertain future outcomes is critical to understanding decision making. Despite longstanding critiques (see, among many others, Pesaran, 1987;
Manski, 2004), rational expectations remain by far the most popular framework to describe
belief formation (Muth, 1961). This theory states that agents have expectations that do not
systematically differ from the realized outcomes, and efficiently process all private information
to form these expectations. Rational expectations (RE) are a key building block in many macroand micro-economic models, and in particular in most of the dynamic microeconomic models
that have been estimated over the last two decades (see, e.g., Aguirregabiria and Mira, 2010;
Blundell, 2017, for recent surveys).
In this paper, we build a new test of RE. Our test only requires having access to the marginal
distributions of subjective beliefs and realizations, and, as such, can be applied quite broadly.
In particular, this test can be used in a data combination context, where individual realizations
and subjective beliefs are observed in two different datasets that cannot be matched. Such
situations are common in practice (see, e.g., Delavande, 2008; Arcidiacono et al., 2012, 2014;
Stinebrickner and Stinebrickner, 2014a; Kuchler and Zafar, 2017; Kapor et al., 2018). Besides,
even in surveys for which an explicit aim is to measure subjective expectations, such as the
Michigan Survey of Consumers or the Survey of Consumer Expectations of the New York Fed,
expectations and realizations can typically only be matched for a subset of the respondents. And
of course, regardless of attrition, whenever one seeks to measure long or medium-term outcomes,
matching beliefs with realizations does require waiting for a long period of time before the data
can be made available to researchers.
The tests of RE implemented so far in this context (see, e.g., Patton and Timmermann, 2012;
Gennaioli et al., 2015) only use specific implications of the RE hypothesis. In contrast, we
develop a test that exploits all possible implications of RE. Using the key insight that we
can rationalize RE if and only if the distribution of realizations is a mean-preserving spread
of the distribution of beliefs, we show that rationalizing RE is equivalent to satisfying one
moment equality and infinitely many moment inequalities.1 As a consequence, if these moment
conditions hold, RE cannot be rejected, given the data at our disposal. By exhausting all relevant
implications of RE, our test is able to detect much more violations of rational expectations than
existing tests.
To develop a statistical test of RE rationalization, we build on the recent literature on inference
based on moment inequalities, and more specifically, on Andrews and Shi (2017). By applying
their results to our context, we show that our test controls size asymptotically and is consistent
1

Interestingly, the equivalence on which we rely, which is based on Strassen‚Äôs theorem (Strassen, 1965), is also
used in the microeconomic risk theory literature, see in particular Rothschild and Stiglitz (1970).

2

over fixed alternatives. We also provide conditions under which the test is not conservative.
We then consider several extensions to our baseline test. First, we show that by using a set of
covariates that are common to both datasets, we can increase our ability to detect violations of
RE. Another important issue is that of unanticipated aggregate shocks. Even if individuals have
rational expectations, the mean of observed outcomes may differ from the mean of individual
beliefs simply because of aggregate shocks. We show that our test can be easily adapted to
account for such shocks. Finally, we prove that our test is robust to measurement errors in
the following sense. If individuals have rational expectations but both beliefs and outcomes are
measured with (classical) errors, then our test does not reject RE provided that the amount of
measurement errors on beliefs does not exceed the amount of intervening transitory shocks plus
the measurement errors on the realized outcomes. In particular, this allows for elicited beliefs
to be noisier than realized outcomes. This provides a rationale for our test even in cases where
realizations and beliefs are observed in the same dataset, since a direct test based on a regression
of the outcome on the beliefs (see, e.g., Lovell, 1986) is, at least at the population level, not
robust to any amount of measurement errors on the subjective beliefs.
Next, we go beyond testing and introduce the concept of minimal deviations from rational
expectations that can be rationalized by the data. To do so, we use tools from the optimal
transport literature (see Galichon, 2016, for an overview). In particular, building on the insights
of a recent article by Gozlan et al. (2018), we construct the minimal deviations by projecting the
subjective expectations on the space of expectations compatible with RE. A remarkable property
of this projection is that it does not depend on the particular choice of distance between random
variables that we consider. These minimal deviations from RE allow us to go beyond the binary
result of the statistical test, and quantify the magnitude of the violations from RE. We then
derive a consistent estimator of these minimal deviations. Importantly for practical purposes,
this estimator can be easily implemented, and at a modest computational cost.
We extend the concept of minimal deviations from rational expectations to accommodate restrictions on the information set of the agents. In the context of structural models, the proposed
approach yields a natural and easy-to-implement sensitivity check on the assumed form of expectations. This procedure does not require observing the beliefs in the same dataset as the
one used to estimate the model, and can thus be used quite generally. Overall, this method
offers a middle ground between estimating structural choice models based on realized data only,
under the assumption of rational expectations (standard approach a la Rust, 1987; Keane and
Wolpin, 1997), and estimating more flexible choice models using subjective beliefs (as in, e.g.,
Stinebrickner and Stinebrickner, 2014b; Delavande and Zafar, 2018).
We apply our framework to test for and quantify deviations from rational expectations about future earnings. To do so, we combine elicited beliefs about future earnings with realized earnings,

3

using data from the Labor Market module of the Survey of Consumer Expectations (SCE, New
York Fed), and test whether household heads form rational expectations on their annual labor
earnings. While a naive test of equality of means between earnings beliefs and realizations shows
that earnings expectations are realistic in the sense of not being significantly biased, thus not
rejecting the rational expectations hypothesis, our test does reject rational expectations at the
1% level. Taken together, our findings illustrate the practical importance of incorporating the
additional restrictions of rational expectations that are embedded in our test. The results of our
test also indicate that the RE hypothesis is more credible for certain subpopulations than others. For instance, we reject RE for individuals without a college degree, who exhibit substantial
deviations from RE. On the other hand, we fail to reject the hypothesis that college-educated
workers have rational expectations on their future earnings. .
Finally, we explore the sensitivity of a standard life-cycle incomplete markets model of consumption to violations of the rational expectations hypothesis. Even though agents are about
right on average about their future earnings, we show that minimal deviations from RE entail
substantial changes in the predicted responses of consumers to income shocks. In addition to
underlining the sensitivity of the model to the RE hypothesis, our results show that departures
from RE account for some of the over-insurance to permanent income shocks, as well as the excess sensitivity of consumption to transitory shocks that have been documented in the literature
(see, e.g., Hall and Mishkin, 1982; Blundell et al., 2008; Kaplan and Violante, 2010).
By developing a test of rational expectations in a setting where realizations and subjective beliefs
are observed in two different datasets, we bring together the literature on data combination (see,
e.g., Cross and Manski, 2002, Molinari and Peski, 2006, Fan et al., 2014, Buchinsky et al., 2018,
and Ridder and Moffitt, 2007 for a survey), and the literature on testing for rational expectations
in a micro environment (see, e.g., Lovell, 1986; Gourieroux and Pradel, 1986; Ivaldi, 1992, for
seminal contributions).
On the empirical side, we contribute to a rapidly growing literature on the use of subjective
expectations data in economics (see, e.g., Manski, 2004; Delavande, 2008; Van der Klaauw and
Wolpin, 2008; Van der Klaauw, 2012; Arcidiacono et al., 2014; de Paula et al., 2014; Stinebrickner
and Stinebrickner, 2014b; Wiswall and Zafar, 2015). In this paper, we show how to incorporate
all of the relevant information from subjective beliefs combined with realized data to test for,
and measure deviations from rational expectations.
By developing a new framework allowing to examine the sensitivity of behavioral models to
departures from the rational expectations hypothesis, we also contribute to a small but growing
body of research estimating structural choice models without imposing rational expectations
(see, e.g., Buchinsky and Leslie, 2010; Stinebrickner and Stinebrickner, 2014a; Kapor et al.,
2018; and Agarwal and Somaini, 2018). We add to this literature by showing how a sensitivity

4

analysis of the RE hypothesis can be conducted in frequent situations where the data used to
estimate the structural model does not include beliefs, but such beliefs are observed in another
dataset. From a methodological point of view, our approach based on minimal deviations shares
some similarities with the sensitivity analysis methods recently proposed by Andrews et al.
(2017), Armstrong and KolesaÃÅr (2018) and Bonhomme and Weidner (2018), in that they study
the robustness of a model to local deviations. In these papers, however, such deviations are
assumed to become negligible as the sample size grows, whereas our deviations do not.
The remainder of the paper is organized as follows. In Section 2, we present the set-up and discuss
the main theoretical equivalences that we use to build our testing procedure. In Section 3, we
present the statistical tests for rational expectations, and establish their asymptotic properties.
Section 4 introduces and studies the properties of minimal deviations from rational expectations
that can be rationalized by the data. Section 5 illustrates the finite sample properties of our
tests and estimators through Monte Carlo simulations. Section 6 applies our framework to
expectations about future earnings. Finally, Section 7 concludes. The appendix collects various
theoretical extensions, additional simulation results, additional material on the application, and
all the proofs. A companion R package (RationalExp) and its user guide (D‚ÄôHaultf≈ìuille et al.,
2018) are available on https://github.com/cgaillac/RationalExp. This package performs
the test of RE and computes the estimator of minimal deviations.

2
2.1

Set-up and main theoretical equivalences
Set-up

We assume that the researcher has access to a first dataset containing the individual outcome
variable of interest, which we denote by Y . She also observes, through a second dataset, the
elicited individual expectation on Y , denoted by œà. Throughout the paper, we focus on situations where the researcher has access to elicited beliefs about mean outcomes, as opposed
to probabilistic expectations about the full distribution of outcomes. The type of subjective
expectations data we consider in the paper has been collected in various contexts, and used in
a number of prior studies (see, among others, Delavande, 2008; Zafar, 2011b; Arcidiacono et al.,
2012, 2014; Hoffman and Burks, 2017).
Formally, œà = E[Y |I], where I denotes the œÉ-algebra corresponding to the agent‚Äôs information
set and E [¬∑|I] is the subjective expectation operator (i.e. for any U , E [U |I] is a I-measurable
random variable). We are interested in testing the rational expectations (RE) hypothesis
œà = E[Y |I], where E [¬∑|I] is the conditional expectation operator generated by the true data
generating process. Importantly, we remain agnostic throughout most of our analysis on the
information set I. Our analysis therefore complements several studies which primarily focus on

5

testing for different information sets, while maintaining the rational expectations assumption
(see Cunha and Heckman, 2007, for a survey).
It is easy to see that the RE hypothesis imposes restrictions on the joint distribution of realizations Y and beliefs œà. In this data combination context, the relevant question of interest is then
whether one can rationalize RE, in the sense that there exists a triplet (Y 0 , œà 0 , I 0 ) such that (i)
the pair of random variables (Y 0 , œà 0 ) are compatible with the marginal distributions of Y and
œà; and (ii) œà 0 correspond to the rational expectations of Y 0 , given the information set I 0 , i.e.,
E(Y 0 |I 0 ) = œà 0 . Hence, we consider the test of the following hypothesis:
H0 : there exists a pair of random variables (Y 0 , œà 0 ) and a sigma-algebra I 0 such that


œÉ(œà 0 ) ‚äÇ I 0 , Y 0 ‚àº Y, œà 0 ‚àº œà and E Y 0 I 0 = œà 0 ,
where ‚àº denotes equality in distribution. Rationalizing RE does not mean that the true realizations Y , beliefs œà and information set I are such that E [Y |I] = œà. Instead, it means that there
exists a triplet (Y 0 , œà 0 , I 0 ) consistent with the data and such that E [Y 0 |I 0 ] = œà 0 . In other words,
rejecting H0 implies that RE does not hold, in the sense that the true realizations, beliefs, and
information set do not satisfy RE (E [Y |I] 6= œà). The converse, however, is not true.

2.2
2.2.1

Equivalences
Main equivalence

Let Œ¥ = E [Y ] ‚àí E [œà], Fœà and FY denote the cumulative distribution functions (cdf) of œà and
Y , x+ = max(0, x), and define
Z y
FY (t) ‚àí Fœà (t)dt.
‚àÜ(y) =
‚àí‚àû

Throughout most of our analysis, we impose the following regularity conditions on the distributions of realized outcomes (Y ) and subjective beliefs (œà):
Assumption 1 E (|Y |) < +‚àû and E (|œà|) < +‚àû.
The following preliminary result will be useful subsequently.
Lemma 1 Suppose that Assumption 1 holds. Then H0 holds if and only if there exists a pair
of random variables (Y 0 , œà 0 ) such that Y 0 ‚àº Y , œà 0 ‚àº œà and E [Y 0 |œà 0 ] = œà 0 .
Lemma 1 states that in order to test for H0 , we can focus on the constraints on the joint
distribution of Y and œà, and ignore those related to the information set. This is intuitive given
that we impose no restrictions on this set. Our main result is Theorem 1 below. It states
that rationalizing RE (i.e., H0 ) is equivalent to a set of many moment inequality and equality
constraints.
6

Theorem 1 Suppose that Assumption 1 holds. The following statements are equivalent:
(i) H0 holds;
(ii) (FY is a mean-preserving spread of Fœà ) ‚àÜ(y) ‚â• 0 for all y ‚àà R and Œ¥ = 0;


(iii) E (y ‚àí Y )+ ‚àí (y ‚àí œà)+ ‚â• 0 for all y ‚àà R and Œ¥ = 0.
The implication (i) ‚áí (iii) and the equivalence between (ii) and (iii) are simple to establish.
The key part of the result is to prove that (iii) implies (i). To show this, we first use Lemma 1,
which states that H0 is equivalent to the existence of (Y 0 , œà 0 ) such that Y 0 ‚àº Y , œà 0 ‚àº œà and
E [Y 0 |œà 0 ] = œà 0 . Then the result essentially follows from Strassen‚Äôs theorem (Strassen, 1965,
Theorem 8).
It is interesting to note that Theorem 1 is related to the theory of risk in microeconomic theory.
In particular, using the terminology of Rothschild and Stiglitz (1970), (ii) states that realizations
(Y ) are more risky than beliefs (œà). The main value of Theorem 1, from a statistical point of
view, is to transform H0 into the set of moment inequality (and equality) restrictions given by
(iii). We show in Section 3 how to build a statistical test of these conditions.

Comparison with alternative tests of rational expectations We now compare our test
with alternative ones that have been proposed in the literature. In the following discussion, as
in this whole section, we reason at the population level and thus ignore statistical uncertainty.
Accordingly, the tests we consider here are formally deterministic, and we compare them in
terms of data generating processes violating the null hypothesis associated with each of them.
Our test can clearly detect many more violations of rational expectations than the ‚Äúnaive‚Äù test of
rational expectations simply based on the equality E(Y ) = E(œà). It also detects more violations
than a test based on the restrictions E(Y ) = E(œà) and V(Y ) ‚â• V(œà) (variance test), which has
been considered in particular in the macroeconomic literature on the accuracy and rationality
of forecasts (see in particular Patton and Timmermann, 2012).2 On the other hand, and as
expected since it relies on the joint distribution of (Y, œà), the ‚Äúdirect‚Äù RE test of E(Y |œà) = œà
can detect more violations of rational expectations than ours.
To better understand the differences between these four different tests (‚Äúnaive‚Äù, variance, ‚Äúdirect‚Äù tests, and our test), it is helpful to consider important particular cases. Of course, if
œà = E [Y |I], individuals are rational and none of the four tests reject their null hypothesis.
2

We also refer the reader to Elliott et al. (2005), Jin et al. (2017) and references therein, for other recent
contributions to the literature on the accuracy and rationality of forecasts. The framework in this literature
differs however from ours in a number of aspects, and in particular by focusing on the evolution over time of
forecasts.

7

Next, consider departures from rational expectations of the form œà = E [Y |I] + Œ∑, with Œ∑ independent of E [Y |I]. If E(Œ∑) 6= 0, subjective beliefs are biased, and individuals are on average
either over-pessimistic or over-optimistic. It follows that E(Y ) 6= E(œà), implying that all four
tests reject their null hypothesis.
More interestingly, if E(Œ∑) = 0, individuals‚Äô expectations are right on average, and the naive
test does not reject the null. However, it is easy to show that, as long as deviations from RE
are heterogeneous in the population (V(Œ∑) > 0), the direct test always leads to a rejection. In
this setting, our test constitutes a middle ground, the rejection of which depends on the degree
of dispersion of the deviations from RE (Œ∑) relative to the uncertainty shocks (Œµ = Y ‚àí E(Y |I)).
In other words and intuitively, we reject the null hypothesis with our test whenever departures
from rational expectations dominate the uncertainty shocks affecting the outcome. Formally,
and using similar arguments as in Proposition 4 in Subsection 2.2.4, one can show that if Œµ is
independent of E [Y |I], our test rejects H0 as long as the distribution of the uncertainty shocks
stochastically dominates at the second-order the distribution of the deviations from RE.
Specifically, if Œµ ‚àº N (0, œÉŒµ2 ) and Œ∑ ‚àº N (0, œÉŒ∑2 ), our test rejects if and only if œÉŒ∑2 > œÉŒµ2 . In such a
case, our test boils down to the variance test mentioned above: we reject whenever V(œà) > V(Y ).
But interestingly, if the discrepancy (Œ∑) between beliefs and rational expectations is not normally
distributed, we can reject H0 even if V(œà) ‚â§ V(Y ). Suppose for instance that Œµ ‚àº N (0, 1) and
Œ∑ = a (‚àí1{U ‚â§ 0.1} + 1{U ‚â• 0.9}) , U ‚àº U[0, 1] and a > 0.
In other words, 80% of individuals are rational, 10% are over-pessimistic and form expectations
equal to E [Y |I] ‚àí a, whereas 10% are over-optimistic and expect E [Y |I] + a. Then one can
show that our test rejects when a ‚â• 1.755, while for a = 1.755, V(Œ∑) ' 0.616 ‚â§ V(Œµ) = 1.
Finally, in one particular case, our test reduces to the naive test of E(Y ) = E(œà). Indeed,
when Y is a binary outcome and œà ‚àà [0, 1], one can easily show that as long as E(Y ) = E(œà),


the inequalities E (y ‚àí Y )+ ‚àí (y ‚àí œà)+ ‚â• 0 automatically hold for all y ‚àà R. This applies to
expectations about binary events, such as, e.g., being employed or not at a given date. This also
applies to situations where expectations about the distribution of continuous outcomes Y are
elicited through questions of the form ‚Äúwhat do you think is the percent chance that [Y] will be
greater than [y]?‚Äù, for different values y. We refer the reader to Manski (2004) for discussions
of papers analyzing this type of probabilistic expectations data. In such cases, one can still
apply our analysis after replacing, for the different values y at which the subjective beliefs were
elicited, Y by 1{Y > y}, and defining œà as the subjective survival function evaluated at y.
Interpretation of the boundary condition Finally, to shed further light on our test and
on the interpretation of H0 , it is instructive to derive the distributions of Y |œà that correspond
8

to the boundary condition (‚àÜ(y) = 0). The proposition below shows that, in the presence of
rational expectations, agents whose beliefs œà lies at the boundary of H0 have perfect foresight,
i.e. œà = E[Y |I] = Y .3
Proposition 1 Suppose that (Y, œà) satisfies RE, u 7‚Üí FY‚àí1
|œà (œÑ |u) is continuous for all œÑ ‚àà (0, 1),
and ‚àÜ(y0 ) = 0 for some y0 in the interior of the support of œà. Then Y |œà = y0 is degenerate.
2.2.2

Equivalence with covariates

In practice we may observe additional variables X ‚àà RdX in both datasets. Assuming that X is
in the agent‚Äôs information set, we modify H0 as follows:4
H0X : there exists a pair of random variables (Y 0 , œà 0 ) and a sigma-algebra I 0 such that


œÉ(œà 0 , X) ‚äÇ I 0 , Y 0 |X ‚àº Y |X, œà 0 |X ‚àº œà|X and E Y 0 I 0 = œà 0 .
Adding covariates increases the number of restrictions that are implied by the rational expectation hypothesis, thus improving our ability to detect violations of rational expectations.
Proposition 2 below formalizes this idea and shows that H0X can be expressed as a system of
many conditional moment inequalities and equalities.
Proposition 2 Suppose that Assumption 1 holds. The following two statements are equivalent:
(i) H0X holds;


(ii) Almost surely, E (y ‚àí Y )+ ‚àí (y ‚àí œà)+ X ‚â• 0 for all y ‚àà R and E [Y ‚àí œà|X] = 0.
Moreover, if H0X holds, H0 holds as well.
2.2.3

Equivalence with unpredictable aggregate shocks

There may be cases where the restriction E [Y |œà] = œà (or, in the presence of covariates,
E [Y |œà, X] = œà) is too strong, in the sense that such a restriction may be violated, even though
the rational expectations hypothesis holds. This occurs in particular in frequent situations where
the outcome Y is affected by unpredictable, aggregate shocks.
These types of shocks arise in a variety of contexts, but for concreteness we consider in the
following the case of individual income. Suppose that the logarithm of income of individual i at
period t, denoted by Yit , satisfies a Restricted Income Profile model:
Yit = Œ±i + Œ≤t + Œµit ,
For any cdf F , we let F ‚àí1 denote its quantile function, namely F ‚àí1 (œÑ ) = inf{x : F (x) ‚â• œÑ }.
See complementary work by Gutknecht et al. (2018), who use subjective expectations data to relax the rational
expectations assumption, and propose a method allowing to test whether specific covariates are included in the
agents‚Äô information sets.
3
4

9

where Œ≤t capture aggregate (macroeconomic) shocks, Œµit follows a zero-mean random walk, and
Œ±i , (Œ≤t )t and (Œµit )t are assumed to be mutually independent. Let Iit‚àí1 denote individual i‚Äôs
information set at time t‚àí1, and suppose that Iit‚àí1 = œÉ (Œ±i , (Œ≤t‚àík )k‚â•1 , (Œµit‚àík )k‚â•1 ). If individuals
form rational expectations on their future outcomes, their beliefs in period t ‚àí 1 about their
future log-income in period t are given by
œàit = E [Yit |Iit‚àí1 ] = Œ±i + E [Œ≤t |(Œ≤t‚àík )k‚â•1 ] + Œµit‚àí1 .
Thus, Yit = œàit + ct + Œµit ‚àí Œµit‚àí1 , with ct = Œ≤t ‚àí E [Œ≤t |(Œ≤t‚àík )k‚â•1 ]. Therefore, although individuals
form rational expectations, we have
E [Yit |Iit‚àí1 , ct ] = œàit + ct 6= œàit .
Note that we condition on ct here since it is an aggregate shock that is common to all individuals. This implies that we can only identify the distributions of Yit and œàit conditional on ct .
Equivalently, ct may be considered as non-random here.
In such context, dropping indexes i and t and maintaining the conditioning on the aggregate
shocks implicit, rationalizing RE does not correspond to E [Y |I] = œà, but instead to E [Y |I] =
c0 +œà for some c0 ‚àà R. A similar reasoning applies to multiplicative instead of additive aggregate
shocks. In such a case, the null takes the form E [Y |I] = c0 œà, for some c0 > 0. In these two
examples, c0 is identifiable: by c0 = E(Y ) ‚àí E(œà) in the additive case, and by c0 = E(Y )/E(œà)
in the multiplicative case. Formally, we consider the following null hypothesis for testing RE in
the presence of aggregate shocks:

H0S : there exist random variables Y 0 , œà 0 , a sigma-algebra I 0 and c0 ‚àà R such that

 
œÉ(œà 0 ) ‚äÇ I 0 , Y 0 ‚àº Y, œà 0 ‚àº œà and E q Y 0 , c0 I 0 = œà 0 .
where q(., .) is a known function supposed to satisfy the following restrictions.
Assumption 2 E (|œà|) < +‚àû and for all c, E (|q (Y, c) |) < +‚àû. Moreover, E [q(Y, c)] = E[œà]
admits a unique solution, c0 .
In the previous examples of additive and multiplicative aggregate shocks, we have, respectively,
q(y, c) = y ‚àí c and q(y, c) = y/c. Then Assumption 2 holds under Assumption 1 above. By
applying our main equivalence result (Theorem 1) to q(Y, c0 ) and œà, we obtain the following
result.
Proposition 3 Suppose that Assumption 2 holds. Then the following statements are equivalent:
(i) H0S holds;


(ii) E (y ‚àí q (Y, c0 ))+ ‚àí (y ‚àí œà)+ ‚â• 0 for all y ‚àà R.
10

Note that with aggregate shocks, the null hypothesis does not involve a moment equality restriction anymore; the corresponding moment is used instead to identify c0 . Related, a clear
limitation of the naive test (E(Y ) = E(œà)) is that, unlike our test, it is not robust to aggregate shocks. In this case, rejecting the null could either stem from violations of the rational
expectation hypothesis, or simply from the presence of aggregate shocks.
2.2.4

Measurement errors

We have assumed so far that Y and œà were perfectly observed; yet measurement errors in survey
data are pervasive (see, e.g. Bound et al., 2001). We explore in the following the extent to which
our test is robust to measurement errors. Specifically, assume that the true variables (œà, Y ) are
unobserved. Instead, we only observe œàb and Yb , which are affected by classical measurement
errors.5 Namely:
œàb = œà + Œæœà with Œæœà ‚ä•
‚ä• œà, E[Œæœà ] = 0
Yb = Y + ŒæY

(1)

with ŒæY ‚ä•
‚ä• Y, E[ŒæY ] = 0.

Then one can show that if RE holds (and assuming
h
iaway aggregate shocks, for simplicity), so that
b
b as long as Cov(ŒæY , œà)
b =Cov(Œæœà , Y ) = 0
b
E [Y |œà] = œà, it is nevertheless the case that E Y œà 6= œà,
and V(Œæœà ) > 0. In other words, the direct test is not robust to any measurement errors on the
subjective beliefs œà. Even if individuals have rational expectations, the direct test will reject
the null in the presence of even a small degree of measurement errors on the elicited beliefs. The
following proposition shows that our test, on the other hand, is robust to a certain degree of
measurement errors on the beliefs. As above, we let Œµ = Y ‚àí œà denote the uncertainty shocks.


b Yb be defined as in (1). Suppose
Proposition 4 Suppose that Y and œà satisfy H0 and let œà,
also that Œµ + ŒæY ‚ä•
‚ä• œà and FŒæ dominates at the second order FŒæ +Œµ . Then Yb and œàb satisfy H0 .
Y

œà

The key condition is that FŒæœà dominates at the second order FŒæY +Œµ , or, equivalently here,
that FŒæY +Œµ is a mean-preserving spread of FŒæœà . Recall that in the case of normal variables,
Œæœà ‚àº N (0, œÉ12 ) and ŒæY + Œµ ‚àº N (0, œÉ22 ), this is in turn equivalent to imposing œÉ12 ‚â§ œÉ22 . Thus, even
if there is no measurement error on Y , so that ŒæY = 0, this condition may hold provided that
the variance of measurement errors on œà is smaller than the variance of the uncertainty shocks
on Y . More generally, this allows elicited beliefs to be - potentially much - noisier than realized
outcomes, a setting which may be relevant in practice. Overall, these results support the use of
our test rather than the direct test even in cases where realizations and beliefs are observed in
the same dataset.
5

See Zafar (2011a) who do not find evidence of non-classical measurement errors on subjective beliefs elicited
from a sample of Northwestern undergraduate students.

11

2.2.5

Other extensions

We conclude this section by briefly discussing other relevant directions in which Theorem 1 can
be extended. Another potential source of uncertainty on œà is rounding. Rounding practices by
interviewees are common in the case of subjective beliefs. Under additional restrictions, it is
possible in such a case to construct bounds on the true beliefs œà (see, e.g., Manski and Molinari,
2010). We show in Appendix B that our test can be generalized to accommodate this rounding
practice.
Finally, we have implicitly maintained the assumption so far that subjective beliefs and realized
outcomes are drawn from the same population. In Appendix C, we relax this assumption and
show that our test can be easily extended to allow for sample selection under unconfoundedness,
through an appropriate reweighting of the observations.

3

Statistical tests

In this section we propose a testing procedure for H0X , which can be easily adapted to the
case where no covariate common to both datasets is available to the analyst. To simplify
notation, we use a potential outcome framework to describe our data combination problem.
Specifically, instead of observing (Y, œà), we suppose to observe only, in addition to the covariates
X, Ye = DY + (1 ‚àí D)œà and D, where D = 1 (resp. D = 0) if the unit belongs to the dataset
of Y (resp. œà). We assume that the two samples are drawn from the same population, which
amounts to D ‚ä•
‚ä• (X, Y, œà) (see Assumption 3-(i) below). In order to build our test, we use the
characterization (ii) of Proposition 2:


E (y ‚àí Y )+ ‚àí (y ‚àí œà)+ X ‚â• 0

‚àÄy ‚àà R and E [Y ‚àí œà|X] = 0.

Equivalently but written more compactly with Ye only,
 
+ 
h
i
e
E W y‚àíY
X ‚â• 0 ‚àÄy ‚àà R and E W Ye X = 0,
where W = D/E(D) ‚àí (1 ‚àí D)/E(1 ‚àí D). This formulation of the null hypothesis allows us to
apply the instrumental functions approach of Andrews and Shi (2017, AS), who consider the issue
of testing many conditional moment inequalities and equalities. We then build on their results to
establish that our test controls size asymptotically and is consistent over fixed alternatives.6 The
initial step is to transform the conditional moments into the following unconditional moments
conditions:

 
+
E W y ‚àí Ye
h(X) ‚â• 0, E [(Y ‚àí œà) h(X)] = 0.
6

Other testing procedures could be used to implement our test, such as that proposed by Chernozhukov et al.
(2018).

12

for all y ‚àà R and h belonging to a suitable class of non-negative functions.
We suppose to observe a sample (Di , Xi , Yei )i=1...n of n i.i.d. copies of (D, X, Ye ). For notational
ei denote the nontransformed vector of covariates, and redefine Xi as:
convenience, we let X



b ‚àí1/2 X
ei ‚àí X
ei ,
Xi = Œ¶0 Œ£
e
X,n

where, for any x = (x1 , . . . , xdX ), we let Œ¶0 (x) = (Œ¶(x1 ), . . . , Œ¶(xd
))> . Here Œ¶ denotes the
X
e n its sample
b e is the sample covariance matrix of X
ei
and X
standard normal cdf, Œ£
X,n
i=1...n
mean.
Now that Xi ‚àà [0, 1]dX , we consider instrumental functions h that are indicators of belonging to specific hypercubes within [0, 1]dX . Namely, we consider the class of functions Hr =
{ha,r , a ‚àà Ar }, with Ar = {1, 2, . . . , 2r}dX (r ‚â• 1), ha,r (x) = 1l {x ‚àà Ca,r } and, for any a =
(a1 , ..., adX )> ‚àà Ar ,

dX 
Y
au ‚àí 1 au
,
.
Ca,r =
2r
2r
u=1

Finally, to define the test statistic T , we need to introduce additional notation. First, we define,
for any given y,
Ô£´

 Ô£∂ Ô£´
Ô£∂

+


e
m1 Di , Yei , Xi , h, y

 Ô£∏ = Ô£≠ wi y ‚àí Yi h (Xi ) Ô£∏ ,
m Di , Yei , Xi , h, y = Ô£≠
(2)
m2 Di , Yei , Xi , h, y
wi Yei h (Xi )


P
P
P
where wi = nDi / nj=1 Dj ‚àín(1‚àíDi )/ nj=1 (1‚àíDj ). Let mn (h, y) = ni=1 m Di , Yei , Xi , h, y /n
and define similarly mn,j for j = 1, 2. For any function h and any y ‚àà R, we also define, for
some  > 0,
    
b Ye ,
b Ye , V
b n (h, y) + Diag V
Œ£n (h, y) = Œ£
 
b Ye is the empirical
b n (h, y) is the sample covariance matrix of ‚àönmn (h, y) and V
where Œ£
variance of Ye . We then denote by Œ£n,jj (h, y)(j = 1, 2) the j-th diagonal term of Œ£n (h, y).
Then the (CrameÃÅr-von-Mises) test statistic T is defined by:
+2
‚àö
2 !
 ‚àö
rn
X
nmn,1 (ha,r , y)
nmn,2 (ha,r , y)
(2r)‚àídX X
T = sup
(1 ‚àí p) ‚àí
+p
,
2
Œ£n,11 (ha,r , y)1/2
Œ£n,22 (ha,r , y)1/2
b r=1 (r + 100) a‚ààA
y‚ààY
r


b
e
e
where Y = min Yi , max Yi , p is a parameter that weights the moments inequalities versus
i=1,...,n

i=1,...,n

equalities and (rn )n‚ààN is a deterministic sequence tending to infinity.
To test for rational expectations in the absence of covariates, we set the instrumental function
equal to the constant function h(X) = 1, and the test statistic is simply written as:
 ‚àö
+2
‚àö
2
nmn,1 (y)
nmn,2 (y)
T = sup (1 ‚àí p) ‚àí
+p
,
Œ£n,11 (y)1/2
Œ£n,22 (y)1/2
b
y‚ààY
13

where, using the notations introduced above, mn,j (y) = mn,j (1, y) and Œ£n,jj (y) = Œ£n,jj (1, y)
(j = 1, 2).

Whether or not covariates are included, the resulting test is of the form œïn,Œ± = 1l T > c‚àón,Œ±
where the estimated critical value c‚àón,Œ± is obtained by bootstrap using as in AS the Generalized
Moment Selection method. Specifically, we follow these three steps:
>
n
1. Compute the function œïn (y, h) = œïn,1 (y, h) , 0 for (y, h) in Yb √ó ‚à™rr=1
Hr , with
(
)
n1/2 ‚àí1/2
1/2
œïn,1 (y, h) = Œ£n,11 Bn 1l
Œ£
mn,1 (y, h) > 1 ,
Œ∫n n,11
and where Bn = (b0 ln(n)/ ln(ln(n)))1/2 , b0 > 0, Œ∫n = (Œ∫ ln(n))1/2 , and Œ∫ > 0. To compute
Œ£n,11 , we fix  to 0.05, as in AS.


2. Let Di‚àó , Yei‚àó , Xi‚àó
denote a bootstrap sample, i.e., an i.i.d. sample from the empirical

 i=1,...,n
cdf of D, Ye , X , and compute from this sample the bootstrap counterparts of mn and
‚àó

Œ£n , m‚àón and Œ£n . Then compute the bootstrap counterpart of T , T ‚àó , replacing Œ£n (y, ha,r )
‚àö
‚àö
‚àó
and nmn (y, ha,r ) by Œ£n (y, ha,r ) and n (m‚àón ‚àí mn ) (y, ha,r ) + œïn (y, ha,r ), respectively.
3. The threshold c‚àón,Œ± is the quantile (conditional on the data) of order 1 ‚àí Œ± + Œ∑ of T ‚àó + Œ∑
for some Œ∑ > 0. Following AS, we set Œ∑ to 10‚àí6 .
Note that, despite the multiple steps involved, the testing procedure remains computationally
easily tractable. In particular, for the baseline sample we use in our application (see Section 6.1),
the RE test only takes 2 min.7
We now turn to the asymptotic properties of the test. For that purpose, it is convenient to
introduce additional notation. Let Y and X denote the support of Y and X respectively, and

 


+
e
LF = (y, ha,r ) : y ‚àà Y, (a, r) ‚àà Ar √ó N : EF W y ‚àí Y
ha,r (X) = 0 ,
where, to make the dependence on the underlying probability
 measure explicit, EF denotes the
e
expectation with respect to the distribution F of D, Y , X . Finally, let F denote a subset of


all possible cumulative distribution functions of D, Ye , X and F0 be the subset of F such that
H0X holds. We impose the following conditions on F and F0 :
Assumption 3
(i) For all F ‚àà F, D ‚ä•
‚ä• (X, Y, œà);
7

This CPU time is obtained using our companion R package, on an Intel Xeon CPU E5-2643, 3.30GHz with
256Gb of RAM.

14

 
(ii) There exists M > 0 such that Ye ‚àà [‚àíM, M ] for all F ‚àà F. Also, inf F ‚ààF VF Ye > 0 and
0 < inf F ‚ààF EF [D] ‚â§ supF ‚ààF EF [D] < 1;

 ‚àí1/2
(iii) For all F ‚àà F0 , KF , the asymptotic covariance kernel of n‚àí1/2 Diag VF Ye
mn is
in a compact set K2 of the set of all 2 √ó 2 matrix valued covariance kernels on Y √ó ‚à™r‚â•1 Hr
with uniform metric d defined by
d(K, K 0 ) =

K(y, h, y 0 , h0 ) ‚àí K 0 (y, h, y 0 , h0 ) .
sup
2
(Y√ó‚à™r‚â•1 Hr )

(y,h,y 0 ,h0 )‚àà

The main result of this section is Theorem 2. It shows that, under Assumption 3, the test œïn,Œ±
controls the asymptotic size and is consistent over fixed alternatives.
Theorem 2 Suppose that rn ‚Üí ‚àû and Assumption 3 holds. Then:
(i) lim supn‚Üí‚àû supF ‚ààF0 EF [œïn,Œ± ] ‚â§ Œ±;
(ii) If there exists F0 ‚àà F0 such that LF0 is nonempty and there exists (j, y0 , h0 ) in {1, 2} √ó LF0
such that KF0 ,jj (y0 , h0 , y0 , h0 ) > 0, then, for any Œ± ‚àà [0, 1/2),
lim lim sup sup EF [œïn,Œ± ] = Œ±.

Œ∑‚Üí0 n‚Üí‚àû F ‚ààF0

(iii) If F ‚àà F\F0 , then limn‚Üí‚àû EF (œïn,Œ± ) = 1.
Theorem 2 (i) is closely related to Theorem 5.1 and Lemma 2 in AS. It shows that the test œïn,Œ±
controls the asymptotic size, in the sense that the supremum over F0 of its level is asymptotically lower or equal to Œ±. To prove this result, the key is to establish that, under Assumption 3,
the class of transformed unconditional moment restrictions that characterize the null hypothesis
satisfies a manageability condition (see Pollard, 1990). Using arguments from Hsu (2016), we
then exhibit cases of equality in Theorem 2 (ii), showing that, under mild additional regularity
conditions, the test has asymptotically exact size (when letting Œ∑ tend to zero). Finally, Theorem 2 (iii), which is based on Theorem 6.1 in AS, shows that the test is consistent over fixed
alternatives.
Extension to account for aggregate shocks This testing procedure can be easily modified
to accommodate unanticipated aggregate shocks. Specifically, using the notation defined in
Section 2.2.3, we consider the same test as above after replacing Ye by Yebc = Dq(Y, b
c) + (1 ‚àí
D)œà, where b
c denotes a consistent estimator of c0 . The resulting test is given by œïn,Œ±,bc =

‚àó
1l T (b
c) > cn,Œ± (where T (b
c) is obtained by replacing Ye by Yebc in the original test statistic).
Such tests have the same properties as those above under some mild regularity conditions on
q(¬∑, ¬∑), which hold in particular for the leading examples of additive and multiplicative shocks
(q(y, c) = y ‚àí c and q(y, c) = y/c). We refer the reader to Appendix A for a detailed discussion
of this extension.
15

4

Minimal deviations from rational expectations

In this section we introduce the concept of minimal deviations from rational expectations, and
build on optimal transport methods to provide conditions under which these minimal deviations
exist and are unique. We first consider in Section 4.1 such deviations while remaining agnostic
on the information set of the agents. Then, in Section 4.2, we characterize such deviations when
the information set is known, as is typically the case in structural models. Finally, we show
how these deviations can be used to assess the sensitivity of structural models to violations of
rational expectations.

4.1
4.1.1

Unconstrained information set
Existence and uniqueness

For the cases where H0 is rejected, we propose a way to quantify the degree to which subjective
expectations differ from rational expectations. To do so, we consider the minimal modifications
- in a sense to be made precise below - to the distribution of subjective beliefs œà that are such
that the modified distribution of beliefs is compatible with the rational expectations hypothesis.
We refer to the discrepancy between the true beliefs and the modified beliefs as the minimal
deviations from rational expectations. We first consider such deviations without imposing any
constraints on the information set of the agents.
Formally, we define the set:

Œ® = (Y 0 , œà 0 , œà 00 ) : Y 0 ‚àº Y, œà 0 ‚àº œà and E(Y 0 |œà 00 ) = œà 00 .

(3)

In this set, (Y 0 , œà 0 ) corresponds to a vector that is compatible with the data, whereas œà 00 correspond to alternative individual expectations, in a counterfactual situation where people would
form rational expectations on their future outcomes. Thus, in view of Lemma 1, the subset of
Œ® for which œà 0 = œà 00 corresponds to the set of random variables (Y 0 , œà 0 ) that are compatible
with the data and with the rational expectations hypothesis. However, if H0 does not hold which is the relevant situation here - such a subset is, by definition, empty. The idea is then to
try and find a vector (Y 0 , œà 0 , œà 00 ) ‚àà Œ® such that œà 0 and œà 00 are closest, in the sense of a family
of metrics defined below.
The following theorem shows that there exists a solution to this problem. Importantly, this
solution turns out to be, for a large class of metrics, independent of the specific metric considered.
The solution is also unique.
Assumption 4 E(Y 2 ) < +‚àû, E(œà 2 ) < +‚àû, and Fœà has no atom.

16

Theorem 3 Suppose that Assumption 4 holds. Then there exists a unique function g ‚àó such
that:
(i) g ‚àó (œà) is consistent with RE (namely, there exists Y 0 such that (Y 0 , œà, g ‚àó (œà)) ‚àà Œ®);
(ii) for any convex function œÅ : R+ ‚Üí R+ satisfying œÅ(0) = 0,
E[œÅ(|œà ‚àí g ‚àó (œà)|)] =

inf

(Y 0 ,œà 0 ,œà 00 )‚ààŒ®

E[œÅ(|œà 0 ‚àí œà 00 |)].

(4)

Moreover, g ‚àó is non-decreasing.
Theorem 3 shows that there exists a unique transformation of the subjective beliefs œà such that
(i) the transformed beliefs g ‚àó (œà) are consistent with RE, and, remarkably, (ii) this transformation
is minimal for all metrics (indexed by œÅ) used to measure the distance between the true and
modified beliefs distributions. Moreover, the modified beliefs are obtained as a monotonically
increasing change of the original beliefs. These minimal modifications can be geometrically
interpreted as the projections from the true subjective beliefs onto the set of beliefs that are
consistent with RE.
The proof of Theorem 3 can be summarized as follows. We first show, using our main equivalence
result (Theorem 1 above) and Proposition 3.1 in Gozlan et al. (2018), that


 
inf
E[œÅ(|œà 0 ‚àí œà 00 |)] =
inf
E œÅ œà 0 ‚àí E Y 0 |œà 0
.
(Y 0 ,œà 0 ,œà 00 )‚ààŒ®

(Y 0 ,œà 0 ): Y 0 ‚àºY, œà 0 ‚àºœà

The optimization problem on the right-hand side is an optimal transport problem, in the sense
that it corresponds to an optimization over probability measures whose marginals are fixed.
Though non-standard, as it involves E [Y 0 |œà 0 ], this problem has been recently studied by Gozlan
et al. (2018). In particular, it follows from their results that there exists a cdf G‚àó such that the
problem can be rewritten as


inf
E[œÅ(|œà 0 ‚àí œà 00 |)] =
inf
E œÅ |œà 0 ‚àí œà 00 | .
(Y 0 ,œà 0 ,œà 00 )‚ààŒ®

(œà 0 ,œà 00 ): œà 0 ‚àºœà, œà 00 ‚àºG‚àó

Then, by a strict convexity argument based on Theorem 1 again and Pass (2013), we show
that such a G‚àó is unique. Finally, using standard results in optimal transport, we show that
g ‚àó = G‚àó‚àí1 ‚ó¶ Fœà is the unique function satisfying (4).
4.1.2

Consistent estimation

While g ‚àó does not have a simple form in general, we propose a simple procedure to construct a
consistent estimator of it, based on i.i.d. copies (Yi )i=1...nY and (œài )i=1...nœà of the realizations Y
and subjective beliefs œà. For simplicity, we suppose in the following that the two samples have
equal size, which we denote (with a slight abuse of notation) by n.8
8

If both samples do not have equal size, one can first apply our analysis after taking a random subsample of
the larger one, with the same size as the smaller one. Then we can compute the average of the estimates over a
large number of such random subsamples.

17

To define our estimator, it is useful to note first that, from the proof of Theorem 3, we have
h
i
g ‚àó = arg min E (œà ‚àí g(œà))2 ,
(5)
g‚ààG0

where the set G0 is defined by



G0 = g non-decreasing : E (y ‚àí Y )+ ‚àí (y ‚àí g(œà))+ ‚â• 0 ‚àÄy ‚àà R, E[g(œà)] = E[Y ] .
By Theorem 1, g ‚àà G0 means that we can rationalize E(Y |g(œà)) = g(œà). Among such functions
g, g ‚àó (œà) is then defined as being closest to œà for the L2 norm.
To estimate g ‚àó , the idea is to replace expectations and cdfs by their empirical counterpart,
both in (5) and in the set G0 . Denoting by (Y(i) )i=1...n and (œà(i) )i=1...n the ordered statistics

of (Yi )i=1...n and (œài )i=1...n , we first focus on the estimation of g ‚àó (œà(1) ), ..., g ‚àó (œà(n) ) . The
empirical counterpart Gb0 of G0 is
(
n



+
X
Gb0 =
œàe(1) , ..., œàe(n) : œàe(1) < ... < œàe(n) ,
(y ‚àí Y(i) )+ ‚àí y ‚àí œàe(i)
‚â• 0 ‚àÄy ‚àà R,
i=1
n
X

)
Y(i) ‚àí œàe(i) = 0 .

(6)

i=1



Note that here we consider vectors œàe(1) , ..., œàe(n) instead of functions g as in G0 , since g may
be assimilated with a vector when œà has a finite support. On the surface, the set Gb0 appears
to be complicated because of the infinitely many inequalities. However, one can show, using
Proposition 2.6 in Gozlan et al. (2018), that Gb0 boils down to the following set, which only
involves a finite number of inequalities:
Ô£±
Ô£º
n
n
Ô£≤
Ô£Ω

X
X
Gb0 =
œàe(1) , ..., œàe(n) : œàe(1) < ... < œàe(n) ,
Y(i) ‚àí œà(i) ‚â• 0 j = 2, ..., n,
Y(i) ‚àí œàe(i) = 0 .
Ô£≥
Ô£æ
i=j

i=1


Then, as the empirical counterpart of (5), our estimator of g ‚àó (œà(1) ), ..., g ‚àó (œà(n) ) satisfies:

gb‚àó (œà(1) ), ..., gb‚àó (œà(n) ) = arg

min

n 
X

œà(i) ‚àí œàe(i)

e(1) <¬∑¬∑¬∑<œà
e(n)
œà
i=1

2

s.t.

n
X

Y(i) ‚àí œàe(i) ‚â• 0, j = 2...n,

i=j
n
X

Y(i) ‚àí œàe(i) = 0.

i=1

Finally, for any t ‚àà R, we let

gb‚àó (t) = gb‚àó min{(œài )i=1...n : œài ‚â• min{t, œà(n) }} .
Theorem 4 shows that gb‚àó is a consistent estimator of the transformation g ‚àó .
18

(7)

Theorem 4 (Convergence of empirical minimal deviations) Suppose that Assumption 4
holds. Then, for all t that is a continuity point of g ‚àó and such that Fœà (t) ‚àà (0, 1), we have, as
n ‚Üí ‚àû,
gb‚àó (t) ‚Üí g ‚àó (t) a.s.
Program (7) is a particular convex quadratic programming problem, which turns out to be
solvable very efficiently. The algorithm below, devised by Suehiro et al. (2012), shows that

gb‚àó (œà(1) ), ..., gb‚àó (œà(n) ) can be obtained with only O(n2 ) elementary operations. The idea is to
rely on the first-order conditions of the program, which have a simple form. Using our R package
and for the baseline sample we use in the application, the estimation of the minimal deviations
from RE takes less than a minute.

Computation of gb‚àó (œà(1) ), ..., gb‚àó (œà(n) ) .
1. Let t = 0 and i0 = 0.
2. While it < n:
(a) Let t = t + 1.

Pn‚àíit‚àí1
(b) Let C t (i) =
k=n+1‚àíi Y(k) ‚àí œà(k) /(i ‚àí it‚àí1 ), for i = it‚àí1 + 1, ..., n and let it =
argmini‚àà{it‚àí1 +1,...,n} C t (i). If there are multiple minimizers, choose the largest one as
it .
(c) Set gb‚àó (œà(k) ) = œà(k) + C t (it ), for k ‚àà {n + 1 ‚àí it , ..., n ‚àí it‚àí1 }.

4.2
4.2.1

Constrained information set and sensitivity analysis in structural models
Existence and uniqueness

We now consider minimal deviations from rational expectations in the presence of constraints
on the information set. Such constraints are typically imposed in structural models, along
with the rational expectations hypothesis. An important motivation for considering minimal
deviations from RE in this setting, then, is to assess the sensitivity of structural models to
the RE hypothesis. A more direct way of evaluating how critical the rational expectations
hypothesis is for a given model would be to solve the model and estimate it, using elicited
beliefs about future outcomes both on and off the agents‚Äô actual choice paths. However, the
data requirements are formidable, and, as a consequence, this approach has only been pursued in
a handful of studies (see, e.g., Arcidiacono et al., 2014; Stinebrickner and Stinebrickner, 2014a,b;
Wiswall and Zafar, 2015, 2018). Our approach can be used more broadly. Notably, it applies to
the frequent cases where the model cannot be solved and estimated using available subjective
beliefs data, the only requirement being that the beliefs are observed in an auxiliary dataset.

19

Specifically, consider a structural model that imposes both a rational expectations formation
process and an information set I M of the agents, such that individual expectations about the




outcome Y are given by E Y |I M . In the following, we refer to this assumption (œà = E Y I M )
as the restricted RE hypothesis. Note that with auxiliary data on the subjective beliefs, we can
test for the restricted RE hypothesis by simply testing whether Fœà = FE[Y |I M ] .
Suppose that the restricted RE hypothesis is rejected. Then, consider the set



Œ®M = (œà 0 , œà 00 ) : œà 0 ‚àº œà, œà 00 ‚àº E Y I M .
As with the set Œ® in the unconstrained case, if we reject RE, there is no pair of the form
(œà 0 , œà 0 ) in Œ®M .9 The goal here is then to find a pair (œà 0 , œà 00 ) ‚àà Œ®M such that œà 0 is as close
to œà 00 as possible. The discrepancy between the restricted model-based RE and the beliefs œà 0
corresponds to the minimal deviations from RE that are consistent with the data on subjective
beliefs.10 Similarly to Theorem 3 in the absence of constraints on the information set, Theorem
5 below shows that there exists a solution to this problem, which is moreover independent of
the metric. To define this solution, we introduce hM = Fœà‚àí1 ‚ó¶ FE[Y |I M ] .
Theorem 5 Suppose that FE[Y |I M ] has no atom. Then, for any convex function œÅ : R+ ‚Üí R+
satisfying œÅ(0) = 0, we have

 

hM E Y I M , E Y I M ‚àà arg

min

(œà 0 ,œà 00 )‚ààŒ®M

E[œÅ(|œà 0 ‚àí œà 00 |)].

(8)



Moreover, if œÅ is strictly convex, hM E Y I M is unique in the sense that for any other œà 0




such that (œà 0 , E Y I M ) ‚àà Œ®M satisfying (8), œà 0 = hM E Y I M almost surely.
Theorem 5 implies that among all random variables that are consistent with the true subjective




beliefs, hM E Y I M is closest to the rational expectations E Y I M , for any metric indexed
by œÅ. Theorem 5 relies on results on optimal transport on the real line. In such a case, the
optimal map has been shown to be independent of the cost function (see, e.g., Rachev and
RuÃàschendorf, 1998, Chapter 3), which is why again here, the minimal deviations from RE do
not depend on the specific metric considered.


A couple of remarks are in order. First, hM E Y I M is I M -measurable, which implies that
it is compatible with the information set I M imposed by the model. Second, by construc

tion, hM E Y I M is consistent with the observed subjective beliefs, since their marginal
9



In this context, the distribution of rational expectations E Y I M is identified. It follows that the set Œ®M
only involves the distribution of expectations, in contrast to the set Œ® in the unconstrained case, which also
depends on the distribution of realizations.
10
At a high level, it is interesting to note that our approach to measuring the deviations from RE is similar in
spirit to the approach proposed by Hansen and Jagannathan (1997) to quantify specification error when estimating
stochastic discount factors in the context of GMM asset pricing models.

20

distributions coincide. Hence, given the data and the constraints imposed by the model on


the information set, we can rationalize that œà = hM E Y I M .11 For this reason, we refer


to hM E Y I M as pseudo-beliefs. We use the term pseudo-beliefs here to emphasize that,


even though both sets of beliefs are observationally equivalent, hM E Y I M does in general
not coincide with the true subjective expectations œà. By construction, the pseudo-beliefs are
identifiable.
Finally, since hM = Fœà‚àí1 ‚ó¶ FE[Y |I M ] , the pseudo-beliefs are simply obtained by an equipercentile
mapping from the distribution of rational expectations to the distribution of the true subjective
beliefs. It follows that the pseudo-beliefs can also be easily estimated, as discussed in more detail
below.
Next, having computed the pseudo-beliefs for a given structural model, we can compare the
results obtained with these pseudo-beliefs with those obtained under the baseline RE model.
Importantly, this provides a way to assess the sensitivity of the findings to violations of RE,
holding fixed the restrictions on the information set implied by the model. Findings from
the baseline model that exhibit significant sensitivity to these minimal deviations should be
interpreted with caution.
We conclude this discussion by noting that, in certain models, the parameters or predictions of
interest may also involve subjective beliefs about additional features of the distribution of future outcomes, such as, e.g., subjective variances. In these cases, one can still use our approach
to evaluate the sensitivity of the model predictions to minimal deviations from rational expectations, after replacing rational expectations by pseudo-beliefs about future outcomes, while
leaving the higher-order moments unchanged.12
4.2.2

Consistent estimation

Estimation of hM is simpler than that of g ‚àó in the absence of restrictions on the information set,
given its simple, explicit form. Specifically, for a given vector of parameters Œ∏ of the structural
model, we can estimate hM by
b
hM = Fbœà‚àí1 ‚ó¶ FE[Y |I M ],Œ∏ ,
(9)


where FE[Y |I M ],Œ∏ denotes the distribution of E Y I M when the true value of the parameter
vector is Œ∏, and Fbœà‚àí1 is the empirical quantile of the subjective beliefs. For a fixed Œ∏, it follows
On the other hand, it is generally impossible to rationalize the model-free beliefs generated from g ‚àó , namely


(g ‚àó )‚àí1 E Y I M . Their distribution does not coincide with the distribution of the observed subjective beliefs
in general.
12
Of course, in a richer data environment where elicited beliefs about higher moments of the outcome distribution
are available to the analyst, one can also use our method to compute the pseudo-beliefs associated with each of
these moments, and then incorporate the corresponding departures from RE in the model.
11

21

from the asymptotic normality of quantiles (see, e.g. Van der Vaart, 2000, Corollary 21.5) that
this estimator is root-n consistent and asymptotically normal.
Recall, however, that the primary motivation behind the estimation hM is to conduct a sensitivity analysis on the structural model. In other words, hM is usually not the parameter of interest.
Instead, the parameters (or predictions) of interest are generally a function of Œ∏, and possibly of
the beliefs too. In the modified model where rational expectations are replaced by the pseudo

beliefs hM (E Y I M ), it follows that such a parameter of interest is given by œÜ = f (Œ∏, Fœà ), for
some function f . This parameter can be estimated in two steps. First, Œ∏ is estimated in the
modified model. Letting Œ∏b denote the corresponding estimator, we then estimate in a second step
b Fbœà ), where Fbœà denotes the empirical cdf. of the subjective beliefs. In particular,
œÜ by œÜb = f (Œ∏,
if Œ∏ is estimated by maximum likelihood or GMM, Œ∏b can be represented as a GMM estimator
including a first-step estimator (that of Fœà ). Since the estimator of Fœà is root-n consistent,
Œ∏b is also root-n consistent and asymptotically normal, under mild regularity restrictions (see,
e.g. Chen et al., 2003). Root-n consistency and asymptotic normality of œÜb follows, as long as
f is (Hadamard) differentiable. Importantly for practical purposes, bootstrap will also be valid
under standard regularity conditions (Chen et al., 2003).

5

Monte Carlo simulations

In this section we study the finite sample performances of the test without covariates through
Monte Carlo simulations. The finite sample performances of the version of our test that accounts
for covariates are reported and discussed in Appendix D.
We suppose that the outcome Y is given by
Y = œÅœà + Œµ,
with œÅ ‚àà [0, 1], œà ‚àº N (0, 1) and
Œµ = Œ∂ (‚àí1l{U ‚â§ 0.1} + 1l{U ‚â• 0.9}) ,
where Œ∂, U and œà are mutually independent, Œ∂ ‚àº N (2, 0.1) and U ‚àº U[0, 1].
In this setup, E(Y |œà) = œÅœà and expectations are rational if and only if œÅ = 1. But since we
observe Y and œà in two different datasets, there are values of œÅ 6= 1 for which our test cannot
reject the null hypothesis. More precisely, we can show that as the sample size n grows to infinity,
we reject the null if and only if œÅ ‚â§ œÅ‚àó ' 0.616. Besides, given this data generating process, the
naive test E(Y ) = E(œà) always fails to reject RE, while the RE test based on variances is only
able to detect a subset of violations of RE that correspond to œÅ < 0.445.
Results reported in Figure 1 show the power curves of the test œïŒ± for five different sample sizes
(nY = nœà = n ‚àà {400; 800; 1, 200; 1, 600; 3, 200}) as a function of the parameter œÅ, using 800
22

simulations for each value of œÅ. We use 500 bootstrap simulations to compute the critical values
of the test. The test statistic T involves the three tuning parameters b0 , Œ∫, and p (see Section 3
for definitions). As described p.643 in Andrews and Shi (2013), there exists in practice a large
range of admissible values for these parameters. Following Section 4.2 of Beare and Shi (2018),
we set them equal to the smallest (resp. highest) value such that the rejection rate under the
null is below the nominal size 0.05, and obtain b0 = 0.3, Œ∫ = 0.001, and p = 0.05.

Notes: The vertical line at œÅ ' 0.616 corresponds to the theoretical limit for the rejection of the null
hypothesis using our test. The dotted horizontal line corresponds to the 5% level.

Figure 1: Power curves.

Several remarks are in order. First, as expected, under the alternative (i.e. for values of œÅ ‚â§
œÅ‚àó = 0.616), rejection frequencies increase with the sample size n. In particular, for the largest
sample size n = 3, 200, our test always results in rejection of the RE hypothesis for values of
œÅ as large as .45. Second, in this setting, our test is conservative in the sense that rejection
frequencies under the null are smaller than Œ± = 0.05, for all sample sizes. This should not
necessarily come as a surprise since the test proposed by AS has been shown to be conservative
in alternative finite-sample settings (see, e.g. Table 1 p.22 in AS for the case of first-order
stochastic dominance tests). However, for the version of our test that accounts for covariates
and for the data generating process considered in Appendix D, rejection frequencies under the
null are very close to the nominal level.
Next, we report in Figure 2 below the estimated minimal deviations from rational expectations.
Specifically, we plot the differences between the beliefs œà and the modified beliefs gb‚àó (œà), where
the transformation gb‚àó is computed using the estimator of Section 4.1.2, for œÅ = 0.3 and n = 800.
In the same figure, we also report the true minimal deviations œà ‚àí g ‚àó (œà), obtained by solving

23

(7) with a large number of observations (n = 10, 000), as g ‚àó does not have a closed form
representation in this setting.

Note: The plain black curve corresponds to the average of œà ‚àí gb‚àó (œà) over 1, 000 simulations (with
n = 800), and the light dotted black curves are the 2.5% and 97.5% quantiles of œà ‚àí gb‚àó (œà).

Figure 2: Estimation and true value of œà ‚àí g ‚àó (œà).
Comparing these two curves shows that the estimator g ‚àó exhibits a fairly small bias over the
support of œà. The 2.5% and 97.5% quantiles of œà ‚àí gb‚àó (œà), in light dotted black lines, are
also reasonably close to each other, showing that the estimator is already fairly accurate with
a sample of size n = 800.13 Finally, we computed the coverage of the bootstrap confidence
intervals of g ‚àó (œà), which is very close to the nominal rates for most values of œà in [‚àí3, 3]. For
œÅ = 0.3 and n = 800, the mean coverage rates over values of œà in [‚àí3, 3] are equal to 98.6% and
95.4% for nominal rates of 99% and 95%, respectively. Overall, these findings support the use
of bootstrap to construct confidence intervals around the estimated minimal deviations.

6

Application to earnings expectations

6.1

Data

Using the tests discussed in Section 3, we now investigate whether household heads form rational
expectations on their future earnings. We use for this purpose data from the Survey of Con13

We obtain very similar patterns on the accuracy of the estimator for alternative values of œÅ.

24

sumer Expectations (SCE), a monthly household survey that has been conducted by the Federal
Reserve Bank of New York since 2012 (see Armantier et al., 2017, for a detailed description
of the survey, and Kuchler and Zafar, 2017; Conlon et al., 2018; Fuster et al., 2018 for recent
articles using the SCE). The SCE is conducted with the primary goal of eliciting consumer expectations about inflation, household finance, labor market, as well as housing market. It is a
rotating internet-based panel of about 1,200 household heads, in which respondents participate
for up to twelve months.14 Each month, the panel consists of about 180 entrants, and 1,100
repeated respondents. While entrants are overall fairly similar to the repeated respondents, they
are slightly older and also have slightly lower incomes (see Table 1 in Armantier et al., 2017).
Of particular interest for this paper is the supplementary module on labor market expectations.
This module is repeated every four months since March 2014. Since March 2015, respondents
are asked the following question about labor market earnings expectations (œà) over the next
four months: ‚ÄúWhat do you believe your annual earnings will be in four months?‚Äù. In this
module, respondents are also asked about current job outcomes, including their current annual
earnings (Y ), through the following question: ‚ÄúHow much do you make before taxes and other
deductions at your [main/current] job, on an annual basis?‚Äù.
Specifically, we use for our baseline test the elicited earnings expectations (œà), which are available
for three cross-sectional samples of household heads who were working either full-time or parttime at the time of the survey, and responded to the labor market module in March 2015,
July 2015, and November 2015, respectively. We combine this data with current earnings (Y )
declared in July 2015, November 2015 and March 2016 by the respondents who are working
full-time or part-time at the time of the survey.15 This leaves us with a final sample of 2,993
observations, which is composed of 1,565 earnings expectation observations, and 1,428 realized
earnings observations (see Table 4 in Appendix E.1 for descriptive statistics).16

6.2

Are earnings expectations rational?

In Table 1 below, we report the results from the naive test of RE (E(Y ) = E(œà)), and our
preferred test (‚ÄúFull RE‚Äù), where we allow for multiplicative aggregate shocks. Several remarks
are in order. First, using our test, we reject for the whole population, at any standard level, the
hypothesis that agents form rational expectations over their future earnings. Second, we also
14

Each survey takes on average about fifteen minutes to complete, and respondents are paid $15 per survey
completed.
15
Throughout our analysis (with the exception of the number of observations reported in Table 1) we use the
monthly survey weights of the SCE in order to obtain an estimation sample that is representative of the population
of U.S. household heads. See Armantier et al. (2017) for more details on the construction of these weights. We
also Winsorize the top 5 percentile of the distributions of realized earnings and earnings beliefs.
16
51% (1,536) of these observations correspond to the sub-sample of respondents who are reinterviewed at least
once.

25

reject RE (at the 5% level) when we apply our test separately for white (non-Hispanics) and
minorities, as well as low vs. high numeracy test scores.17 Third, the results from our test point
to beliefs formation being heterogeneous across schooling (college degree vs. no college degree)
and tenure (more or less than 6 months spent in current job) levels. In particular, we cannot
rule out that the beliefs about future earnings of individuals with more schooling experience
correspond to rational expectations with respect to some information set. Similarly, while we
reject RE at any standard level for the subgroup of workers who have accumulated less than
6 months of experience in their current job, we can only marginally reject at the 10% level
RE for those who have been in their current job for a longer period of time. As such, these
findings complement some of the recent evidence from the economics of education and labor
economics literatures that individuals have more accurate beliefs about their ability as they
progress through their schooling and work careers (see, e.g., Stinebrickner and Stinebrickner,
2012; Arcidiacono et al., 2016).
Table 1: Tests of RE on annual earnings
E(Y ‚àí œà)/E(Y )

Naive RE
(p-val)

Full RE
(p-val)

All

0.034

0.23

< 0.001‚àó‚àó

1,565

1,428

Women
Men

0.059
0.025

0.13
0.48

< 0.001‚àó‚àó
0.210

730
835

649
779

White
Minorities

0.032
0.046

0.31
0.43

0.021‚àó
0.006‚àó‚àó

1,200
365

1,097
331

College degree
No college degree

-0.001
0.093

0.96
0.04‚àó

0.130
0.013‚àó

1,106
459

1,053
375

High numeracy
Low numeracy

0.033
0.055

0.28
0.27

0.012‚àó
0.022‚àó

1,158
407

1,070
358

Tenure ‚â§ 6 months
Tenure > 6 months

0.105
0.007

0.24
0.81

0.001‚àó‚àó
0.091‚Ä†

271
1,294

180
1,248

Number of obs.
œà
Y

Notes: significance levels: ‚Ä† : 10%, ‚àó : 5%, ‚àó‚àó : 1%. ‚ÄúNaive RE‚Äù denotes the naive
RE test of equality of means between Y and œà. ‚ÄúFull RE‚Äù denotes the test without
covariates, where we test H0S with q(y, c) = y/c. We use 5,000 bootstrap simulations
to compute the critical values of the Full RE test. Distributions of realized earnings
(Y ) and earnings beliefs (œà) are both Winsorized at the 95% quantile.

Fourth, using the naive test of equality of means between earnings beliefs and realizations, one
would instead generally not reject the null at any standard levels. The only exception is the
17

Respondents‚Äô numeracy is evaluated in the SCE through five questions involving computation of sales, interests
on savings, chance of winning lottery, of getting a disease and being affected by a viral infection. Respondents
are then partitioned into two categories: ‚ÄúHigh numeracy‚Äù (4 or 5 correct answers), and ‚Äúlow numeracy‚Äù (3 or
fewer correct answers).

26

subgroup of workers without a college degree, for whom the naive test yields rejection of RE
at the 5% level. But, as discussed before, one cannot rule out that such a rejection is due to
aggregate shocks.
Even though individuals in the overall sample form expectations over their earnings in the
near future that are realistic, in the sense of not being significantly biased, the result from our
preferred test shows that earnings expectations are nonetheless not rational. Taken together,
these findings highlight the importance of incorporating the additional restrictions of rational
expectations that are embedded in our test, using the full distributions of subjective beliefs and
realized outcomes to detect violations of rational expectations.
We do not report in this table the results of the direct test of RE. Beyond the obvious implication
that restricting to the subsample of individuals who are followed over four months results in a
loss of statistical power, there are a couple of important issues associated with the direct test.
First, as already discussed in Section 2.2.4, the direct test is not robust to measurement errors on
the subjective beliefs œà. Second, attrition from the survey may be endogenous. To explore this
possibility, we report in Table 2 the estimation results from a logit model of attrition on earnings
beliefs, gender, race/ethnicity, college degree attainment, numeracy test score, and tenure.
Table 2: Logit model of attrition
Population
All

Intercept
‚àó‚àó

1.054
(0.264)

œà
‚àó‚àó

-5.279e-06
(1.341e-06)

Male

White

Coll. Degree

Low Num.

Tenure > 6

0.091
(0.108)

-0.249
(0.170)

-0.069
(0.119)

-0.110
(0.125)

-0.559‚àó‚àó
(0.141)

Notes: 1,565 observations. Significance levels: ‚Ä† : 10%,

‚àó

: 5%,

‚àó‚àó

: 1%.

The main takeaway from this table is that earnings beliefs œà are significantly associated with
attrition, even after controlling for this extensive set of characteristics. This result suggests that
individuals for whom we observe both earnings expectations and realizations are likely to earn
more than those who are not followed across the two waves. Along the same lines, a KolmogorovSmirnov test rejects at the 1% level the equality of the distributions of realized earnings between
the whole sample and the subsample that would be used for the direct test. Similarly, we reject
the equality of the distributions of expected earnings between these two samples. These results
indicate that, in this context, the direct RE test is likely to be misleading.
Finally, going beyond testing, Figure 3 offers additional insights regarding the deviations from
rational expectations on earnings. We focus on the whole population, for which, using our test,
we strongly reject (at the 0.1% level) the hypothesis of rational expectations. This figure shows
that deviations from rational expectations are in fact primarily due to the coexistence of overpessimistic (i.e., individuals for whom earnings beliefs are smaller than the RE constructed from
27

minimal deviations) and over-optimistic individuals.

Notes: pointwise confidence intervals are obtained by percentile bootstrap, with 200 bootstrap samples.
All results are in 2015 US dollars.

Figure 3: Minimal deviations from RE

Both types of deviations from rational expectations largely offset one another when computing
the average across all observations, so that the naive test fails to detect this pattern of violations
from rational expectations. In contrast, our test, which exploits the full distributions of earnings
beliefs and realizations, is able to detect these deviations. We observe similar patterns within
sub-populations for which we reject RE. In particular, we report in Figure 6 in Appendix E the
minimal deviations from RE for the subsample of workers without a college degree. This graph
points again to a substantial degree of over-pessimism for low values of œà, and over-optimism
for larger values of œà, with even larger deviations (in relative terms) from rational expectations
than in the whole population.

6.3

Deviation from RE in a life-cycle consumption model

In this section, we examine the sensitivity of a standard life-cycle incomplete markets (SIM)
model of consumption to the relaxation of the assumption that individuals form rational expectations about their future earnings. In the baseline SIM model, as in the vast majority of
life-cycle consumption models, the rational expectations hypothesis is maintained. However,
if a substantial fraction of the individuals do not have rational expectations on their future
earnings, some of the conclusions that are drawn from this model may be misleading. In the
following, we address this issue by conducting a sensitivity analysis along the lines of Section 4.2.
28

Specifically, we use a benchmark SIM model as a starting point, which we modify to account for
the fact that individuals may not have rational expectations about their income process. Using
this framework, we then illustrate how the minimal deviations from rational expectations that
are consistent with the SCE data impact partial insurance mechanisms, and in particular the
predicted effects of transitory and permanent income shocks on consumption.
6.3.1

Benchmark model and deviation

The SIM model we consider closely resembles that of Kaplan and Violante (2010, KV), who also
focus on the responsiveness of consumption to income shocks. Time is assumed to be discrete,
t ‚àà {1, ..., T }. The economy is constituted of agents (household heads) who work for T ret ‚àí 1
periods, before retiring. Their unconditional probability of surviving until period t is denoted
by Œæt , and we assume that Œæt = 1 for all t < T ret (and ŒæT +1 = 0). Agents are assumed not to be
altruistic. At each period t, consumption, income and assets of agent i are denoted respectively
by Ci,t , Yi,t and Ai,t , with Ai,1 = 0. The assets are made of a tradable risk-free one-period bond
with a rate of return r. Assuming perfect annuity markets, the budget constraint can be written
as follows:


Œæt
Ai,t+1 = (1 + r)Ai,t + Yi,t .
(10)
Ci,t +
Œæt+1
We also assume that agent i faces at each period a constraint on the level of her assets,
Ai,t ‚â• A.

(11)

Agents are forward-looking, and choose at the beginning of period t, if still alive and before
observing their income, their sequence of consumption. They do so by sequentially maximizing
the present value of subjective expected lifetime utility given their information set, denoted by
Ii,t‚àí1 for agent i, and given the constraints in (10)-(11). This present value at period t is equal
to
#
" T
X 0 Œæt0

(12)
E
Œ≤ t ‚àít u Ci,t0 Ii,t‚àí1 ,
Œæt
0
t =t

where Œ≤ denotes the discount factor and u(.) is the flow utility of consumption. E [¬∑|Ii,t‚àí1 ] denotes
the (conditional) subjective expectation operator. In order to make the problem tractable, we
assume that this operator shares the same properties as the conditional expectation operator
E [¬∑|Ii,t‚àí1 ], the key difference being that it integrates over the subjective - rather than the true
- conditional distribution of the data.
During worklife (t < T ret ), the log income ln(Yi,t ) is supposed to be the sum of a deterministic
experience profile, Œ∫i,t , a permanent component, zi,t‚àí1 , a permanent shock, Œ∑i,t , and a transitory

29

shock, i,t :
ln (Yi,t ) = Œ∫i,t + zi,t + i,t ,
zi,t = zi,t‚àí1 + Œ∑i,t .
We also assume that i,t and Œ∑i,t are normally distributed with mean zero and variances œÉ2 and œÉŒ∑2
respectively. They are mutually independent and independent over time and across agents. The
initial permanent shock zi,0 is also normally distributed with mean zero and variance œÉz20 . As in
KV, we assume that the information set at date t, It , is composed of the permanent component
zi,t‚àí1 , as well as past transitory shocks. Finally, when t ‚â• T ret , the post-retirement social
security transfers Yi,t are computed as a piecewise constant function of the lifetime individual
income, following the procedure described pp.64-65 in KV.
We adopt the following specification for the model. As in KV, we suppose that agents start
working in the first period (t = 1), at age 25; we then set T ret = 35 and T = 70 (years). We fix
the interest rate r at 3% and consider two extreme cases for A: a natural borrowing constraint
(NBC) economy, with A = ‚àí108 , and a zero borrowing constraint (ZBC) economy, with A = 0.
Following, e.g., Hall and Mishkin (1982), we use a quadratic specification for the flow utility of
consumption, namely u(C) = ‚àí(C ‚àó ‚àí C)2 /2, with C ‚àó = 200, 000. Finally, as in KV and given
the model in hand, the discount factor Œ≤ is set to match an aggregate wealth-income target ratio
of 2.5.
Finally, we consider two alternative specifications regarding the subjective expectations. First,
in the benchmark model, all individuals form rational expectations on their future income.
Second, we consider an alternative specification in which individual beliefs deviate from rational
expectations, and replace the rational expectations on Yit by the pseudo-beliefs, following the
approach described in Section 4.2.18 Specifically, using our previous notation, the pseudo-beliefs
on income are computed as a function of the rationally expected income as follows:
E [Yi,t |Ii,t‚àí1 ] = hM (E [Yi,t |Ii,t‚àí1 ]) .

(13)

where the function hM is estimated using the empirical counterpart of (denoting by œàt the
subjective beliefs at period t < T ret ):
M

h (y) =

1
T ret ‚àí 1

ret ‚àí1
TX

Fœà‚àí1
‚ó¶ FE[Yt |It‚àí1 ] (y).
t

(14)

t=1

We provide additional details regarding the specification of the model, in particular the income
process, as well as the estimation of the pseudo-beliefs in Appendix E.2.
18

Given the specification of the model, and in particular the quadratic specification of the utility of consumption,
one can show that the optimal consumption path depends on the subjective expectations on Yit only.

30

6.3.2

Results

A Kolmogorov-Smirnov test rejects at the 1% level the equality of the distributions of rationally
expected income and the pseudo income beliefs obtained using (13), with a p-value lower than
10‚àí5 . This indicates that, consistent with the earlier findings discussed in Section 6.2, RE does
not hold in this context. Figure 4 displays b
hM used in equation (13) to compute the pseudobeliefs from the rational expectations. We return to this graph below when we discuss the
sources and consequences of departures from RE in the context of our model.

Notes: pointwise confidence intervals are obtained by percentile bootstrap, with 200 bootstrap samples.
All results are in 2015 US dollars.

Figure 4: Estimate of hM

Next, and following KV, we simulate the model both in the zero borrowing constraint case and in
the natural borrowing constraint case, for an artificial panel of 10,000 households for 70 periods.
Our main object of interest is the partial insurance coefficient, namely the share of the variance
of the income shock xi,t (with x ‚àà {Œ∑, }) that does not translate into consumption growth:
œÜx = 1 ‚àí

Cov(‚àÜ ln(Ci,t ), xi,t )
,
V(xi,t )

where the covariance and variance are computed cross-sectionally over the entire population
of agents between ages 25 and 60. We also consider and discuss below œÜxt , which is the same
quantity but computed conditionally on being of age 24 + t.
We report the partial insurance coefficients to permanent income shocks (œÜŒ∑ ) and transitory
income shocks (œÜ ) in Table 3 below. We first display the coefficients under rational expectations,
31

and then the estimates obtained under our minimal deviations from RE. The changes in the
insurance coefficients across both scenarios reflect the changes in the income expectations (RE
vs. pseudo beliefs), combined with the change in the discount factor Œ≤ which, in both cases,
is set to match an aggregate wealth-income target ratio of 2.5. Specifically, Œ≤ decreases from
around 97% to 94-95%, depending on the borrowing constraints assumption (ZBC or NBC).19
Table 3: Insurance coefficients under RE or deviations from RE.
Zero borrowing constraint

Model with RE
Model with deviations
from RE

Natural borrowing constraint

œÜŒ∑

œÜ

Œ≤

œÜŒ∑

œÜ

Œ≤

0.223
0.425
(0.019)

0.757
0.539
(0.019)

0.971
0.938
(0.003)

0.100
0.568
(0.068)

0.938
0.728
(0.038)

0.973
0.947
(0.003)

Notes: we use œÉŒ∑2 = 0.02, œÉ2 = 0.05, œÉz20 = 0.15, and an aggregate wealth-income ratio of 2.5.
Standard errors in parentheses.

Turning to our main parameters of interest, we find that consumption responses to both transitory and permanent income shocks are significantly affected by the minimal deviations from
RE. In particular, consumption is found to be significantly less responsive to permanent income
shocks when we relax RE, with substantial increases in the partial insurance coefficient œÜŒ∑ for
both ZBC and NBC specifications. In that sense, accounting for deviations from RE with our
pseudo-beliefs takes the model predictions further away from those obtained with a canonical
permanent income hypothesis model (in which œÜŒ∑ = 0). Conversely, accounting for deviations
from RE also results in consumption being more responsive to transitory income shocks (i.e.,
lower insurance coefficient œÜ ). The age profile of the insurance coefficients is also sensitive to the
type of beliefs that are used to simulate the consumption paths. Figure 7 in Appendix E.2 shows
that, in particular, household heads between the ages of 35 and 50 tend to smooth permanent
(transitory) income shocks significantly more (less) when we allow for deviations from RE.
It is interesting to discuss the findings from Table 3 in light of previous empirical estimates that
have been obtained in the consumption literature. In particular, in the presence of borrowing
constraints (ZBC), the partial insurance coefficient to permanent shocks implied by the model
under RE (œÜŒ∑ = 0.22) is lower than the estimated coefficient obtained by Blundell et al. (2008,
BPP) (œÜŒ∑ = 0.36) using US data on income and consumption.20 Accounting for minimal de19

The direction of the change is consistent with prior evidence from lab and field experiments (see, e.g. Andersen
et al., 2008; Andreoni and Sprenger, 2012; Belzil et al., 2017), which generally points to discount factors lower
than 97%.
20
While BPP provide a range of estimates for the insurance coefficient, the estimate 0.36 is obtained when labor

32

viations from RE using our method, the insurance coefficient increases substantially, to about
œÜŒ∑ = 0.43. Hence, relaxing the assumption that agents form rational expectations about their
future incomes reduces the gap between the partial insurance coefficient to permanent shocks
implied by the SIM model, and the empirical estimates obtained by BPP. This suggests that
part of the over-insurance phenomenon to permanent income shocks that has been documented
in the literature (see, e.g., Blundell et al., 2008) may in fact be attributable to departures from
the RE hypothesis that is typically maintained in consumption models. Note that in the natural borrowing constraint (NBC) economy, the model with deviations from RE also results in
significantly larger insurance coefficients to permanent shocks than in the baseline RE model
(0.57 vs. 0.10). While the estimated coefficient that accounts for deviations from RE is larger
than the BPP estimate, the discrepancy remains smaller than in the benchmark RE model.
Turning to the transitory income shocks, we find that relaxing RE results in a significant decrease, of about 20 pp. for both ZBC and NBC cases, in the insurance coefficients œÜ . This
suggests that departures from RE also play a role in accounting for the excess sensitivity of
consumption to transitory shocks that has been documented in some of the literature using
standard realized data on income and consumption (see, e.g., Hall and Mishkin, 1982), and,
more recently, in Kaufmann and Pistaferri (2009), using subjective expectations data from the
Survey of Household Income and Wealth in Italy.
In order to shed light on the underlying mechanisms, it is instructive to examine the lifetime
net worth profiles that are implied by the model with RE, versus the model where we relax RE
using the pseudo-beliefs. These profiles are plotted in Figure 8 in Appendix E.2. A couple of
comments are in order. First, household heads below 40 are less indebted in the model with
deviations from RE. This is due to the fact that, for more than half of them, their expected
income is between 40,000$ and 100,000$ and thus, from Figure 4, they tend to be over-pessimistic
(i.e., pseudo-beliefs are smaller than RE). It follows that they tend to insure more than in the
RE model against permanent shock. Second, later in the life-cycle, household heads tend to
be over-optimistic. This translates into a lower propensity to insure against transitory shocks
compared with the RE environment, which, in turn, results in a stepper decay of the assets after
retirement in Figure 8.21
Taken together, the findings from this analysis show that accounting for minimal deviations
from rational expectations results in significant and sizable changes in the predicted consumpincome is defined as household earnings after tax and transfers, and, as such, is arguably the relevant benchmark
here.
21
The model with deviations from RE fits the data substantially better than the benchmark model, comparing
the worth profiles for both models to the local linear regression obtained from the 1992 Survey of Consumer
Finance (SCF) data (the dotted curves in Figure 8). This is true in particular around and after retirement age.
Over the life cycle, the average prediction error decreases by about 16.5% in both ZBC and NBC cases when we
allow for deviations from RE.

33

tion responses to both transitory and permanent income shocks. As such, they highlight the
importance of collecting subjective expectations data in order to analyze consumption dynamics
while allowing for departures from rational expectations.

7

Conclusion

In this paper, we develop a new test of rational expectations that can be used in a broad
range of empirical settings. In particular, our test only requires having access to the marginal
distributions of realizations and subjective beliefs, and, as such, can be applied in frequent
cases where realizations and beliefs are observed in two separate datasets. We establish that
whether one can rationalize rational expectations is equivalent to the distribution of realizations
being a mean-preserving spread of the distribution of beliefs, a condition which can be tested
using recent tools from the moment inequalities literature. We show that our test can easily
accommodate covariates and aggregate shocks, and, importantly for practical purpose, is robust
to some degree of measurement errors on the elicited beliefs.
Going beyond testing, we also introduce the concept of minimal deviations from rational expectations that can be rationalized by the data. Using recent tools from the optimal transport
literature, we show that, under mild regularity conditions, these deviations exist, are unique,
and are also easily estimated. In the context of structural models, these deviations offer a novel
and tractable way to conduct a sensitivity analysis on the assumed form of expectations.
We apply our method to test and quantify deviations from rational expectations about future
earnings. While individuals tend to be right on average about their future earnings, our test
strongly rejects rational expectations. Using the deviations from rational expectations within a
standard life-cycle incomplete markets, we then provide evidence that the behavioral responses
of consumers to income shocks are sensitive to departures from rational expectations. In particular, our results suggest that part of the over-insurance to permanent income shocks that has
been documented in the literature is attributable to departures from the rational expectations
hypothesis.

34

References
Agarwal, N. and Somaini, P. (2018), ‚ÄòDemand analysis using strategic reports: an application
to a school choice mechanism‚Äô, Econometrica 86(2), 391‚Äì444.
Aguirregabiria, V. and Mira, P. (2010), ‚ÄòDynamic discrete choice structural models: A survey‚Äô,
Journal of Econometrics 156, 38‚Äì67.
Andersen, S., Harrison, G. W., Morten, L. and E., R. E. (2008), ‚ÄòEliciting risk and time preferences‚Äô, Econometrica 76(3), 583‚Äì618.
Andreoni, J. and Sprenger, C. (2012), ‚ÄòEstimating time preferences from convex budgets‚Äô, American Economic Review 102(7), 3333‚Äì56.
Andrews, D. (1994), ‚ÄòEmpirical process methods in econometrics‚Äô, Handbook of econometrics
4, 2247‚Äì2294.
Andrews, D. and Shi, X. (2013), ‚ÄòInference based on conditional moment inequalities‚Äô, Econometrica 81(2), 609‚Äì666.
Andrews, D. and Shi, X. (2017), ‚ÄòInference based on many conditional moment inequalities‚Äô,
Journal of Econometrics 196(2), 275‚Äì287.
Andrews, I., Gentzkow, M. and Shapiro, J. M. (2017), ‚ÄòMeasuring the sensitivity of parameter
estimates to estimation moments‚Äô, The Quarterly Journal of Economics 132(4), 1553‚Äì1592.
Arcidiacono, P., Aucejo, E., Maurel, A. and Ransom, T. (2016), College attrition and the
dynamics of information revelation. NBER Working Paper No. 22325.
Arcidiacono, P., Hotz, J. and Kang, S. (2012), ‚ÄòModeling college major choices using elicited
measures of expectations and counterfactuals‚Äô, Journal of Econometrics 166(1), 3‚Äì16.
Arcidiacono, P., Hotz, J. V., Maurel, A. and Romano, T. (2014), Recovering ex ante returns
and preferences for occupations using subjective expectations data, Technical report. NBER
Working Paper No. 20626.
Armantier, O., Topa, G., Van der Klaauw, W. and Zafar, B. (2017), ‚ÄòAn overview of the survey
of consumer expectations‚Äô, Economic Policy Review 23(2), 51‚Äì72.
Armstrong, T. B. and KolesaÃÅr, M. (2018), ‚ÄòSensitivity analysis using approximate moment condition models‚Äô. Working paper.
Beare, B. and Shi, X. (2018), ‚ÄòAn improved bootstrap test of density ratio ordering‚Äô, Econometrics and Statistics forthcoming.
35

Belzil, C., Maurel, A. and SidibeÃÅ, M. (2017), Estimating the value of higher education financial
aid: Evidence from a field experiment, Technical report. NBER Working Paper No. 23641.
Blundell, R. (2017), ‚ÄòWhat have we learned from structural models?‚Äô, American Economic Review: Papers and Proceedings 107(5), 287‚Äì292.
Blundell, R., Pistaferri, L. and Preston, I. (2008), ‚ÄòConsumption inequality and partial insurance‚Äô, The American Economic Review 98(5), 1887‚Äì1921.
Bonhomme, S. and Weidner, M. (2018), ‚ÄòMinimizing sensitivity to model misspecification‚Äô, arXiv
preprint arXiv:1807.02161 .
Bound, J., Brown, C. and Mathiowetz, N. (2001), ‚ÄòMeasurement error in survey data‚Äô, Handbook
of Econometrics 5, 3705‚Äì3843.
Buchinsky, M. and Leslie, P. (2010), ‚ÄòEducational attainment and the changing u.s. wage
structure: Dynamic implications on young individuals‚Äô choices‚Äô, Journal of Labor Economics
28(3), 541‚Äì594.
Buchinsky, M., Li, F. and Liao, Z. (2018), ‚ÄòEstimation and inference of semiparametric models
using data from several sources‚Äô. Working paper.
Chen, X., Linton, O. and Van Keilegom, I. (2003), ‚ÄòEstimation of semiparametric models when
the criterion function is not smooth‚Äô, Econometrica 71(5), 1591‚Äì1608.
Chernozhukov, V., Chetverikov, D. and Kato, K. (2018), ‚ÄòInference on causal and structural
parameters using many moment inequalities‚Äô, Review of Economic Studies pp. 1‚Äì40.
Conlon, J. J., Philossoph, L., Wiswall, M. and Zafar, B. (2018), Labor market search with
imperfect information and learning, Technical report. NBER Working Paper No. 24988.
Cross, P. J. and Manski, C. F. (2002), ‚ÄòRegressions, short and long‚Äô, Econometrica 70(1), 357‚Äì
368.
Cunha, F. and Heckman, J. J. (2007), ‚ÄòIdentifying and estimating the distributions of ex post
and ex ante returns to schooling‚Äô, Labour Economics 14(6), 870‚Äì93.
Davydov, Y. A., Lifshits, M. A. and Smorodina, N. V. (1998), Local properties of distributions
of stochastic functionals, American Mathematical Society.
de Paula, A., Shapira, G. and Todd, P. E. (2014), ‚ÄòHow beliefs about hiv status affect risky
behaviors: Evidence from malawi‚Äô, Journal of Applied Econometrics 29(6), 944‚Äì964.
Delavande, A. (2008), ‚ÄòPill, patch, or shot? subjective expectations and birth control choice‚Äô,
International Economic Review 49(3), 999‚Äì1042.
36

Delavande, A. and Zafar, B. (2018), ‚ÄòUniversity choice: the role of expected earnings, nonpecuniary outcomes, and financial constraints‚Äô, Journal of Political Economy forthcoming.
D‚ÄôHaultf≈ìuille, X., Gaillac, C. and Maurel, A. (2018), Rationalexp: Tests of and deviations
from rational expectations. Working paper.
Elliott, G., Komunjer, I. and Timmermann, A. (2005), ‚ÄòEstimation and testing of forecast
rationality under flexible loss‚Äô, Review of Economic Studies 72(4), 1107‚Äì1125.
Fan, Y., Sherman, R. and Shum, M. (2014), ‚ÄòIdentifying treatment effects under data combination‚Äô, Econometrica 82(2), 811‚Äì822.
Fuster, A., Kaplan, G. and Zafar, B. (2018), What would you do with $500? spending responses
to gains, losses, news and loans, Technical report. NBER Working Paper No. 24386.
Galichon, A. (2016), Optimal transport methods in economics, Princeton University Press.
Gennaioli, N., Ma, Y. and Shleifer, A. (2015), Expectations and investment, in ‚ÄòNBER Macroeconomics Annual 2015, Volume 30‚Äô, University of Chicago Press.
Gourieroux, C. and Pradel, J. (1986), ‚ÄòDirect test of the rational expectation hypothesis‚Äô, European Economic Review 30(2), 265‚Äì284.
Gozlan, N., Roberto, C., Samson, P.-M., Shu, Y. and Tetali, P. (2018), ‚ÄòCharacterization of a
class of weak transport-entropy inequalities on the line‚Äô, Annales de l‚ÄôIHP 54(3), 1667‚Äì1693.
Gutknecht, D., Hoderlein, S. and Peters, M. (2018), ‚ÄòConstrained information processing and
individual income expectations‚Äô. Working paper.
Hall, R. E. and Mishkin, F. S. (1982), ‚ÄòThe sensitivity of consumption to transitory income:
Estimates from panel data on households‚Äô, Econometrica 50(2), 461‚Äì81.
Hansen, L. P. and Jagannathan, R. (1997), ‚ÄòAssessing specification errors in stochastic discount
factor models‚Äô, Journal of Finance 52(2), 557‚Äì590.
Hoffman, M. and Burks, S. V. (2017), Worker overconfidence: Field evidence and implications
for employee turnover and returns from training, Technical report. NBER Working Paper No.
23240.
Hsu, Y.-C. (2016), ‚ÄòConsistent tests for conditional treatment effects‚Äô, The Econometrics Journal
20(1), 1‚Äì22.
Ivaldi, M. (1992), ‚ÄòSurvey evidence on the rationality of expectations‚Äô, Journal of Applied Econometrics 7(3), 225‚Äì241.
37

Jin, S., Corradi, V. and Swanson, N. R. (2017), ‚ÄòRobust forecast comparison‚Äô, Econometric
Theory 33(6), 1306‚Äì1351.
Kaplan, G. and Violante, G. L. (2010), ‚ÄòHow much consumption insurance beyond selfinsurance?‚Äô, American Economic Journal: Macroeconomics 2(4), 53‚Äì87.
Kapor, A., Neilson, C. A. and Zimmerman, S. (2018), Heterogeneous beliefs and school choice
mechanisms. NBER Working paper No. 25096.
Kaufmann, K. and Pistaferri, L. (2009), ‚ÄòDisentangling insurance and information in intertemporal consumption choices‚Äô, American Economic Review 99(2), 387‚Äì92.
Keane, M. and Wolpin, K. (1997), ‚ÄòThe career decisions of young men‚Äô, Journal of Political
Economy 105(3), 473‚Äì522.
Kuchler, T. and Zafar, B. (2017), ‚ÄòPersonal experiences and expectations about aggregate outcomes‚Äô. Working paper.
Lovell, M. C. (1986), ‚ÄòTests of the rational expectations hypothesis‚Äô, American Economic Review
76(1), 110‚Äì124.
Manski, C. (2004), ‚ÄòMeasuring expectations‚Äô, Econometrica 72(5), 1329‚Äì1376.
Manski, C. and Molinari, F. (2010), ‚ÄòRounding probabilistic expectations in surveys‚Äô, Journal
of Business & Economic Statistics 28(2), 219‚Äì231.
Molinari, F. and Peski, M. (2006), ‚ÄòGeneralization of a result on ‚Äúregressions, short and long‚Äù‚Äô,
Econometric Theory 22(1), 159‚Äì163.
Muth, J. F. (1961), ‚ÄòRational expectations and the theory of price movements‚Äô, Econometrica
29(3), 315‚Äì335.
Pass, B. (2013), ‚ÄòOptimal transportation with infinitely many marginals‚Äô, Journal of Functional
Analysis 264, 947‚Äì963.
Patton, A. J. and Timmermann, A. (2012), ‚ÄòForecast rationality tests based on multi-horizon
bounds‚Äô, Journal of Business & Economic Statistics 30(1), 1‚Äì17.
Pesaran, M. H. (1987), The limits to rational expectations, Basil Blackwell.
Pollard, D. (1990), Empirical processes: theory and applications, in ‚ÄòNSF-CBMS regional conference series in probability and statistics‚Äô, Institute of Mathematical Statistics and the American
Statistical Association, pp. i‚Äì86.

38

Rachev, S. T. and RuÃàschendorf, L. (1998), Mass Transportation Problems: Volume I: Theory,
Springer Science & Business Media.
Ridder, G. and Moffitt, R. (2007), ‚ÄòThe econometrics of data combination‚Äô, Handbook of Econometrics 6, 5469‚Äì5547.
Rothschild, M. and Stiglitz, J. (1970), ‚ÄòIncreasing risk: I. a definition‚Äô, Journal of Economic
Theory 2(3), 225‚Äì243.
Rust, J. (1987), ‚ÄòOptimal replacement of gmc bus engines: An empirical model of harold zurcher‚Äô,
Econometrica 55(5), 999‚Äì1033.
Santambrogio, F. (2015), ‚ÄòOptimal transport for applied mathematicians‚Äô, BirkaÃàuser .
Stinebrickner, R. and Stinebrickner, T. (2012), ‚ÄòLearning about academic ability and the college
dropout decision‚Äô, Journal of Labor Economics 30(4), 707‚Äì748.
Stinebrickner, R. and Stinebrickner, T. (2014a), ‚ÄòAcademic performance and college dropout:
Using longitudinal expectations data to estimate a learning model‚Äô, Journal of Labor Economics 32(3), 601‚Äì644.
Stinebrickner, R. and Stinebrickner, T. (2014b), ‚ÄòA major in science? initial beliefs and final
outcomes for college major and dropout‚Äô, The Review of Economic Studies 81(1), 426‚Äì472.
Strassen, V. (1965), ‚ÄòThe existence of probability measures with given marginals‚Äô, The Annals
of Mathematical Statistics 36(2), 423‚Äì439.
Suehiro, D., Hatano, K., Kijima, S., Takimoto, E. and Nagano, K. (2012), Online prediction
under submodular constraints, in ‚ÄòInternational Conference on Algorithmic Learning Theory‚Äô,
pp. 260‚Äì274.
Van der Klaauw, W. (2012), ‚ÄòOn the use of expectations data in estimating structural dynamic
choice models‚Äô, Journal of Labor Economics 30(3), 521‚Äì554.
Van der Klaauw, W. and Wolpin, K. I. (2008), ‚ÄòSocial security and the retirement and savings
behavior of low-income households‚Äô, Journal of Econometrics 145(1-2), 21‚Äì42.
Van der Vaart, A. (2000), Asymptotic statistics, Cambridge University Press.
Van der Vaart, A. and Wellner, J. (1996), Weak convergence, in ‚ÄòWeak Convergence and Empirical Processes‚Äô, Springer, pp. 16‚Äì28.
Villani, C. (2008), Optimal transport: old and new, Vol. 338, Springer Science & Business Media.

39

Wiswall, M. and Zafar, B. (2015), ‚ÄòDeterminants of college major choice: Identification using
an information experiment‚Äô, The Review of Economic Studies 82(2), 791‚Äì824.
Wiswall, M. and Zafar, B. (2018), ‚ÄòPreference for the workplace, investment in human capital,
and gender‚Äô, The Quarterly Journal of Economics 133(1), 457‚Äì507.
Zafar, B. (2011a), ‚ÄòCan subjective expectations data be used in choice models? evidence on
cognitive biases‚Äô, Journal of Applied Econometrics 26(3), 520‚Äì544.
Zafar, B. (2011b), ‚ÄòHow do college students form expectations?‚Äô, Journal of Labor Economics
29(2), 301‚Äì348.

40

A

Statistical tests in the presence of aggregate shocks

In this appendix, we show how to adapt the construction of the test statistic and obtain similar
results as in Theorem 2 in the presence
 of aggregate shocks. As explained in Section 2.2.3, we
e
e
mostly have to replace Y by Yc = Dq Ye , c + (1 ‚àí D)œà. Because we include covariates here, as
in Section 3, c is actually a function of X. Also, the true function c0 has to be estimated. We
let b
c denote such a nonparametric estimator, which is based on E(q(Y, c0 (X))|X) = E(œà|X).
When q(y, c) = y ‚àí c or q(y, c) = y/c, we get respectively c0 (X) = E(Y |X) ‚àí E(œà|X) and
c0 (X) = E(Y |X)/E(œà|X), and b
c is easy to compute using nonparametric estimators of E(Y |X)
and E(œà|X).


Because in Proposition 3 (ii) we do not test for a moment equality anymore, m Di , Yei , Xi , h, y




P
reduces to m1 Di , Yec,i , Xi , h, y . We let hereafter mn (h, y) = ni=1 m1 Di , Yec,i , Xi , h, y /n.
b n (h, y) +
In thetest
, we replace, for (y, h) ‚àà 
Y √ó‚à™r‚â•1 Hr , Œ£n (h, y) by Œ£n (h, y) = Œ£
 statistic

 T
b YecÃÇ , V
b YecÃÇ , where Œ£
b YecÃÇ are respectively the sample covariance mab n (h, y) and V
Diag V
‚àö
trix of nmn (h, y) and the empirical variance of YecÃÇ . The last difference with the test considered
in Section 3 is that when using the bootstrap to compute the critical value, we also have to reestimate c0 in the bootstrap sample.
We obtain in this context a result similar to Theorem 2 above, under the regularity conditions

stated in Assumption 5. We let hereafter Cs [0, 1]dX denote the space of continuously differentiable functions of order s on [0, 1]dX that have a finite norm kcks,‚àû = max supx‚àà[0,1]dX c(k) (x) .
|k|‚â§s

We also let, for any function f on a set H, kf kH = supx‚ààH |f (x)|. Finally, when the distribution


  ‚àí1/2
m.
of D, Ye , X is F , KF denotes the asymptotic covariance kernel of n‚àí1/2 Diag V Yec0
Assumption 5
oP (1).


(i) b
c and c0 belong to Cs [0, 1]dX , with s ‚â• dX . Moreover, kb
c ‚àí c0 k[0,1]dX =

(ii) For all y ‚àà Y, q is Lipschitz on Y √ó [‚àíC, C] for some C > kc0 k[0,1]dX . Moreover,
sup(y,c)‚ààY√ó[‚àíC,C] |q(y, c)| ‚â§ M0 ;
(iii) For all c ‚àà R, the function q(¬∑, c) : Y ‚Üí Y is bijective and its inverse q I (¬∑, c) is Lipschitz
on Y;
(iv) Fœà|X (¬∑|x), FY |X (¬∑|x) are Lipschitz on Y uniformly in x ‚àà [0, 1]dX with constants QF,1 satisfying supF ‚ààF0 QF,1 ‚â§ Q1 < +‚àû. Alson Fq(œà,c(X)) , Fq(Y,c(X)) are Lipschitz on [‚àíM0 , M0 ]
with constants QF,2 satisfying supF ‚ààF0 QF,2 ‚â§ Q2 < +‚àû;
h i
(iv) inf F ‚ààF VF Yec2 > 0 and 0 ‚â§ inf F ‚ààF EF [D] ‚â§ supF ‚ààF EF [D] ‚â§ 1 ‚àí 0 for some Œµ0 ‚àà
h i
h i
b F Ye 2 is a consistent estimator of VF Ye 2 .
(0, 1/2). Also, V
c
b
c
41

Part (i) imposes some regularity conditions on c0 and its nonparametric estimator b
c. It is
possible to check such regularity conditions on b
c with kernel or series estimators of E(Y |X) and
E(œà|X). Parts (ii) and (iii) also hold when q(y, c) = y ‚àí c and q(y, c) = q(y)/c, by imposing in
the second case that c belongs to a compact subset of (0, ‚àû). Proposition 5 shows that under
these conditions, the test has asymptotically correct size.
Proposition 5 Suppose that rn ‚Üí ‚àû and that Assumptions 3 and 5 hold. Then (i) in Proposition 2 holds, replacing œïn,Œ± by œïn,Œ±,bc .
Results like (ii) and (iii) in Proposition 2 could also be obtained under the conditions of Proposition 5, modifying directly the proof of Proposition 2.

B

Tests with rounding practices

We have considered in Section 2.2.4 the possibility of measurement errors on œà. Another source
of uncertainty on œà is rounding. Rounding practices by interviewees are common. A way to
interpret these practices is that in situations of ambiguity, individuals may only be able to bound
the distribution of their future outcome Y (Manski, 2004). If individuals round at 5% levels,
for instance, an answer œà = 0.05 for the beliefs about percent increase of income should then
only be interpreted as œà ‚àà [0.025, 0.075]. Another case where only bounds on œà are observed is
when questions to elicit subjective expectations take the following form: ‚ÄúWhat do you think
is the percent chance that your own [Y ] will be below [y]?‚Äù, for a certain grid of y. If 0 and
100 are always observed, or if we assume that the support of subjective distributions is included
in [y, y], we can still compute bounds on œà.22 In such cases, we only observe (œàL , œàU ), with
œàL ‚â§ œà ‚â§ œàU . For a thorough discussion of this issue, and especially of how to infer rounding
practices, see Manski and Molinari (2010).
In this setting, rationalizing rational expectations is less stringent than in our baseline set-up
since the constraints on the distribution of œà are weaker. Formally, the null hypothesis takes
the following form:
H0B : ‚àÉ(Y 0 , œà 0 , I 0 ) : œÉ(œà 0 ) ‚äÇ I 0 , Y 0 ‚àº Y, FœàU ‚â§ Fœà0 ‚â§ FœàL and E(Y 0 |I 0 ) = œà 0 .
To obtain an equivalent formulation to H0B , a natural idea would be to fix a candidate cdf F ‚àà
Ry
[FœàU , FœàL ] for Fœà and apply Theorem 1 with this F . Then, letting ‚àÜF (y) = ‚àí‚àû FY (t) ‚àí F (t)dt
R
and Œ¥F = E(Y ) ‚àí udF (u), H0B would hold as long as for some F ‚àà [FœàU , FœàL ], ‚àÜF (y) ‚â• 0
for all y ‚àà R and Œ¥F = 0. In practice though, directly checking whether such a distribution
exists would be very difficult. Fortunately, we show in the following proposition that it is in fact
22

Note however that in this case, our approach does not take into account all the information on the subjective
distribution.

42

sufficient to check that these conditions hold for a specific candidate distribution. To define the
cdf of this distribution, we introduce, for all b ‚àà R, the random variables
œà b = œàU 1l{œàU < b} + max(b, œàL )1l{œàU ‚â• b}.
We also let œà ‚àí‚àû = œàL and œà +‚àû = œàU . The cdf of œà b is then F b (t) = FœàU (t)1l{t < b} +
FœàL (t)1l{t ‚â• b}, for all b ‚àà R. We let FB = {F b , b ‚àà R} denote the set of all such cdfs.
Assumption 6 E(|Y |) < +‚àû, E(|œàL |) < +‚àû and E(|œàU |) < +‚àû.
Proposition 6 Suppose that Assumption 6 holds. First, if E[œàL ] ‚â§ E[Y ] ‚â§ E[œàU ], there exists
a unique F ‚àó ‚àà FB such that Œ¥F ‚àó = 0. Second, the following statements are equivalent:
(i) H0B holds.
(ii) E[œàL ] ‚â§ E[Y ] ‚â§ E[œàU ] and ‚àÜF ‚àó (y) ‚â• 0 for all y ‚àà R.
This test shares some similarities with the test in the presence of aggregate shocks. Specifically,
if E[œàL ] ‚â§ E[Y ] ‚â§ E[œàU ], we first identify b0 ‚àà R such that the candidate belief œà b0 , which
plays a similar role as the modified outcome q(Y, c0 ) in the test with aggregate shocks, satisfies
the equality
constraint E[œà b0 i] = E[Y ]. Noting that the inequality ‚àÜF ‚àó (y) ‚â• 0 can be rewritten
h
+
‚â• 0, it follows from (ii) that rationalizing RE in this context
as E (y ‚àí Y )+ ‚àí y ‚àí œà b0
(i.e., H0B ) is then equivalent to a set of many moment inequality constraints involving the
distributions of realizations Y and candidate belief œà b0 .

C

Tests with sample selection in the datasets

We consider here cases where the two samples are not representative of the same population, or
formally, D is not independent of (Y, œà). This may arise for instance because of oversampling of
some subpopulations or differences in nonresponse between the two surveys that are used. We
assume instead that selection is conditionally exogenous, that is to say:
D‚ä•
‚ä• (Y, œà)|X.

(15)

We show how to use a propensity score weighting to handle such a selection. Denote by p(x) =
P (D = 1|X = x) = E [D|X = x] the propensity score and by
W (X) =

1‚àíD
D
‚àí
.
p(X) 1 ‚àí p(X)

The law of iterated expectations combined with Proposition 2 directly yields the following proposition:
43

Proposition 7 Suppose that (15) and Assumption 1 hold. Then H0X is equivalent to


+ 
e
|X ‚â• 0
E W (X) y ‚àí Y
h
i
for all y ‚àà R and E W (X)Ye |X = 0.
This proposition shows that under sample selection, we can build a statistical test of H0X akin
to that developed in Section 3, by merely estimating nonparametrically p(X). We could consider
for that purpose a series logit estimator, for instance. Validity of such a test would follow using
very similar arguments as for the test with aggregate shocks considered above.

D

Simulations with covariates

We consider here simulations including covariates. The DGP is similar to that considered in
Section 3. Specifically, we assume that
‚àö
Y = œÅœà +

XŒµ,

with œÅ ‚àà [0, 1], œà ‚àº N (0, 1), X ‚àº Beta(0.1, 10) and
Œµ = Œ∂ (‚àí1l{U ‚â§ 0.1} + 1l{U ‚â• 0.9}) ,
where Œ∂ ‚àº N (2, 0.1) and U ‚àº U[0, 1]. (œà, Œ∂, U, X) are supposed to be mutually independent.
Like in the test without covariates, we can show that the test with covariates is able to reject
RE if and only if œÅ < 0.616. On the other hand, by construction E [Y |X] = E [œà|X], so the naive
conditional test has no power. The test based on conditional variances rejects only if œÅ < 0.445.
Finally, we can show that without using X, our test has power only for œÅ < 0.52. Hence, relying
on covariates allows us to gain power for œÅ ‚àà [0.521, 0.616).
Again, we consider hereafter nœà = nY = n ‚àà {400, 800, 1200, 1600, 3200}, use 500 bootstrap
simulations to compute the critical value, and rely on 800 Monte-Carlo replications for each
value of œÅ and n. We use the same parameters p = 0.05 and b0 = 0.3 as above. Figure 5 shows
that the RE test with covariates asymptotically outperforms the RE test without covariates.
The test exhibits a similar behavior as that without covariates, though, as we could expect, the
power converges less quickly to one as n tends to infinity.

44

Notes: the dotted vertical lines correspond to the theoretical limit for the rejection of the null hypothesis for test based on variance (œÅ ' 0.445), our test without covariates (œÅ ' 0.521) and our tests with
covariates (œÅ = 0.616). The dotted horizontal line corresponds to the 5% level.

Figure 5: Power curves for the test with covariates.

E
E.1

Additional material on the application
Descriptive statistics and minimal deviations for non-college graduates
Table 4: Descriptive statistics of the SCE sample

Male
White
College degree
Low numeracy
Tenure ‚â§ 6 months
Age
œà (Earnings beliefs)
Y (Realized earnings)

Mean

Std. dev.

0.53
0.74
0.49
0.33
0.17
45.8
$50,592
$52,354

0.50
0.43
0.46
0.47
0.38
13.0
$40,889
$38,634

45

Notes: the pointwise confidence intervals are obtained by percentile bootstrap. All results are in 2015
US dollars.

Figure 6: Minimal deviations for individuals without a college degree

E.2

Additional details and results on the life-cycle consumption model

The income process is specified as follows. First, we estimate the deterministic trend Œ∫i,t as a
smooth function of age (second-order polynomial) using the dataset of Blundell et al. (2008)
built from the PSID.23 We use the same value as in the baseline specification of KV for œÉ2 and
œÉz20 , namely œÉ2 = 0.05 and œÉz20 = 0.15. We choose œÉŒ∑2 = 0.02 as it is in the range of Blundell
et al. (2008) and appears to fit the 1989 and 1992 Survey of Consumer Finances data better
than the baseline value used by KV. Our main results remain qualitatively unchanged when we
use the same values as in BPP for both variances œÉ2 (0.037) and œÉŒ∑2 (0.019).
To estimate hM , we rely on (14). Given the specification of our model, E [Yi,t |Ii,t‚àí1 ], when
t < T ret , is lognormally distributed with parameters Œ∫i,t + (œÉŒ∑2 + œÉ2 )/2 and œÉz20 + (t ‚àí 1)œÉŒ∑2 . To
estimate Fœà‚àí1
, we use the subjective beliefs of individuals between 25 and 60 measured in the SCE
t
survey. Since in KV, Yi,t is interpreted as household income after taxes and transfers, whereas
we only observe subjective expectations on individual labor earnings, we use an equipercentile
mapping based on the two distributions of realized (expected) individual labor earnings and
realized (expected) household income. We estimate this equipercentile mapping using the dataset
from Blundell et al. (2008), built from the PSID, where both realized individual labor earnings
and household income are observed from 1989 to 1992. Finally, we assume that the quantile of
income expectations is linear in age, and thus estimate Fœà‚àí1
by a quantile regression of subjective
t
23

Results are robust to the use of a more flexible fourth-order polynomial for Œ∫i,t .

46

expectations on age. We finally estimate hM using (14), replacing Fœà‚àí1
by the quantile regression
t
estimator.
Figure 7: Age profiles of insurance coefficients.

(a) With borrowing constraints

(b) Without borrowing constraints
Notes: the curves in gray (resp. in black) correspond to insurance coefficients under RE (resp. minimal deviations
from RE). The dotted black curves are the 2.5 and 97.5 quantiles of bootstrap simulations, taking into account
the randomness of b
hM . They are obtained using 200 bootstrap samples.

47

Figure 8: Average lifetime net worth (in $00,000) profiles.

(b) Natural borrowing constraint

(a) Zero borrowing constraint

Notes: SCF stands for the 1992 Survey of Consumer Finance. The dotted black curve is the estimated nonparametric regression function of net worth of households in this dataset on age using local polynomials and a
bandwidth selected via cross-validation. The confidence intervals on b
hM are obtained with 200 bootstrap samples.

F
F.1

Proofs
Notation and preliminaries

For any set H, let us denote by l‚àû (H) the collection of all uniformly bounded real functions on
H equipped with the supremum norm kf kH = supx‚ààH |f (x)|. Denote by L2 (F ) the square integrable space with respect to the measure associated with F , and let k¬∑kF,2 be the corresponding
norm. We let N (, T , L2 (F )) denote the minimal number of -balls with respect to k¬∑kF,2 needed
to cover T . An -bracket (with respect to F ) is a pair of real functions (l, u) such that l ‚â§ u
and ku ‚àí lkF,2 ‚â§ . Then, for any set of real functions M, we let N[] (, M, L2 (F )) denote the
minimum number of -brackets needed to cover M. We denote by H = (‚à™r‚â•1 Hr ). For x ‚àà Rd ,
d > 1, we denote by kxk‚àû = maxj=1,...,d |x|.
For a sequence of random variable (Un )n‚ààN and a set F0 , we say that Un = OP (1) uniformly in
F ‚àà F0 if for any  > 0 there exist M > 0 and n0 > 0 such that supF ‚ààF0 PF (|Un | > M ) < 
for all n > n0 . Similarly we say that Un = oP (1) uniformly in F ‚àà F0 if for any  > 0,
supF ‚ààF0 PF (|Un | > ) ‚Üí 0.
48

Finally, we add stars to random variables whenever we consider their bootstrap
versions,
as


‚àó
.
with T versus T . We define oP ‚àó and OP ‚àó as above, but conditional on Yei , Di , Xi
i=1...n


is denoted by ‚Üíd‚àó .
Convergence in distribution conditional on Yei , Di , Xi
i=1...n

F.2

Proof of Lemma 1

Under H0 , there exists Y 0 , œà 0 and I 0 such that Y 0 ‚àº Y , œà 0 ‚àº œà, œÉ(œà 0 ) ‚äÇ I 0 and E(Y 0 |I 0 ) = œà 0 .
Then, by the law of iterated expectations,
 
 


E[Y 0 |œà 0 ] = E E Y 0 I 0 œà 0 = E œà 0 |œà 0 = œà 0 .
Conversely, if there exists (Y 0 , œà 0 ) such that Y 0 ‚àº Y , œà 0 ‚àº œà and E[Y 0 |œà 0 ] = œà 0 , let I 0 = œÉ (œà 0 ).
Then œà 0 = E [Y 0 |œà 0 ] = E [Y 0 |I 0 ] and H0 holds.

F.3

Proof of Theorem 1.

(i) ‚áî (iii). By Strassen‚Äôs theorem (Strassen, 1965, Theorem 8), the existence of (Y, œà) with
R
R
margins equal to FY and Fœà and such that E [Y |œà] = œà is equivalent to f dFœà ‚â§ f dFY
for every convex function f . By, e.g., Proposition 2.3 in Gozlan et al. (2018), this is, in turn,
equivalent to (iii).
hR
i
Ry
y
(ii) ‚áî (iii). By Fubini-Tonelli‚Äôs theorem, ‚àí‚àû FY (t)dt = E ‚àí‚àû 1l{t ‚â• Y }dt = E [(y ‚àí Y )+ ] .




The same holds for œà. Hence, ‚àÜ(y) ‚â• 0 for all y ‚àà R is equivalent to E (y ‚àí Y )+ ‚â• E (y ‚àí œà)+
for all y ‚àà R. The result follows.

F.4

Proof of Proposition 1.

First, by Jensen‚Äôs inequality,
E[(y0 ‚àí Y )+ |œà] ‚â• (y0 ‚àí E(Y |œà))+ = (y0 ‚àí œà)+ .
Moreover, ‚àÜ(y0 ) = 0 implies that E((y0 ‚àí Y )+ ) = E((y0 ‚àí œà)+ ). Hence, almost surely,
E[(y0 ‚àí Y )+ |œà] = (y0 ‚àí œà)+ .
Equality in the Jensen‚Äôs inequality implies that the function is affine on the support of the
random variable. Therefore, for almost all u, we either have S(Y |œà = u) ‚äÇ [y0 , +‚àû) or S(Y |œà =
u) ‚äÇ (‚àí‚àû, y0 ]. Because E [Y |œà] = œà, S(Y |œà = u) ‚äÇ [y0 , +‚àû) for almost all u > y0 and
S(Y |œà = u) ‚äÇ (‚àí‚àû, y0 ] for almost all u < y0 . Then, for all œÑ ‚àà (0, 1), FY‚àí1
|œà (œÑ |u) ‚â• y0 for almost
‚àí1
all u ‚â• y0 and FY |œà (œÑ |u) ‚â§ y0 for almost all u ‚â§ y0 . Thus, for all œÑ ‚àà (0, 1), by continuity of
‚àí1
FY‚àí1
|œà (œÑ |¬∑), FY |œà (œÑ |y0 ) = y0 . This implies that Y |œà = y0 is degenerate.

49

F.5

Proof of Proposition 2.

We first prove that H0X is equivalent to the existence of (Y 0 , œà 0 ) such that DY 0 + (1 ‚àí D)œà 0 = Ye ,
D ‚ä•
‚ä• (Y 0 , œà 0 )|X and E((Y 0 |œà 0 , X) = œà 0 . First, under H0X , there exists (Y 0 , œà 0 , I 0 ) such that
DY 0 + (1 ‚àí D)œà 0 = Ye , D ‚ä•
‚ä• (Y 0 , œà 0 )|X, œÉ(œà 0 , X) ‚äÇ I 0 andE((Y 0 |I 0 ) = œà 0 . Then
 




E[Y 0 |œà 0 , X] = E E Y 0 I 0 œà 0 , X = E œà 0 |œà 0 , X = œà 0 .
Conversely, if there exists (Y 0 , œà 0 ) such that DY 0 + (1 ‚àí D)œà 0 = Ye , D ‚ä•
‚ä• (Y 0 , œà 0 )|X and
E(Y 0 |œà 0 , X) = œà 0 , let I 0 = œÉ (X 0 , œà 0 ). Then œà 0 = E(Y 0 |œà 0 , X) = E(Y 0 |I 0 ) and H0X holds.
The proposition then follows as Theorem 1.

F.6

Proof of Proposition 4

For all y, Œæ 7‚Üí E[(y ‚àí œà ‚àí Œæ)+ ] is decreasing and convex. Then, because FŒæœà dominates at the
second order FŒæY +Œµ ,
Z
Z




E (y ‚àí œà ‚àí Œæ)+ dFŒµ+ŒæY (Œæ) ‚â• E (y ‚àí œà ‚àí Œæ)+ dFŒæœà (Œæ).
As a result, for all y,

+  Z 

b
E y‚àíY
= E (y ‚àí œà ‚àí Œµ ‚àí ŒæY )+ |Œµ + ŒæY = Œæ dFŒµ+ŒæY (Œæ)
Z


= E (y ‚àí œà ‚àí Œæ)+ dFŒµ+ŒæY (Œæ)
Z


‚â• E (y ‚àí Œæ ‚àí œà)+ dFŒæœà (Œæ)
i
h
b+ .
=E (y ‚àí œà)
 
 
Moreover, E Yb = E œàb . By Theorem 1, Yb and œàb satisfy H0 .

F.7

Proof of Theorem 2.

(i) This is a particular case of Proposition 5 below, with q(Y, c0 ) = Y . The proof is therefore
omitted.
(ii) We show that equality holds for F0 ‚àà F0 satisfying the conditions stated in (ii). The proof
is divided in three steps. We first prove convergence in distribution of T to S defined below,
and conditional convergence of T ‚àó towards the same limit. Then we show that the cdf H of S
is continuous and strictly increasing in the neighborhood of its quantile of order 1 ‚àí Œ±, for any
Œ± ‚àà (0, 1/2). The third step concludes.
1. Convergence in distribution of T and T ‚àó .
50

First, let us introduce some notation. Let Kj,j (j ‚àà {1, 2}) be the j-th diagonal element




1/2 +2
1/2 2
of the covariance kernel K, S : (ŒΩ, K) 7‚Üí (1 ‚àí p) ‚àíŒΩ1 /K1,1
+ p ŒΩ2 /K2,2 , q(r) =
‚àí1
r2 + 100
(2r)‚àídX , and
n


 ‚àí1/2  

h 
i
1 X
Diag VF0 Ye
m Di , Yei , Xi , h, y ‚àí EF0 m Di , Yei , Xi , h, y
.
ŒΩn,F0 (y, h) = ‚àö
n
i=1

Finally, we define kn,F0 (y, h) =

n1/2 Diag



h 
i
 ‚àí1/2
e
e
EF0 m Di , Yi , Xi , h, y ,
VF0 Y


 ‚àí1/2

 ‚àí1/2

‚àö
‚àö
d
Kn,F0 (y, h, y 0 , h0 ) = Diag VF0 Ye
Cov
nmn (y, h), nmn (y 0 , h0 ) Diag VF0 Ye
  

 ‚àí1/2

 ‚àí1/2
b Ye Diag VF Ye
Diag V
K n,F0 (y, h, y 0 , h0 ) = Kn,F0 (y, h, y 0 , h0 ) + Diag VF0 Ye
0
and use the notations Kn,F0 (y, h) = Kn,F0 (y, h, y, h) and K n,F0 (y, h) = K n,F0 (y, h, y, h).
With this notation, we have, by definition of T ,
T = sup
y‚ààY

X


q(r)S ŒΩn,F0 (y, ha,r ) + kn,F0 (y, ha,r ), K n,F0 (y, ha,r ) .

(a,r):r‚àà{1,...,rn },a‚ààAr

To characterize the distribution of T (resp. T ‚àó ), we first prove the convergence of ŒΩn,F0 and
‚àó
‚àó
Kn,F0 (y, ha,r ) (resp. ŒΩn,F
and Kn,F
(y, ha,r )). For those purposes, we use a class of functions
0
0
which is a general form taken by m1 defined in (2), namely for any 0 < N1 < M1 , the class of
functions

M0 = {fy,œÜ1 ,œÜ2 ,h (e
y , x, d) = dœÜ1 (y ‚àí ye)+ ‚àí (1 ‚àí d)œÜ2 (y ‚àí ye)+ h(x),
(y, œÜ1 , œÜ2 , h) ‚àà Y √ó [N1 , M1 ]2 √ó H}.
Remark first that this class is a particular case of classes M defined in (25) below. Then, by
the proof of Proposition 5 below, Assumptions PS1 and PS2 in AS are satisfied. Thus the
assumptions of Lemma D.2 in AS hold as well. This entails that Assumptions PS4 and PS5 in
AS hold. Namely, there exists a Gaussian process ŒΩF0 such that
‚àó
- ŒΩn,F0 ‚Üíd ŒΩF0 and ŒΩn,F
‚Üíd‚àó ŒΩF0 ;
0
‚àó
(y, h) ‚ÜíP ‚àó
- For all r ‚àà N and (y, h) ‚àà Y √ó Hr , K n,F0 (y, h) ‚ÜíP KF0 (y, h) + I2 and Kn,F
0
KF0 (y, h) + I2 , where I2 is the 2 √ó 2 identity matrix.

Moreover, letting kF0 (y, h) denote the limit in probability of kn,F0 (y, h), we have kF0 (y, h) = 0
if (y, h) ‚àà LF0 and +‚àû otherwise. Note that by assumption, the set LF0 is nonempty.

51

Thus, using Equation (D.11) in the proof of Theorem D.3. in AS, which is based on the uniform
continuity of the function S in the sense of Assumption S2 therein, we have, under F0 ,
X
S (ŒΩF0 (y, ha,r ) + kF0 (y, h), KF0 (y, ha,r ) + I2 )
T ‚Üíd sup
y‚ààY

(a,r)‚ààAr √óN

X

= S := sup
y‚ààY

q(r)S (ŒΩF0 (y, ha,r ), KF0 (y, ha,r ) + I2 ) ,

(a,r):(y,ha,r )‚ààLF0

where the equality follows by definition of S and kF0 (y, h). Similarly, using Assumption PS5
and (D.11) in AS, replacing T by T ‚àó and quantities ŒΩn,F0 (y, ha,r ) and Kn,F0 (y, ha,r ) by their
bootstrap counterparts (see the proof of Lemma D.4 in AS) we have T ‚àó ‚Üíd‚àó S.
2. The cdf H of S is continuous and strictly increasing in the neighborhood of any
of its quantile of order 1 ‚àí Œ± > 1/2.
First, the cdf H of S is a convex functional of the Gaussian process ŒΩF0 . Then, as in the proof
of Lemma B3 in Andrews and Shi (2013), we can use Theorem 11.1 of Davydov et al. (1998)
p.75 to show that H is continuous and strictly increasing at every point of its support except
r = inf{r ‚àà R : H(r) > 0}. Moreover, for any r > 0,
Ô£´
Ô£∂
X
H(r) ‚â• P Ô£≠sup
q(r)S (ŒΩF0 (y, ha,r ), KF0 (y, ha,r ) + I2 ) < rÔ£∏
y‚ààY

(a,r):(y,ha,r )‚ààLF0

‚â•P

‚àí1/2

(K2,F0 ,j,j (y, ha,r ) + )

sup

p
ŒΩF0 ,j (y, ha,r ) <

j‚àà{1,2},(y,a,r):(y,ha,r )‚ààLF0

r/2
Q

!

> 0,
P
where Q = (a,r):(y,ha,r )‚ààLF q(r) < ‚àû and we use Problem 11.3 of Davydov et al. (1998) p.79
0
for the last inequality. Thus, r > r and H is continuous and strictly increasing on (0, ‚àû).
Then, we show that for any Œ± ‚àà (0, 1/2), the quantile of order 1 ‚àí Œ± of the distribution of S is
positive. By assumption, there exists (y0 , h0 ) ‚àà LF0 such that either either KF0 ,11 (y0 , h0 ) > 0
or KF0 ,2 (y0 , h0 ) > 0. Then
Ô£´
Ô£∂
X
P (S > 0) = 1 ‚àí P Ô£≠sup
q(r)S (ŒΩF0 (y, ha,r ), KF0 (y, ha,r ) + I2 ) = 0Ô£∏
y‚ààY

(a,r):(y,ha,r )‚ààLF0

‚â• 1 ‚àí P (ŒΩF0 ,1 (y0 , h0 ) ‚â§ 0, ŒΩF0 ,2 (y, h0 ) = 0)
‚â• 1 ‚àí min {P (ŒΩF0 ,1 (y0 , h0 ) ‚â§ 0) , P (ŒΩF0 ,2 (y0 , h0 ) = 0)}
‚â• 1/2.

(16)

The first inequality holds by definition of the supremum and because S is nonnegative. To
obtain the last inequality, note that either ŒΩF0 ,1 (y0 , h0 ) is non-degenerate, in which case the
52

first probability is 1/2 (since ŒΩF0 ,1 (y0 , h0 ) is normal with zero mean), or ŒΩF0 ,2 (y0 , h0 ) is nondegenerate, in which case the second probability is 0.
Finally, using that H is strictly increasing on (0, ‚àû), (16) ensures that any quantile of S of
order 1 ‚àí Œ± with Œ± ‚àà [0, 1/2) is positive. Hence, H is continuous and strictly increasing in the
neighborhood of any such quantiles.
3. Conclusion.
Using T ‚àó ‚Üíd‚àó S in distribution, Step 2 and Lemma 21.2 in Van der Vaart (2000), we have that
for Œ∑ > 0, c‚àón,Œ± ‚Üíd‚àó c(1 ‚àí Œ± + Œ∑) + Œ∑, where c(1 ‚àí Œ± + Œ∑) is the (1 ‚àí Œ± + Œ∑)-th quantile of the
distribution of S. Because T ‚Üíd S and H is continuous at c(1 ‚àí Œ± + Œ∑) + Œ∑ > 0, we obtain that

lim lim sup PF0 T > c‚àón,Œ± = Œ±.

Œ∑‚Üí0

n‚Üí‚àû

Combined with the inequality of Part (i) above, this yields the result.
 
(iii) This results Theorem E.1 in AS. First, Assumption SIG2 in AS holds for œÉF2 = VF Ye ,
following the proof of Lemma 7.2 (b) under Assumption 3-(ii). Second, Assumptions PS4 and
PS5 are satisfied using the point (ii) above. Third, Assumptions CI, MQ, S1, S3, S4 in AS are
also satisfied by construction of the statistic T . Thus, we can apply Theorem E.1 in AS and the
result follows.


F.8

Proof of Theorem 3.

For any positive convex function œÅ, we let
WœÅ (F, G) =
We also define

Z
G = G cdf :

y

‚àí‚àû

Z

inf

FU,V :U ‚àºF,V ‚àºG

E [œÅ (|U ‚àí V |)] .

y

G(t)dt ‚â§

Z
FY (t)dt ‚àÄy ‚àà R,

Z
ydG(y) =


ydFY (y) .

‚àí‚àû

The proof is divided in three steps. First, we prove that the initial infimum is equal to
inf G‚ààG WœÅ (Fœà , G). Second, we prove that there is a unique G‚àó that reaches this infimum for
all convex function œÅ : R+ ‚Üí R+ such that œÅ(0) = 0. Third, we prove that there is a unique
function g ‚àó such that (4) holds, and that this function is increasing.
1. inf (Y 0 ,œà0 ,œà00 )‚ààŒ® E[œÅ(|œà 0 ‚àí œà 00 |)] = inf G‚ààG WœÅ (Fœà , G).
First, by definition of WœÅ and because for all (Y 0 , œà 0 , œà 00 ) ‚àà Œ® Fœà0 = Fœà , we have
inf

(Y 0 ,œà 0 ,œà 00 )‚ààŒ®

E[œÅ(|œà 0 ‚àí œà 00 |)] =

inf

G:‚àÉ(Y 0 ,œà 0 ,œà 00 )‚ààŒ®: Fœà00 =G

53

WœÅ (Fœà , G).

Thus, it remains to prove that G 0 = G, with G 0 defined by

G 0 = G : ‚àÉ(Y 0 , œà 0 , œà 00 ) ‚àà Œ® : Fœà00 = G .

(17)

First, let G ‚àà G 0 . Let (Y 0 , œà 0 , œà 00 ) ‚àà Œ® be such that Fœà00 = G. By definition of Œ®, we have
E(Y 0 |œà 00 ) = œà 00 and FY 0 = FY . Therefore, by implication (i)‚áí (ii) of Theorem 1 applied to Y 0
and œà 00 , G = Fœà00 ‚àà G. Hence, G 0 ‚äÇ G. Conversely, let G ‚àà G. Then, by implication (ii)‚áí (i)
of Theorem 1, there exists (Y 0 , œà 00 ) such that Y 0 ‚àº Y , Fœà00 = G and E(Y 0 |œà 00 ) = œà 00 . Define
œà 0 = œà. Then (Y 0 , œà 0 , œà 00 ) ‚àà Œ® and G ‚àà G 0 . Equation (17) follows.
2. There exists a unique G‚àó such that for all œÅ, WœÅ (Fœà , G‚àó ) = inf G‚ààG WœÅ (Fœà , G) .
Because Fœà has no atom, the distribution of H ‚àí1 ‚ó¶ Fœà (œà) is H, for any cdf H. Hence, the set

Fg(œà) , g measurable is actually the set of all cdf‚Äôs. Then, by Proposition 3.1 and Remark 3.2
in Gozlan et al. (2018), we have, for any convex function œÅ : R+ ‚Üí R+ such that œÅ(0) = 0,
inf WœÅ (Fœà , G) =

G‚ààG

inf

FY 0 ,œà0 : FY 0 =FY ,Fœà0 =Fœà


 

.
E œÅ œà 0 ‚àí E Y 0 |œà 0

(18)

Third, by Theorem 1.4 in Gozlan et al. (2018), there exists a distribution G‚àó such that
1. For all f convex,

R

f dG‚àó ‚â§

R

f dFY ;

2. for any convex function œÅ : R+ ‚Üí R+ such that œÅ(0) = 0,
inf

FY 0 ,œà0 : FY 0 =FY ,Fœà0 =Fœà


 

= WœÅ (Fœà , G‚àó ).
E œÅ œà 0 ‚àí E Y 0 |œà 0

(19)

By, e.g., Proposition 2.3 in Gozlan et al. (2018), Point (1) is equivalent to G‚àó satisfying (iii) in
Theorem 1. Therefore, in view of Theorem 1, we have G‚àó ‚àà G. Combining (18) and (19), we
obtain:
G‚àó ‚àà arg min WœÅ (Fœà , G).
G‚ààG

Now, G is convex. Moreover, by Lemma 3.2.1 of Pass (2013) and because Fœà has no atom,
G 7‚Üí WœÅ (Fœà , G) is strictly convex for œÅ(x) = x2 . Therefore, G‚àó is the unique minimizer of
G 7‚Üí WœÅ (Fœà , G) for this œÅ. It is therefore the unique G ‚àà G minimizing WœÅ (Fœà , G) for all convex
function œÅ : R+ 7‚Üí R+ such that œÅ(0) = 0.
3. There exists a unique g ‚àó such that E[œÅ(|œà ‚àí g ‚àó (œà)|)] = inf (Y 0 ,œà0 ,œà00 )‚ààŒ® E[œÅ(|œà 0 ‚àí œà 00 |)]
and g ‚àó is increasing.
Let g ‚àó = G‚àó‚àí1 ‚ó¶ Fœà . g ‚àó is increasing. We now prove that it satisfies the equality above. First, by
construction, Fg‚àó (œà) = G‚àó . Moreover, by e.g., Theorem 5.26 of Villani (2008), g ‚àó is the unique
function satisfying
E [œÅ(|œà ‚àí g ‚àó (œà)|)] = WœÅ (Fœà , G‚àó ).
(20)
54

This equation, together with the first and second steps, imply that
E [œÅ(|œà ‚àí g ‚àó (œà)|)] =

inf

(Y 0 ,œà 0 ,œà 00 )‚ààŒ®

E[œÅ(|œà 0 ‚àí œà 00 |)].

(21)

Now, consider g 6= g ‚àó such that Fg(œà) = G‚àó . By unicity of g ‚àó satisfying (20), we have
E [œÅ(|œà ‚àí g(œà)|)] > WœÅ (Fœà , G‚àó ). Finally, if g =
6 g ‚àó is such that Fg(œà) = G 6= G‚àó for some
G ‚àà G, we have, taking œÅ(x) = x2 ,
E [œÅ(|œà ‚àí g(œà)|)] ‚â• WœÅ (Fœà , G) > WœÅ (Fœà , G‚àó ).
Therefore, g ‚àó is the unique function satisfying (21) for all convex function œÅ : R+ 7‚Üí R+ such
that œÅ(0) = 0.

F.9

Proof of Theorem 4.

b ‚àó , defined as
First, in Step 1 of the proof of their Theorem
1.4, Gozlan et al. (2018) show that G
n

the empirical distribution of œàe1 , ..., œàen satisfies
b ‚àón = arg min W2 (Fbœà , G),
G
G‚ààG

where Fbœà denotes the empirical cdf of œà and for any q ‚â• 1, Wp (F, G) = WœÅq (F, G)1/q with
b ‚àó‚àí1 ‚ó¶ Fbœà . Moreover, Fbœà (x)
œÅq (x) = |x|q . Given the definition of g ‚àó , we also have gb‚àó = G
n
converges almost surely to Fœà (x).
Let us focus hereafter on the event of probability one for which Fbœà and FbY converges 
to Fœà and
b ‚àón
FY , respectively, for the W2 distance. On this event, consider any subsequence of G
.
n‚ààN

Following Step 2 of the proof of Theorem 1.4 in Gozlan et al. (2018), but replacing |x| by x2
and using the fact that E(œà 2 ) < +‚àû and E(Y 2 ) < +‚àû, there exists a further subsequence
e satisfies, for all convex
converging for the W2 distance. Moreover, the corresponding limit G
function œÅ : R+ ‚Üí R+ such that œÅ(0) = 0,




 
e =
WœÅ Fœà , G
inf
E œÅ œà 0 ‚àí E Y 0 |œà 0
.
FY 0 ,œà0 : FY 0 =FY ,Fœà0 =Fœà



e = WœÅ (Fœà , G‚àó ). Because
Hence, by the proof of Theorem 3, WœÅ Fœà , G
G‚àó = arg min W2 (Fœà , G),
G‚ààG

 
e = G‚àó . Hence, any subsequence of G
b ‚àón
we have G
admits a converging further subsequence
n‚ààN 
b ‚àón
converges to G‚àó for the W2 distance.
converging to G‚àó . This implies that almost surely, G
n‚ààN
 
b ‚àón
Because convergence for the W2 distance implies weak convergence, G
converges weakly
n‚ààN

55



b ‚àí1‚àó
to G‚àó , almost surely. But then, by Lemma 21.2 in Van der Vaart (2000), G
n (x)
almost surely to

G‚àó‚àí1 (x),

for all x that is a continuity point of

G‚àó‚àí1 .

n‚ààN

converges

Finally, let us prove the almost sure convergence of gb‚àó (t) to g ‚àó (t) for all t that is a continuity
point of g ‚àó and such that Fœà (t) ‚àà (0, 1). Fix Œµ > 0 and let us prove that for all n large enough,
|b
g ‚àó (t) ‚àí g ‚àó (t)| < Œµ with probability one. Because Fœà (t) is a continuity point of G‚àó‚àí1 , there exists
Œ¥ > 0 such that for all u satisfying |u ‚àí Fœà (t)| < Œ¥, |G‚àó‚àí1 (u) ‚àí G‚àó‚àí1 (Fœà (t))| < Œµ/2. It is easy
to see that the set of points of discontinuity of G‚àó‚àí1 is at most countable. Thus, there exists
Œ∑ ‚àà (0, Œ¥) such that Fœà (t) + Œ∑ and Fœà (t) ‚àí Œ∑ are continuity points of G‚àó‚àí1 . Moreover, with
probability one and for all n large enough, |Fbœà (t) ‚àí Fœà (t)| ‚â§ Œ∑. Then, for all n large enough and
with probability one,
b ‚àó‚àí1 ‚ó¶ Fbœà (t) ‚â§ G
b ‚àó‚àí1 ‚ó¶ [Fœà (t) + Œ∑] .
G
n
n
Because Fœà (t) + Œ∑ is a continuity points of G‚àó‚àí1 , we have by what precedes that for all n large
enough and with probability one,
b ‚àó‚àí1 ‚ó¶ Fbœà (t) ‚â§ G
b ‚àó‚àí1 ‚ó¶ [Fœà (t) + Œ∑]
G
n
n
‚â§ G‚àó‚àí1 ‚ó¶ [Fœà (t) + Œ∑] + Œµ/2
‚â§ G‚àó‚àí1 ‚ó¶ Fœà (t) + Œµ.
b ‚àó‚àí1
Similarly, for all n large enough and with probability one, G
‚ó¶ Fbœà (t) ‚â• G‚àó‚àí1 ‚ó¶ Fœà (t) ‚àí Œµ. The
n
result follows by definition of gb‚àó (t).

F.10

Proof of Theorem 5.

Note first that because FE[Y |I] is continuous, FE[Y |I] (E [Y |I]) is uniformly distributed (see,e.g.
Van der Vaart, 2000, p.305). In turn, this implies that the cdf of hM (E [Y |I]) is Fœà . Hence,
(hM (E [Y |I]) , E [Y |I]) ‚àà Œ®M . If for all (œà 0 , œà 00 ), E(œÅ(|œà 0 ‚àí œà 00 |)] = +‚àû, Equality (8) holds. If
not, let (œà 0 , œà 00 ) ‚àà Œ®M be such that E(œÅ(|œà 0 ‚àí œà 00 |)] < +‚àû. Because œÅ is convex, we have, for all
x0 ‚â• x and y 0 ‚â• y,
œÅ(|x0 ‚àí y 0 |) ‚àí œÅ(|x ‚àí y 0 |) ‚àí œÅ(|x0 ‚àí y|) + œÅ(|x ‚àí y|) ‚â§ 0.
Then, by Theorem 3.1.2 in Rachev and RuÃàschendorf (1998),
0

00

Z

E[œÅ(|œà ‚àí œà |)] ‚â•

1

œÅ



‚àí1
Fœà‚àí1 (u) ‚àí FE(Y
(u)
|I M )



du.
Z0 

‚àí1
= œÅ Fœà‚àí1 ‚ó¶ FE[Y |I] (v) ‚àí FE[Y
‚ó¶
F
(v)
dFE[Y |I] (v)
E[Y |I]
|I]
h 
i
‚àí1
= E œÅ hM (E [Y |I]) ‚àí FE[Y
‚ó¶
F
(E
[Y
|I])
.
E[Y |I]
|I]

56

(22)

‚àí1
Finally, note that FE[Y
|I] ‚ó¶ FE[Y |I] (v) < v only if v is in the interior or at the right end of a
‚Äúflat‚Äù of FE[Y |I] (see, e.g., lemma 21.1 in Van der Vaart, 2000). Because the set of such right end
‚àí1
points is countable and FE[Y |I] has no atom, FE[Y
|I] ‚ó¶ FE[Y |I] (E [Y |I]) = E [Y |I] almost surely.
Combined with Equation (22), this implies (8).

Now, let us suppose that œÅ is strictly convex and let (œà 0 , E [Y |I]) ‚àà Œ®M satisfy (8). We can apply
the first part of the proof of Theorem 2.2.1 in Santambrogio (2015), remarking that it does not
rely on the asssumption of compact supports. This implies that the distribution of (œà 0 , E [Y |I])
is equal to that of (hM (E [Y |I]), E [Y |I]). Hence, conditional on E [Y |I], œà 0 is degenerate and
equal to hM (E [Y |I]). The result follows.

F.11

Proof of Proposition 5

h 
i
We introduce EF,c = EF m Di , Yec,i , Xi , h, y and
n
 ‚àí1/2  



1 X
b F Yebc
m Di , Yebc,i , Xi , h, y ‚àí EF,bc ,
ŒΩn,F (y, h) = ‚àö
Diag V
n
i=1

n
 ‚àí1/2  



1 X
ŒΩ n,F (y, h) = ‚àö
Diag VF Yec0
m Di , Yec0 ,i , Xi , h, y ‚àí EF,c0 .
n
i=1

The proof is based on Theorem 5.1 in AS, hence we have to check that the corresponding
assumptions PS1, PS2, and SIG1 hold. Namely, we have to ensure that
- PS1: for all sequence F ‚àà F and all (d, y 0 , x, h, y, c) ‚àà {0, 1} √ó Y √ó [0, 1]dX √ó Hr √ó Y √ó

Cs [0, 1]dX
 
2+Œ¥ 
m(d, y 0 , x, h, y)
0
e
 
‚â§ M (d, y , x, h, y) and EF M Di , Yc,i , Xi , h, y
‚â§ C < ‚àû,
VF Yec,i
where Œ¥ > 0 and for some function M ;
- PS2: for all sequence Fn ‚àà F, the i.i.d triangular array of processes


 m D , Ye



i n,c(Xn,i ) , Xn,i , h, y


, (c, y, h) ‚àà Cs [0, 1]dX √ó Y √ó H, i ‚â§ n, n ‚â• 1
Tn0 =
VFn Yen,c(X )
n,i

is manageable with respect to some envelope function U1 (see Pollard, 1990, p.38 for the
definition of a manageable class);
 
 


b F Yei,c /VF Yei,c ‚àí 1 > Œ∂ ‚Üí 0.
- SIG1: for all Œ∂ > 0, supF ‚ààF ,c‚ààCs ([0,1]dX ) P V

 ‚àí1/2
We proceed in two steps, to handle the fact that c0 and Diag VF Yec0
are estimated:
57

1. We first show that
sup

sup

F ‚ààF0 h‚àà‚à™r‚â•1 Hr ,y‚ààY

sup

sup

F ‚ààF0 h‚àà‚à™r‚â•1 Hr ,y‚ààY

kŒΩn,F (y, h) ‚àí ŒΩ n,F (y, h)k‚àû =oP (1),
‚àó
ŒΩn,F
(y, h) ‚àí ŒΩ ‚àón,F (y, h)

‚àû

=oP ‚àó (1).

(23)
(24)

2. Next, we show that m satisfies assumptions PS1, PS2, and that SIG1 in AS also holds for
 
2
P 
P
œÉF2 = VF Yec0 , where F ‚àà F and œÉ
bn2 = n‚àí1 ni=1 Yebc,i ‚àí n‚àí1 nj=1 Yebc,j .
1. Proof of (23)-(24).
We apply the uniform version over F ‚àà F0 of Theorem 3 in Chen et al. (2003) to a general
e
class of functions

 to which pertain the moment condition m (see (2), with Y replaced here by
Yec = Dq Ye , c +(1‚àíD)œà and without the moment equality m2 ). Hence, it suffices to verify that
Assumptions (3.2) and (3.3) of Theorem 3 in Chen et al. (2003) are satisfied. Let us introduce,
for any 0 < N1 < M1 , the classes of functions

o
n

M1 = fc,y,œÜ,h (e
y , x) = œÜ (y ‚àí q (e
y , c(x)))+ h(x), (c, y, œÜ, h) ‚àà Cs [0, 1]dX √ó Y √ó [N1 , M1 ] √ó H ,
(25)
n

o

M2 = fc,y,œÜ,h (e
y , x) = œÜ (y ‚àí ye)+ h(x), (c, y, œÜ, h) ‚àà Cs [0, 1]dX √ó Y √ó [N1 , M1 ] √ó H ,
M ={fc,y,œÜ1 ,œÜ2 ,h (e
y , x, d) = (dgc,y,œÜ1 ,h ‚àí (1 ‚àí d)qc,y,œÜ2 ,h ) (e
y , x) , g ‚àà M1 , q ‚àà M2 ,


(c, y, œÜ1 , œÜ2 , h) ‚àà Cs [0, 1]dX √ó Y √ó [N1 , M1 ]2 √ó H}.
Note that œÜ1 , œÜ2 , and c in the class M denote components of m that are estimated.

Consider the space Cs [0, 1]dX √ó Y √ó [N1 , M1 ]2 √ó H equipped with the norm
o
n
k(c, y, œÜ1 , œÜ2 , h)k = max kck[0,1]dX , |y| , |œÜ1 | , |œÜ2 | , khk[0,1]dX .

For v = (c, y, œÜ1 , œÜ2 , h), v 0 = (c0 , y 0 , œÜ01 , œÜ02 , h0 ) ‚àà Cs [0, 1]dX √ó Y √ó [N1 , M1 ]2 √ó H and (e
y , x, d) ‚àà
d
X
Y √ó [0, 1] √ó {0, 1}, we have, by the triangular inequality and Assumptions 5-(i) and 5-(v),
|fv (e
y , x, d) ‚àí fv0 (e
y , x, d)| ‚â§ gc,y,œÜ1 ,h (e
y , x) ‚àí gc0 ,y0 ,œÜ01 ,h0 (e
y , x)
+ qc,y,œÜ2 ,h (e
y , x) ‚àí qc0 ,y0 ,œÜ02 ,h0 (e
y , x)

‚â§(M + M0 ) œÜ1 ‚àí œÜ02 + œÜ2 ‚àí œÜ02


+ 2M1 y ‚àí y 0 + q (e
y , c(x)) ‚àí q ye, c0 (x)


+ 2M0 M1 1l {q(e
y , c(x)) ‚â§ y} ‚àí 1l q(e
y , c(x)) ‚â§ y 0



+ 1l q (e
y , c(x)) ‚â§ y 0 ‚àí 1l q ye, c0 (x) ‚â§ y 0

+ h(x) ‚àí h0 (x) .
58

Since q(e
y , .) is Lipschitz and by convexity of x 7‚Üí x2 , we obtain


2
2
|fv (e
y , x, d) ‚àí fv0 (e
y , x, d)|2 /7 ‚â§(M + M0 )2 œÜ1 ‚àí œÜ01 + œÜ2 ‚àí œÜ02
h
i
2
2
+ 4M12 y ‚àí y 0 + Kq c ‚àí c0 [0,1]dX


y , c(x)) ‚â§ y} ‚àí 1l q(e
y , c(x)) ‚â§ y 0
+ 4(M0 M1 )2 1l {q(e



+ 1l q (e
y , c(x)) ‚â§ y 0 ‚àí 1l q ye, c0 (x) ‚â§ y 0

2
+ h ‚àí h0 [0,1]dX .
for some constant Kq > 0. Fix Œ¥ > 0. If kv ‚àí v 0 k ‚â§ Œ¥, then

|fv (e
y , x, d) ‚àí fv0 (e
y , x, d)|2 /7 ‚â§Œ¥ 2 2(M + M0 )2 + 4M12 (1 + Kq ) + 4(M0 M1 )2

+ 4(M0 M1 )2 1l {q(e
y , c(x)) ‚â§ y + Œ¥} ‚àí 1l {q(e
y , c(x)) ‚â§ y ‚àí Œ¥}



 
I
0
.
+ 1l ye ‚â§ q y , c(x) ‚àí 1l ye ‚â§ q I y 0 , c0 (x)
Next, by Assumption 5-(iv),
h n 

o
n 

oi
E 1l q Ye , c(X) ‚â§ y + Œ¥ ‚àí 1l q Ye , c(X) ‚â§ y ‚àí Œ¥
=Fq(Ye ,c(X)) (y + Œ¥) ‚àí Fq(Ye ,c(X)) (y ‚àí Œ¥)
‚â§2Q2 Œ¥.
Finally,
 


 
E 1l Y ‚â§ q I y 0 , c(X) ‚àí 1l ye ‚â§ q I y 0 , c0 (X)
 




‚â§E 1l Y ‚â§ q I y 0 , c(X) ‚àí QF,2 Œ¥ ‚àí 1l ye ‚â§ q I y 0 , c(X) + QF,2 Œ¥





‚â§E FY |X q I y 0 , c(X) ‚àí QqI Œ¥ X ‚àí FY |X q I y 0 , c(X) + QqI Œ¥ X
‚â§2QF,1 QqI Œ¥,
where QqI is the Lipschitz constant of q I . Thus, by Assumption 5, there exists Q > 0 such that
"
sup E

F ‚ààF0

sup
kv‚àív 0 k‚â§Œ¥







fv Ye , X, D ‚àí fv0 Ye , X, D



2

#
‚â§ QŒ¥.

(26)

Therefore the class M satisfies Condition (3.2) of Theorem 3 in Chen et al. (2003) uniformly in
F ‚àà F0 . Moreover, the class H is manageable and thus Donsker (see Lemma 3 in Andrews and

Shi, 2013). Finally, by Remark 3 (ii) in Chen et al. (2003), Cs [0, 1]dX is also Donsker. Then,

Cs [0, 1]dX , Y, [N1 , M1 ], and H satisfy Condition (3.3) of Theorem 3 in Chen et al. (2003). The
result follows by Theorem 3 in Chen et al. (2003).
bn2 .
2. m satisfies PS1 and PS2 of AS and SIG1 of AS also holds for œÉF2 and œÉ
59

From Assumption 5 (iii) and the proof of Lemma 7.2 (a) in AS, PS1 is satisfied replacing B by
max(M, M0 ) in the proof of Lemma 7.2-(a) in AS.
We now show that PS2 in AS also holds. As the result is uniform over F0 , we have to consider
sequences for the cdfs Fn of (Dn,i , Yn,i , Xn,i )i=1...n (with Fn ‚àà F0 ). We also define
Yen,c(Xn,i ) = Dn,i q (Yn,i , c(Xn,i )) + (1 ‚àí Dn,i )œàn,i ,
Wn,i = Dn,i /EFn [Dn,i ] ‚àí (1 ‚àí Dn,i )/EFn [1 ‚àí Dn,i ] ,


œÉF2 n = VFn Yen,c(Xn,i ) .
Note that by Assumption 3 (iii), œÉF2 n ‚â• œÉ > 0 for all Fn ‚àà F. Let (‚Ñ¶, F, Fn ) be a probability
space and let œâ denote a generic element in ‚Ñ¶. Showing Assumption PS2 in AS then boils down
to prove that for any 0 < N1 < M1 := 1/ inf F œÉF2 , the i.i.d triangular array of processes



+

T1,n,œâ = Wn,i œÜ y ‚àí Yen,c(Xn,i ) h(Xn,i ), (c, y, œÜ, h) ‚àà Cs [0, 1]dX √ó Y √ó [N1 , M1 ] √ó H,

i ‚â§ n, n ‚â• 1
is manageable with respect to some envelope function U1 . Lemma 3 in Andrews and Shi (2013)
shows that the processes {h(Xn,i ), h ‚àà H, i ‚â§ n, n ‚â• 1} are manageable with respect to the
constant function 1. Then, using Lemma D.5 in AS, it remains to show that



+


0
dX
e
T1,n,œâ = Wn,i œÜ y ‚àí Yn,c(Xn,i ) , (c, y, œÜ) ‚àà Cs [0, 1]
√ó Y √ó [N1 , M1 ], i ‚â§ n, n ‚â• 1 ,
is manageable with respect to some envelope. For such an envelope, we can consider U10 (œâ) =
0
. Let us define
(M0 + M )/(œÉ0 ). We now prove the manageability of T1,n,œâ

M0 = fc,y,œÜ1 ,œÜ2 (e
y , x, d) = dœÜ1 (y ‚àí q (e
y , c(x)))+ ‚àí (1 ‚àí d)œÜ2 (y ‚àí ye)+ ,
o


(c, y, œÜ1 , œÜ2 ) ‚àà Cs [0, 1]dX √ó Y √ó [N1 , M1 ]2 .
Reasoning as for the class M defined in (25), and using the last equation of the proof of Theorem
3 in Chen et al. (2003), p.1607, we have that for  > 0,







N[¬∑] , M0 , k ¬∑ k2 ‚â§ N 0 , [N1 , M1 ]2 , |¬∑| √ó N 0 , Y, |¬∑| √ó N 0 , Cs [0, 1]dX , k ¬∑ k[0,1]dX ,
with 0 = (/(2Q))2 and Q defined in (26). Using Theorem 2.7.1 page 155 in Van der Vaart and
Wellner (1996), there exists a constant Q2 depending only on s, dX , and [0, 1]dX such that
 

ln N 0 , Cs ([0, 1]dX ), k ¬∑ k[0,1]dX
‚â§ Q2 0‚àídX /s .
Moreover, because Y and [N1 , M1 ] are compact subsets of two Euclidean spaces, there exist Q3 ,
Q4 such that


N 0 , [N1 , M1 ]2 , |¬∑| ‚â§ Q3 0‚àí4 and N 0 , Y, |¬∑| ‚â§ Q4 0‚àí2 .
(27)
60

This yields
ln N[¬∑] , M0 , k ¬∑ k2





‚â§ (6 + Q2 ) max ‚àí ln(0 ), 0‚àídX /s + ln(Q3 Q4 ).

(28)


0
Let denote element-by-element product and D  |Œ± U10 (œâ)| , Œ± T1,n,œâ
denote random packing numbers. By (A.1) in Andrews (1994, p.2284), we have



0
sup
D  Œ± U10 (œâ) , Œ± T1,n,œâ
‚â§ sup N
, M0 , k ¬∑ k2
2
F ‚ààF0
œâ‚àà‚Ñ¶,n‚â•1, Œ±‚ààRn
+

‚â§ sup N[¬∑] , M0 , k ¬∑ k2 ,
(29)
F ‚ààF0

where the second inequality follows as in e.g., Van der Vaart and Wellner (1996, p.84). Then,
(28) ensures (see Definition 7.9 in Pollard (1990), p.38) that

0
‚â§ Œª(),
sup
D  Œ± U10 (œâ) , Œ± T1,n,œâ
œâ‚àà‚Ñ¶,n‚â•1, Œ±‚ààRn
+





where Œª() = exp (6 + Q2 ) max ‚àí2 ln (/(2Q)) , (/(2Q))‚àí2dX /s + ln(Q3 Q4 ) . Moreover, by
‚àö
‚àö
‚àö
using a + b ‚â§ a + b for all a, b ‚â• 0,
Z 1p
Z 1h

i1/2
p
p
ln(Œª())d ‚â§ 6 + Q2
max ‚àí2 ln (/(2Q)) , (/(2Q))‚àí2dX /s
d + ln(Q3 Q4 )
0

0

< ‚àû.
0
Thus, T1,n,œâ
hence T1,n,œâ are manageable. Therefore, m satisfies PS2 in AS.

Finally, in order to show that SIG1 in AS is satisfied, we use Assumption 5 (iii) and follow the
proof of Lemma 7.2 (b) in AS where we replace Y by q(Y, c(X)) and B by max(M, M0 ). The
result follows.

F.12

Proof of Proposition 6

We first prove that if E[œàL ] ‚â§ E[Y ] ‚â§ E[œàU ], there exists a unique F ‚àó ‚àà FB such that Œ¥F ‚àó = 0.
0
0
First, suppose that F b 6= F b and, without loss of generality, b > b0 . Then œà b ‚â§ œà b , implying
0
that F b (y) ‚â§ F b (y) for all y. Moreover, the inequality is strict for at least one y. As a result,
0
E(œà b ) > E(œà b ). In other words, there is at most one F ‚àó ‚àà FB such that Œ¥F ‚àó = 0. If E[œàL ] = E[Y ]
or E[œàU ] = E[Y ], such a solution also exists by taking b = ‚àí‚àû and b = +‚àû, respectively. Now,
suppose that E[œàL ] < E[Y ] < E[œàU ]. For all +‚àû > b > b0 > ‚àí‚àû,

0
œà b ‚àí œà b = œàU ‚àí max(œàL , b0 ) 1l{œàU ‚àà [b0 , b)} + (b ‚àí b0 )1l{œàL < b0 , œàU ‚â• b}
+ (b ‚àí œàL )1l{œàL ‚àà [b0 , b), œàU ‚â• b}.
0
As a result, |œà b ‚àí œà b | ‚â§ |b ‚àí b0 |. This implies that Œ¥e : b 7‚Üí E[œà b ] is continuous. Moreover,
e = E[œàL ] < E(Y ) and limb‚Üí+‚àû Œ¥(b)
e = E[œàU ] > E(Y ). By the intermediate value
limb‚Üí‚àí‚àû Œ¥(b)

61

e ‚àó ) = E(Y ). Hence, there exists F ‚àó ‚àà FB such that Œ¥F ‚àó = 0.
theorem, there exists b‚àó such that Œ¥(b
The first part of Proposition 6 follows.
Let us turn to the second part of the proposition. First, if (ii) holds, there exists b0 ‚àà R
such that F ‚àó = F b0 . Then, by construction and Theorem 1, Y and œà b0 satisfy H0 . Moreover,
F b0 ‚àà [FœàU , FœàL ]. Therefore, H0B holds as well.
Now, let us prove that (i) implies (ii). Let us denote by D the set of all the cdfs for œà such that
H0B holds. By Theorem 1, these are cdfs F satisfying FœàU ‚â§ F ‚â§ FœàL , Œ¥F = 0 and dominating
at the second order FY . We show below that all F ‚àà D are dominated at the second order by
R
R
F ‚àó . Then, because FœàU ‚â§ F ‚àó ‚â§ FœàL and ydF ‚àó (y) = ydFY (y), D is not empty only if F ‚àó
dominates at the second order FY . The result then follows by Theorem 1.
Thus, we have to show that for all t ‚àà R,
F ‚àó = argminFœà ‚ààD

Z

t

Fœà (y)dy.

(30)

‚àí‚àû

First, if F ‚àó = F ‚àí‚àû , we have for all F 6= F ‚àó , F (y) ‚â§ FœàL (y) = F ‚àó (y) for all y, with strict
inequality for some y. Then Œ¥F > Œ¥F ‚àó = 0 and D = {F ‚àó }, implying that (30) holds. Similarly,
(30) holds if F ‚àó = F +‚àû .
Suppose now that F ‚àó = F b0 for some b0 ‚àà R. Because FœàU (y) ‚â§ Fœà (y) for all y < b0 and
all Fœà ‚àà D, (30) holds for all t < b0 . We now prove that (30) holds also for t ‚â• b0 . First
R
R
suppose that t ‚â• max(b0 , 0). For all Fœà ‚àà D, ydFY (y) = ydFœà (y)dy. As a result, by Fubini‚Äôs
theorem,
Z 0
Z t
Z ‚àû
‚àó
‚àó
‚àí
F (y)dy +
(1 ‚àí F (y)) dy +
(1 ‚àí F ‚àó (y)) dy
‚àí‚àû

Z

0
0

t

Z

=‚àí

Z
(1 ‚àí Fœà (y)) dy +

Fœà (y)dy +
‚àí‚àû

t

‚àû

(1 ‚àí Fœà (y)) dy.

0

t

Because Fœà ‚â§ FœàL = F ‚àó on [b0 , +‚àû], this implies that
Z 0
Z t
Z 0
Z t
‚àó
‚àó
‚àí
F (y)dy +
(1 ‚àí F (y)) dy ‚â• ‚àí
Fœà (y)dy +
(1 ‚àí Fœà (y)) dy
‚àí‚àû

‚àí‚àû

0

0

and thus (30) holds for t ‚â• max(b0 , 0). Now, if b0 < 0 and t ‚àà (b0 , 0), we have
Z t
 Z ‚àû
Z 0
‚àó
‚àó
‚àí
F (y)dy +
F (y)dy +
(1 ‚àí F ‚àó (y)) dy
‚àí‚àû
t
0
Z t
 Z ‚àû
Z 0
=‚àí
Fœà (y)dy +
Fœà (y)dy +
(1 ‚àí Fœà (y)) dy.
‚àí‚àû

t

0

F‚àó

Using again Fœà ‚â§ FœàL =
on [t, +‚àû) yields
Z 0
Z ‚àû
Z
‚àí
F ‚àó (y)dy +
(1 ‚àí F ‚àó (y)) dy ‚â§ ‚àí
t

0

t

Therefore, the result also follows in this case.
62

0

Z

‚àû

(1 ‚àí Fœà (y)) dy.

Fœà (y)dy +
0

