NBER WORKING PAPER SERIES

GENERIC MACHINE LEARNING INFERENCE ON HETEROGENOUS TREATMENT
EFFECTS IN RANDOMIZED EXPERIMENTS
Victor Chernozhukov
Mert Demirer
Esther Duflo
Iv√°n Fern√°ndez-Val
Working Paper 24678
http://www.nber.org/papers/w24678

NATIONAL BUREAU OF ECONOMIC RESEARCH
1050 Massachusetts Avenue
Cambridge, MA 02138
June 2018

We thank Susan Athey, Moshe Buchinsky, Denis Chetverikov, Siyi Luo, Max Kasy, Susan
Murphy, Whitney Newey, and seminar participants at UCLA and AEA for valuable comments.
We gratefully acknowledge research support from the National Science Foundation. The views
expressed herein are those of the authors and do not necessarily reflect the views of the National
Bureau of Economic Research.
NBER working papers are circulated for discussion and comment purposes. They have not been
peer-reviewed or been subject to the review by the NBER Board of Directors that accompanies
official NBER publications.
¬© 2018 by Victor Chernozhukov, Mert Demirer, Esther Duflo, and Iv√°n Fern√°ndez-Val. All
rights reserved. Short sections of text, not to exceed two paragraphs, may be quoted without
explicit permission provided that full credit, including ¬© notice, is given to the source.

Generic Machine Learning Inference on Heterogenous Treatment Effects in Randomized Experiments
Victor Chernozhukov, Mert Demirer, Esther Duflo, and Iv√°n Fern√°ndez-Val
NBER Working Paper No. 24678
June 2018
JEL No. C18,C21,D14,G21,O16
ABSTRACT
We propose strategies to estimate and make inference on key features of heterogeneous effects in
randomized experiments. These key features include best linear predictors of the effects using
machine learning proxies, average effects sorted by impact groups, and average characteristics of
most and least impacted units. The approach is valid in high dimensional settings, where the
effects are proxied by machine learning methods. We post-process these proxies into the
estimates of the key features. Our approach is generic, it can be used in conjunction with
penalized methods, deep and shallow neural networks, canonical and new random forests,
boosted trees, and ensemble methods. It does not rely on strong assumptions. In particular, we
don‚Äôt require conditions for consistency of the machine learning methods. Estimation and
inference relies on repeated data splitting to avoid overfitting and achieve validity. For inference,
we take medians of p-values and medians of confidence intervals, resulting from many different
data splits, and then adjust their nominal level to guarantee uniform validity. This variational
inference method is shown to be uniformly valid and quantifies the uncertainty coming from both
parameter estimation and data splitting. An empirical application to the impact of micro-credit on
economic development illustrates the use of the approach in randomized experiments.
Victor Chernozhukov
Department of Economics
Massachusetts Institute of Technology
77 Massachusetts Avenue
Cambridge, Mass. 02139
vchern@mit.edu
Mert Demirer
Department of Economics
Massachusetts Institute of Technology
77 Massachusetts Avenue E52-300
Cambridge, Mass. 02139
mdemirer@mit.edu

Esther Duflo
Department of Economics, E52-544
MIT
77 Massachusetts Avenue
Cambridge, MA 02139
and NBER
eduflo@mit.edu
Iv√°n Fern√°ndez-Val
Department of Economics
Boston University
270 Bay State Rd
Boston, MA 02215
ivanf@bu.edu

GENERIC MACHINE LEARNING INFERENCE ON HETEROGENOUS TREATMENT
EFFECTS IN RANDOMIZED EXPERIMENTS
VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

Abstract. We propose strategies to estimate and make inference on key features of heterogeneous effects in randomized experiments. These key features include best linear predictors of the effects using machine learning proxies, average
effects sorted by impact groups, and average characteristics of most and least impacted units. The approach is valid in high
dimensional settings, where the effects are proxied by machine learning methods. We post-process these proxies into
the estimates of the key features. Our approach is generic, it can be used in conjunction with penalized methods, deep
and shallow neural networks, canonical and new random forests, boosted trees, and ensemble methods. It does not
rely on strong assumptions. In particular, we don‚Äôt require conditions for consistency of the machine learning methods.
Estimation and inference relies on repeated data splitting to avoid overfitting and achieve validity. For inference, we
take medians of p-values and medians of confidence intervals, resulting from many different data splits, and then adjust
their nominal level to guarantee uniform validity. This variational inference method is shown to be uniformly valid and
quantifies the uncertainty coming from both parameter estimation and data splitting. An empirical application to the
impact of micro-credit on economic development illustrates the use of the approach in randomized experiments.
Key words: Agnostic Inference, Machine Learning, Confidence Intervals, Causal Effects, Variational P-values and
Confidence Intervals, Uniformly Valid Inference, Quantification of Uncertainty, Sample Splitting, Multiple Splitting,
Assumption-Freeness, Microcredit
JEL: C18, C21, D14, G21, O16

1. Introduction
Randomized experiments play an important role in the evaluation of social and economic programs and medical treatments (e.g., [33, 25]). Researchers and policy makers are often interested
in features of the impact of the treatment that go beyond the simple average treatment effects. In
particular, very often, they want to know whether treatment effect depends on covariates, such as
gender, age, etc. It is essential to assess if the impact of the program would generalize to a different population with different characteristics, and for economists, to better understand the driving
mechanism behind the effects of a particular program.
One issue with reporting treatment effects split by subgroups, however, is that there are often a
large number of potential sample splits: choosing subgroups ex-post opens the possibility of overfitting. To solve this problem, medical journals and the FDA require pre-registering the sub-sample
of interest in medical trials in advance. In economics, this approach has gained some traction, with
Date: May 30, 2018.
We thank Susan Athey, Moshe Buchinsky, Denis Chetverikov, Siyi Luo, Max Kasy, Susan Murphy, Whitney Newey,
and seminar participants at UCLA and AEA for valuable comments. We gratefully acknowledge research support from
the National Science Foundation.
1

2

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

the adoption of pre-analysis plans (which can be filed in the AEA registry for randomized experiments). Restricting heterogeneity analysis to pre-registered subgroups, however, amounts to
throwing away a large amount of potentially valuable information, especially now that many researchers collect large baseline data sets. It should be possible to use the data to discover ex post
whether there is any relevant heterogeneity in treatment effect by covariates.
To do this in a disciplined fashion and avoid the risk of overfitting, scholars have recently proposed using machine learning (ML) tools (see e.g. [5] and below for a review). Indeed, ML tools
seem to be ideal to explore heterogeneity of treatment effect, when researchers have access to a potentially large array of baseline variables to form subgroups, and little guiding principles on which
of those are likely to be relevant. Several recent papers, which we review below, develop methods
for detecting heterogeneity in treatment effects. Empirical researchers have taken notice.1
This paper develops a generic approach to use any of the ML tools to predict and make inference
on heterogeneous treatment or policy effects. A core difficulty of applying ML tools to the estimation of heterogenous causal effects is that, while they are successful in prediction empirically, it
is much more difficult to obtain uniformly valid inference. In fact, in high dimensional settings,
absent strong assumptions, generic ML tools may not even produce consistent estimates of the conditional average treatment effect (or CATE) (the difference in the expected potential outcomes between
treated and control groups conditional on covariates).
Previous attempts to solve this problem focus either on specific tools (for example the method
proposed by [4], which has become popular with applied researchers, and uses trees), or on situations where those assumptions might be satisfied. Our approach to resolve the fundamental
impossibilities in non-parametric inference is different. Motivated by [27], instead of attempting to
get consistent estimation and uniformly valid inference on the CATE itself, we focus on providing
valid estimation and inference on features of CATE. We start by building a ML proxy predictor of
CATE, and then develop valid inference on features of the CATE based on this proxy predictor.
In particular, we develop valid inference on three objects, which are likely to be of interest to applied researchers and policy makers: First, the Best Linear Predictor (BLP) of the CATE based on
the ML proxy predictor; second, the Sorted Group Average Treatment Effects (GATES) or average
treatment effect by heterogeneity groups induced by the ML proxy predictor; and third, the Classification Analysis (CLAN) or the average characteristics of the most and least affected units defined
in terms of the ML proxy predictor. Thus, we can find out if there is detectable heterogeneity in the
treatment effect based on observables, and if there is any, what is the treatment effect for different
bins. And finally we can describe which of the covariates is correlated with this heterogeneity.

1

In the last few months alone, several new empirical papers in economics used ML methods to estimate heterogenous

effects. E.g. [43], which shows that villagers outperform the machine learning tools when they predict heterogeneity in
returns to capital. [23] predict who benefits the most from a summer internship projects. The methodological papers
reviewed later also contain a number of empirical applications.

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

3

There is a trade-off between more restrictive assumptions or tools and a more ambitious estimation. We chose a different approach to address this trade-off than previous papers: focus on coarser
objects of the function rather than the function itself, but make as little assumptions as possible.
This seems to be a worthwhile sacrifice: the objects for which we have developed inference appear
to us at this point to be the most relevant, but in the future, one could easily use the same approach
to develop methods to estimate other objects of interest.
The Model and Key Causal Functions. Let Y (1) and Y (0) be the potential outcomes in the treatment state 1 and the non-treatment state 0; see [45]. Let Z be a vector of covariates that characterize
the observational units. The main causal functions are the baseline conditional average (BCA):
b0 (Z) := E[Y (0) | Z],

(1.1)

and the conditional average treatment effect (CATE):
s0 (Z) := E[Y (1) | Z] ‚àí E[Y (0) | Z].

(1.2)

Suppose the binary treatment variable D is randomly assigned conditional on Z, with probability of assignment depending only on a subvector of stratifying variables Z1 ‚äÜ Z, namely
D ‚ä•‚ä• (Y (1), Y (0)) | Z,

(1.3)

and the propensity score is known and is given by
p(Z) := P[D = 1 | Z] = P[D = 1 | Z1 ],

(1.4)

which we assume is bounded away from zero or one:
p(Z) ‚àà [p0 , p1 ] ‚äÇ (0, 1).

(1.5)

The observed outcome is Y = DY (1) + (1 ‚àí D)Y (0). Under the stated assumption, the causal
functions are identified by the components of the regression function of Y given D, Z:
Y = b0 (Z) + Ds0 (Z) + U, E[U | Z, D] = 0,
that is,
b0 (Z) = E[Y | D = 0, Z],

(1.6)

s0 (Z) = E[Y | D = 1, Z] ‚àí E[Y | D = 0, Z].

(1.7)

and

We observe Data = (Yi , Zi , Di )N
i=1 , consisting of i.i.d. copies of the random vector (Y, Z, D)
having probability law P . The expectation with respect to P is denoted by E = EP . The probability
law of the entire data is denoted by P = PP and the corresponding expectation is denoted by
E = EP .

4

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

Properties of Machine Learning Estimators of s0 (Z) Motivating the Agnostic Approach. Machine learning (ML) is a name attached to a variety of new, constantly evolving statistical learning methods: Random Forest, Boosted Trees, Neural Networks, Penalized Regression, Ensembles,
and Hybrids (see, e.g., [49] for a recent review, and [26] for a prominent textbook treatment). In
modern high-dimensional settings, ML methods effectively explore the various forms of nonlinear structured sparsity to yield ‚Äúgood‚Äù approximations to s0 (z) whenever such assumptions are
valid, based on equations (1.6) and (1.7). As a result these methods often work much better than
classical methods in high-dimensional settings, and have found widespread uses in industrial and
academic applications.
Motivated by their practical predictive success, it is really tempting to apply ML methods directly
to try to learn the CATE function z 7‚Üí s0 (z) (by learning the two regression functions for treated
and untreated and taking the difference). However, it is hard, if not impossible, to obtain uniformly
valid inference on z 7‚Üí s0 (z) using generic ML methods, under credible assumptions and practical
tuning parameter choices. There are several fundamental reasons as well as huge gaps between
theory and practice that are responsible for this.
One fundamental reason is that the ML methods might not even produce consistent estimators
of z 7‚Üí s0 (z) in high dimensional settings. For example, if z has dimension d and the target function
z 7‚Üí s0 (z) is assumed to have p continuous and bounded derivatives, then the worst case (minimax)
lower bound on the rate of learning this function from a random sample of size N cannot be better
than N ‚àíp/(2p+d) as N ‚Üí ‚àû, as shown by Stone [46]. Hence if p is fixed and d is also small, but
slowly increasing with N , such as d > log N , then there exists no consistent estimator of z 7‚Üí s0 (z)
generally.
Hence, generic ML estimators cannot be regarded as consistent, unless further very strong assumptions are made. Examples of such assumptions include structured forms of linear and nonlinear sparsity and super-smoothness. While these (sometime believable and yet untestable) assumptions make consistent adaptive estimation possible (e.g.,[16]), inference remains a more difficult problem, as adaptive confidence sets do not exist even for low-dimensional nonparametric
problems ([39, 27]). Indeed, adaptive estimators (including modern ML methods) have biases of
comparable or dominating order as compared to sampling error. Further assumptions such as
‚Äùself-similarity‚Äù are needed to bound the biases and expand the confidence bands by the size of bias
(see [28, 20]) to produce partly adaptive confidence bands. For more traditional statistical methods there are constructions in this vein that make use of either undersmoothing or bias-bounding
arguments ([28, 20]). These methods, however, are not yet available for ML methods in high dimensions (see, however, [29] for a promising approach called ‚Äùtargeted undersmoothing‚Äù in sparse
linear models).
Suppose we did decide to be optimistic (or panglossian) and imposed the strong assumptions,
that made the theoretical versions of the ML methods provide us with high-quality consistent estimators of z 7‚Üí s0 (z) and valid confidence bands based on them. This would still not give us

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

5

a practical construction we‚Äôd want for our applications. The reason is that there is often a gap
between theoretical versions of the ML methods appearing in various theoretical papers and the
practical versions (with the actual, data-driven tuning parameters) coded up in statistical computing packages used by practitioners.2 The use of ML, for example, involves many tuning parameters
with practical rules for choosing them, while theoretical work provides little guidance or backing
for such practical rules; see e.g., the influential book [26] for many examples of such rules. Unfortunately, theoretical work often only provides existence results: there exist theoretical ranges of
the tuning parameters that make the simple versions of the methods work for predictive purposes
(under very strong assumptions), leaving no satisfactory guide to practice.
In this paper we take an agnostic view. We neither rely on any structured assumptions, which
might be difficult to verify or believe in practice, nor impose conditions that make the ML estimators consistent. We simply treat ML as providing proxy predictors for the objects of interest.
Our Agnostic Approach. Here, we propose strategies for estimation and inference on
key features of s0 (Z) rather than s0 (Z) itself.
Because of this difference in focus we can avoid making strong assumptions about the properties
of the ML estimators.
Let (M, A) denote a random partition of the set of indices {1, . . . , N }. The strategies that we
consider rely on random splitting of
Data = (Yi , Di , Zi )N
i=1
into a main sample, denoted by DataM = (Yi , Di , Zi )i‚ààM , and an auxiliary sample, denoted by
DataA = (Yi , Di , Zi )i‚ààA . We will sometimes refer to these samples as M and A. We assume that
the main and auxiliary samples are approximately equal in size, though this is not required theoretically.
From the auxiliary sample A, we obtain ML estimators of the baseline and treatment effects,
which we call the proxy predictors,
z 7‚Üí B(z) = B(z; DataA ) and z 7‚Üí S(z) = S(z; DataA ).
These are possibly biased and noisy predictors of b0 (z) and s0 (z), and in principle, we do not even
require that they are consistent for b0 (z) and s0 (z). We simply treat these estimates as proxies,
which we post-process to estimate and make inference on the features of the CATE z 7‚Üí s0 (z). We
condition on the auxiliary sample DataA , so we consider these maps as frozen, when working with
the main sample.
2There are cases where such gap does not exist, e.g., see [12, 14] for the lasso. On the other hand, for example, even the

wide use of K-fold cross-validation in high-dimensional settings for machine learning remains theoretically unjustified.
There do exist, however, related subsample-based methods [51, 38] that do achieve excellent performance for tuning
selection.

6

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

Using the main sample and the proxies, we shall target and develop valid inference about key
features of s0 (Z) rather than s0 (Z), which include
(1) Best Linear Predictor (BLP) of the CATE s0 (Z) based on the ML proxy predictor S(Z);
(2) Sorted Group Average Treatment Effects (GATES): average of s0 (Z) (ATE) by heterogeneity groups induced by the ML proxy predictor S(Z);
(3) Classification Analysis (CLAN): average characteristics of the most and least affected units
defined in terms of the ML proxy predictor S(Z).
Our approach is generic with respect to the ML method being used, and is agnostic about its formal
properties.
We will make use of many splits of the data into main and auxiliary samples to produce robust
estimates. Our estimation and inference will systematically account for two sources of uncertainty:
(I) Estimation uncertainty conditional on the auxiliary sample.
(II) Splitting uncertainty induced by random partitioning of the data into the main and auxiliary samples.
Because we account for the second source, we call the resulting collection of methods as variational
estimation and inference methods (VEINs). For point estimates we report the median of the estimated key features over different random splits of the data. For the confidence intervals we take
the medians of many random conditional confidence sets and we adjust their nominal confidence
level to reflect the splitting uncertainty. We construct p-values by taking medians of many random
conditional p-values and adjust the nominal levels to reflect the splitting uncertainty. Note that
considering many different splits and accounting for variability caused by splitting is very important. Indeed, with a single splitting practice, empiricists may unintentionally look for a ‚Äùgood‚Äù data
split, which supports their prior beliefs about the likely results, thereby invalidating inference.3
Relationship to the Literature. We focus the review strictly on the literatures about estimation
and inference on heterogeneous effects and inference using sample splitting.
We first mention work that uses linear and semiparametric regression methods. A semiparametric inference method for characterizing heterogeneity, called the sorted effects method, was
given in [18]. This approach does provide a full set of inference tools, including simultaneous
bands for percentiles of the CATE, but is strictly limited to the traditional semiparametric estimators for the regression and causal functions. [29] proposed a sparsity based method called ‚Äùtargeted undersmoothing‚Äù to perform inference on heterogeneous effects. This approach does allow
3This problem is ‚Äúsolved‚Äù by fixing the Monte-Carlo seed and the entire data analysis algorithm before the empirical

study. Even if such a huge commitment is really made and followed, there is a considerable risk that the resulting
data-split may be non-typical. Our approach allows one to avoid taking this risk.

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

7

for high-dimensional settings, but makes strong assumptions on sparsity as well as additional assumptions that enable the targeted undersmoothing. A related approach, which allows for simultaneous inference on many coefficients (for example, inference, on the coefficients corresponding
to the interaction of the treatment with other variables) was first given in [13] using a Z-estimation
framework, where the number of interactions can be very large; see also [24] for a more recent
effort in this direction, focusing on de-biased lasso in mean regression problems. This approach,
however, still relies on a strong form of sparsity assumptions. [52] proposed a post-selection inference framework within the high-dimensional linear sparse models for the heterogeneous effects.
The approach is attractive because it allows for some misspecification of the model.
Next we discuss the use of tree-based and other methods. [32] discussed the use of a heuristic
support-vector-machine method with lasso penalization for classification of heterogeneous treatments into positive and negative ones. They used the Horvitz-Thompson transformation of the
outcome (e.g., as in [31, 1]) such that the new outcome becomes an unbiased, noisy version of
CATE. [4] made use of the Horvitz-Thompson transformation of the outcome variable to inform
the process of building causal trees, with the main goal of predicting CATE. They also provide a
valid inference result on average treatment effects for groups defined by the tree leaves, conditional
on the data split in two subsamples: one used to build the tree leaves and the one to estimate the
predicted values given the leaves. Like our methods, this approach is essentially assumption-free.
The difference with our generic approach is that it is limited to trees and does not account for
splitting uncertainty, which is important in practical settings. [48] provided a subsampling-based
construction of a causal random forest, providing valid pointwise inference for CATE (see also
the review in [48] on prior uses of random forests in causal settings) for the case when covariates
are very low-dimensional (and essentially uniformly distributed).4 Unfortunately, this condition
rules out the typical high-dimensional settings that arise in many empirical problems, including
the ones considered in this paper.
Our approach is radically different from these existing approaches, in that we are changing the
target, and instead of hunting for CATE z 7‚Üí s0 (z), we focus on key features of z 7‚Üí s0 (z). Our
approach is generic, it can be used in conjunction with penalized methods, deep and shallow neural
networks, canonical and new random forests, boosted trees, and ensemble methods. Our approach
is agnostic and does not make unrealistic or hard-to-check assumptions, for example, we don‚Äôt
even require conditions for consistency of the ML methods. We simply treat the ML methods as
providing a proxy predictor z 7‚Üí S(z), which we post-process to estimate and make inference
on the key features of the CATE z 7‚Üí s0 (z). Some of our strategies rely on Horvitz-Thompson
4The dimension d is fixed in [48]; the analysis relies on the Stone‚Äôs model with smoothness index Œ≤ = 1, in which no

consistent estimator exists once d > log n. It‚Äôd be interesting to establish consistency properties and find valid inferential
procedures for the random forest in high-dimensional (d ‚àù n or d  n) approximately sparse cases, with continuous and
categorical covariates, but we are not aware of any studies that cover such settings, which are of central importance to
us.

8

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

transformations of outcome and some do not. The inspiration for our approach draws upon an
observation in [27], namely that some fundamental impossibilities in non-parametric inference
could be avoided if we focus inference on coarser features of the non-parametric functions rather
than the functions themselves.
Our inference approach is also of independent interest, and could be applied to many problems,
where sample splitting is used to produce ML predictions, e.g. [2]. Related references include
[50, 41], where the ideas are related but quite different in details, which we shall explain below.
The premise is the same, however, as in [41, 44] ‚Äì we should not rely on a single random split
of the data and should adjust inference in some way. Our approach takes the medians of many
conditional confidence intervals as the confidence interval and the median of many conditional
p-values as the p-value, and adjusts their nominal levels to account for the splitting uncertainty.
Our construction of p-values builds upon ideas in [15, 41], though what we propose is radically
simpler, and our confidence intervals appear to be brand new. Of course sample splitting ideas
are classical, going back to [30, 36, 11, 21, 42], though having been mostly underdeveloped and
overlooked for inference, as characterized by [44].
2. Main Identification Results and Estimation Strategies
2.1. BLP of CATE. We consider two strategies for identifying and estimating the best linear predictor of s0 (Z) using S(Z):
BLP[s0 (Z) | S(Z)] := arg

min
f (Z)‚ààSpan(1,S(Z))

E[s0 (Z) ‚àí f (Z)]2 ,

which, if exists, is defined by projecting s0 (Z) on the linear span of 1 and S(Z) in the space L2 (P ).
BLP of CATE: The First Strategy. Here we shall identify the coefficients of the BLP from the
weighted linear projection:
Y = Œ±0 X1 + Œ≤1 (D ‚àí p(Z)) + Œ≤2 (D ‚àí p(Z))(S ‚àí ES) + , E[w(Z)X] = 0,

(2.1)

where S := S(Z),
w(Z) = {p(Z)(1 ‚àí p(Z))}‚àí1 ,
X1 := X1 (Z),

e.g.,

X := (X1 , X2 )

X1 = [1, B(Z)],

X2 := [D ‚àí p(Z), (D ‚àí p(Z))(S(Z) ‚àí (S ‚àí ES)].
Note that the above equation uniquely pins down Œ≤1 and Œ≤2 under weak assumptions.
The interaction (D ‚àí p(Z))(S ‚àí ES) is orthogonal to D ‚àí p(Z) under the weight w(Z) and to all
other regressors that are functions of Z under any Z-dependent weight.5
5The orthogonalization ideas embedded in this strategy do have classical roots in econometrics (going back to at

least Frisch and Waugh in the 30s), and similar strategies underlie the orthogonal or double machine learning approach
(DML) in [19]. Our paper has different goals than DML, attacking the problem of inference on heterogeneous effects

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

9

A consequence is our first main identification result, namely that
Œ≤1 + Œ≤2 (S(Z) ‚àí ES) = BLP[s0 (Z) | S(Z)],
in particular Œ≤1 = Es0 (Z) and Œ≤2 = Cov(s0 (Z), S(Z))/ Var(S(Z)).
Theorem 2.1 (BLP 1). Consider z 7‚Üí S(z) and z 7‚Üí B(z) as fixed maps. Assume that Y and X have
finite second moments and that EXX 0 is full rank. Then, (Œ≤1 , Œ≤2 ) defined in (2.1) also solves the best linear
predictor/approximation problem for the target s0 (Z):
(Œ≤1 , Œ≤2 )0 = arg min E[s0 (Z) ‚àí b1 ‚àí b2 S(Z)]2 ,
b1 ,b2

in particular Œ≤1 = ES0 (Z) and Œ≤2 = Cov(s0 (Z), S(Z))/ Var(S(Z)).
The identification result is constructive. We can base the corresponding estimation strategy on
the empirical analog:
Yi = Œ±
b0 X1i + Œ≤b1 (Di ‚àí p(Zi )) + Œ≤b2 (Di ‚àí p(Zi ))(Si ‚àí EN,M Si ) + b
i ,

i ‚àà M,

EN,M [w(Zi )b
i Xi ] = 0,
where EN,M denotes the empirical expectation with respect to the main sample, i.e.
X
EN,M g(Yi , Di , Zi ) := |M |‚àí1
g(Yi , Di , Zi ).
i‚ààM

The properties of this estimator, conditional on the auxilliary data, are well known and follow as
a special case of Lemma B.1 in the Appendix.
Comment 2.1 (Main Implications of the result). If S(Z) is a perfect proxy for s0 (Z), then Œ≤2 = 1.
In general, Œ≤2 6= 1, correcting for noise in S(Z). If S(Z) is complete noise, uncorrelated to s0 (Z),
then Œ≤2 = 0. Furthermore, if there is no heterogeneity, that is s0 (Z) = s, then Œ≤2 = 0. Rejecting
the hypothesis Œ≤2 = 0 therefore means that there is both heterogeneity and S(Z) is its relevant
predictor.

Figure 1 provides two examples. The left panel shows a case without heterogeneity in the CATE
where s0 (Z) = 0, whereas there right panel shows a case with strong heterogeneity in the CATE
where s0 (Z) = Z. In both cases we evenly split 1000 observations between the auxiliary and main
samples, Z is uniformly distributed in (‚àí1, 1), and the proxy predictor S(Z) is estimated by random
forest in the auxiliary sample following the standard implementation, see e.g. [26]. When there
is no heterogeneity, post-processing the ML estimates helps reducing sampling noise bringing the
estimated BLP close to the true BLP; whereas under strong heterogeneity the signal in the ML
estimates dominates the sampling noise and the post-processing has little effect.
without rate and even consistency assumptions. The strategy here is more nuanced in that we are making it work under
misspecification or inconsistent learning, which is likely to be true in very high-dimensional problems.

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

0.5
‚àí0.5

0.0

S(Z)

0
‚àí4

‚àí1.0

‚àí2

S(Z)

2

1.0

4

10

‚àí1.0

‚àí0.5

0.0

0.5

1.0

‚àí1.0

‚àí0.5

Z

0.0

0.5

1.0

Z

Figure 1. Example. In the left panel we have a homogeneous CATE s0 (Z) = 0; in
the right panel we have heterogeneous CATE s0 (Z) = Z. The proxy predictor S(Z)
is produced by the Random Forest, shown by green line, the true BLP of CATE is
shown by black line, and the estimated BLP of CATE is shown by blue line. The
true and estimated BLP of CATE are more attenuated towards zero than the proxy
predictor.
Comment 2.2 (Digression: Naive Strategy that is not Quite Right). It is tempting and ‚Äúmore natural‚Äù to estimate
Y = Œ±ÃÉ1 + Œ±ÃÉ2 B + Œ≤ÃÉ1 D + Œ≤ÃÉ2 D(S ‚àí ES) + ,

E[XÃÉ] = 0,

where XÃÉ = (1, B, D, D(S ‚àí ES)). This is a good strategy for predicting the conditional expectation
of Y given Z and D. But, Œ≤ÃÉ2 6= Œ≤2 , and Œ≤ÃÉ1 + Œ≤ÃÉ2 (S ‚àí ES) is not the best linear predictor of s0 (Z). 
BLP of CATE: The Second Strategy. The second strategy makes use of the Horvitz-Thompson
transformation:
D ‚àí p(Z)
.
H = H(D, Z) =
p(Z)(1 ‚àí p(Z))
It is well known that the transformed response Y H provides an unbiased signal about CATE:
E[Y H | Z] = s0 (Z)
and it follows that
BLP[s0 (Z) | S(Z)] = BLP[Y H | S(Z)].
This simple strategy is completely fine for identification purposes, but can severely underperform
in estimation and inference due to lack of precision. We can repair the deficiencies by considering,

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

11

instead, the linear projection:
Y H = ¬µ0 X1 H + Œ≤1 + Œ≤2 (S ‚àí ES) + Àú,

EÀú
XÃÉ = 0,

(2.2)

where B := B(Z), S := S(Z), and XÃÉ := (X10 H, XÃÉ20 )0 , XÃÉ2 = (1, (S ‚àí ES)0 )0 , where X1 = X1 (Z), e.g.
B(Z) or (B(Z), S(Z), p(Z))0 . The terms X1 are present in order to reduce noise.
We show that, as a complementary main identification result,
Œ≤1 + Œ≤2 (S ‚àí ES) = BLP[s0 (Z) | S(Z)].

Theorem 2.2 (BLP 2). Consider z 7‚Üí S(z) and z 7‚Üí B(z) as fixed maps. Assume that Y has finite second
moments and XÃÉ = (X1 H, 1, (S ‚àí ES)) is such that EXÃÉ XÃÉ 0 is finite and full rank. Then, (Œ≤1 , Œ≤2 ) defined
in (2.2) solves the best linear predictor/approximation problem for the target s0 (Z):
(Œ≤1 , Œ≤2 )0 = arg min E[s0 (Z) ‚àí b1 ‚àí b2 S(Z)]2 ,
b1 ,b2

in particular Œ≤1 = Es0 (Z) and Œ≤2 = Cov(s0 (Z), S(Z))/ Var(S(Z)).
The corresponding estimator is defined through the empirical analog:
Yi Hi = ¬µ
b0 X1i Hi + Œ≤b1 + Œ≤b2 (Si ‚àí EN,M Si ) + b
i ,

EN,M b
i XÃÉi = 0,

and the properties of this estimator, conditional on the auxiliary data, are well known and given
in Lemma B.1.
2.2. The Sorted Group ATE. The target parameters are
E[s0 (Z) | G],
where G is an indicator of group membership.
Comment 2.3. There are many possibilities for creating groups based upon ML tools applied to
the auxiliary data. For example, one can group or cluster based upon predicted baseline response
(as in the ‚Äúendogenous stratification‚Äù analysis, [2]) or based upon actual predicted treatment effect
S. We focus on the latter approach for defining groups, although our identification and inference
ideas immediately apply to other ways of defining groups, and could be helpful in these contexts.
We build the groups to explain as much variation in s0 (Z) as possible
Gk := {S ‚àà Ik },

k = 1, ..., K,

where Ik = [`k‚àí1 , `k ) are non-overlaping intervals that divide the support of S into regions [`k‚àí1 , `k )
with equal or unequal masses:
‚àí‚àû = `0 < `1 < . . . < `K = +‚àû.

12

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

The parameters of interest are the Sorted Group Average Treatment Effects (GATES):
E[s0 (Z) | Gk ],

k = 1, . . . , K.

Given the definition of groups, it is natural for us to impose the monotonicity restriction
E[s0 (Z) | G1 ] 6 ... 6 E[s0 (Z) | GK ],
which holds asymptotically if S(Z) is consistent for s0 (Z) and the latter has an absolutely continuous distribution. Under the monotonicity condition, the estimates could be rearranged to obey the
weak monotonicity condition, improving the precision of the estimator. The joint confidence intervals could also be improved by intersecting them with the set of monotone functions. Furthermore,
as before, we can test for homogeneous effects, s0 (Z) = s, by testing whether,
E[s0 (Z) | G1 ] = ... = E[s0 (Z) | GK ].
GATES: The First Strategy. Here we shall recover the GATES parameters from the weighted linear
projection equation:
0

Y = Œ± X1 +

K
X

Œ≥k ¬∑ (D ‚àí p(Z)) ¬∑ 1(Gk ) + ŒΩ,

E[w(Z)ŒΩW ] = 0,

(2.3)

k=1

for B := B(Z), S := S(Z), W = (X10 , W20 )0 ,
0
W2 = ({(D ‚àí p(Z))1(Gk )}K
k=1 ) .

The presence of D ‚àí p(Z) in the interaction (D ‚àí p(Z))1(Gk ) orthogonalizes this regressor relative
to all other regressors that are functions of Z. The controls X1 , e.g. B, can be included to improve
precision.
The second main identification result is that the projection coefficients Œ≥k are the GATES
parameters:
K
Œ≥ = (Œ≥k )K
k=1 = (E[s0 (Z) | Gk ])k=1 .

Given the identification strategy, we can base the corresponding estimation strategy on the following empirical analog:
Yi = Œ±
b0 X1i + Œ≥
b0 W2i + ŒΩbi ,

i ‚àà M, EN,M [w(Zi )b
ŒΩi Wi ] = 0.

(2.4)

The properties of this estimator, conditional on the auxilliary data, are well known and stated as a
special case of Lemma B.1.
A formal statement appears below, together with a complementary result.
Figure 2 provides two examples using the same designs as in fig. 1. Post-processing the ML
estimates again has stronger effect when there is no heterogeneity, but in both cases help bring the
estimated GATES close to the true GATES.

13

1.0

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

4

‚óè

‚óè
‚óè

‚óè
‚óè

‚óè
‚óè

‚óè

‚óè

‚óè
‚óè

0.0

‚óè
‚óè

E s(Z)|Group

‚óè

0

‚óè
‚óè
‚óè

‚óè

‚óè

‚óè

‚óè
‚óè

‚óè

‚àí0.5

‚àí2

E s(Z)|Group

2

0.5

‚óè
‚óè

‚àí4

‚óè
‚óè

‚àí1.0

‚óè

1

2

3

4

5

1

2

Heterogeneity Group

3

4

5

Heterogeneity Group

Figure 2. In the left panel we have the homogeneous CATE s0 (Z) = 0; in the right
panel we have heterogeneous CATE s0 (Z) = Z. The proxy predictor S(Z) for CATE
is produced by the random forest, whose sorted averages by groups are shown as
red dots, exhibiting large biases. These are the naive estimates. The true sorted
group average treatment effects (GATES) E[s0 (Z) | Gk ] are shown by black dots, and
estimated GATES are shown by blue dots. The true and estimated GATES correct
for the biases relative to the naive strategy shown in red. The estimated GATES
shown by blue dots are always closer to the true GATEs shown by black dots than
the naive estimates shown in red.
GATES: The Second Strategy. Here we employ linear projections on Horvitz-Thompson transformed variables:
K
X
0
Y H = ¬µ X1 H +
Œ≥k ¬∑ 1(Gk ) + ŒΩ, E[ŒΩ WÃÉ ] = 0,
(2.5)
k=1

for B := B(Z), S := S(Z), WÃÉ = (X10 H, WÃÉ20 ), WÃÉ20 = ({1(Gk )}K
k=1 ).
Again, we show that the projection parameters are GATES:
K
Œ≥ = (Œ≥k )K
k=1 = (E[s0 (Z) | Gk ])k=1 .

Given the identification strategy, we can base the corresponding estimation strategy on the following empirical analog:
Yi Hi = ¬µ
b0 X1i Hi + Œ≥
b0 WÃÉ2i + ŒΩbi ,

i ‚àà M, EN,M [b
ŒΩi WÃÉi ] = 0.

(2.6)

14

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

The properties of this estimator, conditional on the auxiliary data, are well known and given in
Lemma B.1. The resulting estimator has similar performance to the previous estimator, and under
some conditions their first-order properties coincide.
The following is the formal statement of the identification result.
Theorem 2.3 (GATES). Consider z 7‚Üí S(z) and z 7‚Üí B(z) as fixed maps. Assume that Y has finite
second moments and the W ‚Äôs and WÃÉ defined above are such that EW W 0 and EWÃÉ WÃÉ 0 are finite and have full
rank. Consider Œ≥ = (Œ≥k )K
k=1 defined by the weighted regression equation (2.3) or by the regression equation
(2.5). These parameters defined in two different ways are equivalent and are equal to the expectation of s0 (Z)
conditional on the proxy group {S ‚àà Ik }:
Œ≥k = E[s0 (Z) | Gk ].
2.3. Classification Analysis (CLAN). When the BLP and GATES analyses reveal substantial heterogeneity, it is interesting to know the properties of the subpopulations that are most and least
affected. Here we focus on the ‚Äúleast affected group‚Äù G1 and ‚Äúmost affect group‚Äù GK . Under the
monotonicity assumption, it is reasonable that the first and the last groups are the most and least
affected, where the labels ‚Äúmost‚Äù and ‚Äúleast‚Äù can be swapped depending on the context.
Let g(Y, Z) be a vector of characteristics of an observational unit. The parameters of interest are
the average characteristics of the most and least affected groups:
Œ¥1 = E[g(Y, Z) | G1 ]

and

Œ¥K = E[g(Y, Z) | GK ].

The parameters Œ¥K and Œ¥1 are identified because they are averages of variables that are directly
observed. We can compare Œ¥K and Œ¥1 to quantify differences between the most and least affected
groups. We call this type of comparisons as classification analysis or CLAN.
3. ‚ÄùVariational‚Äù Estimation and Inference Methods
3.1. Estimation and Inference: The Generic Targets. Let Œ∏ denote a generic target parameter or
functional, for example,
‚Ä¢ Œ∏ = Œ≤2 is the heterogeneity predictor loading parameter;
‚Ä¢ Œ∏ = Œ≤1 + Œ≤2 (S(z) ‚àí ES) is the ‚Äúpersonalized‚Äù prediction of s0 (z);
‚Ä¢ Œ∏ = Œ≥k is the expectation of s0 (Z) for the group Gk ;
‚Ä¢ Œ∏ = Œ≥K ‚àí Œ≥1 is the difference in the expectation of s0 (Z) between the most and least affected
groups;
‚Ä¢ Œ∏ = Œ¥K ‚àí Œ¥1 is the difference in the expectation of the characteristics of the most and least
impacted groups.

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

15

3.2. Quantification of Uncertainty: Two Sources. There are two principal sources of sampling
uncertainty:
(I) Estimation uncertainty regarding the parameter Œ∏, conditional on the data split;
(II) Uncertainty or ‚Äùvariation‚Äù induced by the data splitting.
Conditional on the data split, quantification of estimation uncertainty is standard. To account
for uncertainty with respect to the data splitting, it makes sense to examine the robustness and
variability of the estimates/confidence intervals with respect to different random splits. One of our
goals is to develop methods, which we call ‚Äùvariational estimation and inference‚Äù (VEIN) methods,
for quantifying this uncertainty. These methods can be of independent interest in many settings
where the sample splitting is used.
Quantifying Source (I): Conditional Inference. We first recognize that the parameters implicitly
depend on
DataA := {(Yi , Di , Xi )}i‚ààA ,
the auxiliary sample, used to create the ML proxies B = BA and S = SA . Here we make the
dependence explicit: Œ∏ = Œ∏A .
All of the examples admit an estimator Œ∏bA such that under mild assumptions,
2
Œ∏bA | DataA ‚àºa N (Œ∏A , œÉ
bA
),

in the sense that, as |M | ‚Üí ‚àû,
‚àí1 b
P(b
œÉA
(Œ∏A ‚àí Œ∏A ) 6 z | DataA ) ‚ÜíP Œ¶(z).

Implicitly this requires the auxiliary data DataA to be ‚Äùsufficiently regular‚Äù, and this should happen with high probability.
As a consequence, the confidence interval (CI)
[LA , UA ] := [Œ∏bA ¬± Œ¶‚àí1 (1 ‚àí Œ±/2)b
œÉA ]
covers Œ∏A with approximate probability 1 ‚àí Œ±:
P[Œ∏A ‚àà [LA , UA ] | DataA ] = 1 ‚àí Œ± ‚àí oP (1).
This leads to straighforward conditional inference, which does not account for the sample splitting
uncertainty.
Quantifying Source (II): ‚ÄúVariational‚Äù Inference. Different partitions (A, M ) of {1, ..., N } yield
different targets Œ∏A . Conditional on the data, we treat Œ∏A as a random variable, since (A, M ) are
random sets that form random partitions of {1, . . . , N } into samples of size n and N ‚àí n. Different partitions also yield different estimators Œ∏bA and approximate distributions for these estimators.
Hence we need a systematic way of treating the randomness in these estimators and their distributions.

16

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

Comment 3.1. In cases where the data sets are not large, it may be desirable to restrict attention to
balanced partitions (A, M ), where the proportion of treated units is equal to the designed propensity score.
We want to quantify the uncertainty induced by the random partitioning. Conditional on Data,
the estimated Œ∏bA is still a random variable, and the confidence band [LA , UA ] is a random set. For
reporting purposes, we instead would like to report an estimator and confidence set, which are
non-random conditional on the data.
Adjusted Point and Interval Estimators. Our proposal is as follows. As a point estimator,
we shall report the median of Œ∏bA as (A, M ) vary (as random partitions):
Œ∏b := Med[Œ∏bA | Data].
This estimator is more robust than the estimator based on a single split. To account for partition uncertainty, we propose to report the following confidence interval (CI) with the nominal
confidence level 1 ‚àí 2Œ±:
[l, u] := [Med[LA | Data], Med[UA | Data]].
Note that the price of splitting uncertainty is reflected in the discounting of the confidence level
from 1 ‚àí Œ± to 1 ‚àí 2Œ±. Alternatively, we can report the confidence interval based on inversion
of a test based upon p-values, constructed below.
The above estimator and confidence set are non-random conditional on the data. The confidence set reflects the uncertainty created by the random partitioning of the data into the main and
auxilliary data.
Comment 3.2. For a random variable X with law PX we define
Med(X) := inf{x ‚àà R : PX (X 6 x) > 1/2},
Med(X) := sup{x ‚àà R : PX (X > x) > 1/2},
Med(X) := (Med(X) + Med(X))/2.
Note that the lower median Med(X) is the usual definition of the median. The upper median
Med(X) is the next distinct quantile of the random variable (or it is the usual median after reversing
the order on R). For example, when X is uniform on {1, 2, 3, 4}, then Med(X) = 2 and Med(X) = 3;
and if X is uniform on {1, 2, 3}, then Med(X) = Med(X) = 2. For continuous random variables
the upper and lower medians coincide. For discrete random variables they can differ, but the
differences will be small for variables that are close to being continuous.

Suppose we are testing H0 : Œ∏A = Œ∏0 against H1 : Œ∏A < Œ∏0 , conditional on the auxiliary data,
then the p-value is given by
‚àí1 b
pA = Œ¶(b
œÉA
(Œ∏A ‚àí Œ∏0 )).

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

17

‚àí1 b
The p-value for testing H0 : Œ∏A = Œ∏0 against H1 : Œ∏A > Œ∏0 , is given by pA = 1 ‚àí Œ¶(b
œÉA
(Œ∏A ‚àí Œ∏0 )).

Under the null hypothesis pA is approximately distributed as the uniform variable, pA ‚àº U (0, 1),
conditional on DataA . Note that, conditional on Data, pA still has randomness induced by random
partitioning of the data, which we need to address.
Adjusted P-values. We say that testing the null hypothesis, based on the p-values pA , that
are random conditional on data, has significance level Œ± if
P(pA 6 Œ±/2 | Data) > 1/2

or p.5 = Med(pA | Data) 6 Œ±/2.

That is, for at least 50% of the random data splits, the realized p-value pA falls below the level
Œ±/2. Hence we can call p = 2p.5 the sample splitting-adjusted p-value, and consider its small
values as providing evidence against the null hypothesis.
Comment 3.3. Our construction of p-values builds upon the false-discovery-rate type adjustment
ideas in [15, 41], though what we propose is radically simpler, and is minimalistic for our problem,
whereas the idea of our confidence intervals below appears to be completely new.

The main idea behind this construction is simple: the p-values are distributed as marginal uniform variables {Uj }j‚ààJ , and hence obey the following property.
Lemma 3.1 (A Property of Uniform Variables). Consider M , the (usual, lower) median of a sequence
{Uj }j‚ààJ of uniformly distributed variables, Uj ‚àº U (0, 1) for each j ‚àà J, where variables are not necessarily
independent. Then,
P(M 6 Œ±/2) 6 Œ±.
Proof. Let M denote the median of {Uj }j‚ààJ . Then M 6 Œ±/2 is equivalent to |J|‚àí1
Œ±/2)] ‚àí 1/2 > 0. So
X
[1(Uj 6 Œ±/2)] > 1/2}.
P[M 6 Œ±/2] = E1{|J|‚àí1

P

j‚ààJ [1(Uj

6

j‚ààJ

By Markov inequality this is bounded by
X
2E|J|‚àí1
[1(Uj 6 Œ±/2)] 6 2E[1(Uj 6 Œ±/2)] 6 2Œ±/2 = Œ±.
j‚ààJ

where the last inequality holds by the marginal uniformity.



Main Inference Result: Variational P-values and Confidence Intervals. We present a formal result on adjusted p-values using this condition:
PV. Suppose that A is a set of regular auxiliary data configurations such that for all x ‚àà [0, 1],
under the null hypothesis:
sup |PP [pA 6 x | DataA ‚àà A] ‚àí x| 6 Œ¥ = o(1),

P ‚ààP

18

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

and inf P ‚ààP PP [DataA ‚àà A] =: 1 ‚àí Œ≥ = 1 ‚àí o(1). In particular, suppose that this holds for
the p-values
‚àí1 b
‚àí1 b
pA = Œ¶(b
œÉA
(Œ∏A ‚àí Œ∏A )) and pA = 1 ‚àí Œ¶(b
œÉA
(Œ∏A ‚àí Œ∏A )).

Lemma B.1 shows that this condition is plausible for the least squares estimators defined in the
previous section under mild conditions.
Theorem 3.1 (Uniform Validity of Variational P-Value). Under condition PV and the null hypothesis
holding,
PP (p.5 6 Œ±/2) 6 Œ± + 2(Œ¥ + Œ≥) = Œ± + o(1),
uniformly in P ‚àà P.
In order to establish the properties of the confidence interval [l, u], we first consider the properties of the related confidence interval, which is based on the inversion of the p-value based tests:
CI := {Œ∏ ‚àà R : pu (Œ∏) > Œ±/2, pl (Œ∏) > Œ±/2},

(3.1)

for Œ± < .25 , where, for œÉ
bA > 0,
‚àí1 b
(Œ∏A ‚àí Œ∏)] | Data),
œÉA
pl (Œ∏) := Med(1 ‚àí Œ¶[b

(3.2)

‚àí1 b
(Œ∏A ‚àí Œ∏)] | Data).
pu (Œ∏) := Med(Œ¶[b
œÉA

(3.3)

The confidence interval CI has the following representation in terms of the medians of t-statistics
implied by the proof Theorem 3.2 stated below:
Ô£º
Ô£±
h b
i
Œ∏A
‚àí1 (1 ‚àí Œ±/2) | Data < 0 Ô£Ω
Ô£≤
Med Œ∏‚àí
‚àí
Œ¶
i
h œÉbAb
.
(3.4)
CI = Œ∏ ‚àà R :
Ô£≥
Med Œ∏‚àíŒ∏A + Œ¶‚àí1 (1 ‚àí Œ±/2) | Data > 0 Ô£æ
œÉ
bA

This CI can be (slightly) tighter than [l, u], while the latter is much simpler to construct.
The following theorem establishes that both confidence sets maintain the approximate confidence level 1 ‚àí 2Œ±.
Theorem 3.2 (Uniform Validity of Variational Confidence Intervals). CI can be represented as (3.4)
and CI ‚äÜ [l, u], and under condition PV,
PP (Œ∏A ‚àà CI) > 1 ‚àí 2Œ± ‚àí 2(Œ¥ + Œ≥) = 1 ‚àí 2Œ± ‚àí o(1),
uniformly in P ‚àà P.
4. Other Considerations and Extensions
1. Choosing the Best ML Method Targeting CATE in Stage 1. There are several options. The
best ML method can be chosen using the auxiliary sample, based on either (a) the ability to predict
Y H using BH and S or (b) the ability to predict Y using B and (D ‚àí p(Z))(S ‚àí E(S)) under the
weight w(Z) (as in the first type of strategies we developed earlier). To be specific, we can solve
either of the following problems:

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

19

(a) minimize the errors in the prediction of Y H on BH and S:
X
(B, S) = arg min
[Yi Hi ‚àí B(Zi )Hi ‚àí S(Zi )]2 ,
B‚ààB,S‚ààS

i‚ààA

where B and S are parameter spaces for z 7‚Üí B(z) and z 7‚Üí S(z); or
(b) minimize the errors in the weighted prediction of Y on B and (D ‚àí p(Z))(S ‚àí E(S)):
X
(B, S) = arg min
w(Zi )[Yi ‚àí B(Zi ) ‚àí (Di ‚àí p(Zi )){S(Zi ) ‚àí SÃÑ(Zi )}]2 ,
B‚ààB,S‚ààS

i‚ààA

P
where SÃÑ(Zi ) = |A|‚àí1 i‚ààA S(Zi ) and B and S are parameter spaces for z 7‚Üí B(z) and
z 7‚Üí S(z).
This idea improves over simple but inefficient strategy of predicting Y H just using S, which have
been suggested before for causal inference. It also improves over the simple strategy that predicts
Y using B and DS (which chooses the best predictor for E[Y | D, Z] in a given class but not necessarily the best predictor for CATE s0 (Z)). Note that this idea is new and is of major independent
interest.
2. Choosing the Best ML Method BLP Targeting CATE in Stage 2. The best ML method can
also be chosen in the main sample by maximizing
Œõ := |Œ≤2 |2 Var(S(Z)) = Corr2 (s0 (Z), S(Z))Var(s0 (Z)).

(4.1)

Maximizing Œõ is equivalent to maximizing the correlation between the ML proxy predictor S(Z)
and the true score s0 (Z), or equivalent to maximizing the R2 in the regression of s0 (Z) on S(Z).
3. Choosing the Best ML Method GATES Targeting CATE in Stage 2. Analogously, for GATES
the best ML method can also be chosen in the main sample by maximizing
!2
K
K
X
X
ŒõÃÑ = E
Œ≥k 1(S ‚àà Ik )
=
Œ≥k2 P(S ‚àà Ik ).
(4.2)
k=1

k=1

P
This is the part of variation Es20 (Z) of s0 (z) explained by SÃÑ(Z) = K
k=1 Œ≥k 1(S(Z) ‚àà Ik ). Hence
choosing the ML proxy S(Z) to maximize ŒõÃÑ is equivalent to maximizing the R2 in the regression
of s0 (Z) on SÃÑ(Z) (without a constant). If the groups Gk = {S ‚àà Ik } have equal size, namely
P(S(Z) ‚àà Ik ) = 1/K for each k = 1, ..., K, then
ŒõÃÑ =

K
1 X 2
Œ≥k .
K
k=1

4. Stratified Splitting. The idea is to balance the proportions of treated and untreated in both
A and M samples, so that the proportion of treated is equal to the experiment‚Äôs propensity scores
across strata. This formally requires us to replace the i.i.d. assumption by the i.n.i.d. assumption

20

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

(independent but not identically distributed observations) when accounting for estimation uncertainty, conditional on the auxiliary sample. This makes the notation more complicated, but the
results in Lemma B.1 still go through with notational modifications.
5. When Proxies have Little Variation. The analysis may generate proxy predictors S that have
little variation, so we can think of them as ‚Äúweak‚Äù, which makes the parameter Œ≤2 weakly identified.
We can either add small noise to the proxies, which is called jittering, so that inference results go
through, or we may switch to testing rather than estimation. For practical reasons, we prefer the
jittering approach.

5. Further Potential Applications to Prediction and Causal Inference Problems
Our inference approach generalizes to any problem of the following sort.
Generalization. Suppose we can construct an unbiased signal YÃÉ such that
E[YÃÉ | Z] = s0 (Z),
where s0 (Z) is now a generic target function. Let S(Z) denote an ML proxy for s0 (Z). Then,
using previous arguments, we immediately can generate the following conclusions:
(1)
(2)
(3)
(4)
(5)

The projection of YÃÉ on the ML proxy S(Z) identifies the BLP of s0 (Z) using S(Z).
The grouped averages of the target (GAT) E[s0 (Z) | Gk ] are identified by E[YÃÉ | Gk ].
Using ML tools we can train proxy predictors S(Z) to predict YÃÉ in auxiliary samples.
We post-process S(Z) in the main sample, by estimating the BLP and GATs.
We apply variational inference on functionals of the BLP and GATs.

The noise reduction strategies, like the ones we used on the context of H-transformed outcomes,
can be useful in these cases, but their construction could depend on the context.
Example 1. Forecasting or Predicting Regression Functions using ML proxies. This is the most
common type of the problem arising in forecasting. Here the target is the best predictor of Y using
Z, namely s0 (Z) = E[Y | Z], and YÃÉ = Y trivially serves as the unbiased signal. The interesting part
here is the use of variational inference tools developed in this paper for constructing confidence
intervals for the predicted values produced by the estimated BLP of s0 (Z) using S(Z).
Example 2. Predicting Structural Derivatives using ML proxies. Suppose we are interested in
best predicting the partial derivative s0 (z), where s0 (z) = ‚àÇg(x, z)/‚àÇx, where g(x, z) = E[Y | X =
x, Z = z]. In the context of demand analysis, Y is the log of individual demand, X is the log-price
of a product, and Z includes prices of other products and characteristics of individuals. Then the
unbiased signal is given by YÃÉ = Y [‚àÇ log p(X | Z)/‚àÇx], where p(x | z) is the conditional density

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

21

function of x given z. That is, E[YÃÉ | Z] = s0 (Z) under mild conditions on the density using the
integration by parts formula.

6. Empirical Application and Implementation Algorithms
6.1. Heterogeneity in the Effect of Microcredit Availability. We analyze a randomized experiment designed to evaluate the impact of microcredit availability on borrowing and self-employment
activities, which was previously studied in [22]. The experiment was conducted in 162 villages
in Morocco, divided into 81 pairs of villages with similar observable characteristics (number of
households, accessibility to the center of the community, existing infrastructure, type of activities
carried out by the households, and type of agriculture activities). One of the villages in each pair
was randomly assigned to treatment and the other to control. Between 2006 and 2007 a microfinance institution started operating in the treated villages. Two years after the intervention an
endline household survey was conducted with 5,551 households, which constitute our sample.
There was no other microcredit penetration in these villages, before and for the duration of the
study. Therefore, we interpret the treatment as the availability of microcredit.
Recent randomized evaluations of access to microcredit at the community level have found limited impacts of microcredit.6 Despite evidence that access to microfinance leads to an increase in
borrowing ([3], [9], [47]) and business creation or expansion ([3], [6], [9], [47]), most studies have
found that this does not translate into an increase in economic outcomes such as profit, income,
labor supply and consumption ([3], [9], [22]). Moreover, there is also no evidence of substantial
gains in human development outcomes, such as education and health ([9],[47]). Studies which
estimate the impact of microfinance by randomizing microcredit at the individual level confirm
these findings ([7], [34], [35]).
One question that remains elusive is whether the lack of evidence on the average effects masks
heterogeneity, in which there are potential winners and losers of the microcredit expansion. Understanding this heterogeneity can have important implications for evaluating the welfare effects
of microcredit, designing policies and targeting the groups that would benefit from microfinance.
Indeed, the idea that there might be heterogeneity in the impact of microcredit has been a common
theme among RCTs evaluating microfinance programs. Having found mostly positive but insignificant coefficients, the papers cited above attempt to explore heterogeneous treatment effects, mostly
using quantile treatment effects. For profits, most studies seem to find positive impact at the higher
quantiles (and in the data set we study here, [22] actually find negative impacts at lower level). Using Bayesian hierarchical methods to aggregate the evidence across studies, [40] cautions that these
results on quantiles may not be generalizable: the profit variables seems to have too much noise to
lend itself to quantile estimation.
6See [10] for a summary of the recent literature

22

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

A number of recent papers also consider heterogeneous treatment effects by studying the effect
of microfinance on subpopulations. In a follow-up study of [9], [8] investigates whether the heterogeneity is persistent six years after the microfinance was introduced. They find that credit has
a much bigger impact on the business outcomes of those who started a business before microfinance entered than of those without prior businesses. Using the same dataset as in this application,
[22] classifies households into three categories in term of their probability to borrow before the intervention and finds that microcredit access has a significant impact on investment and profit, but
still no impact on income and consumption among those who are most likely to borrow. It is worth
noting that the original strategy for this study was to construct groups which, ex ante had different probability to borrow, in order to separately estimate the direct effect of microcredit on those
most likely to borrow, and the indirect effect on those very unlikely to borrow. The researchers initially tried to predict the probability to borrow fitting a model to a first group of villages for which
they had collected a short survey. However they ended up predicting the probability to borrow
ex-post because the model proved to have low predictive power. One concern with this ex-post
classification is that it may lead to overfitting.
The identification strategy developed in this paper provides several advantages in studying heterogeneity in the treatment effects of microfinance. First, contrary to the literature, which relies on
ad hoc subgroup analysis across a few baseline characteristics, we are agnostic about the source
of heterogeneity. While the variable ‚Äúhad a prior business‚Äù has proven to be a robust and generalizable predictor of differences in treatment effect ( [40]) and could therefore be pre-specified in
future pre-analysis plans, we have little idea about what else predicts heterogeneity. Second, our
approach is valid in high dimensional settings, allowing us to include a rich set of characteristics
in an unspecified functional form. Finally, using the CLAN estimation we are able to identify the
characteristics of the most and least affected subpopulations, which could be an important input
for a welfare analysis or targeting households who are likely to benefit from access to microfinance.
We focus on heterogeneity in treatment effects on four household outcome variables, Y : the
amount of money borrowed, the output from self-employment activities, profit from self-employment
activities, and monthly consumption. The treatment variable, D, is an indicator for the household
residing in a treated village. The covariates, Z, include some baseline household characteristics
such as number of members, number of adults, head age, indicators for households doing animal husbandry, doing other non-agricultural activity, having an outstanding loan over the past 12
months, household spouse responded to the survey, another household member (excluding the
household head) responded to the survey, and 81 village pair fixed effects (these are the variables
that are available for all households). We also include indicators for missing observation at baseline as controls. Table 1 shows some descriptive statistics for the variables used in the analysis (all
monetary variables are expressed in Moroccan Dirams, or MAD). Treated and control households
have similar characteristics and the unconditional average treatment effect on loans, output, profit
and consumption are respectively 1,128, 5,237, 1,844 and -31.

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

23

Table 1. Descriptive Statistics of Households
All

Treated

Control

2,930
35,148
11,035
2,996

1,802
29,911
9,191
3,027

3.872
2.601
35.937
0.426
0.129
0.224
0.074
0.048

3.886
2.607
36.014
0.404
0.164
0.196
0.061
0.041

Outcome Variables
Total Amount of Loans
2,359
Total output from self-employment activities (past 12 months) 32,499
Total profit from self-employment activities (past 12 months)
10,102
Total monthly consumption
3,012
Baseline Covariates
Number of Household Members
Number of Members 16 Years Old or Older
Head Age
Declared Animal Husbandry Self-employment Activity
Declared Non-agricultural Self-employment Activity
Borrowed from Any Source
Spouse of Head Responded to Self-employment Section
Member Responded to Self-employment Section

3.879
2.604
35.976
0.415
0.146
0.210
0.067
0.044

Table 2. Comparison of ML Methods: Microfinance Availability

Elastic Net

Boosting

Neural Network

Random Forest

2,808,960
875

1,919,609
283

2,175,872
568

2,753,511
1290

142,021,759
8,677

81,927,950
3,625

72,908,917
4,986

123,485,223
5,123

32,462,874
4,595

16,674,642
2,167

13,411,383
1,447

43,184,732
4,344

45,084
101

26,158
69

38,578
85

37,507
109

Amount of Loans
Best BLP (Œõ)
Best GATES (ŒõÃÑ)
Output
Best BLP (Œõ)
Best GATES (ŒõÃÑ)
Profit
Best BLP (Œõ)
Best GATES (ŒõÃÑ)
Consumption
Best BLP (Œõ)
Best GATES (ŒõÃÑ)

Notes: Medians over 100 splits in half.

We implement our methods using the algorithm and ML methods described in Section 6.2. By
design the propensity score p(Zi ) = 1/2 for all the households. Table 2 compares the four ML

24

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

Table 3. BLP of Microfinance Availability

Elastic Net

Random Forest

ATE (Œ≤1 )

HET (Œ≤2 )

ATE (Œ≤1 )

HET (Œ≤2 )

Amount of Loans

1,163
(545,1737)
[0.000]

0.238
(0.021,0.448)
[0.060]

1,180
(546,1770)
[0.001]

0.390
(0.037,0.779)
[0.062]

Output

5,096
(230,10027)
[0.079]

0.262
(0.084,0.431)
[0.008]

4,854
(-167,9982)
[0.116]

0.190
(-0.099,0.498)
[0.385]

Profit

1,554
(-1344,4388)
[0.584]

0.243
(0.079,0.416)
[0.008]

1,625
(-1332,4576)
[0.577]

0.275
(0.036,0.510)
[0.045]

Consumption

-59.2
(-161.4,43.9)
[0.513]

0.154
(-0.054,0.382)
[0.270]

-58.5
(-167.0, 45.9)
[0.494]

0.183
(-0.177,0.565)
[0.617]

Notes: Medians over 100 splits. 90% confidence interval in parenthesis.
P-values for the hypothesis that the parameter is equal to zero in brackets.

methods for producing the proxy predictors S(Zi ) considered in Stage 1. We find that the Random Forest and Elastic Net outperform the Boosted Tree and Neural Network across all outcome
variables for both metrics. Accordingly, we focus on these two methods for the rest of the analysis.7
Table 3 presents results of the BLP of CATE using the ML proxies S(Z) for the four outcome
variables. We report estimates of the coefficients Œ≤1 and Œ≤2 , which correspond to the ATE and
heterogeneity loading (HET) parameters in the BLP, respectively. In parentheses, we report confidence intervals adjusted for variability across the sample splits using the median method; and in
brackets, we report adjusted p-values for the hypothesis that the parameter is equal to zero. The
estimated ATEs of microfinance availability are consistent with the findings of [22] and are similar
to the unconditional ATE, as expected by virtue of the randomization. The ATE on the amount
of loans and output are positive and statistically significant at least at the 10% level with both ML
methods. Microfinance availability does not have a significant impact on profit and consumption.
Turning to the heterogeneity results, we reject the hypothesis that HET is zero at the 10% level
for the amount of loans, output and profit with the elastic net method, suggesting the presence of
heterogeneity in the effect of microfinance availability. The results are consistent across both ML
methods except for output, for which HET coefficient on the Random Forest proxy is not significantly different from zero at the 10% level. Finally, the BLP analysis does not reveal any significant
7The results obtained using Boosted Tree and Neural Network are similar to the results reported, but they are slightly

less precise. These results are not reported but are available from the authors upon request.

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

25

Table 4. GATES of 20% Most and Least Affected Groups
Elastic Net

Amount of Loans

Output

Profit

Consumption

Random Forest

20% Most
(Œ≥5 )

20% Least
(Œ≥1 )

Difference
(Œ≥5 ‚àí Œ≥1 )

20% Most
(Œ≥5

20% Least
(Œ≥1 )

Difference
(Œ≥5 ‚àí Œ≥1 )

2,678

-197

2,995

2,883

70

2,942

(1298,4076)

(-1835,1308)

(946,5104)

(1141,4695)

(-1630,1594)

(551,5355)

[0.000]

[1.000]

[0.008]

[0.002]

[1.000]

[0.034]

22,070

-2,882

2,531

21,551

690

21,790

(7343,36960)

(-12602,6920)

(7201,42649)

(6764,37498)

(-12457,13840)

(-313.6,42831)

[0.007]

[1.000]

[0.012]

[0.011]

[1.000]

[0.108]

10,707

-1,227

11,768

12,000

-2,130

14,056

(1628,19032)

(-7273,5003)

(1186,22485)

(2911,20638)

(-9135,4853)

(2292,25698)

[0.028]

[1.000]

[0.059]

[0.018]

[1.000]

[0.035]

60

-342

378

56

-309

313

(-174,281)

(-686,-0.32)

(-66,808)

(-252,360)

(-691,59)

(-211,813)

[1.000]

[0.100]

[0.189]

[1.000]

[0.222]

[0.522]

Notes: Medians over 100 splits. 90% confidence interval in parenthesis.
P-values for the hypothesis that the parameter is equal to zero in brackets.

heterogeneity in the effect on consumption. Overall, these results suggest that microfinance availability has heterogenous impacts on business-related outcomes that do not seem to translate into a
detectable contemporaneous effect on the standard of living as represented by consumption, even
for the most positively affected households. One possible explanation is that households that are
most likely to borrow and get higher profits from microfinance compensate by reducing their labor
supply: this is the finding in [22].
We next estimate the GATES. We divide the households into K = 5 groups based on the quintiles
of the ML proxy predictor S(Z) and estimate the average effect for each group. Figures 3-6 present
the estimated GATES coefficients Œ≥1 ‚àí Œ≥5 along with joint confidence bands. We also report the
ATE and its confidence interval that were obtained in the BLP analysis for comparison. The GATES
provide a richer understanding of the heterogeneity. In particular, the figures reveal that there are
groups of winners, the most affected groups, for which the GATES on amount of loans, output
and profit are significantly different from zero. These groups are likely to drive the heterogeneity
in the treatment effect that we find in the BLP analysis. We further investigate the GATES by
comparing the most and least affected groups in Table 4. Here we find that the difference of GATES
of these two groups is significantly different from zero at least at the 10% level on amount of loans,
level on output and profit, whereas we fail to reject the hypothesis that this difference is zero at
conventional levels on consumption. Looking at the least affected group, it is reassuring to see that
we have no evidence of negative impact on profit and income, mitigating the concerns that there are
adversely affected households. However, there is negative and insignificant effect on consumption

26

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

Table 5. CLAN of Microfinance Availability

Elastic Net

Random Forest

20% Most
(Œ¥5 )

20% Least
(Œ¥1 )

Difference
(Œ¥5 ‚àí Œ¥1 )

20% Most
(Œ¥5 )

20% Least
(Œ¥1 )

Difference
(Œ¥5 ‚àí Œ¥1 )

30.5
(28.4,32.7)
0.221
(0.191,0.250)
0.169
(0.137,0.202)
-

38.9
(36.9,41.0)
0.059
(0.032,0.087)
0.210
(0.176,0.244)
-

-8.4
(-11.4,-5.4)
[0.000]
0.152
(0.113,0.191)
[0.000]
-0.038
(-0.083,0.007)
[0.199]

24.1
(22.0,26.2)
0.149
(0.123,0.177)
0.126
(0.093,0.159)
-

38.2
(36.1,40.4)
0.107
(0.080,0.136)
0.284
(0.251,0.317)
-

-14.0
(-17.0,-11.0)
[0.000]
0.029
(-0.012,0.070)
[0.326]
-0.156
(-0.203,-0.108)
[0.000]

36.1
(34.0,38.2)
0.276
(0.247,0.306)
0.191
(0.157,0.226)
-

36.5
(34.3,38.6)
0.051
(0.022,0.081)
0.241
(0.206,0.275)
-

-0.445
(-3.4,2.5)
[1.000]
0.226
(0.183,0.268)
[0.000]
-0.056
(-0.105,-0.006)
[0.059]

34.5
(32.3,36.8)
0.252
(0.221,0.283)
0.202
(0.170,0.235)
-

31.7
(29.4,34.0)
0.094
(0.062,0.125)
0.201
(0.167,0.236)
-

2.5
(-0.69,5.6)
[0.262]
0.158
(0.113,0.204)
[0.000]
0.006
(-0.042,0.053)
[1.000]

34.1
(32.1,36.2)
0.198
(0.168,0.227)
0.177
(0.142,0.211)
-

40.0
(37.9,42.1)
0.103
(0.074,0.133)
0.267
(0.233,0.303)
-

-6.2
(-9.0,-3.2)
[0.000]
0.085
(0.044,0.125)
[0.000]
-0.086
(-0.136,-0.036)
[0.002]

31.8
(29.5,34.1)
0.183
(0.153,0.214)
0.164
(0.133,0.197)
-

35.9
(33.6,38.15)
0.111
(0.082,0.140)
0.195
(0.161,0.228)
-

-4.5
(-7.7,-1.2)
[0.013]
0.070
(0.029,0.113)
[0.002]
-0.031
(-0.077,0.015)
[0.373]

Amount of Loans
Head Age

Non-agricultural self-emp.

Borrowed from Any Source

Output
Head Age

Non-agricultural self-emp.

Borrowed from Any Source

Profit
Head Age

Non-agricultural self-emp.

Borrowed from Any Source

Notes: Medians over 100 splits. 90% confidence interval in parenthesis.
P-values for the hypothesis that the parameter is equal to zero in brackets.

for the same group. A possible explanation for this result is that investment is lumpy and some
households cut back consumption to increase investment. All the results for the GATES are fairly
robust to the ML method.
We conclude by looking at the average characteristics of the most and least affected groups to
understand what generates heterogeneity in the treatment effects. We omit the results for consumption as we do not detect heterogeneity for this outcome. We focus on three characteristics
in this analysis: Age of household head, non-agricultural self-employment activity and whether
the household borrowed from any source. Table 5 reports the CLAN for the 20% least and most

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

27

affected groups defined by the quantiles of the CATE proxy S(Z) as well as the difference between
the two. We find households with young heads, non-agriculture self-employment and that borrowed less from any source are likely to borrow more from the microfinance institution, suggesting
that formal loans are substitutes rather than complements. In this setting, formal loans are rare and
most of them are unpaid bills from the utility companies. It does make sense that microfinance is
used to pay for them. For output only the average self-employment sector indicator is found to be
significantly different between the most and least affected groups. Finally, the estimates for profit
are similar to the estimates of amount of loans. It is important to note that the significance of some
of these differences is sensitive to the ML method used to generate the proxy predictors, but the
sign of the differences is robust.
6.2. Implementation Algorithm. In this section we describe an algorithm based on the first identification strategy and provide some specific implementation details for the empirical example.
Algorithm 1 (Inference Algorithm). The inputs are given by the data on units i ‚àà [N ] = {1, ..., N }.
Step 0. Fix the number of splits S and the significance level Œ±, e.g. S = 100 and Œ± = 0.05.
Step 1. Compute the propensity scores p(Zi ) for i ‚àà [N ].
Step 2. Consider S splits in half of the indices i ‚àà {1, ..., N } into the main sample, M , and the
auxiliary sample, A. Over each split s = 1, .., S, apply the following steps:
a. Tune and train each ML method separately to learn B(¬∑) and S(¬∑) using A. For each i ‚àà M ,
compute the predicted baseline effect B(Zi ) and predicted treatment effect S(Zi ). If there is
zero variation in B(Zi ) and S(Zi ) add Gaussian noise with a variance of 0.1 to the proxies.
b. Estimate the BLP parameters by weighted OLS in M , i.e.,
Yi = Œ±
b0 X1i + Œ≤b1 (Di ‚àí p(Zi )) + Œ≤b2 (Di ‚àí p(Zi ))(Si ‚àí EN,M Si ) + b
i , i ‚àà M
0 , D ‚àí p(Z ), (D ‚àí p(Z ))(S ‚àí E
0
such that EN,M [w(Zi )b
i Xi ] = 0 for Xi = [X1i
i
i
i
i
i
N,M Si )] , where
w(Zi ) = {p(Zi )(1 ‚àí p(Zi ))}‚àí1 and X1i includes a constant, B(Zi ) and S(Zi ).
c. Estimate the GATES parameters by weighted OLS in M , i.e.,
0

Yi = Œ±
b X1i +

K
X

Œ≥
bk ¬∑ (Di ‚àí p(Zi )) ¬∑ 1(Si ‚àà Ik ) + ŒΩbi , i ‚àà M,

k=1
0 , {(D ‚àí p(Z ))1(S ‚àà I )}K ]0 , where w(Z ) =
such that EN,M [w(Zi )b
ŒΩi Wi ] = 0 for Wi = [Xi1
i
i
i
i
k k=1
{p(Zi )(1 ‚àí p(Zi ))}‚àí1 , X1i includes a constant, B(Zi ) and S(Zi ), Ik = [`k‚àí1 , `k ), and `k is the
(k/K)-quantile of {Si }i‚ààM .
d. Estimate the CLAN parameters in M by

Œ¥b1 = EN,M [g(Yi , Zi ) | Si ‚àà I1 ]

and

Œ¥bK = EN,M [g(Yi , Zi ) | Si ‚àà IK ],

where Ik = [`k‚àí1 , `k ) and `k is the (k/K)-quantile of {Si }i‚ààM .

28

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

e. Compute the two performance measures for the ML methods
d
b = |Œ≤b2 |2 Var(S(Z))
Œõ

K
X
bÃÑ = 1
Œõ
Œ≥
bk2 .
K
k=1

bÃÑ over the splits.
b and Œõ
Step 3: Choose the best ML methods based on the medians of Œõ
Step 4: Compute the estimates, (1 ‚àí Œ±)-level conditional confidence intervals and conditional
p-values for all the parameters of interest. Monotonize the confidence intervals if needed. For
example, construct a (1 ‚àí Œ±) joint confidence interval for the GATES as
{b
Œ≥k ¬± b
c(1 ‚àí Œ±)b
œÉk , k = 1, . . . , K},

(6.1)

where b
c(1 ‚àí Œ±) is a consistent estimator of the (1 ‚àí Œ±)-quantile of maxk‚àà1,...,K |b
Œ≥k ‚àí Œ≥k |/b
œÉk and œÉ
bk
is the standard error of Œ≥
bk conditional on the data split. Monotonize the band (6.1) with respect to
k using the rearrangement method of [17].
Step 5: Compute the adjusted (1 ‚àí 2Œ±)-confidence intervals and adjusted p-values using the
VEIN methods described in Section 3.
Comment 6.1 (ML Methods). We consider four ML methods to estimate the proxy predictors:
elastic net, boosted trees, neural network with feature extraction, and random forest. The ML
methods are implemented in R using the package caret [37]. The names of the elastic net, boosted
tree, neural network with feature extraction, and random forest methods in caret are glmnet, gbm,
pcaNNet and rf, respectively. For each split of the data, we choose the tuning parameters separately
for B(z) and S(z) based on mean squared error estimates of repeated 2-fold cross-validation, except
for random forest, for which we use the default tuning parameters to reduce the computational
time.8 In tuning and training the ML methods we use only the auxiliary sample. In all the methods
we rescale the outcomes and covariates to be between 0 and 1 before training.
Comment 6.2 (Microfinance Application). We adopt two strategies to improve precision, and to
adapt our strategy to the experimental design. First, since the stratification was conducted within
pairs, the linear projections of the BLP and GATES control for village pair fixed effects along with
the predicted baseline effect, B(z) and predicted treatment effect, S(z). Second, as suggested in
Section 4, we use stratified sample splitting where the strata are village pairs. We cluster the standard errors at the village level to account for potential correlated shocks within each village. All
reported results are medians over S = 100 splits and Œ± = 0.05.
8We have the following tuning parameters for each method: Elastic Net: alpha (Mixing Percentage), lambda (Regular-

ization Parameter), Boosted trees: n.trees (Number of Boosting Iterations), interaction.depth (Max Tree Depth), shrinkage (Shrinkage), n.minobsinnode (Min. Terminal Node Size), size (Number of Hidden Units) , decay (Weight Decay),
mtry (Number of Randomly Selected Predictors).

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

29

7. Concluding Remarks
We propose to focus inference on key features of heterogeneous effects in randomized experiments, and develop the corresponding methods. These key features include best linear predictors
of the effects and average effects sorted by groups, as well as average characteristics of most and
least affected units. Our new approach is valid in high dimensional settings, where the effects are
estimated by machine learning methods. The main advantage of our approach is its credibility: the
approach is agnostic about the properties of the machine learning estimators, and does not rely on
incredible or hard-to-verify assumptions. Estimation and inference relies on data splitting, where
the latter allows us to avoid overfitting and all kinds of non-regularities. Our inference quantifies uncertainty coming from both parameter estimation and the data splitting, and could be of
independent interest. An empirical application illustrates the practical uses of the approach.
Appendix A. Proofs
Proof of Theorem 2.1. The subset of the normal equations, which correspond to Œ≤ := (Œ≤1 , Œ≤2 )0 , are
given by E[w(Z)(Y ‚àí Œ±0 X1 ‚àí Œ≤ 0 X2 )X2 ] = 0. Substituting Y = b0 (Z) + s0 (Z)D + U , and using the
definition X2 = X2 (Z, D) = [D ‚àí p(Z), (D ‚àí p(Z)(S ‚àí ES)]0 , X1 = X1 (Z), and the law of iterated
expectations, we notice that:
E[w(Z)b0 (Z)X2 ] = E[w(Z)b0 (Z) E[X2 | Z]] = 0,
=0

E[w(Z)U X2 ] = E[w(Z) E[U | Z, D] X2 (Z, D)] = 0,
0

E[w(Z)X1 X2 ] = E[w(Z)X1 (Z) E[X2 (Z, D) | Z]] = 0.
=0

Hence the normal equations simplify to: E[w(Z)(s0 (Z)D ‚àí Œ≤ 0 X2 )X2 ] = 0. Since
E[{D ‚àí p(Z)}{D ‚àí p(Z)} | Z] = p(Z)(1 ‚àí p(Z)) = w‚àí1 (Z),
and S = S(Z), the components of X2 are orthogonal by the law of iterated expectations:
Ew(Z)(D ‚àí p(Z))(D ‚àí p(Z))(S ‚àí ES) = E(S ‚àí ES) = 0.
Hence the normal equations above further simplify to
E[w(Z){s0 (Z)D ‚àí Œ≤1 (D ‚àí p(Z))}(D ‚àí p(Z))] = 0,
E[w(Z){s0 (Z)D ‚àí Œ≤2 (D ‚àí p(Z))(S ‚àí ES)}(D ‚àí p(Z))(S ‚àí ES)] = 0.
Solving these equations and using the law of iterated expectations, we obtain
Œ≤1 =

Ew(Z)s0 (Z)w‚àí1 (Z)
Ew(Z){s0 (Z)D(D ‚àí p(Z))}
=
= Es0 (Z),
Ew(Z)(D ‚àí p(Z))2
Ew(Z)w‚àí1 (Z)
Œ≤2 =

Ew(Z){s0 (Z)D(D ‚àí p(Z))(S ‚àí ES)}
Ew(Z)(D ‚àí p(Z))2 (S ‚àí ES)2

30

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

=

Ew(Z)s0 (Z)w‚àí1 (Z)(S ‚àí ES)
= Cov(s0 (Z), S)/Var(S).
Ew(Z)w‚àí1 (Z)(S ‚àí ES)2

The conclusion follows by noting that these coefficients also solve the normal equations
E{[s0 (Z) ‚àí Œ≤1 ‚àí Œ≤2 (S ‚àí ES)][1, (S ‚àí ES)]0 } = 0,
which characterize the optimum in the problem of best linear approximation/prediction of s0 (Z)
using S.

Proof of Theorem 2.2. The normal equations defining Œ≤ = (Œ≤1 , Œ≤2 )0 are given by E[(Y H ‚àí¬µ0 X1 H ‚àí
Œ≤ 0 XÃÉ2 )XÃÉ2 ] = 0. Substituting Y = b0 (Z) + s0 (Z)D + U , and using the definition XÃÉ2 = XÃÉ2 (Z) =
[1, (S(Z) ‚àí ES(Z))]0 , X1 = X1 (Z), and the law of iterated expectations, we notice that:
E[b0 (Z)H XÃÉ2 (Z)] = E[b0 (Z) E[H | Z] XÃÉ2 (Z)] = 0,
=0

E[U H XÃÉ2 (Z)] = E[E[U | Z, D] H(D, Z)XÃÉ2 (Z)] = 0,
0

E[X1 (Z)H XÃÉ2 (Z)] = E[X1 (Z) E[H | Z] XÃÉ2 (Z)] = 0.
=0

Hence the normal equations simplify to:
E[(s0 (Z)DH ‚àí Œ≤ 0 XÃÉ2 )XÃÉ2 ] = 0.
Since 1 and S ‚àí ES are orthogonal, the normal equations above further simplify to
E{s0 (Z)DH ‚àí Œ≤1 } = 0,
E[{s0 (Z)DH ‚àí Œ≤2 (S ‚àí ES)}(S ‚àí ES)] = 0.
Using that
E[DH | Z] = [p(Z)(1 ‚àí p(Z))]/[p(Z)(1 ‚àí p(Z))] = 1,
S = S(Z), and the law of iterated expectations, the equations simplify to
E{s0 (Z) ‚àí Œ≤1 } = 0,
E{s0 (Z) ‚àí Œ≤2 (S ‚àí ES)}(S ‚àí ES) = 0.
These are normal equations that characterize the optimum in the problem of best linear approximation/prediction of s0 (Z) using S. Solving these equations gives the expressions for Œ≤1 and Œ≤2
stated in the theorem.

Proof of Theorem 2.3. The proof is similar to the proof of Theorem 2.1- 2.2. Moreover, since the
proofs for the two strategies are similar, we will only demonstrate the proof for the second strategy.
The subset of the normal equations, which correspond to Œ≥ := (Œ≥k )K
k=1 , are given by E[(Y H ‚àí
0
0
¬µ WÃÉ1 ‚àí Œ≥ WÃÉ2 )WÃÉ2 ] = 0. Substituting Y = b0 (Z) + s0 (Z)D + U , and using the definition WÃÉ2 =

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

31

0
WÃÉ2 (Z) = [1(S ‚àà Ik )K
k=1 ] , WÃÉ1 = X1 (Z)H, and the law of iterated expectations, we notice that:

E[b0 (Z)H WÃÉ2 (Z)] = E[b0 (Z) E[H | Z] WÃÉ2 (Z)] = 0,
=0

E[U H WÃÉ2 (Z)] = E[E[U | Z, D] H(D, Z)WÃÉ2 (Z)] = 0,
0

E[WÃÉ1 WÃÉ2 (Z)] = E[X1 (Z) E[H | Z] WÃÉ2 (Z)] = 0.
=0

Hence the normal equations simplify to:
E[{s0 (Z)DH ‚àí Œ≥ 0 WÃÉ2 }WÃÉ2 ] = 0.
0
Since components of WÃÉ2 = WÃÉ2 (Z) = [1(Gk )K
k=1 ] are orthogonal, the normal equations above further simplify to

E[{s0 (Z)DH ‚àí Œ≥k 1(Gk )}1(Gk )] = 0.
Using that
E[DH | Z] = [p(Z){1 ‚àí p(Z)}]/[p(Z){1 ‚àí p(Z)}] = 1,
S = S(Z), and the law of iterated expectations, the equations simplify to
E[{s0 (Z) ‚àí Œ≥k 1(Gk )}1(Gk )] = 0 ‚áê‚áí Œ≥k = Es0 (Z)1(Gk )/E[1(Gk )] = E[s0 (Z) | Gk ].


Proof of Theorem 3.1. We have that p.5 6 Œ±/2 is equivalent to EP [1(pA 6 Œ±/2) | Data] > 1/2. So
PP [p.5 6 Œ±/2] = EP 1{EP [1(pA 6 Œ±/2) | Data] > 1/2}.
By Markov inequality,
EP 1{EP [1(pA 6 Œ±/2) | Data] > 1/2} 6 2PP [pA 6 Œ±/2].
Moreover,
PP (pA 6 Œ±/2) 6 EP [PP [pA 6 Œ±/2 | DataA ‚àà A] + Œ≥] 6 Œ±/2 + Œ¥ + Œ≥.


Proof of Theorem 3.2. To show the second claim, we note that
PP (Œ∏A 6‚àà CI) = PP (pl (Œ∏A ) 6 Œ±/2) + PP (pu (Œ∏A ) 6 Œ±/2)
6 Œ± + Œ¥ + Œ≥ + Œ± + Œ¥ + Œ≥,
where the inequality holds by Theorem 3.1 on the p-values. The last bound is upper bounded by
2Œ± + o(1) by the regularity condition PV for the p-values, uniformly in P ‚àà P.
To show the first claim, we need to show the following inequalities:
sup{Œ∏ ‚àà R : pu (Œ∏) > Œ±/2} 6 u,

inf{Œ∏ ‚àà R : pl (Œ∏) > Œ±/2} > l.

We demonstrate the first inequality, and the second follows similarly.

32

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

We have that
‚àí1 b
{Œ∏ ‚àà R : pu (Œ∏) > Œ±/2} = {Œ∏ ‚àà R : Med[Œ¶{b
œÉA
(Œ∏A ‚àí Œ∏)} | Data] > Œ±/2}
‚àí1 b
œÉA
= {Œ∏ ‚àà R : Œ¶{Med[b
(Œ∏A ‚àí Œ∏) | Data]} > Œ±/2}
‚àí1 b
= {Œ∏ ‚àà R : Med[b
œÉA
(Œ∏A ‚àí Œ∏) | Data] > Œ¶‚àí1 (Œ±/2)}
‚àí1
œÉA
(Œ∏ ‚àí Œ∏bA ) | Data] < Œ¶‚àí1 (1 ‚àí Œ±/2)}
= {Œ∏ ‚àà R : Med[b
#
)
(
"
Œ∏ ‚àí Œ∏bA
‚àí Œ¶‚àí1 (1 ‚àí Œ±/2) | Data < 0 ,
=
Œ∏ ‚àà R : Med
œÉ
bA

where we have used the equivariance of Med and Med to monotone transformations, implied from
their definition. We claim that by the definition of
u := Med[Œ∏bA + œÉ
bA Œ¶‚àí1 (1 ‚àí Œ±/2) | Data],
we have

#
u ‚àí Œ∏bA
‚àí Œ¶‚àí1 (1 ‚àí Œ±/2) | Data > 0.
Med
œÉ
bA
"

Indeed, by the definition of u,


E 1(u ‚àí Œ∏bA ‚àí œÉ
bA Œ¶‚àí1 (1 ‚àí Œ±/2) > 0) | Data > 1/2.
Since œÉ
bA > 0 by assumption,
1(u ‚àí Œ∏bA ‚àí œÉ
bA Œ¶‚àí1 (1 ‚àí Œ±/2) > 0) = 1

!
u ‚àí Œ∏bA
‚àí Œ¶‚àí1 (1 ‚àí Œ±/2) > 0 ,
œÉ
bA

and it follows that
P

 u ‚àí Œ∏b

A

œÉ
bA


‚àí Œ¶‚àí1 (1 ‚àí Œ±/2) > 0 | Data > 1/2.

The claimed inequality sup{Œ∏ ‚àà R : pu (Œ∏) > Œ±/2} 6 u follows.



Appendix B. A Lemma on Uniform in P Conditional Inference
Lemma B.1. Fix two positive constants c and C, and a small constant Œ¥ > 0. Let YÃÉ and X denote a generic
outcome and a generic d-vector of regressors, whose use and definition may differ in different places of the
paper. Assume that for each P ‚àà P, EP |YÃÉ |4+Œ¥ < C and let 0 < w 6 w(Z) 6 w < ‚àû denote a generic
weight, and that {(YÃÉi , Zi , Di )}N
i=1 are i.i.d. copies of (YÃÉ , Z, D). Let {DataA ‚àà AN } be the event such
that the ML algorithm, operating only on DataA , produces a vector XA = X(Z, D; DataA ) that obeys, for
A = YÃÉ ‚àí X 0 Œ≤A defined by: EP [A w(Z)XA | DataA ] = 0, the following inequalities, uniformly in P ‚àà P
0
0
EP [kXA k4+Œ¥ | DataA ] 6 C, mineig EP [XA XA
| DataA ] > c, mineig EP [2A XA XA
| DataA ] > c.

Suppose that PP {DataA ‚àà AN } > 1 ‚àí Œ≥ ‚Üí 1 uniformly in P ‚àà P, as N ‚Üí ‚àû. Let Œ≤bA be defined by:
EN,M [w(Z)XAb
A ] = 0,

b
A = YA ‚àí X 0 Œ≤bA .

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

33

0 )‚àí1 E
0 (E
0 ‚àí1 be an estimator of
Let VbN,A := (EN,M XA XA
2A XA XA
N,M b
N,M XA XA )
0
0
0
VN,A = (EP [XA XA
| DataA ])‚àí1 EP [2A XA XA
| DataA ](EP [XA XA
| DataA ])‚àí1 .

Let Id denote the identify matrix of order d. Then for any convex set R in Rd , we have that uniformly in
P ‚àà P:
‚àí1/2 b
PP [Vb
(Œ≤A ‚àí Œ≤A ) ‚àà R | DataA ] ‚ÜíP P(N (0, Id ) ‚àà R),
N,A

‚àí1/2
PP [VbN,A (Œ≤bA ‚àí Œ≤A ) ‚àà R | {DataA ‚àà AN }] ‚Üí P(N (0, Id ) ‚àà R),

and the same results hold with VbN,A replaced by VN,A .
Proof. It suffices to demonstrate the argument for an arbitrary sequence {Pn } in P. Let z 7‚Üí
XÃÉA,N (z) be a deterministic map such that the following inequalities hold, for eÃÉA defined by
EPn [eÃÉA w(Z)XÃÉA,N (Z)] = 0
and XÃÉA,N = XÃÉA,N (Z):
0
0
EPn [kXÃÉA,N k4 ] < C, mineig EPn [XÃÉA,N XÃÉA,N
] > c, mineig EPn [eÃÉ2A XÃÉA,N XÃÉA,N
] > c.

Then we have that (abusing notation):
BN := sup

sup

XÃÉA,N h‚ààBL1 (Rd )

‚àí1/2

|EPn h(VÃÉN,A (Œ≤bA ‚àí Œ≤A ) | XÃÉA,N ) ‚àí Eh(N (0, Id ))| ‚Üí 0,

by the standard argument for asymptotic normality of the least squares estimator, which utilizes
the Lindeberg-Feller Central Limit Theorem. Here
0 ‚àí1
0
0 ‚àí1
) ,
(EXÃÉA XÃÉA
) EÀú
2A XÃÉA XÃÉA
VÃÉN,A := (EXÃÉA XÃÉA

and BL1 (Rd ) denotes the set of Lipschitz maps h : Rd ‚Üí [0, 1] with the Lipschitz coefficient
bounded by 1.
Then, for the stochastic sequence XA,N = XA,N (DataA ),
sup
h‚ààBL1 (Rd )

‚àí1/2

|EPn [h(VN,A (Œ≤bA ‚àí Œ≤A )) | XA,N ] ‚àí E[h(N (0, Id ))]| 6 BN + 2(1 ‚àí 1{DataA ‚àà AN }) ‚ÜíPn 0.

1/2 ‚àí1/2
Since under the stated bounds on moments, VbN,A VN,A ‚ÜíPn Id by the standard argument for
consistency of the Eicker-Huber-White sandwich, we further notice that

sup
h‚ààBL1

(Rd )

‚àí1/2
‚àí1/2
|EPn [h(VbN,A (Œ≤bA ‚àí Œ≤A )) | XA,N ] ‚àí EPn [h(VN,A (Œ≤bA ‚àí Œ≤A )) | XA,N ]|

‚àí1/2 1/2
‚àí1/2
6 EPn [kVbN,A VN,A ‚àí Id k ‚àß 1 ¬∑ kVN,A (Œ≤bA ‚àí Œ≤A )k ‚àß 1 | XA,N ] ‚ÜíPn E[0 ‚àß 1 ¬∑ kN (0, Id )k ‚àß 1] = 0,

in order to conclude that
sup
h‚ààBL1 (Rd )

‚àí1/2
EPn [h(VbN,A (Œ≤bA ‚àí Œ≤A )) | XA,N ] ‚àí E[h(N (0, Id ))] ‚ÜíP 0.

34

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

‚àí1/2
‚àí1/2
Moreover, since EPn [h(VbN,A (Œ≤bA ‚àí Œ≤A )) | XA,N ] = EPn [h(VbN,A (Œ≤bA ‚àí Œ≤A )) | DataA ], the first
‚àí1/2
conclusion follows: PPn [VbN,A (Œ≤bA ‚àí Œ≤A ) ‚àà R | DataA ] ‚ÜíPn P(N (0, Id ) ‚àà R), by the conventional
smoothing argument (where we approximate the indicator of a convex region by a smooth map
with finite Lipschitz coefficient). The second conclusion
‚àí1/2
PPn [VbN,A (Œ≤bA ‚àí Œ≤A ) ‚àà R | DataA ‚àà AN ] ‚Üí P(N (0, Id ) ‚àà R)

follows from the first by
‚àí1/2

PPn [VbN,A (Œ≤bA ‚àí Œ≤A ) ‚àà R | DataA ‚àà AN ] =
‚àí1/2
= EPn [PPn [VbN,A (Œ≤bA ‚àí Œ≤A ) ‚àà R | DataA ]1({DataA ‚àà AN })/PPn {DataA ‚àà AN }]

‚Üí E[P(N (0, Id ) ‚àà R) ¬∑ 1],
using the definition of the weak convergence, implied by the convergence to the constants in probability.

References
[1] Alberto Abadie. Semiparametric difference-in-differences estimators. The Review of Economic Studies, 72(1):1‚Äì19,
2005.
[2] Alberto Abadie, Matthew M Chingos, and Martin R West. Endogenous stratification in randomized experiments.
Technical report, National Bureau of Economic Research, 2017.
[3] Manuela Angelucci, Dean Karlan, and Jonathan Zinman. Microcredit impacts: Evidence from a randomized microcredit program placement experiment by compartamos banco. American Economic Journal: Applied Economics,
7(1):151‚Äì182, 2015.
[4] Susan Athey and Guido Imbens. Recursive partitioning for heterogeneous causal effects. Proceedings of the National
Academy of Sciences, 113(27):7353‚Äì7360, 2016.
[5] Susan Athey and Guido W Imbens. The econometrics of randomized experiments. Handbook of Economic Field Experiments, 1:73‚Äì140, 2017.
[6] Orazio Attanasio, Britta Augsburg, Ralph De Haas, Emla Fitzsimons, and Heike Harmgart. The impacts of microfinance: Evidence from joint-liability lending in mongolia. American Economic Journal: Applied Economics, 7(1):90‚Äì122,
2015.
[7] Britta Augsburg, Ralph De Haas, Heike Harmgart, and Costas Meghir. Microfinance, poverty and education. 2012.
[8] Abhijit Banerjee, Emily Breza, Esther Duflo, and Cynthia Kinnan. Do credit constraints limit entrepreneurship?
heterogeneity in the returns to microfinance. Evanston, USA: Department of Economics Northwestern University, 2015.
[9] Abhijit Banerjee, Esther Duflo, Rachel Glennerster, and Cynthia Kinnan. The miracle of microfinance? evidence
from a randomized evaluation. American Economic Journal: Applied Economics, 7(1):22‚Äì53, 2015.
[10] Abhijit Vinayak Banerjee. Microcredit under the microscope: what have we learned in the past two decades, and
what do we need to know? Annu. Rev. Econ., 5(1):487‚Äì519, 2013.
[11] G. Barnard. Discussion of ‚ÄúCross-validatory choice and assessment of statistical predictions‚Äù by Stone. Journal of
the Royal Statistical Society. Series B (Methodological), page 133?135, 1974.
[12] A. Belloni, V. Chernozhukov, and C. Hansen. Inference on treatment effects after selection amongst highdimensional controls. Review of Economic Studies, 81:608‚Äì650, 2014.
[13] Alexandre Belloni, Victor Chernozhukov, and Kengo Kato. Uniform post selection inference for lad regression
models. arXiv preprint arXiv:1304.0282, 2013.

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

35

[14] Alexandre Belloni, Victor Chernozhukov, and Lie Wang. Pivotal estimation of nonparametric functions via squareroot lasso. arXiv preprint arXiv:1105.1475, 2011.
[15] Yoav Benjamini and Yosef Hochberg. Controlling the false discovery rate: a practical and powerful approach to
multiple testing. Journal of the royal statistical society. Series B (Methodological), pages 289‚Äì300, 1995.
[16] P. J. Bickel, Y. Ritov, and A. B. Tsybakov. Simultaneous analysis of Lasso and Dantzig selector. Annals of Statistics,
37(4):1705‚Äì1732, 2009.
[17] V. Chernozhukov, I. FernaÃÅndez-Val, and A. Galichon. Improving point and interval estimators of monotone functions by rearrangement. Biometrika, 96(3):559‚Äì575, 2009.
[18] V. Chernozhukov, I. Fernandez-Val, and Y. Luo. The Sorted Effects Method: Discovering Heterogeneous Effects
Beyond Their Averages. ArXiv e-prints, December 2015.
[19] Victor Chernozhukov, Denis Chetverikov, Mert Demirer, Esther Duflo, Christian Hansen, Whitney Newey, and
James Robins. Double/debiased machine learning for treatment and structural parameters. The Econometrics Journal, 2017.
[20] Victor Chernozhukov, Denis Chetverikov, and Kengo Kato. Anti-concentration and honest, adaptive confidence
bands. The Annals of Statistics, 42(5):1787‚Äì1818, 2014.
[21] DR Cox. A note on data-splitting for the evaluation of significance levels. Biometrika, 62(2):441‚Äì444, 1975.
[22] Bruno CreÃÅpon, Florencia Devoto, Esther Duflo, and William ParienteÃÅ. Estimating the impact of microcredit on those
who take it up: Evidence from a randomized experiment in morocco. American Economic Journal: Applied Economics,
7(1):123‚Äì150, 2015.
[23] Jonathan Davis and Sara B Heller. Rethinking the benefits of youth employment programs: The heterogeneous
effects of summer jobs. Technical report, National Bureau of Economic Research, 2017.
[24] Ruben Dezeure, Peter BuÃàhlmann, and Cun-Hui Zhang. High-dimensional simultaneous inference with the bootstrap. arXiv preprint arXiv:1606.03940, 2016.
[25] Esther Duflo, Rachel Glennerster, and Michael Kremer. Using randomization in development economics research:
A toolkit. Handbook of development economics, 4:3895‚Äì3962, 2007.
[26] Jerome Friedman, Trevor Hastie, and Robert Tibshirani. The elements of statistical learning, volume 1. Springer series
in statistics New York, 2001.
[27] Christopher Genovese and Larry Wasserman. Adaptive confidence bands. The Annals of Statistics, pages 875‚Äì905,
2008.
[28] Evarist GineÃÅ and Richard Nickl. Confidence bands in density estimation. The Annals of Statistics, 38(2):1122‚Äì1170,
2010.
[29] Christian Hansen, Damian Kozbur, and Sanjog Misra. Targeted undersmoothing. arXiv preprint arXiv:1706.07328,
2017.
[30] John A Hartigan. Using subsample values as typical values. Journal of the American Statistical Association,
64(328):1303‚Äì1317, 1969.
[31] Keisuke Hirano, Guido W. Imbens, and Geert Ridder. Efficient estimation of average treatment effects using the
estimated propensity score. Econometrica, 71(4):1161‚Äì1189, 2003.
[32] Kosuke Imai and Marc Ratkovic. Estimating treatment effect heterogeneity in randomized program evaluation. The
Annals of Applied Statistics, 7(1):443‚Äì470, 2013.
[33] Guido W Imbens and Donald B Rubin. Causal inference in statistics, social, and biomedical sciences. Cambridge University Press, 2015.
[34] Dean Karlan and Jonathan Zinman. Expanding credit access: Using randomized supply decisions to estimate the
impacts. The Review of Financial Studies, 23(1):433‚Äì464, 2009.
[35] Dean Karlan and Jonathan Zinman. Microcredit in theory and practice: Using randomized credit scoring for impact
evaluation. Science, 332(6035):1278‚Äì1284, 2011.

36

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

[36] Leslie Kish and Martin Richard Frankel. Inference from complex samples. Journal of the Royal Statistical Society. Series
B (Methodological), pages 1‚Äì37, 1974.
[37] Max Kuhn. Caret package. Journal of Statistical Software, 28(5):1‚Äì26, 2008.
[38] Guillaume LecueÃÅ and Charles Mitchell. Oracle inequalities for cross-validation type procedures. Electronic Journal
of Statistics, 6:1803‚Äì1837, 2012.
[39] Mark G Low et al. On nonparametric confidence intervals. The Annals of Statistics, 25(6):2547‚Äì2554, 1997.
[40] Rachael Meager. Aggregating distributional treatment effects: A bayesian hierarchical analysis of the microcredit
literature. Working Paper, 2017.
[41] Nicolai Meinshausen, Lukas Meier, and Peter BuÃàhlmann. P-values for high-dimensional regression. Journal of the
American Statistical Association, 104(488):1671‚Äì1681, 2009.
[42] Frederick Mosteller and John Wilder Tukey. Data analysis and regression: a second course in statistics. AddisonWesley Series in Behavioral Science: Quantitative Methods, 1977.
[43] Natalia Rigol, Reshmaan Hussam, and Benjamin Roth. Targeting high ability entrepreneurs using community information: Mechanism design in the field, 2016.
[44] Alessandro Rinaldo, Larry Wasserman, Max G‚ÄôSell, Jing Lei, and Ryan Tibshirani. Bootstrapping and sample splitting for high-dimensional, assumption-free inference. arXiv preprint arXiv:1611.05401, 2016.
[45] Donald B Rubin. Estimating causal effects of treatments in randomized and nonrandomized studies. Journal of
educational Psychology, 66(5):688, 1974.
[46] Charles J. Stone. Optimal global rates of convergence for nonparametric regression. Ann. Statist., 10(4):1040‚Äì1053,
1982.
[47] Alessandro Tarozzi, Jaikishan Desai, and Kristin Johnson. The impacts of microcredit: Evidence from ethiopia.
American Economic Journal: Applied Economics, 7(1):54‚Äì89, 2015.
[48] Stefan Wager and Susan Athey. Estimation and inference of heterogeneous treatment effects using random forests.
Journal of the American Statistical Association, (just-accepted), 2017.
[49] Larry Wasserman. Machine learning overview. In Becker-Friedman Institute, Conference on ML in Economics, 2016.
[50] Larry Wasserman and Kathryn Roeder. High dimensional variable selection. Annals of statistics, 37(5A):2178, 2009.
[51] Marten Wegkamp et al. Model selection in nonparametric regression. The Annals of Statistics, 31(1):252‚Äì273, 2003.
[52] Qingyuan Zhao, Dylan S Small, and Ashkan Ertefaie. Selective inference for effect modification via the lasso. arXiv
preprint arXiv:1705.08020, 2017.

GENERIC ML FOR FEATURES OF HETEROGENOUS TREATMENT EFFECTS

Elastic Net

Random Forest

ATE

90% CB(ATE)

ATE

90% CB(ATE)

GATES

90% CB(GATES)

GATES

90% CB(GATES)

1

2

4000

Treatment Effect

4000

Treatment Effect

37

2000

2000

0

0

‚àí2000

‚àí2000
1

2

3

4

5

Group by Het Score

3

4

5

Group by Het Score

Figure 3. GATES of Microfinance Availability: Amount of Loans. Point estimates
and 90% adjusted confidence intervals uniform across groups based on 100 random
splits in half
Elastic Net
40000

ATE

90% CB(ATE)

GATES

90% CB(GATES)

Random Forest
40000

90% CB(ATE)

GATES

90% CB(GATES)

1

2

Treatment Effect

20000

Treatment Effect

20000

ATE

0

0

‚àí20000

‚àí20000
1

2

3
Group by Het Score

4

5

3

4

Group by Het Score

Figure 4. GATES of Microfinance Availability: Output. Point estimates and 90%
adjusted confidence intervals uniform across groups based on 100 random splits in
half

5

38

VICTOR CHERNOZHUKOV, MERT DEMIRER, ESTHER DUFLO, AND IVAÃÅN FERNAÃÅNDEZ-VAL

Elastic Net

20000

ATE

90% CB(ATE)

GATES

90% CB(GATES)

Random Forest

20000

90% CB(ATE)

GATES

90% CB(GATES)

1

2

10000
Treatment Effect

Treatment Effect

10000

ATE

0

‚àí10000

0

‚àí10000

1

2

3

4

5

3

Group by Het Score

4

5

Group by Het Score

Figure 5. GATES of Microfinance Availability: Profit. Point estimates and 90% adjusted confidence intervals uniform across groups based on 100 random splits in
half
Elastic Net
ATE

90% CB(ATE)

GATES

90% CB(GATES)

500

Treatment Effect

Treatment Effect

500

Random Forest

0

‚àí500

ATE

90% CB(ATE)

GATES

90% CB(GATES)

1

2

0

‚àí500

1

2

3
Group by Het Score

4

5

3

4

Group by Het Score

Figure 6. GATES of Microfinance Availability: Consumption. Point estimates and
90% adjusted confidence intervals uniform across groups based on 100 random
splits in half

5

