NBER WORKING PAPER SERIES

EMPIRICAL ASSET PRICING VIA MACHINE LEARNING
Shihao Gu
Bryan Kelly
Dacheng Xiu
Working Paper 25398
http://www.nber.org/papers/w25398
NATIONAL BUREAU OF ECONOMIC RESEARCH
1050 Massachusetts Avenue
Cambridge, MA 02134
December 2018, Revised September 2019
We benefitted from discussions with Joseph Babcock, Si Chen (Discussant), Rob Engle, Andrea
Frazzini, Amit Goyal (Discussant), Lasse Pedersen, Lin Peng (Discussant), Alberto Rossi
(Discussant), Guofu Zhou (Discussant), and seminar and conference participants at Erasmus
School of Economics, NYU, Northwestern, Imperial College, National University of Singapore,
UIBE, Nanjing University, Tsinghua PBC School of Finance, Fannie Mae, U.S. Securities and
Exchange Commission, City University of Hong Kong, Shenzhen Finance Institute at CUHK,
NBER Summer Institute, New Methods for the Cross Section of Returns Conference, Chicago
Quantitative Alliance Conference, Norwegian Financial Research Conference, EFA, China
International Conference in Finance, 10th World Congress of the Bachelier Finance Society,
Financial Engineering and Risk Management International Symposium, Toulouse Financial
Econometrics Conference, Chicago Conference on New Aspects of Statistics, Financial
Econometrics, and Data Science, Tsinghua Workshop on Big Data and Internet Economics, Q
group, IQ-KAP Research Prize Symposium, Wolfe Re- search, INQUIRE UK, Australasian
Finance and Banking Conference, Goldman Sachs Global Alternative Risk Premia Conference,
AFA, and Swiss Finance Institute. We gratefully acknowledge the computing support from the
Research Computing Center at the University of Chicago. The views expressed herein are those
of the authors and do not necessarily reflect the views of the National Bureau of Economic
Research.
At least one co-author has disclosed a financial relationship of potential relevance for this
research. Further information is available online at http://www.nber.org/papers/w25398.ack
NBER working papers are circulated for discussion and comment purposes. They have not been
peer-reviewed or been subject to the review by the NBER Board of Directors that accompanies
official NBER publications.
Â© 2018 by Shihao Gu, Bryan Kelly, and Dacheng Xiu. All rights reserved. Short sections of text,
not to exceed two paragraphs, may be quoted without explicit permission provided that full
credit, including Â© notice, is given to the source.

Empirical Asset Pricing via Machine Learning
Shihao Gu, Bryan Kelly, and Dacheng Xiu
NBER Working Paper No. 25398
December 2018, Revised September 2019
JEL No. C45,C55,C58,G11,G12
ABSTRACT
We perform a comparative analysis of machine learning methods for the canonical problem of
empirical asset pricing: measuring asset risk premia. We demonstrate large economic gains to
investors using machine learning forecasts, in some cases doubling the performance of leading
regression-based strategies from the literature. We identify the best performing methods (trees
and neural networks) and trace their predictive gains to allowance of nonlinear predictor
interactions that are missed by other methods. All methods agree on the same set of dominant
predictive signals which includes variations on momentum, liquidity, and volatility. Improved
risk premium measurement through machine learning simplifies the investigation into economic
mechanisms of asset pricing and highlights the value of machine learning in financial innovation.
Shihao Gu
University of Chicago Booth School of Business
5807 S. Woodlawn
Chicago, IL 60637
shihaogu@chicagobooth.edu
Bryan Kelly
Yale School of Management
165 Whitney Ave.
New Haven, CT 06511
and NBER
bryan.kelly@yale.edu

Dacheng Xiu
Booth School of Business
University of Chicago
5807 South Woodlaswn Avenue
Chicago, IL 60637
dachxiu@chicagobooth.edu

1

Introduction

In this article, we conduct a comparative analysis of machine learning methods for finance. We do
so in the context of perhaps the most widely studied problem in finance, that of measuring equity
risk premia.

1.1

Primary Contributions

Our primary contributions are two-fold. First, we provide a new set of benchmarks for the predictive
accuracy of machine learning methods in measuring risk premia of the aggregate market and individual stocks. This accuracy is summarized two ways. The first is a high out-of-sample predictive
R2 relative to preceding literature that is robust across a variety of machine learning specifications.
Second, and more importantly, we demonstrate the large economic gains to investors using machine
learning forecasts. A portfolio strategy that times the S&P 500 with neural network forecasts enjoys
an annualized out-of-sample Sharpe ratio of 0.77, versus the 0.51 Sharpe ratio of a buy-and-hold
investor. And a value-weighted long-short decile spread strategy that takes positions based on stocklevel neural network forecasts earns an annualized out-of-sample Sharpe ratio of 1.35, more than
doubling the performance of a leading regression-based strategy from the literature.
Return prediction is economically meaningful. The fundamental goal of asset pricing is to understand the behavior of risk premia.1 If expected returns were perfectly observed, we would still
need theories to explain their behavior and empirical analysis to test those theories. But risk premia
are notoriously difficult to measureâ€”market efficiency forces return variation to be dominated by
unforecastable news that obscures risk premia. Our research highlights gains that can be achieved
in prediction and identifies the most informative predictor variables. This helps resolve the problem of risk premium measurement, which then facilitates more reliable investigation into economic
mechanisms of asset pricing.
Second, we synthesize the empirical asset pricing literature with the field of machine learning.
Relative to traditional empirical methods in asset pricing, machine learning accommodates a far
more expansive list of potential predictor variables and richer specifications of functional form. It is
this flexibility that allows us to push the frontier of risk premium measurement. Interest in machine
learning methods for finance has grown tremendously in both academia and industry. This article
provides a comparative overview of machine learning methods applied to the two canonical problems
of empirical asset pricing: predicting returns in the cross section and time series. Our view is that the
best way for researchers to understand the usefulness of machine learning in the field of asset pricing
is to apply and compare the performance of each of its methods in familiar empirical problems.
1

Our focus is on measuring conditional expected stock returns in excess of the risk-free rate. Academic finance
traditionally refers to this quantity as the â€œrisk premiumâ€ due to its close connection with equilibrium compensation for
bearing equity investment risk. We use the terms â€œexpected returnâ€ and â€œrisk premiumâ€ interchangeably. One may be
interested in potentially distinguishing among different components of expected returns such as those due to systematic
risk compensation, idiosyncratic risk compensation, or even due to mispricing. For machine learning approaches to this
problem, see Gu et al. (2019) and Kelly et al. (2019).

2

1.2

What is Machine Learning?

The definition of â€œmachine learningâ€ is inchoate and is often context specific. We use the term to
describe (i) a diverse collection of high-dimensional models for statistical prediction, combined with
(ii) so-called â€œregularizationâ€ methods for model selection and mitigation of overfit, and (iii) efficient
algorithms for searching among a vast number of potential model specifications.
The high-dimensional nature of machine learning methods (element (i) of this definition) enhances
their flexibility relative to more traditional econometric prediction techniques. This flexibility brings
hope of better approximating the unknown and likely complex data generating process underlying
equity risk premia. With enhanced flexibility, however, comes a higher propensity of overfitting
the data. Element (ii) of our machine learning definition describes refinements in implementation
that emphasize stable out-of-sample performance to explicitly guard against overfit. Finally, with
many predictors it becomes infeasible to exhaustively traverse and compare all model permutations.
Element (iii) describes clever machine learning tools designed to approximate an optimal specification
with manageable computational cost.

1.3

Why Apply Machine Learning to Asset Pricing?

A number of aspects of empirical asset pricing make it a particularly attractive field for analysis with
machine learning methods.
1) Two main research agendas have monopolized modern empirical asset pricing research. The
first seeks to describe and understand differences in expected returns across assets. The second
focuses on dynamics of the aggregate market equity risk premium. Measurement of an assetâ€™s risk
premium is fundamentally a problem of predictionâ€”the risk premium is the conditional expectation
of a future realized excess return. Machine learning, whose methods are largely specialized for
prediction tasks, is thus ideally suited to the problem of risk premium measurement.
2) The collection of candidate conditioning variables for the risk premium is large. The profession
has accumulated a staggering list of predictors that various researchers have argued possess forecasting power for returns. The number of stock-level predictive characteristics reported in the literature
numbers in the hundreds and macroeconomic predictors of the aggregate market number in the
dozens.2 Additionally, predictors are often close cousins and highly correlated. Traditional prediction methods break down when the predictor count approaches the observation count or predictors
are highly correlated. With an emphasis on variable selection and dimension reduction techniques,
machine learning is well suited for such challenging prediction problems by reducing degrees of freedom and condensing redundant variation among predictors.
3) Further complicating the problem is ambiguity regarding functional forms through which the
high-dimensional predictor set enter into risk premia. Should they enter linearly? If nonlinearities
2

Green et al. (2013) count 330 stock-level predictive signals in published or circulated drafts. Harvey et al. (2016)
study 316 â€œfactors,â€ which include firm characteristics and common factors, for describing stock return behavior. They
note that this is only a subset of those studied in the literature. Welch and Goyal (2008) analyze nearly 20 predictors
for the aggregate market return. In both stock and aggregate return predictions, there presumably exists a much larger
set of predictors that were tested but failed to predict returns and were thus never reported.

3

are needed, which form should they take? Must we consider interactions among predictors? Such
questions rapidly proliferate the set of potential model specifications. The theoretical literature offers
little guidance for winnowing the list of conditioning variables and functional forms. Three aspects
of machine learning make it well suited for problems of ambiguous functional form. The first is its
diversity. As a suite of dissimilar methods it casts a wide net in its specification search. Second, with
methods ranging from generalized linear models to regression trees and neural networks, machine
learning is explicitly designed to approximate complex nonlinear associations. Third, parameter
penalization and conservative model selection criteria complement the breadth of functional forms
spanned by these methods in order to avoid overfit biases and false discovery.

1.4

What Specific Machine Learning Methods Do We Study?

We select a set of candidate models that are potentially well suited to address the three empirical
challenges outlined above. They constitute the canon of methods one would encounter in a graduate
level machine learning textbook.3 This includes linear regression, generalized linear models with penalization, dimension reduction via principal components regression (PCR) and partial least squares
(PLS), regression trees (including boosted trees and random forests), and neural networks. This is
not an exhaustive analysis of all methods. For example, we exclude support vector machines as these
share an equivalence with other methods that we study4 and are primarily used for classification
problems. Nonetheless, our list is designed to be representative of predictive analytics tools from
various branches of the machine learning toolkit.

1.5

Main Empirical Findings

We conduct a large scale empirical analysis, investigating nearly 30,000 individual stocks over 60
years from 1957 to 2016. Our predictor set includes 94 characteristics for each stock, interactions
of each characteristic with eight aggregate time series variables, and 74 industry sector dummy
variables, totaling more than 900 baseline signals. Some of our methods expand this predictor set
much further by including nonlinear transformations and interactions of the baseline signals. We
establish the following empirical facts about machine learning for return prediction.
Machine learning shows great promise for empirical asset pricing. At the broadest level, our
main empirical finding is that machine learning as a whole has the potential to improve our empirical
understanding of expected asset returns. It digests our predictor data set, which is massive from
the perspective of the existing literature, into a return forecasting model that dominates traditional
approaches. The immediate implication is that machine learning aids in solving practical investments
problems such as market timing, portfolio choice, and risk management, justifying its role in the
business architecture of the fintech industry.
Consider as a benchmark a panel regression of individual stock returns onto three lagged stocklevel characteristics: size, book-to-market, and momentum. This benchmark has a number of attrac3

See, for example, Hastie et al. (2009).
See, for example, Jaggi (2013) and Hastie et al. (2009), who discuss the equivalence of support vector machines
with the lasso. For an application of the kernel trick to the cross section of returns, see Kozak (2019).
4

4

tive features. It is parsimonious and simple, and comparing against this benchmark is conservative
because it is highly selected (the characteristics it includes are routinely demonstrated to be among
the most robust return predictors). Lewellen (2015) demonstrates that this model performs about
as well as larger and more complex stock prediction models studied in the literature.
In our sample, which is longer and wider (more observations in terms of both dates and stocks)
than that studied in Lewellen (2015), the out-of-sample R2 from the benchmark model is 0.16% per
month for the panel of individual stock returns. When we expand the OLS panel model to include
our set of 900+ predictors, predictability vanishes immediatelyâ€”the R2 drops deeply into negative
territory. This is not surprising. With so many parameters to estimate, efficiency of OLS regression
deteriorates precipitously and therefore produces forecasts that are highly unstable out-of-sample.
This failure of OLS leads us to our next empirical fact.
Vast predictor sets are viable for linear prediction when either penalization or dimension reduction
is used. Our first evidence that the machine learning toolkit aids in return prediction emerges
from the fact that the â€œelastic net,â€ which uses parameter shrinkage and variable selection to limit
the regressionâ€™s degrees of freedom, solves the OLS inefficiency problem. In the 900+ predictor
regression, elastic net pulls the out-of-sample R2 into positive territory at 0.11% per month. Principal
components regression (PCR) and partial least squares (PLS), which reduce the dimension of the
predictor set to a few linear combinations of predictors, further raise the out-of-sample R2 to 0.26%
and 0.27%, respectively. This is in spite of the presence of many likely â€œflukeâ€ predictors that
contribute pure noise to the large model. In other words, the high-dimensional predictor set in a
simple linear specification is at least competitive with the status quo low-dimensional model, as long
as over-parameterization can be controlled.
Allowing for nonlinearities substantially improves predictions. Next, we expand the model to
accommodate nonlinear predictive relationships via generalized linear models, regression trees, and
neural networks. We find that trees and neural networks unambiguously improve return prediction
with monthly stock-level R2 â€™s between 0.33% and 0.40%. But the generalized linear model, which
introduces nonlinearity via spline functions of each individual baseline predictor (but with no predictor interactions), fails to robustly outperform the linear specification. This suggests that allowing for
(potentially complex) interactions among the baseline predictors is a crucial aspect of nonlinearities
in the expected return function. As part of our analysis, we discuss why generalized linear models
are comparatively poorly suited for capturing predictor interactions.
Shallow learning outperforms deeper learning. When we consider a range of neural networks
from very shallow (a single hidden layer) to deeper networks (up to five hidden layers), we find that
neural network performance peaks at three hidden layers then declines as more layers are added.
Likewise, the boosted tree and random forest algorithms tend to select trees with few â€œleavesâ€ (on
average less than six leaves) in our analysis. This is likely an artifact of the relatively small amount
of data and tiny signal-to-noise ratio for our return prediction problem, in comparison to the kinds
of non-financial settings in which deep learning thrives thanks to astronomical datasets and strong
signals (such as computer vision).
The distance between nonlinear methods and the benchmark widens when predicting portfolio
5

returns. We build bottom-up portfolio-level return forecasts from the stock-level forecasts produced
by our models. Consider, for example, bottom-up forecasts of the S&P 500 portfolio return. By
aggregating stock-level forecasts from the benchmark three-characteristic OLS model, we find a
monthly S&P 500 predictive R2 of âˆ’0.22%. The bottom-up S&P 500 forecast from the generalized
linear model, in contrast, delivers an R2 of 0.71%. Trees and neural networks improve upon this
further, generating monthly out-of-sample R2 â€™s between 1.08% to 1.80% per month. The same
pattern emerges for forecasting a variety of characteristic factor portfolios, such as those formed on
the basis of size, value, investment, profitability, and momentum. In particular, a neural network with
three layers produces a positive out-of-sample predictive R2 for every factor portfolio we consider.
More pronounced predictive power at the portfolio level versus the stock level is driven by the
fact that individual stock returns behave erratically for some of the smallest and least liquid stocks
in our sample. Aggregating into portfolios averages out much of the unpredictable stock-level noise
and boosts the signal strength, which helps in detecting the predictive gains from machine learning.
The economic gains from machine learning forecasts are large. Our tests show clear statistical
rejections of the OLS benchmark and other linear models in favor of nonlinear machine learning
tools. The evidence for economic gains from machine learning forecastsâ€”in the form of portfolio
Sharpe ratiosâ€”are likewise impressive. For example, an investor who times the S&P 500 based on
bottom-up neural network forecasts enjoys a 26 percentage point increase in annualized out-of-sample
Sharpe ratio, to 0.77, relative to the 0.51 Sharpe ratio of a buy-and-hold investor. And when we
form a long-short decile spread directly sorted on stock return predictions from a neural network, the
strategy earns an annualized out-of-sample Sharpe ratio of 1.35 (value-weighted) and 2.45 (equalweighted). In contrast, an analogous long-short strategy using forecasts from the benchmark OLS
model delivers Sharpe ratios of 0.61 and 0.83, respectively.
The most successful predictors are price trends, liquidity, and volatility. All of the methods we
study produce a very similar ranking of the most informative stock-level predictors, which fall into
three main categories. First, and most informative of all, are price trend variables including stock
momentum, industry momentum, and short-term reversal. Next are liquidity variables including
market value, dollar volume, and bid-ask spread. Finally, return volatility, idiosyncratic volatility,
market beta, and beta squared are also among the leading predictors in all models we consider.
Better understanding our machine learning findings through simulation. In Appendix A we perform Monte Carlo simulations that support the above interpretations of our analysis. We apply
machine learning to simulated data from two different data generating processes. Both produce data
from a high dimensional predictor set. But in one, individual predictors enter only linearly and additively, while in the other predictors can enter through nonlinear transformations and via pairwise
interactions. When we apply our machine learning repertoire to the simulated datasets, we find that
linear and generalized linear methods dominate in the linear and uninteracted setting, yet tree-based
methods and neural networks significantly outperform in the nonlinear and interactive setting.

6

1.6

What Machine Learning Cannot Do

Machine learning has great potential for improving risk premium measurement, which is fundamentally a problem of prediction. It amounts to best approximating the conditional expectation
E(ri,t+1 |Ft ), where ri,t+1 is an assetâ€™s return in excess of the risk-free rate, and Ft is the true and
unobservable information set of market participants. This is a domain in which machine learning
algorithms excel.
But these improved predictions are only measurements. The measurements do not tell us about
economic mechanisms or equilibria. Machine learning methods on their own do not identify deep
fundamental associations among asset prices and conditioning variables. When the objective is to
understand economic mechanisms, machine learning may still be useful. It requires the economist to
add structureâ€”to build a hypothesized mechanism into the estimation problemâ€”and decide how to
introduce a machine learning algorithm subject to this structure. A nascent literature has begun to
make progress marrying machine learning with equilibrium asset pricing (for example, Kelly et al.,
2019; Feng et al., 2019), and this remains an exciting direction for future research.

1.7

Literature

Our work extends the empirical literature on stock return prediction, which comes in two basic
strands. The first strand models differences in expected returns across stocks as a function of stocklevel characteristics, and is exemplified by Fama and French (2008) and Lewellen (2015). The typical
approach in this literature runs cross-sectional regressions5 of future stock returns on a few lagged
stock characteristics. The second strand forecasts the time series of returns and is surveyed by
Koijen and Nieuwerburgh (2011) and Rapach and Zhou (2013). This literature typically conducts
time series regressions of broad aggregate portfolio returns on a small number of macroeconomic
predictor variables.
These traditional methods have potentially severe limitations that more advanced statistical tools
in machine learning can help overcome. Most important is that regressions and portfolio sorts are
ill-suited to handle the large numbers of predictor variables that the literature has accumulated over
five decades. The challenge is how to assess the incremental predictive content of a newly proposed
predictor while jointly controlling for the gamut of extant signals (or, relatedly, handling the multiple
comparisons and false discovery problem). Our primary contribution is to demonstrate potent return
predictability that is harnessable from the large collection of existing variables when machine learning
methods are used.
Machine learning methods have appeared sporadically in the asset pricing literature. Rapach
et al. (2013) apply lasso to predict global equity market returns using lagged returns of all countries.
Several papers apply neural-networks to forecast derivatives prices (Hutchinson et al., 1994; Yao
et al., 2000, among others). Khandani et al. (2010) and Butaru et al. (2016) use regression trees
to predict consumer credit card delinquencies and defaults. Sirignano et al. (2016) estimate a deep
5
In addition to least squares regression, the literature often sorts assets into portfolios on the basis of characteristics
and studies portfolio averagesâ€”a form of nonparametric regression.

7

neural network for mortgage prepayment, delinquency, and foreclosure. Heaton et al. (2016) develop
a neural network for portfolio selection.
Recently, variations of machine learning methods have been used to study the cross section of
stock returns. Harvey and Liu (2016) study the multiple comparisons problem using a bootstrap
procedure. Giglio and Xiu (2016) and Kelly et al. (2019) use dimension reduction methods to estimate
and test factor pricing models. Moritz and Zimmermann (2016) apply tree-based models to portfolio
sorting. Kozak et al. (2019) and Freyberger et al. (2019) use shrinkage and selection methods to,
respectively, approximate a stochastic discount factor and a nonlinear function for expected returns.
The focus of our paper is to simultaneously explore a wide range of machine learning methods to
study the behavior of expected stock returns, with a particular emphasis on comparative analysis
among methods.

2

Methodology

This section describes the collection of machine learning methods that we use in our analysis. In
each subsection we introduce a new method and describe it in terms of its three fundamental elements. First is the statistical model describing a methodâ€™s general functional form for risk premium
predictions. The second is an objective function for estimating model parameters. All of our estimates share the basic objective of minimizing mean squared predictions error (MSE). Regularization
is introduced through variations on the MSE objective, such as adding parameterization penalties
and robustification against outliers. These modifications are designed to avoid problems with overfit
and improve modelsâ€™ out-of-sample predictive performance. Finally, even with a small number of
predictors, the set of model permutations expands rapidly when one considers nonlinear predictor
transformations. This proliferation is compounded in our already high dimension predictor set. The
third element in each subsection describes computational algorithms for efficiently identifying the
optimal specification among the permutations encompassed by a given method.
As we present each method, we aim to provide a sufficiently in-depth description of the statistical
model so that a reader having no machine learning background can understand the basic model
structure without needing to consult outside sources. At the same time, when discussing the computational methods for estimating each model, we are deliberately terse. There are many variants of
each algorithm, and each has its own subtle technical nuances. To avoid bogging down the reader
with programming details, we describe our specific implementation choices in Appendix B and refer
readers to original sources for further background. We also summarize the literature on statistical
properties of each estimator in Appendix C.
In its most general form, we describe an assetâ€™s excess return as an additive prediction error
model:
ri,t+1 = Et (ri,t+1 ) + i,t+1 ,

(1)

Et (ri,t+1 ) = g ? (zi,t ).

(2)

where

8

Stocks are indexed as i = 1, ..., Nt and months by t = 1, ..., T . For ease of presentation, we assume
a balanced panel of stocks, and defer the discussion on missing data to Section 3.1. Our objective is
to isolate a representation of Et (ri,t+1 ) as a function of predictor variables that maximizes the outof-sample explanatory power for realized ri,t+1 . We denote those predictors as the P -dimensional
vector zi,t , and assume the conditional expected return g ? (Â·) is a flexible function of these predictors.
Despite its flexibility, this framework imposes some important restrictions. The g ? (Â·) function
depends neither on i nor t. By maintaining the same form over time and across different stocks, the
model leverages information from the entire panel which lends stability to estimates of risk premia
for any individual asset. This is in contrast to standard asset pricing approaches that re-estimate a
cross-sectional model each time period, or that independently estimate time series models for each
stock. Also, g ? (Â·) depends on z only through zi,t . This means our prediction does not use information
from the history prior to t, or from individual stocks other than the ith .

2.1

Sample Splitting and Tuning via Validation

Important preliminary steps (prior to discussing specific models and regularization approaches) are
to understand how we design disjoint sub-samples for estimation and testing and to introduce the
notion of â€œhyperparameter tuning.â€
The regularization procedures discussed below, which are machine learningâ€™s primary defense
against overfitting, rely on a choice of hyperparameters (or, synonymously, â€œtuning parametersâ€).
These are critical to the performance of machine learning methods as they control model complexity.
Hyperparameters include, for example, the penalization parameters in lasso and elastic net, the
number of iterated trees in boosting, the number of random trees in a forest, and the depth of
the trees. In most cases, there is little theoretical guidance for how to â€œtuneâ€ hyperparameters for
optimized out-of-sample performance.6
We follow the most common approach in the literature and select tuning parameters adaptively
from the data in a validation sample. In particular, we divide our sample into three disjoint time
periods that maintain the temporal ordering of the data. The first, or â€œtraining,â€ subsample is used
to estimate the model subject to a specific set of tuning parameter values.
The second, or â€œvalidation,â€ sample is used for tuning the hyperparameters. We construct forecasts for data points in the validation sample based on the estimated model from the training sample.
Next, we calculate the objective function based on forecast errors from the validation sample, and iteratively search for hyperparameters that optimize the validation objective (at each step re-estimating
the model from the training data subject to the prevailing hyperparameter values).
Tuning parameters are chosen from the validation sample taking into account estimated parameters, but the parameters are estimated from the training data alone. The idea of validation is to
simulate an out-of-sample test of the model. Hyperparameter tuning amounts to searching for a
degree of model complexity that tends to produce reliable out-of-sample performance. The validation sample fits are of course not truly out-of-sample because they are used for tuning, which is in
6
In machine learning, a â€œhyperparameterâ€ governs the extent of estimator regularization. This usage is related to,
but different from, its meaning in Bayesian statistics as a parameter of a prior distribution.

9

turn an input to the estimation. Thus the third, or â€œtesting,â€ subsample, which is used for neither
estimation nor tuning, is truly out-of-sample and thus is used to evaluate a methodâ€™s predictive
performance. Further details of our sample splitting scheme are provided in Appendix D, and a
summary of hyperparameter tuning schemes for each model is provided in Appendix E.

2.2

Simple Linear

We begin our model description with the least complex method in our analysis, the simple linear
predictive regression model estimated via ordinary least squares (OLS). While we expect this to
perform poorly in our high dimension problem, we use it as a reference point for emphasizing the
distinctive features of more sophisticated methods.
Model. The simple linear model imposes that conditional expectations g ? (Â·) can be approximated by a linear function of the raw predictor variables and the parameter vector, Î¸,
0
g(zi,t ; Î¸) = zi,t
Î¸.

(3)

This model imposes a simple regression specification and does not allow for nonlinear effects or
interactions between predictors.
Objective Function and Computational Algorithm. Our baseline estimation of the simple
linear model uses a standard least squares, or â€œl2 â€, objective function:
L(Î¸) =

N T
1 XX
(ri,t+1 âˆ’ g(zi,t ; Î¸))2 .
NT

(4)

i=1 t=1

Minimizing L(Î¸) yields the pooled OLS estimator. The convenience of the baseline l2 objective function is that it offers analytical estimates and thus avoids sophisticated optimization and computation.
2.2.1

Extension: Robust Objective Functions

In some cases it is possible to improve predictive performance by replacing equation (4) with a
weighted least squares objective such as
N T
1 XX
wi,t (ri,t+1 âˆ’ g(zi,t ; Î¸))2 .
LW (Î¸) =
NT

(5)

i=1 t=1

This allows the econometrician to tilt estimates towards observations that are more statistically or
economically informative. For example, one variation that we consider sets wi,t inversely proportional
to the number of stocks at time t. This imposes that every month has the same contribution to
the model regardless of how many stocks are available that month. This also amounts to equally
weighting the squared loss of all stocks available at time t. Another variation that we consider sets
wi,t proportional to the equity market value of stock i at time t. This value weighted loss function
underweights small stocks in favor of large stocks, and is motivated by the economic rational that

10

small stocks represent a large fraction of the traded universe by count while constituting a tiny
fraction of aggregate market capitalization.7
Heavy tails are a well known attribute of financial returns and stock-level predictor variables.
Convexity of the least squares objective (4) places extreme emphasis on large errors, thus outliers
can undermine the stability of OLS-based predictions. The statistics literature, long aware of this
problem, has developed modified least squares objective functions that tend to produce more stable
forecasts than OLS in the presence of extreme observations.8 In the machine learning literature,
a common choice for counteracting the deleterious effect of heavy-tailed observations is the Huber
robust objective function, defined as
LH (Î¸) =

N T
1 XX
H (ri,t+1 âˆ’ g(zi,t ; Î¸), Î¾) ,
NT

(6)

i=1 t=1

where

(
H(x; Î¾) =

x2 ,
2

2Î¾|x| âˆ’ Î¾ ,

if

|x| â‰¤ Î¾;

if

|x| > Î¾.

.

The Huber loss, H(Â·), is a hybrid of squared loss for relatively small errors and absolute loss for
relatively large errors, where the combination is controlled by a tuning parameter, Î¾, that can be
optimized adaptively from the data.9
While this detour introduces robust objective functions in the context of the simple linear model,
they are easily applicable in almost all of the methods that we study. In our empirical analysis we
study the predictive benefits of robust loss functions in multiple machine learning methods.

2.3

Penalized Linear

The simple linear model is bound to fail in the presence of many predictors. When the number
of predictors P approaches the number of observations T , the linear model becomes inefficient or
even inconsistent.10 It begins to overfit noise rather than extracting signal. This is particularly
troublesome for the problem of return prediction where the signal-to-noise ratio is notoriously low.
Crucial for avoiding overfit is reducing the number of estimated parameters. The most common
machine learning device for imposing parameter parsimony is to append a penalty to the objective
function in order to favor more parsimonious specifications. This â€œregularizationâ€ of the estimation
problem mechanically deteriorates a modelâ€™s in-sample performance in hopes that it improves its
stability out-of-sample. This will be the case when penalization manages to reduce the modelâ€™s fit
7

As of Fama and French (2008), the smallest 20% of stocks comprise only 3% of aggregate market capitalization.
An example of a statistically motivated weighting scheme uses wi,t inversely proportional to an observationâ€™s estimated
error variance, a choice that potentially improves prediction efficiency in the spirit of generalized least squares.
8
Classical analyses include Box (1953), Tukey (1960), and Huber (1964).
9
OLS is a special case of the (6) with Î¾ = âˆž. While most theoretical analysis in high-dimensional statistics assume
that data have sub-Gaussian or sub-exponential tails, Fan et al. (2017) provide a theoretical justification of using this
loss function in the high-dimensional setting as well as a procedure to determine the hyperparameter.
10
We deliberately compare P with T , instead of with N T , because stock returns share strong cross-sectional dependence, limiting the incremental information contained in new cross-section observations.

11

of noise while preserving its fit of the signal.
Objective Function and Computational Algorithm. The statistical model for our penalized
linear model is the same as the simple linear model in equation (3). That is, it continues to consider
only the baseline, untransformed predictors. Penalized methods differ by appending a penalty to the
original loss function:
L(Î¸; Â·) =L(Î¸) + Ï†(Î¸; Â·).

(7)

There are several choices for the penalty function Ï†(Î¸; Â·). We focus on the popular â€œelastic netâ€
penalty, which takes the form
Ï†(Î¸; Î», Ï) = Î»(1 âˆ’ Ï)

P
X
j=1

P

1 X 2
|Î¸j | + Î»Ï
Î¸j .
2

(8)

j=1

The elastic net involves two non-negative hyperparameters, Î» and Ï, and includes two well known
regularizers as special cases. The Ï = 0 case corresponds to the lasso and uses an absolute value,
or â€œl1 â€, parameter penalization. The fortunate geometry of the lasso sets coefficients on a subset
of covariates to exactly zero. In this sense, the lasso imposes sparsity on the specification and can
thus be thought of as a variable selection method. The Ï = 1 case corresponds to ridge regression,
which uses an l2 parameter penalization, that draws all coefficient estimates closer to zero but does
not impose exact zeros anywhere. In this sense, ridge is a shrinkage method that helps prevent
coefficients from becoming unduly large in magnitude. For intermediate values of Ï, the elastic net
encourages simple models through both shrinkage and selection.
We adaptively optimize the tuning parameters, Î» and Ï, using the validation sample. Our implementation of penalized regression uses the accelerated proximal gradient algorithm and accommodates both least squares and Huber objective functions (see Appendix B.1 for more detail).

2.4

Dimension Reduction: PCR and PLS

Penalized linear models use shrinkage and variable selection to manage high dimensionality by forcing
the coefficients on most regressors near or exactly to zero. This can produce suboptimal forecasts
when predictors are highly correlated. A simple example of this problem is a case in which all of the
predictors are equal to the forecast target plus an iid noise term. In this situation, choosing a subset
of predictors via lasso penalty is inferior to taking a simple average of the predictors and using this
as the sole predictor in a univariate regression.
The idea of predictor averaging, as opposed to predictor selection, is the essence of dimension
reduction. Forming linear combinations of predictors helps reduce noise to better isolate the signal in
predictors, and also helps de-correlate otherwise highly dependent predictors. Two classic dimension
reduction techniques are principal components regression (PCR) and partial least squares (PLS).
PCR consists of a two-step procedure. In the first step, principal components analysis (PCA)
combines regressors into a small set of linear combinations that best preserve the covariance structure

12

among the predictors. In the second step, a few leading components are used in standard predictive
regression. That is, PCR regularizes the prediction problem by zeroing out coefficients on low
variance components.
A drawback of PCR is that it fails to incorporate the ultimate statistical objectiveâ€”forecasting
returnsâ€”in the dimension reduction step. PCA condenses data into components based on the covariation among the predictors. This happens prior to the forecasting step and without consideration of
how predictors associate with future returns.
In contrast, partial least squares performs dimension reduction by directly exploiting covariation
of predictors with the forecast target.11 PLS regression proceeds as follows. For each predictor j,
estimate its univariate return prediction coefficient via OLS. This coefficient, denoted Ï•j , reflects the
â€œpartialâ€ sensitivity of returns to each predictor j. Next, average all predictors into a single aggregate
component with weights proportional to Ï•j , placing the highest weight on the strongest univariate
predictors, and the least weight on the weakest. In this way, PLS performs its dimension reduction
with the ultimate forecasting objective in mind. To form more than one predictive component, the
target and all predictors are orthogonalized with respect to previously constructed components, and
the above procedure is repeated on the orthogonalized dataset. This is iterated until the desired
number of PLS components is reached.
Model. Our implementation of PCR and PLS begins from the vectorized version of the linear
0 Î¸+
model in equations (1)â€“(3). In particular, we reorganize the linear regression ri,t+1 = zi,t
i,t+1 as

R = ZÎ¸ + E,

(9)

where R is the N T Ã— 1 vector of ri,t+1 , Z is the N T Ã— P matrix of stacked predictors zi,t , and E is
a N T Ã— 1 vector of residuals i,t+1 .
PCR and PLS take the same general approach to reducing the dimensionality. They both condense the set of predictors from dimension P to a much smaller number of K linear combinations of
predictors. Thus, the forecasting model for both methods is written as
R = (Zâ„¦K )Î¸K + EÌƒ.

(10)

â„¦K is P Ã— K matrix with columns w1 , w2 , . . . , wK . Each wj is the set of linear combination weights
used to create the j th predictive components, thus Zâ„¦K is the dimension-reduced version of the
original predictor set. Likewise, the predictive coefficient Î¸K is now a K Ã— 1 vector rather than P Ã— 1.
Objective Function and Computational Algorithm. PCR chooses the combination weights
â„¦K recursively. The j th linear combination solves12
wj = arg max Var(Zw),
w

s.t. w0 w = 1,

Cov(Zw, Zwl ) = 0,

l = 1, 2, . . . , j âˆ’ 1.

(11)

11
See Kelly and Pruitt (2013, 2015) for asymptotic theory of PLS regression and its application to forecasting risk
premia in financial markets.
12
For two vectors a and b, we denote Cov(a, b) := (a âˆ’ aÌ„)| (b âˆ’ bÌ„), where aÌ„ is the average of all entries of a. Naturally,
we define Var(a) := Cov(a, a).

13

Intuitively, PCR seeks the K linear combinations of Z that most faithfully mimic the full predictor
set. The objective illustrates that the choice of components is not based on the forecasting objective
at all. Instead, the emphasis of PCR is on finding components that retain the most possible common
variation within the predictor set. The well known solution for (11) computes â„¦K via singular value
decomposition of Z, and therefore the PCR algorithm is extremely efficient from a computational
standpoint.
In contrast to PCR, the PLS objective seeks K linear combinations of Z that have maximal
predictive association with the forecast target. The weights used to construct j th PLS component
solve
wj = arg max Cov2 (R, Zw),
w

s.t. w0 w = 1,

Cov(Zw, Zwl ) = 0,

l = 1, 2, . . . , j âˆ’ 1.

(12)

This objective highlights the main distinction between PCR and PLS. PLS is willing to sacrifice how
accurately Zâ„¦K approximates Z in order to find components with more potent return predictability.
The problem in (12) can be efficiently solved using a number of similar routines, the most prominent
being the SIMPLS algorithm of de Jong (1993).
Finally, given a solution for â„¦K , Î¸K is estimated in both PCR and PLS via OLS regression of
R on Zâ„¦K . For both models, K is a hyperparameter that can be determined adaptively from the
validation sample.

2.5

Generalized Linear

Linear models are popular in practice, in part because they can be thought of as a first-order approximation to the data generating process.13 When the â€œtrueâ€ model is complex and nonlinear, restricting
the functional form to be linear introduces approximation error due to model misspecification. Let
g ? (zi,t ) denote the true model and g(zi,t ; Î¸) the functional form specified by the econometrician. And
let g(zi,t ; b
Î¸) and rbi,t+1 denote the fitted model and its ensuing return forecast. We can decompose a
modelâ€™s forecast error as:
ri,t+1 âˆ’ rbi,t+1 = g ? (zi,t ) âˆ’ g(zi,t ; Î¸) +
|
{z
}
approximation error

g(zi,t ; Î¸) âˆ’ g(zi,t ; b
Î¸)
|
{z
}
estimation error

+

i,t+1
.
| {z }
intrinsic error

Intrinsic error is irreducible; it is the genuinely unpredictable component of returns associated with
news arrival and other sources of randomness in financial markets. Estimation error, which arises
due to sampling variation, is determined by the data. It is potentially reducible by adding new
observations, though this may not be under the econometricianâ€™s control. Approximation error
is directly controlled by the econometrician, and is potentially reducible by incorporating more
flexible specifications that improve the modelâ€™s ability to approximate the true model. But additional
flexibility raises the risk of overfitting and destabilizing the model out-of-sample. In this and the
following subsections, we introduce nonparametric models of g(Â·) with increasing degrees of flexibility,
13

See White (1980) for a discussion of limitations of linear models as first-order approximations.

14

each complemented by regularization methods to mitigate overfit.
Model. The first and most straightforward nonparametric approach that we consider is the
generalized linear model. It introduces nonlinear transformations of the original predictors as new
additive terms in an otherwise linear model. Generalized linear models are thus the closest nonlinear
counterparts to the linear approaches in Sections 2.2 and 2.3.
The model we study adapts the simple linear form by adding a K-term spline series expansion
of the predictors
g(z; Î¸, p(Â·)) =

P
X

p(zj )0 Î¸j ,

(13)

j=1

where p(Â·) = (p1 (Â·), p2 (Â·), . . . , pK (Â·))0 is a vector of basis functions, and the parameters are now a
K Ã— N matrix Î¸ = (Î¸1 , Î¸2 , . . . , Î¸N ). There are many potential choices for spline functions. We adopt

a spline series of order two: 1, z, (z âˆ’ c1 )2 , (z âˆ’ c2 )2 , . . . , (z âˆ’ cKâˆ’2 )2 , where c1 , c2 , . . . cKâˆ’2 are
knots.
Objective Function and Computational Algorithm. Because higher order terms enter
additively, forecasting with the generalized linear model can be approached with the same estimation
tools as in Section 2.2. In particular, our analysis uses a least squares objective function, both with
and without the Huber robustness modification. Because series expansion quickly multiplies the
number of model parameters, we use penalization to control degrees of freedom. Our choice of
penalization function is specialized for the spline expansion setting and is known as the group lasso.
It takes the form
Ï†(Î¸; Î», K) = Î»

P
K
X
X
j=1

!1/2
Î¸2j,k

.

(14)

k=1

As its name suggests, the group lasso selects either all K spline terms associated with a given
characteristic or none of them. We embed this penalty in the general objective of equation (7).
Group lasso accommodates either least squares or robust Huber objective, and it uses the same
accelerated proximal gradient descent as the elastic net. It has two tuning parameters, Î» and K.14

2.6

Boosted Regression Trees and Random Forests

The model in (13) captures individual predictorsâ€™ nonlinear impact on expected returns, but does not
account for interactions among predictors. One way to add interactions is to expand the generalized
model to include multivariate functions of predictors. While expanding univariate predictors with
K basis functions multiplies the number of parameters by a factor of K, multi-way interactions
increase the parameterization combinatorially. Without a priori assumptions for which interactions
to include, the generalized linear model becomes computationally infeasible.15
14

For additional details, see Appendix B.1. A similar model in the return prediction context is Freyberger et al.
(2019).
15
Parameter penalization does not solve the difficulty of estimating linear models when the number of predictors is
exponentially larger than the number of observations. Instead, one must turn to heuristic optimization algorithms such
as stepwise regression (sequentially adding/dropping variables until some stopping rule is satisfied), variable screening
(retaining predictors whose univariate correlations with the prediction target exceed a certain value), or others.

15

Figure 1: Regression Tree Example

True

Value
Value>0.4
<0.3
True

Category
1

Size
<0.5

1
False

Category 3
Category
3
Size

False

0.5

Category 1

Category
2

0

0.3

Category 2

Value

1

Note: This figure presents the diagrams of a regression tree (left) and its equivalent representation (right) in
the space of two characteristics (size and value). The terminal nodes of the tree are colored in blue, yellow,
and red, respectively. Based on their values of these two characteristics, the sample of individual stocks is
divided into three categories.

As an alternative, regression trees have become a popular machine learning approach for incorporating multi-way predictor interactions. Unlike linear models, trees are fully nonparametric and
possess a logic that departs markedly from traditional regressions. At a basic level, trees are designed to find groups of observations that behave similarly to each. A tree â€œgrowsâ€ in a sequence
of steps. At each step, a new â€œbranchâ€ sorts the data leftover from the preceding step into bins
based on one of the predictor variables. This sequential branching slices the space of predictors into
rectangular partitions, and approximates the unknown function g ? (Â·) with the average value of the
outcome variable within each partition.
Figure 1 shows an example with two predictors, â€œsizeâ€ and â€œb/m.â€ The left panel describes how
the tree assigns each observation to a partition based on its predictor values. First, observations are
sorted on size. Those above the breakpoint of 0.5 are assigned to Category 3. Those with small size
are then further sorted by b/m. Observations with small size and b/m below 0.3 are assigned to
Category 1, while those with b/m above 0.3 go into Category 2. Finally, forecasts for observations in
each partition are defined as the simple average of the outcome variableâ€™s value among observations
in that partition.
Model. More formally, the prediction of a tree, T , with K â€œleavesâ€ (terminal nodes), and depth
L, can be written as
g(zi,t ; Î¸, K, L) =

K
X

Î¸k 1{zi,t âˆˆCk (L)} ,

(15)

k=1

where Ck (L) is one of the K partitions of the data. Each partition is a product of up to L indicator
functions of the predictors. The constant associated with partition k (denoted Î¸k ) is defined to be

16

the sample average of outcomes within the partition.16 In the example of Figure 1, the prediction
equation is
g(zi,t ; Î¸, 3, 2) = Î¸1 1{sizei,t <0.5} 1{b/mi,t <0.3} + Î¸2 1{sizei,t <0.5} 1{b/mi,t â‰¥0.3} + Î¸3 1{sizei,t â‰¥0.5} .
Objective Function and Computational Algorithm. To grow a tree is to find bins that best
discriminate among the potential outcomes. The specific predictor variable upon which a branch
is based, and the specific value where the branch is split, is chosen to minimize forecast error.
The expanse of potential tree structures, however, precludes exact optimization. The literature has
developed a set of sophisticated optimization heuristics to quickly converge on approximately optimal
trees. We follow the algorithm of Breiman et al. (1984), which we describe in detail in Appendix
B.2. The basic idea is to myopically optimize forecast error at the start of each branch. At each
new level, we choose a sorting variable from the set of predictors and the split value to maximize the
discrepancy among average outcomes in each bin.17 The loss associated with the forecast error for
a branch C is often called â€œimpurity,â€ which describes how similarly observations behave on either
side of the split. We choose the most popular l2 impurity for each branch of the tree:
H(Î¸, C) =

1 X
(ri,t+1 âˆ’ Î¸)2 ,
|C|

(16)

zi,t âˆˆC

where |C| denotes the number of observations in set C. Given C, it is clear that the optimal choice of
1 P
Î¸: Î¸ = |C|
zi,t âˆˆC ri,t+1 . The procedure is equivalent to finding the branch C that locally minimizes
the impurity. Branching halts when the number of leaves or the depth of the tree reach a pre-specified
threshold that can be selected adaptively using a validation sample.
Among the advantages of a tree model are that it is invariant to monotonic transformations of
predictors, that it naturally accommodates categorical and numerical data in the same model, that
it can approximate potentially severe nonlinearities, and that a tree of depth L can capture (L âˆ’ 1)way interactions. Their flexibility is also their limitation. Trees are among the prediction methods
most prone to overfit, and therefore must be heavily regularized. In our analysis, we consider two
â€œensembleâ€ tree regularizers that combine forecasts from many different trees into a single forecast.18
Boosting. The first regularization method is â€œboosting,â€ which recursively combines forecasts
from many over-simplified trees.19 Shallow trees on their own are â€œweak learnersâ€ with minuscule
predictive power. The theory behind boosting suggests that many weak learners may, as an ensemble,
comprise a single â€œstrong learnerâ€ with greater stability than a single complex tree.
16

We focus on recursive binary trees for their relative simplicity. Breiman et al. (1984) discuss more complex tree
structures.
17
Because splits are chosen without consideration of future potential branches, it is possible to myopically bypass
an inferior branch that would have led to a future branch with an ultimately superior reduction in forecast error.
18
The literature also considers a number of other approaches to tree regularization such as early stopping and postpruning, both of which are designed to reduce overfit in a single large tree. Ensemble methods demonstrate more
reliable performance and are scalable for very large datasets, leading to their increased popularity in recent literature.
19
Boosting is originally described in Schapire (1990) and Freund (1995) for classification problems to improve the
performance of a set of weak learners. Friedman et al. (2000a) and Friedman (2001) extend boosting to contexts beyond
classification, eventually leading to the gradient boosted regression tree.

17

The details of our boosting procedure, typically referred to as gradient boosted regression trees
(GBRT), are described in Algorithm 4 of Appendix B.2. It starts by fitting a shallow tree (e.g., with
depth L = 1). This over-simplified tree is sure to be a weak predictor with large bias in the training
sample. Next, a second simple tree (with the same shallow depth L) is used to fit the prediction
residuals from the first tree. Forecasts from these two trees are added together to form an ensemble
prediction of the outcome, but the forecast component from the second tree is shrunken by a factor
Î½ âˆˆ (0, 1) to help prevent the model from overfitting the residuals. At each new step b, a shallow tree
is fitted to the residuals from the model with bâˆ’1 trees, and its residual forecast is added to the total
with a shrinkage weight of Î½. This is iterated until there are a total of B trees in the ensemble. The
final output is therefore an additive model of shallow trees with three tuning parameters (L, Î½, B)
which we adaptively choose in the validation step.
Random Forest. Like boosting, a random forest is an ensemble method that combines forecasts
from many different trees. It is a variation on a more general procedure known as bootstrap aggregation, or â€œbaggingâ€ (Breiman, 2001). The baseline tree bagging procedure draws B different bootstrap
samples of the data, fits a separate regression tree to each, then averages their forecasts. Trees for
individual bootstrap samples tend to be deep and overfit, making their individual predictions inefficiently variable. Averaging over multiple predictions reduces this variation, thus stabilizing the
treesâ€™ predictive performance.
Random forests use a variation on bagging designed to reduce the correlation among trees in
different bootstrap samples. If, for example, firm size is the dominant return predictor in the data,
then most of the bagged trees will have low-level splits on size resulting in substantial correlation
among their ultimate predictions. The forest method de-correlates trees using a method known as
â€œdropout,â€ which considers only a randomly drawn subset of predictors for splitting at each potential
branch. Doing so ensures that, in the example, early branches for at least a few trees will split on
characteristics other than firm size. This lowers the average correlation among predictions to further
improve the variance reduction relative to standard bagging. Depth L of the trees and number
of bootstrap samples B are the tuning parameters optimized via validation. Precise details of our
random forest implementation are described in Algorithm 3 of the appendix.

2.7

Neural Networks

The final nonlinear method that we analyze is the artificial neural network. Arguably the most
powerful modeling device in machine learning, neural networks have theoretical underpinnings as
â€œuniversal approximatorsâ€ for any smooth predictive association (Hornik et al., 1989; Cybenko,
1989). They are the currently preferred approach for complex machine learning problems such as
computer vision, natural language processing, and automated game-playing (such as chess and go).
Their flexibility draws from the ability to entwine many telescoping layers of nonlinear predictor
interactions, earning the synonym â€œdeep learning.â€ At the same time, their complexity ranks neural
networks among the least transparent, least interpretable, and most highly parameterized machine
learning tools.

18

Figure 2: Neural Networks
Output Layer

Output Layer

Hidden Layer

f

f

f

f

f

Input Layer

Input Layer

Note: This figure provides diagrams of two simple neural networks with (right) or without (left) a hidden layer.
Pink circles denote the input layer and dark red circles denote the output layer. Each arrow is associated
with a weight parameter. In the network with a hidden layer, a nonlinear activation function f transforms
the inputs before passing them on to the output.

Model. We focus our analysis on traditional â€œfeed-forwardâ€ networks. These consist of an â€œinput
layerâ€ of raw predictors, one or more â€œhidden layersâ€ that interact and nonlinearly transform the
predictors, and an â€œoutput layerâ€ that aggregates hidden layers into an ultimate outcome prediction.
Analogous to axons in a biological brain, layers of the networks represent groups of â€œneuronsâ€ with
each layer connected by â€œsynapsesâ€ that transmit signals among neurons of different layers. Figure
2 shows two illustrative examples.
The number of units in the input layer is equal to the dimension of the predictors, which we
set to four in this example (denoted z1 , ..., z4 ). The left panel shows the simplest possible network
that has no hidden layers. Each of the predictor signals is amplified or attenuated according to
a five-dimensional parameter vector, Î¸, that includes an intercept and one weight parameter per
P
predictor. The output layer aggregates the weighted signals into the forecast Î¸0 + 4k=1 zk Î¸k ; that
is, the simplest neural network is a linear regression model.
The model incorporates more flexible predictive associations by adding hidden layers between
the inputs and output. The right panel of Figure 2 shows an example with one hidden layer that
contains five neurons. Each neuron draws information linearly from all of the input units, just as in
the simple network on the left. Then, each neuron applies a nonlinear â€œactivation functionâ€ f to its
aggregated signal before sending its output to the next layer.
thesecond neuron in the
 For example,
P4
(1)
(0)
(0)
hidden layer transforms inputs into an output as x2 = f Î¸2,0 + j=1 zj Î¸2,j . Lastly, the results
from each neuron are linearly aggregated into an ultimate output forecast:
g(z; Î¸) =

(1)
Î¸0

+

5
X

(1) (1)

xj Î¸ j .

j=1

Thus, in this example, there are a total of 31= (4 + 1) Ã— 5 + 6 parameters (five parameters to reach

19

each neuron and six weights to aggregate the neurons into a single output).
There are many choices to make when structuring a neural network, including the number of
hidden layers, the number of neurons in each layer, and which units are connected. Despite the
aforementioned â€œuniversal approximationâ€ result that suggests the sufficiency of a single hidden
layer, recent literature has shown that deeper networks can often achieve the same accuracy with
substantially fewer parameters.20
On the other hand, in small data sets simple networks with only a few layers and nodes often
perform best. Training a very deep neural network is challenging because it typically involves a
large number of parameters, because the objective function is highly non-convex, and because the
recursive calculation of derivatives (known as â€œback-propagationâ€) is prone to exploding or vanishing
gradients.
Selecting a successful network architecture by cross-validation is in general a difficult task. It
is unrealistic and unnecessary to find the optimal network by searching over uncountably many
architectures. Instead, we fix a variety of network architectures ex ante and estimate each of these.
What we hope to achieve is reasonably lower bound on the performance of machine learning methods.
We consider architectures with up to five hidden layers. Our shallowest neural network has a
single hidden layer of 32 neurons, which we denoted NN1. Next, NN2 has two hidden layers with 32
and 16 neurons, respectively; NN3 has three hidden layers with 32, 16, and 8 neurons, respectively;
NN4 has four hidden layers with 32, 16, 8, 4 neurons, respectively; and NN5 has five hidden layers
with 32, 16, 8, 4, and 2 neurons, respectively. We choose the number of neurons in each layer
according to the geometric pyramid rule (see Masters, 1993). All architectures are fully connected
so each unit receives an input from all units in the layer below. By comparing the performance of
NN1 through NN5, we can infer the trade-offs of network depth in the return forecasting problem.21
There are many potential choices for the nonlinear activation function (such as sigmoid, hyperbolic, softmax, etc.). We use the same activation function at all nodes, and choose a popular
functional form in recent literature known as the rectified linear unit (ReLU), defined as22
ï£±
ï£²0
ReLU(x) =
ï£³x

if x < 0
otherwise,

which encourages sparsity in the number of active neurons, and allows for faster derivative evaluation.
Our neural network model has the following general formula. Let K (l) denote the number of
(l)

neurons in each layer l = 1, ..., L. Define the output of neuron k in layer l as xk . Next, define the
(l)

(l)

(l)

vector of outputs for this layer (augmented to include a constant, x0 ) as x(l) = (1, x1 , ..., xK (l) )0 . To
initialize the network, similarly define the input layer using the raw predictors, x(0) = (1, z1 , ..., zN )0 .
20

Eldan and Shamir (2016) formally demonstrate that depthâ€”even if increased by one layerâ€”can be exponentially
more valuable than increasing width in standard feed-forward neural networks. Ever since the seminal work by Hinton
et al. (2006), the machine learning community has experimented and adopted deeper (and wider) networks, with as
many as 152 layers for image recognition, e.g., He et al. (2016a).
21
We confine the choices of architectures to a small set of five based on our limited sample size (compared to typical
neural network applications).
22
See, e.g., Jarrett et al. (2009), Nair and Hinton (2010), and Glorot et al. (2011).

20

The recursive output formula for the neural network at each neuron in layer l > 0 is then


0 (lâˆ’1)
(l)
xk = ReLU x(lâˆ’1) Î¸k
,

(17)

with final output
0

g(z; Î¸) = x(Lâˆ’1) Î¸(Lâˆ’1) .

(18)

The number of weight parameters in each hidden layer l is K (l) (1 + K (lâˆ’1) ), plus another 1 + K (Lâˆ’1)
weights for the output layer.
Objective Function and Computational Algorithm. We estimate the neural network
weight parameters by minimizing the penalized l2 objective function of prediction errors. Unlike
tree-based algorithms that require â€œgreedyâ€ optimization, training a neural network, in principle,
allows for joint updates of all model parameters at each step of the optimizationâ€”a substantial
advantage of neural networks over trees. However, the high degree of nonlinearity and nonconvexity
in neural networks, together with their rich parameterization, make brute force optimization highly
computationally intensive (often to the point of infeasibility). A common solution uses stochastic gradient descent (SGD) to train a neural network. Unlike standard descent that uses the entire
training sample to evaluate the gradient at each iteration of the optimization, SGD evaluates the gradient from a small random subset of the data. This approximation sacrifices accuracy for enormous
acceleration of the optimization routine.
For the same reasons described above (severe nonlinearity and heavy parameterization), regularization of neural networks requires more care than the methods discussed above. In addition to l1
penalization of the weight parameters, we simultaneously employ four other regularization techniques
in our estimation: learning rate shrinkage, early stopping, batch normalization, and ensembles.
A critical tuning parameter in SGD is the learning rate, which controls the step size of the
descent. It is necessary to shrink the learning rate toward zero as the gradient approaches zero,
otherwise noise in the calculation of the gradient begins to dominate its directional signal. We adopt
the â€œlearning rate shrinkageâ€ algorithm of Kingma and Ba (2014) to adaptively control the learning
rate (described further in Algorithm 5 of the Appendix B.3).23
Next, â€œearly stoppingâ€ is a general machine learning regularization tool. It begins from an initial
parameter guess that imposes parsimonious parameterization (for example, setting all Î¸ values close
to zero). In each step of the optimization algorithm, the parameter guesses are gradually updated to
reduce prediction errors in the training sample. At each new guess, predictions are also constructed
for the validation sample, and the optimization is terminated when the validation sample errors begin
to increase. This typically occurs before the prediction errors are minimized in the training sample,
hence the name early stopping (see Algorithm 6). By ending the parameter search early, parameters
are shrunken toward the initial guess. It is a popular substitute to l2 penalization of Î¸ parameters
23

Relatedly, random subsetting at each SGD iteration adds noise to the optimization procedure, which itself serves
as a form of regularization. See, Wilson and Martinez (2003).

21

because it achieves regularization at a much lower computational cost.24 Early stopping can be used
alone, or together with l1 -regularization as we do in this paper.
â€œBatch normalizationâ€ (Ioffe and Szegedy, 2015) is a simple technique for controlling the variability of predictors across different regions of the network and across different datasets. It is motivated
by the phenomenon of internal covariate shift in which inputs of hidden layers follow different distributions than their counterparts in the validation sample. This issue is constantly encountered when
fitting deep neural networks that involve many parameters and rather complex structures. For each
hidden unit in each training step (a â€œbatchâ€), the algorithm cross-sectionally de-means and variance
standardizes the batch inputs to restore the representation power of the unit.
Finally, we adopt an ensemble approach in training our neural networks (see also Hansen and
Salamon, 1990; Dietterich, 2000). In particular, we use multiple random seeds to initialize neural
network estimation and construct predictions by averaging forecasts from all networks. This reduces
prediction variance because the stochastic nature of the optimization can cause different seeds to
produce different forecasts.25

2.8

Performance Evaluation

To assess predictive performance for individual excess stock return forecasts, we calculate the outof-sample R2 as
P
2
Roos

=1âˆ’

(i,t)âˆˆT3 (ri,t+1

âˆ’ rbi,t+1 )2

2
(i,t)âˆˆT3 ri,t+1

P

,

(19)

where T3 indicates that fits are only assessed on the testing subsample, whose data never enter into
2
pools prediction errors across firms and over time into a grand
model estimation or tuning. Roos

panel-level assessment of each model.
A subtle but important aspect of our R2 metric is that the denominator is the sum of squared
excess returns without demeaning. In many out-of-sample forecasting applications, predictions are
compared against historical mean returns. While this approach is sensible for the aggregate index or
long-short portfolios, for example, it is flawed when it comes to analyzing individual stock returns.
Predicting future excess stock returns with historical averages typically underperforms a naive forecast of zero by a large margin. That is, the historical mean stock return is so noisy that it artificially
lowers the bar for â€œgoodâ€ forecasting performance. We avoid this pitfall by benchmarking our R2
against a forecast value of zero. To give an indication of the importance of this choice, when we
benchmark model predictions against historical mean stock returns, the out-of-sample monthly R2
of all methods rises by roughly three percentage points.
24

Early stopping bears a comparatively low computation cost because it only partially optimizes, while the l2 regularization, or more generally elastic net, search across tuning parameters and fully optimizes the model subject to
each tuning parameter guess. As usual, elastic netâ€™s l1 -penalty component encourages neurons to connect to limited
number of other neurons, while its l2 -penalty component shrinks the weight parameters toward zero (a feature known
in the neural net literature as â€œweight-decayâ€). In certain circumstances, early stopping and weight-decay are shown
to be equivalent. See, e.g., Bishop (1995) and Goodfellow et al. (2016).
25
Estimation with different seeds can run independently in parallel which limits incremental computing time.

22

To make pairwise comparisons of methods, we use the Diebold and Mariano (1995) test for
differences in out-of-sample predictive accuracy between two models.26 While time series dependence
in returns is sufficiently weak, it is unlikely that the conditions of weak error dependence underlying
the Diebold-Mariano test apply to our stock-level analysis due of potentially strong dependence in
the cross section. We adapt Diebold-Mariano to our setting by comparing the cross-sectional average
of prediction errors from each model, instead of comparing errors among individual returns. More
precisely, to test the forecast performance of method (1) versus (2), we define the test statistic
DM12 = dÂ¯12 /b
Ïƒ Â¯ , where
d12

d12,t+1 =
(1)

1
n3,t+1

n3 
X

2
(1)
ebi,t+1

âˆ’



2
(2)
ebi,t+1


,

(20)

i=1

(2)

ebi,t+1 and ebi,t+1 denote the prediction error for stock return i at time t using each method, and
n3,t+1 is the number of stocks in the testing sample (year t + 1). Then dÂ¯12 and Ïƒ
b Â¯ denote the
d12

mean and Newey-West standard error of d12,t over the testing sample. This modified DieboldMariano test statistic, which is now based on a single time series d12,t+1 of error differences with
little autocorrelation, is more likely to satisfy the mild regularity conditions needed for asymptotic
normality and in turn provide appropriate p-values for our model comparison tests.

2.9

Variable Importance and Marginal Relationships

Our goal in interpreting machine learning models is modest. We aim to identify covariates that have
an important influence on the cross-section of expected returns while simultaneously controlling for
the many other predictors in the system.
We discover influential covariates by ranking them according to a notion of variable importance,
which we denote as VIj for the j th input variable. We consider two different notions of importance.
The first is the reduction in panel predictive R2 from setting all values of predictor j to zero, while
holding the remaining model estimates fixed (used, for example, in the context of dimension reduction
by Kelly et al., 2019). The second, proposed in the neural networks literature by Dimopoulos et al.
(1995), is the sum of squared partial derivatives (SSD) of the model to each input variable j, which
summarizes the sensitivity of model fits to changes in that variable.27
As part of our analysis, we also trace out the marginal relationship between expected returns
26
As emphasize by Diebold (2015), the model-free nature of the Diebold-Mariano test means that it should be
interpreted as a comparison of forecasts, and not as a comparison of â€œfully articulated econometric models.â€
27
In particular, SSD defines the j th variable importance as
!2
X
âˆ‚g(z; Î¸)
SSDj =
,
âˆ‚zj
z=zi,t
i,tâˆˆT
1

where, with a slight abuse of notation, zj in the denominator of the derivative denotes the j th element of the vector
of input variables. We measure SSD within the training set, T1 . Note that due to non-differentiabilities in tree-based
models, the Dimopoulos et al. (1995) method is not applicable. Therefore, when we conduct this second variable
importance analysis, we measure variable importance for random forests and boosted trees using mean decrease in
impurity (see, e.g., Friedman, 2001).

23

and each characteristic. Despite obvious limitations, such a plot is an effective tool for visualizing
the first-order impact of covariates in a machine learning model.

3

An Empirical Study of US Equities

3.1

Data and Over-arching Model

We obtain monthly total individual equity returns from CRSP for all firms listed in the NYSE,
AMEX, and NASDAQ. Our sample begins in March 1957 (the start date of the S&P 500) and ends
in December 2016, totaling 60 years. The number of stocks in our sample is almost 30,000, with
the average number of stocks per month exceeding 6,200.28 We also obtain the Treasury-bill rate to
proxy for the risk-free rate from which we calculate individual excess returns.
In addition, we build a large collection of stock-level predictive characteristics based on the cross
section of stock returns literature. These include 94 characteristics29 (61 of which are updated
annually, 13 updated quarterly, and 20 updated monthly). In addition, we include 74 industry
dummies corresponding to the first two digits of Standard Industrial Classification (SIC) codes. We
provide the details of these characteristics in Table A.6.30
We also construct eight macroeconomic predictors following the variable definitions detailed in
Welch and Goyal (2008), including dividend-price ratio (dp), earnings-price ratio (ep), book-tomarket ratio (bm), net equity expansion (ntis), Treasury-bill rate (tbl), term spread (tms), default
spread (dfy), and stock variance (svar).31
All of the machine learning methods we consider are designed to approximate the over-arching
empirical model Et (ri,t+1 ) = g ? (zi,t ) defined in equation (2). Throughout our analysis we define the
baseline set of stock-level covariates zi,t as
zi,t = xt âŠ— ci,t ,
28

(21)

We include stocks with prices below $5, share codes beyond 10 and 11, and financial firms. There are at least
three important reasons why we select the largest possible pool of assets. First, these commonly used filters remove
certain stocks that are components of the S&P 500 index, and we find it clearly problematic to exclude such important
stocks from an asset pricing analysis. Moreover, because we aggregate individual stock return predictions to predict
the index, we cannot omit such stocks. Second, our results are less prone to sample selection or data snooping biases
that the literature, e.g. Lo and MacKinlay (1990), cautions against. Third, using a larger sample helps avoid overfitting
by increasing the ratio of observation count to parameter count. That said, our results are qualitatively identical and
quantitively unchanged if we filter out these firms.
29
We cross-sectionally rank all stock characteristics period-by-period and map these ranks into the [-1,1] interval
following Kelly et al. (2019) and Freyberger et al. (2019).
30
The 94 predictive characteristics are based on Green et al. (2017), and we adapt the SAS code available from
Jeremiah Greenâ€™s website and extend the sample period back to 1957. Our data construction differs by adhering more
closely to variable definitions in original papers. For example, we construct book-equity and operating profitability
following Fama and French (2015). Most of these characteristics are released to the public with a delay. To avoid the
forward-looking bias, we assume that monthly characteristics are delayed by at most 1 month, quarterly with at least
4 months lag, and annual with at least 6 months lag. Therefore, in order to predict returns at month t + 1, we use
most recent monthly characteristics at the end of month t, most recent quarterly data by end t âˆ’ 4, and most recent
annual data by end t âˆ’ 6. Another issue is missing characteristics, which we replace with the cross-sectional median at
each month for each stock, respectively.
31
The monthly data are available from Amit Goyalâ€™s website.

24

where ci,t is a Pc Ã— 1 matrix of characteristics for each stock i, and xt is a Px Ã— 1 vector of macroeconomic predictors (and are thus common to all stocks, including a constant). Thus, zi,t is a P Ã— 1
vector of features for predicting individual stock returns (with P = Pc Px ) and includes interactions between stock-level characteristics and macroeconomic state variables. The total number of
covariates is 94 Ã— (8 + 1) + 74 = 920.
The over-arching model specified by (2) and (21) nests many models proposed in the literature
(Rosenberg, 1974; Harvey and Ferson, 1999, among others). The motivating example for this model
structure is the standard beta-pricing representation of the asset pricing conditional Euler equation,
Et (ri,t+1 ) = Î² 0i,t Î»t .

(22)

The structure of our feature set in (21) allows for purely stock-level information to enter expected
returns via ci,t in analogy with the risk exposure function Î² i,t , and also allows aggregate economic
conditions to enter in analogy with the dynamic risk premium Î»t . In particular, if Î² i,t = Î¸1 ci,t , and
Î»t = Î¸2 xt , for some constant parameter matrices Î¸1 (K Ã— Pc ) and Î¸2 (K Ã— Px ), then the beta-pricing
model in (22) becomes
0
g ? (zi,t ) = Et (ri,t+1 ) = Î² 0i,t Î»t = c0i,t Î¸01 Î¸2 xt = (xt âŠ— ci,t )0 vec(Î¸01 Î¸2 ) =: zi,t
Î¸,

(23)

where Î¸ = vec(Î¸01 Î¸2 ). The over-arching model is more general than this example because g ? (Â·) is
not restricted to be a linear function. Considering nonlinear g ? (Â·) formulations, for example via
generalized linear models or neural networks, essentially expands the feature set to include a variety
of functional transformations of the baseline zi,t predictor set.
We divide the 60 years of data into 18 years of training sample (1957 - 1974), 12 years of validation
sample (1975 - 1986), and the remaining 30 years (1987 - 2016) for out-of-sample testing. Because
machine learning algorithms are computationally intensive, we avoid recursively refitting models each
month. Instead, we refit once every year as most of our signals are updated once per year. Each time
we refit, we increase the training sample by one year. We maintain the same size of the validation
sample, but roll it forward to include the most recent twelve months.32

3.2

The Cross Section of Individual Stocks

Table 1 presents the comparison of machine learning techniques in terms of their out-of-sample
predictive R2 . We compare thirteen models in total, including OLS with all covariates, OLS-3
(which pre-selects size, book-to-market, and momentum as the only covariates), PLS, PCR, elastic
net (ENet), generalized linear model with group lasso (GLM), random forest (RF), gradient boosted
regression trees (GBRT), and neural network architectures with one to five layers (NN1,...,NN5).
For OLS, ENet, GLM, and GBRT, we present their robust versions using Huber loss, which perform
better than the version without.
2 for the entire pooled sample. The OLS model using all 920
The first row of Table 1 reports Roos
32

Note that we do not use cross-validation in order to maintain the temporal ordering of the data.

25

2 )
Table 1: Monthly Out-of-sample Stock-level Prediction Performance (Percentage Roos

0.6

PLS

PCR

ENet
+H

GLM
+H

RF

GBRT
+H

NN1

NN2

NN3

NN4

NN5

-3.46
-11.28
-1.30

0.16
0.31
0.17

0.27
-0.14
0.42

0.26
0.06
0.34

0.11
0.25
0.20

0.19
0.14
0.30

0.33
0.63
0.35

0.34
0.52
0.32

0.33
0.49
0.38

0.39
0.62
0.46

0.40
0.70
0.45

0.39
0.67
0.47

0.36
0.64
0.42

N

0.8

OLS-3
+H

N

All
Top 1000
Bottom 1000

OLS
+H

All
Top
Bottom

2
Roos

0.4

0.2

0

-0.2
5

N

4

N

3

N

N

2

N

N

1

N

N
T+

BR

G

RF

H

+H

LM

G

+H

et
EN

R

PC

S

PL

+H

-3

LS

O

2
Note: In this table, we report monthly Roos
for the entire panel of stocks using OLS with all variables (OLS), OLS using
only size, book-to-market, and momentum (OLS-3), PLS, PCR, elastic net (ENet), generalize linear model (GLM),
random forest (RF), gradient boosted regression trees (GBRT), and neural networks with one to five layers (NN1â€“NN5).
2
â€œ+Hâ€ indicates the use of Huber loss instead of the l2 loss. We also report these Roos
within subsamples that include
only the top 1,000 stocks or bottom 1,000 stocks by market value. The lower panel provides a visual comparison of the
2
Roos
statistics in the table (omitting OLS due to its large negative values).

2 of âˆ’3.46%, indicating it is handily dominated by applying a naive forecast
features produces an Roos

of zero to all stocks in all months. This may be unsurprising as the lack of regularization leaves OLS
highly susceptible to in-sample overfit. However, restricting OLS to a sparse parameterization, either
by forcing the model to include only three covariates (size, value, and momentum), or by penalizing
the specification with the elastic netâ€”generates a substantial improvement over the full OLS model
2 of 0.16% and 0.11% respectively). Figure 3 summarizes the complexity of each model at each
(Roos

re-estimation date. The upper left panel shows the number of features to which elastic net assigns
a non-zero loading. In the first ten years of the test sample, the model typically chooses fewer than
five features. After 2000, the number of selected features rises and hovers between 20 and 40.
Regularizing the linear model via dimension reduction improves predictions even further. By
forming a few linear combinations of predictors, PLS and especially PCR, raise the out-of-sample
R2 to 0.27% and 0.26%, respectively. Figure 3 shows that PCR typically uses 20 to 40 components
in its forecasts. PLS, on the other hand, fails to find a single reliable component for much of the
early sample, but eventually settles on three to six components. The improvement of dimension
26

Figure 3: Time-varying Model Complexity

ENet+H

40
20
0
1985

1990

1995

2000 2005
PLS

2010

2015

5
0
1985

1990

1995

2005

2010

2
1990

1995

2000

1990

1995

2000 2005
GLM+H

2010

2015

1990

1995

2000 2005
GBRT+H

2010

2015

1990

1995

2010

2015

50

100

4

0
1985

0
1985

0
1985

2015

# of Char.

Tree Depth

6

2000
RF

50

100
# of Char.

# of Comp.

10

PCR

100
# of Comp.

# of Char.

60

2005

2010

50
0
1985

2015

2000

2005

Note: This figure demonstrates the model complexity for elastic net (ENet), PCR, PLS, generalized linear model with
group lasso (GLM), random forest (RF) and gradient boosted regression trees (GBRT) in each training sample of
our 30-year recursive out-of-sample analysis. For ENet and GLM we report the number of features selected to have
non-zero coefficients; for PCR and PLS we report the number of selected components; for RF we report the average
tree depth; and for GBRT we report the number of distinct characteristics entering into the trees.

reduction over variable selection via elastic net suggests that characteristics are partially redundant
and fundamentally noisy signals. Combining them into low-dimension components averages out noise
to better reveal their correlated signals.
The generalized linear model with group lasso penalty fails to improve on the performance of
2 of 0.19%). The fact that this method uses spline functions of individual
purely linear methods (Roos

features, but includes no interaction among features, suggests that univariate expansions provide
little incremental information beyond the linear model. Though it tends to select more features than
elastic net, those additional features do not translate into incremental performance.
Boosted trees and random forests are competitive with PCR, producing fits of 0.34% and 0.33%,
respectively. Random forests generally estimate shallow trees, with one to five layers on average.
To quantify the complexity of GBRT, we report the number of features used in the boosted tree
ensemble at each re-estimation point. In the beginning of the sample GBRT uses around 30 features
to partition outcomes, with this number increasing to 50 later in the sample.
Neural networks are the best performing nonlinear method, and the best predictor overall. The
2
Roos

is 0.33% for NN1 and peaks at 0.40% for NN3. These results point to the value of incorporating

complex predictor interactions, which are embedded in tree and neural network models but that are

27

2 )
Table 2: Annual Out-of-sample Stock-level Prediction Performance (Percentage Roos

PCR

ENet
+H

GLM
+H

RF

GBRT
+H

NN1

NN2

NN3

NN4

NN5

-34.86
-54.86
-19.22

2.50
2.48
4.88

2.93
1.84
5.36

3.08
1.64
5.44

1.78
1.90
3.94

2.60
1.82
5.00

3.28
4.80
5.08

3.09
4.07
4.61

2.64
2.77
4.37

2.70
4.24
3.72

3.40
4.73
5.17

3.60
4.91
5.01

2.79
4.86
3.58

N

N

N

5

PLS

N

6

OLS-3
+H

G

All
Top
Bottom

OLS
+H

All
Top
Bottom

2
Roos

4
3
2
1
0
5

N

4

N

3

N

2

N

N

1

N

T+

BR

RF

H

+H

LM

G

+H

et
EN

R

PC

S

PL

+H

-3

LS

O

2
Note: Annual return forecasting Roos
(see Table 1 notes).

missed by other techniques. The results also show that in the monthly return setting, the benefits
of â€œdeepâ€ learning are limited, as four and five layer models fail to improve over NN3.33
The second and third rows of Table 1 break out predictability for large stocks (the top 1,000 stocks
by market equity each month) and small stocks (the bottom 1,000 each month). This is based on the
full estimated model (using all stocks), but focuses on fits among the two subsamples. The baseline
patterns that OLS fares poorly, regularized linear models are an improvement, and nonlinear models
dominate carries over into subsamples. Tree methods and neural networks are especially successful
2
among large stocks, with Roos
ranging from 0.52% to 0.70%. This dichotomy provides reassurance

that machine learning is not merely picking up small scale inefficiencies driven by illiquidity.34
Table 2 conducts our analysis at the annual horizon. The comparative performance across dif2
ferent methods is similar to the monthly results shown in Table 1, but the annual Roos
is nearly

an order of magnitude larger. Their success in forecasting annual returns likewise illustrates that
33

Because we hold the five neural networks architectures fixed and simply compare across them, we do not describe
their estimated complexity in Figure 3.
34
As an aside, it is useful to know that there is a roughly 3% inflation in out-of-sample R2 s if performance is
benchmarked against historical averages. For OLS-3, the R2 relative to the historical mean forecast is 3.74% per
month! Evidently, the historical mean is such a noisy forecaster that it is easily beaten by a fixed excess return
forecasts of zero.

28

Table 3: Comparison of Monthly Out-of-Sample Prediction using Diebold-Mariano Tests

OLS+H
OLS-3+H
PLS
PCR
ENet+H
GLM+H
RF
GBRT+H
NN1
NN2
NN3
NN4

OLS-3
+H

PLS

PCR

ENet
+H

GLM
+H

RF

GBRT
+H

NN1

NN2

NN3

NN4

NN5

3.26âˆ—

3.29âˆ—
1.42

3.35âˆ—
1.87
-0.19

3.29âˆ—
-0.27
-1.18
-1.10

3.28âˆ—
0.62
-1.47
-1.37
0.64

3.29âˆ—
1.64
0.87
0.85
1.90
1.76

3.26âˆ—
1.28
0.67
0.75
1.40
1.22
0.07

3.34âˆ—
1.25
0.63
0.58
1.73
1.29
-0.03
-0.06

3.40âˆ—
2.13
1.32
1.17
1.97
2.28
0.31
0.16
0.56

3.38âˆ—
2.13
1.37
1.19
2.07
2.17
0.37
0.21
0.59
0.32

3.37âˆ—
2.36
1.66
1.34
1.98
2.68âˆ—
0.34
0.17
0.45
-0.03
-0.32

3.38âˆ—
2.11
1.08
1.00
1.85
2.37
0.00
-0.04
0.04
-0.88
-0.92
-1.04

Note: This table reports pairwise Diebold-Mariano test statistics comparing the out-of-sample stock-level prediction
performance among thirteen models. Positive numbers indicate the column model outperforms the row model. Bold
font indicates the difference is significant at 5% level or better for individual tests, while an asterisk indicates significance
at the 5% level for 12-way comparisons via our conservative Bonferroni adjustment.

machine learning models are able to isolate risk premia that persist over business cycle frequencies
and are not merely capturing short-lived inefficiencies.
While Table 1 offers a quantitative comparison of modelsâ€™ predictive performance, Table 3 assesses
the statistical significance of differences among models at the monthly frequency. It reports DieboldMariano test statistics for pairwise comparisons of a column model versus a row model. DieboldMariano statistics are distributed N (0, 1) under the null of no difference between models, thus the test
statistic magnitudes map to p-values in the same way as regression t-statistics. Our sign convention
is that a positive statistic indicates the column model outperforms the row model. Bold numbers
denote significance at the 5% level for each individual test.
The first conclusion from Table 3 is that constrained linear modelsâ€”including restricting OLS
to only use three predictors, reducing dimension via PLS or PCA, and penalizing via elastic netâ€”
produce statistically significant improvements over the unconstrained OLS model. Second, we see
little difference in the performance of penalized linear methods and dimension reduction methods.
Third, we find that tree-based methods uniformly improve over linear models, but the improvements
are at best marginally significant. Neural networks are the only models that produce large and
significant statistical improvements over linear and generalized linear models. They also improve
over tree models, but the difference is not statistically significant.
Table 3 makes multiple comparisons. We highlight how inference changes under a conservative
Bonferroni multiple comparisons correction that divides the significance level by the number of
comparisons.35 For a significance level of 5% amid 12 model comparisons, the adjusted one-sided
35
Multiple comparisons are a concern when the researcher conducts many hypotheses tests and draws conclusions
based on only those that are significant. This distorts the size of tests through a selection bias. This is not how we
present our resultsâ€”we report t-statistics for every comparison we considerâ€”yet we report adjusted inference to err
on the side of caution. We also note that false discoveries in multiple comparisons should be randomly distributed.

29

critical value in our setting is 2.64. In the table, tests that exceed this conservative threshold
are accompanied by an asterisk. The main difference with a Bonferroni adjustment is that neural
networks become only marginally significant over penalized linear models.

3.3

Which Covariates Matter?

We now investigate the relative importance of individual covariates for the performance of each model
using the importance measures described in Section 2.9. To begin, for each method, we calculate the
reduction in R2 from setting all values of a given predictor to zero within each training sample, and
average these into a single importance measure for each predictor. Figure 4 reports the resulting
importances of the top 20 stock-level characteristics for each method. Variable importances within a
model are normalized to sum to one, giving them the interpretation of relative importance for that
particular model.
Figure 5 reports overall rankings of characteristics for all models. We rank the importance of
each characteristic for each method, then sum their ranks. Characteristics are ordered so that the
highest total ranks are on top and the lowest ranking characteristics are at the bottom. The color
gradient within each column shows the model-specific ranking of characteristics from least to most
important (lightest to darkest).36
Figures 4 and 5 demonstrate that models are generally in close agreement regarding the most
influential stock-level predictors, which can be grouped into four categories. The first are based
on recent price trends, including five of the top seven variables in Figure 5: short-term reversal
(mom1m), stock momentum (mom12m), momentum change (chmom), industry momentum (indmom), recent maximum return (maxret), and long-term reversal (mom36m). Next are liquidity
variables, including turnover and turnover volatility (turn, std turn), log market equity (mvel1),
dollar volume (dolvol), Amihud illiquidity (ill), number of zero trading days (zerotrade), and bidask spread (baspread). Risk measures constitute the third influential group, including total and
idiosyncratic return volatility (retvol, idiovol), market beta (beta), and beta-squared (betasq). The
last group includes valuation ratios and fundamental signals, such as earnings-to-price (ep), sales-toprice (sp), asset growth (agr), and number of recent earnings increases (nincr). Figure 4 shows that
characteristic importance magnitudes for penalized linear models and dimension reduction models
are highly skewed toward momentum and reversal. Trees and neural networks are more democratic,
drawing predictive information from a broader set of characteristics.
We find that our second measure of variable importance, SSD from Dimopoulos et al. (1995),
produces very similar results to the simpler R2 measure. Within each model, we calculate the Pearson
correlation between relative importances from SSD and the R2 measure. These correlations range
from 84.0% on the low end (NN1) to 97.7% on the high end (random forest). That is, the two
The statistically significant t-statistics in our analyses do not appear random, but instead follow a pattern in which
nonlinear models outperform linear ones.
36
Figure 5 is based on the average rank over 30 recursing training samples. Figure A.1 presents the ranks for each of
the recursing sample, respectively. The rank of important characteristics (top third of the covariates) are remarkably
stable over time. This is true for all models, though we show results for one representative model (NN3) in the interest
of space.

30

Figure 4: Variable Importance By Model
PLS

PCR

mom1m
chmom
indmom
mom12m
std_turn
maxret
turn
sp
mom6m
mvel1
ep
dolvol
rd_mve
agr
cashpr
nincr
chcsho
retvol
operprof
lev

mom1m
chmom
mom12m
indmom
maxret
sp
mvel1
chcsho
rd_mve
agr
invest
ep
mom6m
cashpr
depr
bm
lgr
chinv
bm_ia
mom36m
0.0

0.1

0.2

0.3

0.0

0.1

ENet+H

0.2

0.3

GLM+H

mom1m
mom12m
indmom
agr
dolvol
rd_mve
invest
chcsho
sp
std_turn
ps
nincr
chmom
chinv
turn
ep
mvel1
retvol
mom6m
mom36m

mom1m
mom12m
indmom
mvel1
maxret
rd_mve
agr
invest
ill
chcsho
cashpr
dolvol
chmom
turn
ep
lgr
chinv
sic2
securedind
mom36m
0.0

0.2

0.4

0.6

0.0

RF

0.1

0.2

0.3

0.4

0.5

GBRT+H

mom1m
dy
mvel1
maxret
indmom
securedind
nincr
retvol
chmom
mom12m
baspread
mom6m
convind
idiovol
sp
beta
betasq
ill
dolvol
mom36m

dy
mom1m
securedind
mom12m
maxret
nincr
retvol
indmom
mvel1
chmom
convind
sp
idiovol
baspread
mom6m
beta
age
mom36m
turn
rd_mve
0.00

0.05

0.10

0.00

0.05

NN2

0.10

0.15

0.20

NN3

mom1m
mvel1
retvol
chmom
maxret
dolvol
turn
mom12m
mom6m
baspread
ill
idiovol
std_turn
indmom
nincr
zerotrade
securedind
mom36m
sp
betasq

mom1m
mvel1
retvol
maxret
chmom
dolvol
turn
idiovol
mom6m
baspread
mom12m
ill
std_turn
indmom
nincr
zerotrade
mom36m
securedind
sp
beta
0.00

0.05

0.10

0.15

0.20

0.00

0.05

0.10

0.15

0.20

Note: Variable importance for the top 20 most influential variables in each model. Variable importance is an average
over all training samples. Variable importances within each model are normalized to sum to one.

31

Figure 5: Characteristic Importance
mom1m
mvel1
mom12m
chmom
maxret
indmom
retvol
dolvol
sp
turn
agr
nincr
rd_mve
std_turn
mom6m
mom36m
ep
chcsho
securedind
idiovol
baspread
ill
age
convind
rd
depr
beta
betasq
cashpr
ps
zerotrade
dy
orgcap
bm
lgr
cashdebt
chinv
invest
lev
operprof
bm_ia
saleinv
egr
cfp
rd_sale
sgr
roaq
roic
sic2
mve_ia
ms
quick
herf
hire
pricedelay
salerec
roavol
roeq
grcapx
currat
cash
std_dolvol
acc
cfp_ia
grltnoa
gma
pctacc
absacc
salecash
secured
pchdepr
tang
pchcapx_ia
chempia
ear
pchsale_pchinvt
pchsaleinv
chtx
chpmia
chatoia
tb
aeavol
rsup
pchgm_pchsale
pchsale_pchxsga
cinvest
pchquick
pchsale_pchrect
realestate
pchcurrat
stdacc
stdcf
divi
divo
sin
PLS

PCR

ENet+H

GLM+H

RF

GBRT+H

NN1

NN2

NN3

NN4

NN5

Note: Rankings of 94 stock-level characteristics and the industry dummy (sic2) in terms of overall model contribution.
Characteristics are ordered based on the sum of their ranks over all models, with the most influential characteristics on
top and least influential on bottom. Columns correspond to individual models, and color gradients within each column
indicate the most influential (dark blue) to least influential (white) variables.

32

Table 4: Variable Importance for Macroeconomic Predictors

dp
ep
bm
ntis
tbl
tms
dfy
svar

PLS

PCR

ENet+H

GLM+H

RF

GBRT+H

NN1

NN2

NN3

NN4

NN5

12.52
12.25
14.21
11.25
14.02
11.35
17.17
7.22

14.12
13.52
14.83
9.10
15.29
10.66
15.68
6.80

2.49
3.27
33.95
1.30
13.29
0.31
42.13
3.26

4.54
7.37
43.46
4.89
7.90
5.87
24.10
1.87

5.80
6.27
10.94
13.02
11.98
16.81
24.37
10.82

6.05
2.85
12.49
13.79
19.49
15.27
22.93
7.13

15.57
8.86
28.57
18.37
17.18
10.79
0.09
0.57

17.58
8.09
27.18
19.26
16.40
10.59
0.06
0.85

14.84
7.34
27.92
20.15
17.76
10.91
0.06
1.02

13.95
6.54
26.95
19.59
20.99
10.38
0.04
1.57

13.15
6.47
27.90
18.68
21.06
10.33
0.12
2.29

0.6
PLS
PCR
ENet+H
GLM+H
RF
GBRT+H
NN1
NN2
NN3
NN4
NN5

0.5

0.4

0.3

0.2

0.1

0

dp

ep

bm

ntis

tbl

tms

dfy

svar

Note: Variable importance for eight macroeconomic variables in each model. Variable importance is an average over
all training samples. Variable importances within each model are normalized to sum to one. The lower panel provides
a complementary visual comparison of macroeconomic variable importances.

methods provide a highly consistent summary of which variables are most influential for forecast
accuracy. The full set of SSD results are shown in appendix Figure A.2.
For robustness, we re-run our analysis with an augmented set of characteristics that include five
placebo â€œcharacteristics.â€ They are simulated according to the data generating process (A.1) in
Appendix A. The parameters are calibrated to have similar behavior as our characteristics dataset
but are independent of future returns by construction. Figure A.3 in Appendix F presents the variable
importance plot (based on R2 ) with five noise characteristics highlighted. The table confirms that the
most influential characteristics that we identify in our main analysis are unaffected by the presence of
irrelevant characteristics. Noise variables appear among the least informative characteristics, along
with sin stocks, dividend initiation/omission, cashflow volatility, and other accounting variables.
Table 4 shows the R2 -based importance measure for each macroeconomic predictor variable (again
normalized to sum to one within a given model). All models agree that the aggregate book-to-market
ratio is a critical predictor, whereas market volatility has little role in any model. PLS and PCR
place similar weights on all other predictors, potentially because these variables are highly correlated.
Linear and generalized linear models strongly favor bond market variables including the default
33

spread and treasury rate. Nonlinear methods (trees and neural networks) place great emphasis on
exactly those predictors ignored by linear methods, such as term spreads and issuance activity.
Many accounting characteristics are not available at the monthly frequency, which might explain
their low importance in Figure 5. To investigate this, appendix Figure A.6 presents the rank of
variables based on the annual return forecasts. Price trend variables become less important compared
to the liquidity and risk measures, although they are still quite influential. The characteristics that
were ranked in the bottom half of predictors at the monthly horizon remain largely unimportant at
the annual horizon. The exception is industry (sic2) which shows substantial predictive power at the
annual frequency.
3.3.1

Marginal Association Between Characteristics and Expected Returns

Figure 6 traces out the model-implied marginal impact of individual characteristics on expected
excess returns. Our data transformation normalizes characteristics to the (-1,1) interval, and holds
all other variables fixed at their median value of zero. We choose four illustrative characteristics
for the figure, including size (mvel1), momentum (mom12m), stock volatility (retvol), and accruals
(acc).
First, Figure 6 illustrates that machine learning methods identify patterns similar to some well
known empirical phenomena. For example, expected stock returns are decreasing in size, increasing
in past one-year return, and decreasing in stock volatility. And it is interesting to see that all
methods agree on a nearly exact zero relationship between accruals and future returns. Second, the
(penalized) linear model finds no predictive association between returns and either size or volatility,
while trees and neural networks find large sensitivity of expected returns to both of these variables.
For example, a firm that drops from median size to the 20th percentile of the size distribution
experiences an increase in its annualized expected return of roughly 2.4% (0.002Ã—12Ã—100), and a
firm whose volatility rises from median to 80th percentile experiences a decrease of around 3.0% per
year, according to NN3, and these methods detect nonlinear predictive associations. The inability
of linear models to capture nonlinearities can lead them to prefer a zero association, and this can in
part explain the divergence in the performance of linear and nonlinear methods.
3.3.2

Interaction Effects

The favorable performance of trees and neural networks indicates a benefit to allowing for potentially
complex interactions among predictors. Machine learning models are often referred to as â€œblack
boxes.â€ This is in some sense a misnomer, as the models are readily inspectable. They are, however,
complex, and this is the source of both their power and their opacity. Any exploration of interaction
effect is vexed by vast possibilities for identity and functional forms for interacting predictors. In
this section, we present a handful of interaction results to help illustrate the inner workings of one
black box method, the NN3 model.
As a first example, we examine a set of pairwise interaction effects in NN3. Figure 7 reports how
expected returns vary as we simultaneously vary values of a pair of characteristics over their support

34

Figure 6: Marginal Association Between Expected Returns and Characteristics
4

Ã—10 -3

4

ENet+H
GLM+H
RF
GBRT+H
NN3

0

0

-4
-1
4

Ã—10 -3

-0.8

-0.6

-0.4

-0.2

0
mvel1

0.2

0.4

0.6

0.8

-4
-1

1

Ã—10 -3

4

0

-4
-1

-0.8

-0.6

-0.4

-0.2
0
0.2
mom12m

0.4

0.6

0.8

1

-0.6

-0.4

-0.2

0.4

0.6

0.8

1

Ã—10 -3

0

-0.8

-0.6

-0.4

-0.2

0
retvol

0.2

0.4

0.6

0.8

-4
-1

1

-0.8

0
acc

0.2

Note: Sensitivity of expected monthly percentage returns (vertical axis) to individual characteristics (holding all other
covariates fixed at their median values).

[-1,1], while holding all other variables fixed at their median value of zero. We show interactions of
stock size (mvel1) with four other predictors: short-term reversal (mom1m), momentum (mom12m),
and total and idiosyncratic volatility (retvol and idiovol, respectively).
The upper-left figure shows that the short-term reversal effect is strongest and is essentially
linear among small stocks (blue line). Among large stocks (green line), reversal is concave, occurring
primarily when the prior month return is positive. The upper-right figure shows the momentum
effect, which is most pronounced among large stocks for the NN3 model.37 Likewise, on the lowerleft, we see that the low volatility anomaly is also strongest among large stocks. For small stocks, the
volatility effect is hump-shaped. Finally, the lower-right shows that NN3 estimates no interaction
effect between size and accrualsâ€”the size lines are simply vertical shifts of the univariate accruals
curve.
Figure 8 illustrates interactions between stock-level characteristics and macroeconomic indicator
variables. It shows, for example, that the size effect is more pronounced when aggregate valuations
are low (bm is high) and when equity issuance (ntis) is low, while the low volatility anomaly is
especially strong in high valuation and high issuance environments. Appendix Figure A.4 shows
the 100 most important interactions of stock characteristics with macroeconomic indicators for each
machine learning model. The most influential features come from interacting a stockâ€™s recent price
37

Note that conclusions from our model can diverge from results in the literature because we jointly model hundreds
of predictor variables, which can lead to new conclusions regarding marginal effects, interaction effects, and so on.

35

Figure 7: Expected Returns and Characteristic Interactions (NN3)
0.6

0.6

mvel1=-1
mvel1=-0.5
mvel1=0
mvel1=0.5
mvel1=1

0

-0.6

-1

0

-0.8

-0.6

-0.4

-0.2

0
0.2
mom1m

0.4

0.6

0.8

-0.6

1

-1

0.6

0.6

0

0

-0.6

-1

-0.8

-0.6

-0.4

-0.2

0
retvol

0.2

0.4

0.6

0.8

-0.6

1

-1

-0.8

-0.6

-0.4

-0.2
0
0.2
mom12m

0.4

0.6

0.8

1

-0.8

-0.6

-0.4

-0.2

0.4

0.6

0.8

1

0
acc

0.2

Note: Sensitivity of expected monthly percentage returns (vertical axis) to interactions effects for mvel1 with mom1m,
mom12m, retvol, and acc in model NN3 (holding all other covariates fixed at their median values).

trends (e.g., momentum, short-term reversal, or industry momentum) with aggregate asset price
levels (e.g., valuation ratios of the aggregate stock market or Treasury bill rates). Furthermore, the
dominant macroeconomic interactions are stable over time, as illustrated in appendix Figure A.5.

3.4

Portfolio Forecasts

So far we have analyzed predictability of individual stock returns. Next, we compare forecasting
performance of machine learning methods for aggregate portfolio returns. There are a number of
benefits to analyzing portfolio-level forecasts.
First, because all of our models are optimized for stock-level forecasts, portfolio forecasts provide
an additional indirect evaluation of the model and its robustness. Second, aggregate portfolios
tend to be of broader economic interest because they represent the risky-asset savings vehicles most
commonly held by investors (via mutual funds, ETFs, and hedge funds). We study value-weight
portfolios to assess the extent to which a modelâ€™s predictive performance thrives in the most valuable
(and most economically important) assets in the economy. Third, the distribution of portfolio returns
is sensitive to dependence among stock returns, with the implication that a good stock-level prediction
model is not guaranteed to produce accurate portfolio-level forecasts. Bottom-up portfolio forecasts
allow us to evaluate a modelâ€™s ability to transport its asset predictions, which occur at the finest

36

Figure 8: Expected Returns and Characteristic/Macroeconomic Variable Interactions (NN3)
0.5

0.5

bm=Quantile 10%
bm=Quantile 30%
bm=Quantile 50%
bm=Quantile 70%
bm=Quantile 90%

0

-0.5

-1

0

-0.8

-0.6

-0.4

-0.2

0
0.2
mvel1

0.4

0.5

0.6

0.8

-0.5

1

-1

-1

-0.8

-0.6

-0.4

-0.2

0
0.2
mvel1

0.5

bm=Quantile 10%
bm=Quantile 30%
bm=Quantile 50%
bm=Quantile 70%
bm=Quantile 90%

0

-0.5

ntis=Quantile 10%
ntis=Quantile 30%
ntis=Quantile 50%
ntis=Quantile 70%
ntis=Quantile 90%

0.4

0.6

0.8

1

ntis=Quantile 10%
ntis=Quantile 30%
ntis=Quantile 50%
ntis=Quantile 70%
ntis=Quantile 90%

0

-0.8

-0.6

-0.4

-0.2

0
retvol

0.2

0.4

0.6

0.8

-0.5

1

-1

-0.8

-0.6

-0.4

-0.2

0
retvol

0.2

0.4

0.6

0.8

1

Note: Sensitivity of expected monthly percentage returns (vertical axis) to interactions effects for mvel1 and retvol
with bm and ntis in model NN3 (holding all other covariates fixed at their median values).

asset level, into broader investment contexts. Last but not least, the portfolio results are one step
further â€œout-of-sampleâ€ in that the optimization routine does not directly account for the predictive
performance of the portfolios.
Our assessment of forecast performance up to this point has been entirely statistical, relying on
comparisons of predictive R2 . The final advantage of analyzing predictability at the portfolio level
is that we can assess the economic contribution of each method via its contribution to risk-adjusted
portfolio return performance.
3.4.1

Pre-specified Portfolios

We build bottom-up forecasts by aggregating individual stock return predictions into portfolios.
p
Given the weight of stock i in portfolio p (denoted wi,t
) and given a model-based out-of-sample

forecast for stock i (denoted rbi,t+1 ), we construct the portfolio return forecast as
p
rbt+1
=

n
X

p
wi,t
Ã— rbi,t+1 .

i=1

This bottom-up approach works for any target portfolio whose weights are known a priori.
We form bottom-up forecasts for 30 of the most well known portfolios in the empirical finance

37

Table 5: Monthly Portfolio-level Out-of-Sample Predictive R2
OLS-3
+H

PLS

PCR

ENet
+H

GLM
+H

RF

GBRT
+H

NN1

NN2

NN3

NN4

NN5

S&P 500
SMB
HML
RMW
CMA
UMD

-0.22
0.81
0.66
-2.35
0.80
-0.90

-0.86
2.09
0.50
1.19
-0.44
-1.09

Panel
-1.55
0.39
1.21
0.41
0.03
-0.47

A: Common Factor Portfolios
0.75
0.71
1.37
1.40
1.72
2.36
0.57
0.35
0.46
0.84
0.98
0.21
-1.07
-0.06 -0.54
-0.92
-1.07
1.24
-0.11
-1.04
0.47
-0.37
1.37
-0.25

1.08
1.40
1.22
0.68
1.88
-0.56

1.13
1.16
1.31
0.47
1.60
-0.26

1.80
1.31
1.06
0.84
1.06
0.19

1.63
1.20
1.25
0.53
1.84
0.27

1.17
1.27
1.24
0.54
1.31
0.35

Big Value
Big Growth
Big Neutral
Small Value
Small Growth
Small Neutral

0.10
-0.33
-0.17
0.30
-0.16
-0.27

Panel B: Sub-components of Factor
0.00
-0.33
0.25
0.59
1.31
-1.26 -1.62
0.70
0.51
1.32
-1.09 -1.51
0.80
0.36
1.31
1.66
1.05
0.64
0.85
1.24
0.14
-0.18 -0.33
-0.12
0.71
0.60
0.19
0.21
0.28
0.88

Portfolios
1.06
0.85
1.19
1.00
1.28
1.43
0.52
1.59
1.24
0.05
0.36
0.58

0.87
1.10
1.24
1.37
0.42
0.62

1.46
1.50
1.70
1.54
0.48
0.70

1.21
1.24
1.81
1.40
0.41
0.58

0.99
1.11
1.40
1.30
0.50
0.68

Big Conservative
Big Aggressive
Big Neutral
Small Conservative
Small Aggressive
Small Neutral

-0.57
0.20
-0.29
-0.05
-0.10
-0.30

-0.10
-0.80
-1.75
1.17
0.51
0.45

-1.06
-1.15
-1.96
0.71
0.01
0.12

1.02
0.30
0.83
-0.02
-0.09
0.42

0.46
0.67
0.48
0.34
0.14
0.35

1.11
1.75
1.13
0.96
1.00
0.76

0.55
2.00
0.77
0.56
1.46
-0.01

1.15
1.33
0.85
0.82
0.34
0.70

1.13
1.51
0.85
0.87
0.64
0.69

1.59
1.78
1.51
0.96
0.75
0.83

1.37
1.55
1.45
0.90
0.62
0.66

1.07
1.42
1.16
0.83
0.71
0.72

Big Robust
Big Weak
Big Neutral
Small Robust
Small Weak
Small Neutral

-1.02
-0.12
0.86
-0.71
0.05
-0.51

-1.08
1.42
-1.22
0.35
1.06
0.07

-2.06
1.07
-1.26
-0.38
0.59
-0.47

0.55
0.89
0.41
-0.04
-0.13
-0.33

0.35
1.10
0.13
-0.42
0.44
-0.32

1.10
1.33
1.10
0.70
1.05
0.60

0.33
1.77
0.91
0.19
1.42
-0.08

0.74
1.79
0.84
0.24
0.71
0.10

0.79
1.79
0.94
0.50
0.92
0.25

1.28
2.05
1.19
0.63
0.99
0.38

1.03
1.66
1.15
0.53
0.90
0.32

0.74
1.60
0.99
0.55
0.89
0.41

Big Up
Big Down
Big Medium
Small Up
Small Down
Small Medium

0.20
-1.54
-0.04
0.07
-0.21
0.07

-0.25
-1.63
-1.51
0.78
0.15
0.82

-1.24
-1.55
-1.94
0.56
-0.20
0.20

0.66
0.44
0.81
-0.07
0.15
0.59

1.17
-0.33
-0.08
0.25
-0.01
0.37

1.18
1.14
1.57
0.62
1.51
1.22

0.90
0.71
1.80
-0.03
1.38
1.06

0.80
0.36
1.29
0.06
0.74
1.09

0.76
0.70
1.32
0.07
0.82
1.09

1.13
1.07
1.71
0.21
1.02
1.18

1.12
0.90
1.55
0.19
0.91
1.00

0.93
0.84
1.23
0.25
0.96
1.03

Note: In this table, we report the out-of-sample predictive R2 s for 30 portfolios using OLS with size, book-to-market,
and momentum, OLS-3, PLS, PCR, elastic net (ENet), generalized linear model with group lasso (GLM), random forest
(RF), gradient boosted regression trees (GBRT), and five architectures of neural networks (NN1,...,NN5), respectively.
â€œ+Hâ€ indicates the use of Huber loss instead of the l2 loss. The six portfolios in Panel A are the S&P 500 index and the
Fama-French SMB, HML, CMA, RMW, and UMD factors. The 24 portfolios in Panel B are 3 Ã— 2 size double-sorted
portfolios used in the construction of the Fama-French value, investment, profitability, and momentum factors.

literature, including the S&P 500, the Fama-French size, value, profitability, investment, and momentum factor portfolios (SMB, HML, RMW, CMA, and UMD, respectively), and sub-components of
these Fama-French portfolios, including six size and value portfolios, six size and investment portfolios, six size and profitability portfolios, and six size and momentum portfolios. The sub-component
portfolios are long-only and therefore have substantial overlap with the market index, while SMB,
HML, RMW, CMA, and UMD are zero-net-investment long-short portfolios that are in large part

38

Table 6: Market Timing Sharpe Ratio Gains
OLS-3
+H

PLS

PCR

S&P 500
SMB
HML
RMW
CMA
UMD

0.07
0.06
0.00
0.00
0.02
0.01

0.05
0.17
0.01
-0.01
0.02
-0.06

Panel A: Common Factor Portfolios
-0.06
0.12
0.19
0.18
0.19
0.09
0.24
0.26
0.00
-0.07
0.04
-0.03
-0.02
0.04
0.02
-0.06 -0.19
-0.13 -0.11
-0.01
0
-0.09
-0.05
0.08
-0.01
-0.02 -0.02
-0.07 -0.04
-0.07

Big Value
Big Growth
Big Neutral
Small Value
Small Growth
Small Neutral

-0.01
0.08
0.06
-0.04
0.00
0.02

Big Conservative
Big Aggressive
Big Neutral
Small Conservative
Small Aggressive
Small Neutral

ENet
+H

GLM
+H

RF

GBRT
+H

NN1

NN2

NN3

NN4

NN5

0.22
0.21
0.04
-0.03
0.00
-0.04

0.20
0.18
0.06
-0.09
0.01
-0.08

0.26
0.15
0.04
0.01
0.05
-0.04

0.22
0.09
0.02
0.01
0.04
-0.10

0.19
0.11
0.01
-0.07
0.06
-0.01

Panel B: Sub-components of Factor
0.06
-0.03
0.09
0.06
0.09
-0.01 -0.08
0.10
0.17
0.20
0.03
-0.06
0.11
0.16
0.13
0.15
0.09
0.01
0.08
0.07
0.03
-0.06 -0.03
-0.05
0.04
0.09
0.05
0.03
0.04
0.11

Portfolios
0.08
0.11
0.21
0.22
0.17
0.23
0.08
0.11
0.05
0.02
0.11
0.09

0.11
0.20
0.21
0.11
0.03
0.08

0.13
0.26
0.23
0.10
0.03
0.10

0.10
0.22
0.23
0.11
0.02
0.09

0.11
0.21
0.21
0.13
0.02
0.11

0.08
0.08
0.04
0.04
0.01
0.01

0.02
-0.01
-0.01
0.17
0.05
0.06

-0.04
-0.11
-0.08
0.12
-0.06
0.03

0.08
0.01
0.09
0.02
-0.05
0.01

0.15
0.13
0.11
0.05
-0.03
0.04

0.09
0.22
0.09
0.17
0.08
0.08

0.13
0.18
0.11
0.15
0.06
0.09

0.17
0.21
0.13
0.11
0.02
0.07

0.14
0.19
0.12
0.11
0.05
0.06

0.19
0.23
0.18
0.14
0.06
0.08

0.16
0.20
0.18
0.13
0.04
0.07

0.14
0.20
0.16
0.15
0.05
0.09

Big Robust
Big Weak
Big Neutral
Small Robust
Small Weak
Small Neutral

0.10
0.05
0.09
0.09
-0.03
0.04

0.07
0.12
0.00
0.04
0.09
0.04

-0.07
0.05
-0.04
-0.03
0.00
-0.03

0.11
0.09
0.09
0.00
-0.03
0.00

0.18
0.12
0.20
0.00
-0.02
0.01

0.17
0.21
0.19
0.10
0.07
0.11

0.18
0.17
0.17
0.07
0.07
0.09

0.18
0.22
0.22
0.04
0.06
0.04

0.16
0.20
0.21
0.05
0.06
0.04

0.22
0.21
0.24
0.08
0.06
0.07

0.19
0.18
0.21
0.08
0.05
0.07

0.16
0.19
0.20
0.08
0.06
0.08

Big Up
Big Down
Big Medium
Small Up
Small Down
Small Medium

0.10
-0.02
-0.01
0.08
-0.14
0.05

0.05
0.09
0.04
0.13
0.04
0.11

-0.06
-0.08
-0.06
0.10
-0.05
0.07

0.10
-0.02
0.14
0.05
-0.09
0.08

0.21
0.02
0.09
0.07
-0.05
0.09

0.16
0.08
0.17
0.16
0.06
0.13

0.14
0.10
0.20
0.12
0.04
0.15

0.17
0.10
0.22
0.07
0.01
0.13

0.14
0.07
0.21
0.06
0.01
0.12

0.17
0.12
0.25
0.08
0.02
0.14

0.18
0.11
0.22
0.07
0.01
0.13

0.17
0.09
0.19
0.10
0.01
0.15

Note: Improvement in annualized Sharpe ratio (SRâˆ— âˆ’ SR). We compute the SRâˆ— by weighting the portfolios based
on a market timing strategy Campbell and Thompson (2007). Cases with Sharpe ratio deterioration are omitted.

purged of market exposure. In all cases, we create the portfolios ourselves using CRSP market equity value weights. Our portfolio construction differs slightly from the actual S&P 500 index and
the characteristic-based Fama-French portfolios (Fama and French, 1993, 2015), but has the virtue
that we can exactly track the ex ante portfolio weights of each.38
Table 5 reports the monthly out-of-sample R2 over our 30-year testing sample. Regularized linear
methods fail to outperform naive constant forecasts of the S&P 500. In contrast, all nonlinear models
have substantial positive predictive performance. The one month out-of-sample R2 is 0.71% for the
38

Our replication of S&P500 returns has a correlation with the actual index of more than 0.99. For the other
portfolios (SMB, HML, RMW, CMA, UMD), the return correlations between our replication and the version from Ken
Frenchâ€™s website are 0.99, 0.97, 0.95, 0.99, 0.96, respectively.

39

generalized linear model and reaches as high as 1.80% for the three-layer neural network. As a
benchmark for comparison, nearly all of the macroeconomic return predictor variables in the survey
of Welch and Goyal (2008) fail to produce a positive out-of-sample forecast R2 . Kelly and Pruitt
(2013) find that PLS delivers an out-of-sample forecasting R2 around 1% per month for the aggregate
market index, though their forecasts directly target the market return as opposed to being bottomup forecasts. And the most well-studied portfolio predictors, such as the aggregate price-dividend
ratio, typically produce an in-sample predictive R2 of around 1% per month (e.g., Cochrane, 2007),
smaller than what we find out-of-sample.
The patterns in S&P 500 forecasting performance across models carry over to long-only characteristicsorted portfolios (rows 2â€“25) and long-short factor portfolios (SMB, HML, RMW, CMA, and UMD).
2 for every portfolio analyzed, with NN3
Nonlinear methods excel. NN3â€“NN5 produce a positive Roos
2 for all but UMD (which is by and large the
dominating. NN1 and NN2 also produce a positive Roos
2 is positive for 22 out of 30 portfolios.
hardest strategy to forecast). The generalized linear model Roos

Linear methods, on the other hand, are on balance unreliable for bottom-up portfolio return forecasting, though their performance tends to be better for â€œbigâ€ portfolios compared to â€œsmall.â€ For
select long-short factor portfolios (e.g., SMB), constrained linear methods such as PLS perform comparatively well (consistent with the findings of Kelly and Pruitt, 2013). In short, machine learning
methods, and nonlinear methods in particular, produce unusually powerful out-of-sample portfolio
predictions.
We next assess the economic magnitudes of portfolio predictability. Campbell and Thompson
(2008) show that small improvements in R2 can map into large utility gains for a mean-variance
investor. They show that the Sharpe ratio (SRâˆ— ) earned by an active investor exploiting predictive
information (summarized as a predictive R2 ) improves over the Sharpe ratio (SR) earned by a
buy-and-hold investor according to
r
âˆ—

SR =

SR2 + R2
.
1 âˆ’ R2

2
We use this formula to translate the predictive Roos
of Table 5 (along with the full-sample Sharpe

ratio of each portfolio) into an improvement in annualized Sharpe ratio, SRâˆ— âˆ’ SR, for an investor
exploiting machine learning predictions for portfolio timing. The results are presented in appendix
Table A.7. For example, the buy-and-hold Sharpe ratio of the S&P 500, which is 0.51 in our 30-year
out-of-sample period, can be improved to 0.71 by a market-timer exploiting forecasts from the NN3
model. For characteristic-based portfolios, nonlinear machine learning methods help improve Sharpe
ratios by anywhere from a few percentage points to over 24 percentage points.
Campbell and Thompson (2008) also propose evaluating the economic magnitude of portfolio
predictability with a market timing trading strategy. We follow their out-of-sample trading strategy
exactly, scaling up/down positions each month as expected returns rise/fall, while imposing a maximum leverage constraint of 50% and excluding short sales for long-only portfolios (we do not impose
these constraints for long-short factor portfolios). Table 6 reports the annualized Sharpe ratio gains
(relative to a buy-and-hold strategy) for timing strategies based on machine learning forecasts. Con40

sistent with our other results, the strongest and most consistent trading strategies are those based on
nonlinear models, with neural networks the best overall. In the case of NN3, the Sharpe ratio from
timing the S&P 500 index 0.77, or 26 percentage points higher than a buy-and-hold position. Longshort factor portfolios are harder to time than the S&P 500 and the other 24 long-only portfolios,
and all methods fail to outperform the static UMD strategy.
As a robustness test, we also analyze bottom-up predictions for annual rather than monthly
returns. The comparative patterns in predictive performance across methods is the same in annual
and monthly data. Appendix Table A.8 demonstrates the superiority of nonlinear methods, and in
particular neural networks. NN3 continues to dominate for the market portfolio, achieving an annual
2 of 15.7%.
Roos

3.4.2

Machine Learning Portfolios

Next, rather than assessing forecast performance among pre-specified portfolios, we design a new set
of portfolios to directly exploit machine learning forecasts. At the end of each month, we calculate
one-month-ahead out-of-sample stock return predictions for each method. We then sort stocks into
deciles based on each modelâ€™s forecasts. We reconstitute portfolios each month using value weights.
Finally, we construct a zero-net-investment portfolio that buys the highest expected return stocks
(decile 10) and sells the lowest (decile 1).
Table 7 reports results. Out-of-sample portfolio performance aligns very closely with results on
machine learning forecast accuracy reported earlier. Realized returns generally increase monotonically with machine learning forecasts from every method (with occasional exceptions, such as decile
8 of NN1). Neural network models again dominate linear models and tree-based approaches. In
particular, for all but the most extreme deciles, the quantitative match between predicted returns
and average realized returns using neural networks is extraordinarily close. The best 10â€“1 strategy
comes from NN4, which returns on average 2.3% per month (27.1% on an annualized basis). Its
monthly volatility is 5.8% (20.1% annualized), amounting to an annualized out-of-sample Sharpe
ratio of 1.35.
While value-weight portfolios are less sensitive to trading cost considerations, it is perhaps more
natural to study equal weights in our analysis because our statistical objective functions minimize
equally weighted forecast errors. Appendix Table A.9 reports the performance of machine learning
portfolios using an equal-weight formation. The qualitative conclusions of this table are identical
to those of Table 7, but the Sharpe ratios are substantially higher. For example, the long-short
decile spread portfolio based on the NN4 model earns an annualized Sharpe ratio of 2.45 with equal
weighting. To identify the extent to which equal-weight results are driven by micro-cap stocks, Table
A.10 reports equal-weight portfolio results excluding stocks that fall below the 20th percentile of the
NYSE size distribution. In this case, the NN4 long-short decile spread earns a Sharpe ratio of 1.69.
As recommended by Lewellen (2015), the OLS-3 model is an especially parsimonious and robust
benchmark model. He also recommends somewhat larger OLS benchmark models with either seven
or 15 predictors, which we report in appendix Table A.11. The larger OLS models improve over

41

Table 7: Performance of Machine Learning Portfolios
OLS-3+H

PLS

PCR

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Low(L)
2
3
4
5
6
7
8
9
High(H)

-0.17
0.17
0.35
0.49
0.62
0.75
0.88
1.02
1.21
1.51

0.40
0.58
0.60
0.71
0.79
0.92
0.85
0.86
1.18
1.34

5.90
4.65
4.43
4.32
4.57
5.03
5.18
5.29
5.47
5.88

0.24
0.43
0.47
0.57
0.60
0.63
0.57
0.56
0.75
0.79

-0.83
-0.21
0.12
0.38
0.61
0.84
1.06
1.32
1.66
2.25

0.29
0.55
0.64
0.78
0.77
0.88
0.92
0.92
1.15
1.30

5.31
4.96
4.63
4.30
4.53
4.78
4.89
5.14
5.24
5.85

0.19
0.38
0.48
0.63
0.59
0.64
0.65
0.62
0.76
0.77

-0.68
-0.11
0.19
0.42
0.62
0.81
1.01
1.23
1.52
2.02

0.03
0.42
0.53
0.68
0.81
0.81
0.87
1.01
1.20
1.25

5.98
5.25
4.94
4.64
4.66
4.58
4.72
4.77
4.88
5.60

0.02
0.28
0.37
0.51
0.60
0.61
0.64
0.73
0.86
0.77

H-L

1.67

0.94

5.33

0.61

3.09

1.02

4.88

0.72

2.70

1.22

4.82

0.88

ENet+H

GLM+H

RF

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Low(L)
2
3
4
5
6
7
8
9
High(H)

-0.04
0.27
0.44
0.59
0.73
0.87
1.01
1.16
1.36
1.66

0.24
0.56
0.53
0.72
0.72
0.85
0.87
0.88
0.80
0.84

5.44
4.84
4.50
4.11
4.42
4.60
4.75
5.20
5.61
6.76

0.15
0.40
0.40
0.61
0.57
0.64
0.64
0.59
0.50
0.43

-0.47
0.01
0.29
0.50
0.68
0.84
1.00
1.18
1.40
1.81

0.08
0.49
0.65
0.72
0.70
0.84
0.86
0.87
1.04
1.14

5.65
4.80
4.52
4.59
4.55
4.53
4.82
5.18
5.44
6.33

0.05
0.35
0.50
0.55
0.53
0.65
0.62
0.58
0.66
0.62

0.29
0.44
0.53
0.60
0.67
0.73
0.80
0.87
0.96
1.12

-0.09
0.38
0.64
0.60
0.57
0.64
0.67
1.00
1.23
1.53

6.00
5.02
4.70
4.56
4.51
4.54
4.65
4.91
5.59
7.27

-0.05
0.27
0.48
0.46
0.44
0.49
0.50
0.71
0.76
0.73

H-L

1.70

0.60

5.37

0.39

2.27

1.06

4.79

0.76

0.83

1.62

5.75

0.98

GBRT+H

NN1

NN2

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Low(L)
2
3
4
5
6
7
8
9
High(H)

-0.45
-0.16
0.02
0.17
0.34
0.46
0.59
0.72
0.88
1.11

0.18
0.49
0.59
0.63
0.57
0.77
0.52
0.72
0.99
1.17

5.60
4.93
4.75
4.68
4.70
4.48
4.73
4.92
5.19
5.88

0.11
0.35
0.43
0.46
0.42
0.59
0.38
0.51
0.66
0.69

-0.38
0.16
0.44
0.64
0.80
0.95
1.11
1.31
1.58
2.19

-0.29
0.41
0.51
0.70
0.77
0.78
0.81
0.75
0.96
1.52

7.02
5.89
5.07
4.56
4.37
4.39
4.40
4.86
5.22
6.79

-0.14
0.24
0.35
0.53
0.61
0.62
0.64
0.54
0.64
0.77

-0.23
0.21
0.44
0.59
0.72
0.84
0.97
1.13
1.37
1.99

-0.54
0.36
0.65
0.73
0.81
0.84
0.95
0.93
1.04
1.38

7.83
6.08
5.07
4.53
4.38
4.51
4.61
5.09
5.69
6.98

-0.24
0.20
0.44
0.56
0.64
0.65
0.71
0.63
0.63
0.69

H-L

1.56

0.99

4.22

0.81

2.57

1.81

5.34

1.17

2.22

1.92

5.75

1.16

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Low(L)
2
3
4
5
6
7
8
9
High(H)

-0.03
0.34
0.51
0.63
0.71
0.79
0.88
1.00
1.21
1.83

-0.43
0.30
0.57
0.66
0.69
0.76
0.99
1.09
1.25
1.69

7.73
6.38
5.27
4.69
4.41
4.46
4.77
5.47
5.94
7.29

-0.19
0.16
0.37
0.49
0.55
0.59
0.72
0.69
0.73
0.80

-0.12
0.30
0.50
0.62
0.72
0.81
0.90
1.03
1.23
1.89

-0.52
0.33
0.42
0.60
0.69
0.84
0.93
1.08
1.26
1.75

7.69
6.16
5.18
4.51
4.26
4.46
4.56
5.13
5.93
7.51

-0.23
0.19
0.28
0.46
0.56
0.65
0.70
0.73
0.74
0.81

-0.23
0.23
0.45
0.60
0.73
0.85
0.96
1.11
1.34
1.99

-0.51
0.31
0.54
0.67
0.77
0.86
0.88
0.94
1.02
1.46

7.69
6.10
5.02
4.47
4.32
4.35
4.76
5.17
6.02
7.40

-0.23
0.17
0.37
0.52
0.62
0.68
0.64
0.63
0.58
0.68

H-L

1.86

2.12

6.13

1.20

2.01

2.26

5.80

1.35

2.22

1.97

5.93

1.15

NN3

NN4

NN5

Note: In this table, we report the performance of prediction-sorted portfolios over the 30-year out-of-sample testing
period. All stocks are sorted into deciles based on their predicted returns for the next month. Column â€œPredâ€, â€œAvgâ€,
â€œStdâ€, and â€œSRâ€ provide the predicted monthly returns for each decile, the average realized monthly returns, their
standard deviations, and Sharpe ratios, respectively. All portfolios are value weighted.

42

Table 8: Drawdowns, Turnover, and Risk-adjusted Performance of Machine Learning Portfolios
OLS-3
+H

PLS

PCR

Max DD(%)
Max 1M Loss(%)
Turnover(%)

69.60
24.72
58.20

41.13
27.40
110.87

42.17
18.38
125.86

Max DD(%)
Max 1M Loss(%)
Turnover(%)

84.74
37.94
57.24

32.35
32.35
104.47

Mean Ret.
FF5+Mom Î±
t-stats
R2
IR

0.94
0.39
2.76
78.60
0.54

Mean Ret.
FF5+Mom Î±
t(Î±)
R2
IR

1.34
0.83
6.64
84.26
1.30

ENet
+H

GLM
+H

RF

GBRT
+H

NN1

NN2

NN3

NN4

NN5

Drawdowns and Turnover (Value Weighted)
60.71
37.09
52.27
48.75
61.60
55.29
27.40
15.61
26.21
21.83
18.59
37.02
151.59 145.26 133.87 143.53 121.02 122.46

30.84
30.84
123.50

51.78
33.03
126.81

57.52
38.95
125.37

31.39
22.33
118.07

Drawdowns and Turnover (Equally Weighted)
33.70
21.01
46.42
37.19
18.25
25.81
32.35
15.74
34.63
22.34
12.79
25.81
142.78 137.97 120.29 134.24 112.35 112.43

17.34
12.50
113.76

14.72
9.01
114.17

21.78
21.78
114.34

1.02
0.24
1.09
34.95
0.21

1.22
0.62
2.89
39.11
0.57

Risk-adjusted
0.60
1.06
-0.23
0.38
-0.89
1.68
28.04
30.78
-0.17
0.33

Performance (Value Weighted)
1.62
0.99
1.81
1.92
1.20
0.66
1.20
1.33
3.95
3.11
4.68
4.74
13.43
20.68
27.67
25.81
0.77
0.61
0.92
0.93

1.97
1.52
4.92
20.84
0.96

2.26
1.76
6.00
20.47
1.18

2.12
1.43
4.71
18.23
0.92

2.08
1.40
5.90
26.27
1.15

2.45
1.95
9.92
40.50
1.94

Risk-adjusted Performance (Equally Weighted)
2.11
2.31
2.38
2.14
2.91
3.31
1.32
1.79
1.88
1.87
2.60
3.07
4.77
8.09
6.66
8.19
10.51
11.66
20.89
21.25
19.91
11.19
13.98
10.60
0.93
1.58
1.30
1.60
2.06
2.28

3.27
3.02
11.70
9.63
2.29

3.33
3.08
12.28
11.57
2.40

3.09
2.78
10.68
14.54
2.09

Note: The top two panels report a value-weight and equal-weight portfolio maximum drawdown (â€œMax DDâ€), most
extreme negative monthly return (â€œMax 1M Lossâ€), and average monthly percentage change in holdings (â€œTurnoverâ€).
The bottom panel report average monthly returns in percent as well as alphas, information ratios (IR), and R2 with
respect to the Fama-French five-factor model augmented to include the momentum factor.

OLS-3, but are nonetheless handily outperformed by tree-based models and neural networks.
The top panel of Table 8 reports drawdowns, portfolio turnover, and risk-adjusted performance
of 10â€“1 spread portfolios from each machine learning model, for both value and equally weighted
strategies. We define maximum drawdown of a strategy as
MaxDD =

max

0â‰¤t1 â‰¤t2 â‰¤T

(Yt1 âˆ’ Yt2 )

where Yt is the cumulative log return from date 0 through t.
Not only do neural network portfolios have higher Sharpe ratios than alternatives, they also have
comparatively small drawdowns, particularly for equal-weight portfolios. The maximum drawdown
experienced for the NN4 strategy is 51.8% and 14.7% for value and equal weights, respectively. In
contrast, the maximum drawdown for OLS-3 are 69.6% and 84.7%, respectively. Equal-weight neural
network strategies also experience the most mild one-month losses. For example, for NN4, the worst
one-month performance is a âˆ’9.01% return, which is the least extreme monthly loss among all models
with either weighting scheme.

43

We define the strategyâ€™s average monthly turnover as
T
wi,t (1 + ri,t+1 )
1X X
Turnover =
wi,t+1 âˆ’ P
T
j wj,t (1 + rj,t+1 )
t=1

!
,

i

where wi,t is the weight of stock i in the portfolio at time t. For NN1 through NN5, turnover is
consistently between 110% and 130% per month, and turnover for tree-based methods and penalized
regression is slightly higher. As a frame of reference, the monthly turnover of a short-term reversal
decile spread is 172.6% per month while for a size decile spread it is 22.9%. Given the large role of
price trend predictors selected by all machine learning approaches, it is perhaps unsurprising that
their outperformance is accomplished with comparatively high portfolio turnover.
The bottom panel of Table 8 reports risk-adjusted performance of machine learning portfolios
based on factor pricing models. In a linear factor model, the tangency portfolio of the factors
themselves represents the maximum Sharpe ratio portfolio in the economy. Any portfolio with a
higher Sharpe ratio than the factor tangency portfolio possesses alpha with respect to the model.
From prior work, the out-of-sample factor tangency portfolios of the Fama-French three and fivefactor models have Sharpe ratios of roughly 0.8 and 1.3, respectively (Kelly et al., 2019). It is
unsurprising then that portfolios formed on the basis of machine learning forecasts earn large and
significant alphas versus these models. A six-factor model (that appends a momentum factor to
the Fama-French five-factor model) explains as much as 40% of the average return for strategies
based on linear models, but explains only about 10% to 30% of variation in neural network-based
portfolios. As a result, neural networks have information ratios ranging from 0.9 to 2.4 depending
on the number of layers and the portfolio weighting scheme. Test statistics for the associated alphas
are highly significant for both tree models and all neural network models.
The results of Table 8 are visually summarized in Figure 9, which reports cumulative performance
for the long and short sides for select strategies, along with the cumulative market excess return as
a benchmark. NN4 dominates the other models by a large margin in both directions. Interestingly,
the short side of all portfolios is essentially flat in the post-2000 sample.39
Finally, we consider two meta-strategies that combine forecasts of all machine learning portfolios.
The first is a simple equally weighted average of decile long-short portfolios from our 11 machine
learning methods. This achieves a stock-level predictive R2 of 0.43% per month and an equally
weighted decile spread Sharpe ratio of 2.49, both of which are higher than any single method on its
own. The value weighted decile spread Sharpe ratio is 1.33, which is slightly lower than that for the
NN4 model.
The second meta-strategy rotates among machine learning methods by selecting the best machine
learning model for each one-year test sample based on the predictive R2 during the corresponding validation sample. Over our 30-year out-of-sample period, this method selects NN3 11 times, NN1 seven
times, GBRT six times, NN2 five times, and NN4 one time. This method delivers the highest overall
panel R2 (0.45%), but underperforms the standalone NN4 model in terms of decile spread Sharpe
39

The corresponding plot of cumulative returns for equal-weight strategies is shown in appendix Figure A.7.

44

Figure 9: Cumulative Return of Machine Learning Portfolios
OLS-3+H

6

PLS

PCR

ENet+H

GLM+H

RF

GBRT+H

NN4

SP500-Rf

solid = long

dash = short

2008

2011

2014

5

Long Position

4
3
2
1

Short Position

0
1
2
3

4
1987

1990

1993

1996

1999

2002

2005

2016

Note: Cumulative log returns of portfolios sorted on out-of-sample machine learning return forecasts. The solid and
dash lines represent long (top decile) and short (bottom decile) positions, respectively. The shaded periods show NBER
recession dates. All portfolios are value weighted.

ratio (2.42 and 1.23 with equal and value weights, respectively). Interestingly, the meta-strategyâ€™s
predictive R2 gain is statistically insignificant relative to the best standalone neural network models.

4

Conclusion

Using the empirical context of return prediction as a proving ground, we perform a comparative
analysis of methods in the machine learning repertoire. At the highest level, our findings demonstrate
that machine learning methods can help improve our empirical understanding of asset prices. Neural
networks and, to a lesser extent, regression trees, are the best performing methods. We track down
the source of their predictive advantage to accommodation of nonlinear interactions that are missed
by other methods. We also find that â€œshallowâ€ learning outperforms â€œdeepâ€ learning, which differs
from the typical conclusion in other fields such as computer vision or bioinformatics, and is likely due
to the comparative dearth of data and low signal-to-noise ratio in asset pricing problems. Machine
learning methods are most valuable for forecasting larger and more liquid stock returns and portfolios.
Lastly, we find that all methods agree on a fairly small set of dominant predictive signals, the most
powerful predictors being associated with price trends including return reversal and momentum. The
next most powerful predictors are measures of stock liquidity, stock volatility, and valuation ratios.
The overall success of machine learning algorithms for return prediction brings promise for both
economic modeling and for practical aspects of portfolio choice. With better measurement through
machine learning, risk premia are less shrouded in approximation and estimation error, thus the
challenge of identifying reliable economic mechanisms behind asset pricing phenomena becomes less
45

steep. Finally, our findings help justify the growing role of machine learning throughout the architecture of the burgeoning fintech industry.

References
Bach, Francis R., 2008, Consistency of the group lasso and multiple kernel learning, Journal of
Machine Learning Research 9, 1179â€“1225.
Bai, Jushan, and Serena Ng, 2002, Determining the number of factors in approximate factor models,
Econometrica 70, 191â€“221.
Bai, Jushan, and Serena Ng, 2013, Principal components estimation and identification of static
factors, Journal of Econometrics 176, 18â€“29.
Bai, Zhidong, 1999, Methodologies in spectral analysis of large dimensional random matrices: A
review, Statistica Sinica 9, 611â€“677.
Biau, GeÌrard, 2012, Analysis of a random forests model, Journal of Machine Learning Research 13,
1063â€“1095.
Bickel, Peter J, Yaâ€™acov Ritov, and Alexandre B Tsybakov, 2009, Simultaneous analysis of Lasso
and Dantzig selector, Annals of Statistics 37, 1705â€“1732.
Bishop, Christopher M., 1995, Neural Networks for Pattern Recognition (Oxford University Press).
Box, G. E. P., 1953, Non-normality and tests on variances, Biometrika 40, 318â€“335.
Breiman, Leo, 2001, Random forests, Machine learning 45, 5â€“32.
Breiman, Leo, Jerome Friedman, Charles J Stone, and Richard A Olshen, 1984, Classification and
regression trees (CRC press).
BuÌˆhlmann, Peter, and Torsten Hothorn, 2007, Boosting Algorithms: Regularization, Prediction and
Model Fitting, Statistical Science 22, 477â€“505.
BuÌˆhlmann, Peter, and Bin Yu, 2003, Boosting with the l2 loss, Journal of the American Statistical
Association 98, 324â€“339.
Butaru, Florentin, Qingqing Chen, Brian Clark, Sanmay Das, Andrew W Lo, and Akhtar Siddique,
2016, Risk and risk management in the credit card industry, Journal of Banking & Finance 72,
218â€“239.
Campbell, John Y., and S. B. Thompson, 2008, Predicting excess stock returns out of sample: Can
anyting beat the historical average?, Review of Financial Studies 21, 1509â€“1531.
Campbell, John Y, and Samuel B Thompson, 2007, Predicting excess stock returns out of sample:
Can anything beat the historical average?, The Review of Financial Studies 21, 1509â€“1531.
Chen, Tianqi, and Carlos Guestrin, 2016, Xgboost: A scalable tree boosting system, in Proceedings
of the 22Nd ACM SIGKDD International Conference on Knowledge Discovery and Data Mining,
KDD â€™16, 785â€“794 (ACM, New York, NY, USA).

46

Chizat, LeÌnaÄ±Ìˆc, and Francis Bach, 2018, On the global convergence of gradient descent for overparameterized models using optimal transport, in Proceedings of the 32Nd International Conference on Neural Information Processing Systems, NIPSâ€™18, 3040â€“3050 (Curran Associates Inc.,
USA).
Cochrane, John H, 2007, The dog that did not bark: A defense of return predictability, The Review
of Financial Studies 21, 1533â€“1575.
Cybenko, George, 1989, Approximation by superpositions of a sigmoidal function, Mathematics of
control, signals and systems 2, 303â€“314.
Daubechies, I, M Defrise, and C De Mol, 2004, An iterative thresholding algorithm for linear inverse
problems with a sparsity constraint, Communications on Pure and Applied Mathematics 57, 1413â€“
1457.
de Jong, Sijmen, 1993, Simpls: An alternative approach to partial least squares regression, Chemometrics and Intelligent Laboratory Systems 18, 251 â€“ 263.
Diebold, Francis X., 2015, Comparing predictive accuracy, twenty years later: A personal perspective
on the use and abuse of diebold-mariano tests, Journal of Business & Economic Statistics 33, 1â€“9.
Diebold, Francis X., and Roberto S. Mariano, 1995, Comparing predictive accuracy, Journal of
Business & Economic Statistics 13, 134â€“144.
Dietterich, Thomas G, 2000, Ensemble methods in machine learning, in International workshop on
multiple classifier systems, 1â€“15, Springer.
Dimopoulos, Yannis, Paul Bourret, and Sovan Lek, 1995, Use of some sensitivity criteria for choosing
networks with good generalization ability, Neural Processing Letters 2, 1â€“4.
Eldan, Ronen, and Ohad Shamir, 2016, The power of depth for feedforward neural networks, in
Vitaly Feldman, Alexander Rakhlin, and Ohad Shamir, eds., 29th Annual Conference on Learning
Theory, volume 49 of Proceedings of Machine Learning Research, 907â€“940 (PMLR, Columbia
University, New York, New York, USA).
Fama, Eugene F, and Kenneth R French, 1993, Common risk factors in the returns on stocks and
bonds, Journal of financial economics 33, 3â€“56.
Fama, Eugene F, and Kenneth R French, 2008, Dissecting anomalies, The Journal of Finance 63,
1653â€“1678.
Fama, Eugene F., and Kenneth R. French, 2015, A five-factor asset pricing model, Journal of Financial Economics 116, 1â€“22.
Fan, Jianqing, Quefeng Li, and Yuyan Wang, 2017, Estimation of high dimensional mean regression
in the absence of symmetry and light tail assumptions, Journal of the Royal Statistical Society, B
79, 247â€“265.
Fan, Jianqing, Cong Ma, and Yiqiao Zhong, 2019, A selective overview of deep learning, Technical
report, Princeton University.
Feng, Guanhao, Stefano Giglio, and Dacheng Xiu, 2019, Taming the factor zoo: A test of new factors,
Journal of Finance, forthcoming .

47

Freund, Yoav, 1995, Boosting a weak learning algorithm by majority, Information and Computation
121, 256â€“285.
Freyberger, Joachim, Andreas Neuhierl, and Michael Weber, 2019, Dissecting characteristics nonparametrically, Review of Financial Studies, forthcoming .
Friedman, Jerome, Trevor Hastie, Holger HoÌˆfling, Robert Tibshirani, et al., 2007, Pathwise coordinate optimization, The Annals of Applied Statistics 1, 302â€“332.
Friedman, Jerome, Trevor Hastie, and Robert Tibshirani, 2000a, Additive logistic regression: A
statistical view of boosting, Annals of Statistics 28, 337â€“374.
Friedman, Jerome, Trevor Hastie, and Robert Tibshirani, 2000b, Additive logistic regression: a
statistical view of boosting (with discussion and a rejoinder by the authors), Annals of Statistics
28, 337â€“407.
Friedman, Jerome H, 2001, Greedy function approximation: a gradient boosting machine, Annals of
statistics 1189â€“1232.
Giglio, Stefano W, and Dacheng Xiu, 2016, Asset pricing with omitted factors, Technical report,
University of Chicago.
Glorot, Xavier, Antoine Bordes, and Yoshua Bengio, 2011, Deep sparse rectifier neural networks., in
Aistats, volume 15, 315â€“323.
Goodfellow, Ian, Yoshua Bengio, and Aaron Courville, 2016, Deep Learning (MIT Press), http:
//www.deeplearningbook.org.
Green, Jeremiah, John RM Hand, and X Frank Zhang, 2013, The supraview of return predictive
signals, Review of Accounting Studies 18, 692â€“730.
Green, Jeremiah, John RM Hand, and X Frank Zhang, 2017, The characteristics that provide independent information about average us monthly stock returns, The Review of Financial Studies
30, 4389â€“4436.
Gu, Shihao, Bryan T Kelly, and Dacheng Xiu, 2019, Autoencoder asset pricing models, Available at
SSRN .
Hansen, Lars Kai, and Peter Salamon, 1990, Neural network ensembles, IEEE transactions on pattern
analysis and machine intelligence 12, 993â€“1001.
Harvey, Campbell R., and Wayne E. Ferson, 1999, Conditioning variables and the cross-section of
stock returns, Journal of Finance 54, 1325â€“1360.
Harvey, Campbell R, and Yan Liu, 2016, Lucky factors, Technical report, Duke University.
Harvey, Campbell R, Yan Liu, and Heqing Zhu, 2016, ... and the cross-section of expected returns,
Review of Financial Studies 29, 5â€“68.
Hastie, Trevor, Robert Tibshirani, and Jerome Friedman, 2009, The Elements of Statistical Learning
(Springer).
He, Kaiming, Xiangyu Zhang, Shaoqing Ren, and Jian Sun, 2016a, Deep residual learning for image
recognition, in 2016 IEEE Conference on Computer Vision and Pattern Recognition, CVPR 2016,
Las Vegas, NV, USA, June 27-30, 2016 , 770â€“778.
48

He, Kaiming, Xiangyu Zhang, Shaoqing Ren, and Jian Sun, 2016b, Deep residual learning for image
recognition, in The IEEE Conference on Computer Vision and Pattern Recognition (CVPR).
Heaton, JB, NG Polson, and JH Witte, 2016, Deep learning in finance, arXiv preprint
arXiv:1602.06561 .
Hinton, Geoffrey E., Simon Osindero, and Yee-Whye Teh, 2006, A fast learning algorithm for deep
belief nets, Neural Comput. 18, 1527â€“1554.
Hornik, Kurt, Maxwell Stinchcombe, and Halbert White, 1989, Multilayer feedforward networks are
universal approximators, Neural networks 2, 359â€“366.
Huber, P. J., 1964, Robust estimation of a location parameter, Annals of Mathematical Statistics 35,
73â€“101.
Hutchinson, James M, Andrew W Lo, and Tomaso Poggio, 1994, A nonparametric approach to
pricing and hedging derivative securities via learning networks, The Journal of Finance 49, 851â€“
889.
Ioffe, Sergey, and Christian Szegedy, 2015, Batch Normalization: Accelerating Deep Network Training by Reducing Internal Covariate Shift, International Conference on Machine Learning 448â€“456.
Jaggi, Martin, 2013, An equivalence between the lasso and support vector machines, Regularization,
optimization, kernels, and support vector machines 1â€“26.
Jarrett, Kevin, Koray Kavukcuoglu, Yann Lecun, et al., 2009, What is the best multi-stage architecture for object recognition?, in 2009 IEEE 12th International Conference on Computer Vision,
2146â€“2153, IEEE.
Johnstone, Iain M., 2001, On the distribution of the largest eigenvalue in principal components
analysis, Annals of Statistics 29, 295â€“327.
Johnstone, Iain M., and Arthur Yu Lu, 2009, On consistency and sparsity for principal components
analysis in high dimensions, Journal of the American Statistical Association 104, 682â€“693.
Kelly, Bryan, and Seth Pruitt, 2013, Market expectations in the cross-section of present values, The
Journal of Finance 68, 1721â€“1756.
Kelly, Bryan, and Seth Pruitt, 2015, The three-pass regression filter: A new approach to forecasting
using many predictors, Journal of Econometrics 186, 294â€“316.
Kelly, Bryan, Seth Pruitt, and Yinan Su, 2019, Some characteristics are risk exposures, and the rest
are irrelevant, Journal of Financial Economics, forthcoming .
Khandani, Amir E, Adlar J Kim, and Andrew W Lo, 2010, Consumer credit-risk models via machinelearning algorithms, Journal of Banking & Finance 34, 2767â€“2787.
Kingma, Diederik, and Jimmy Ba, 2014, Adam: A method for stochastic optimization, arXiv preprint
arXiv:1412.6980 .
Knight, Keith, and Wenjiang Fu, 2000, Asymptotics for lasso-type estimators, Annals of Statistics
28, 1356â€“1378.
Koijen, Ralph, and Stijn Van Nieuwerburgh, 2011, Predictability of returns and cash flows, Annual
Review of Financial Economics 3, 467â€“491.
49

Kozak, Serhiy, 2019, Kernel trick for the cross section, Available at SSRN 3307895 .
Kozak, Serhiy, Stefan Nagel, and Shrihari Santosh, 2019, Shrinking the cross section, Journal of
Financial Economics, forthcoming .
Lewellen, Jonathan, 2015, The cross-section of expected stock returns, Critical Finance Review 4,
1â€“44.
Lin, Henry W., Max Tegmark, and David Rolnick, 2017, Why does deep and cheap learning work so
well?, Journal of Statistical Physics 168, 1223â€“1247.
Lo, Andrew W, and A Craig MacKinlay, 1990, Data-snooping biases in tests of financial asset pricing
models, Review of financial studies 3, 431â€“467.
Lounici, Karim, Massimiliano Pontil, Sara van de Geer, and Alexandre B. Tsybakov, 2011, Oracle
inequalities and optimal inference under group sparsity, Annals of Statistics 39, 2164â€“2204.
Lugosi, GaÌbor, and Nicolas Vayatis, 2004, On the bayes-risk consistency of regularized boosting
methods, Annals of Statistics 32, 30â€“55.
Masters, Timothy, 1993, Practical Neural Network Recipes in C++ (Academic Press).
Mei, Song, Theodor Misiakiewicz, and Andrea Montanari, 2019, Mean-field theory of two-layers neural networks: dimension-free bounds and kernel limit, in Conference on Learning Theory (COLT).
Mei, Song, Andrea Montanari, and Phan-Minh Nguyen, 2018, A mean field view of the landscape of
two-layer neural networks, Proceedings of the National Academy of Sciences 115, E7665â€“E7671.
Meinshausen, Nicolai, and Bin Yu, 2009, Lasso-type recovery of sparse representations for highdimensional data, Annals of Statistics 37, 246â€“270.
Mentch, Lucas, and Giles Hooker, 2016, Quantifying uncertainty in random forests via confidence
intervals and hypothesis tests, Journal of Machine Learning Research 17, 1â€“41.
Mol, Christine De, Ernesto De Vito, and Lorenzo Rosasco, 2009, Elastic-net regularization in learning
theory, Journal of Complexity 25, 201 â€“ 230.
Moritz, Benjamin, and Tom Zimmermann, 2016, Tree-based conditional portfolio sorts: The relation
between past and future stock returns, Available at SSRN 2740751 .
Nair, Vinod, and Geoffrey E Hinton, 2010, Rectified linear units improve restricted boltzmann machines, in Proceedings of the 27th International Conference on Machine Learning (ICML-10),
807â€“814.
Nesterov, Yurii, 1983, A method of solving a convex programming problem with convergence rate
o(1/k 2 ), Soviet Mathematics Doklady 27, 372â€“376.
Parikh, Neal, and Stephen Boyd, 2013, Proximal algorithms, Foundations and Trends in Optimization
1, 123â€“231.
Paul, Debashis, 2007, Asymptotics of sample eigenstructure for a large dimensional spiked covariance
model, Statistical Sinica 17, 1617â€“1642.
Polson, Nicholas G., James Scott, and Brandon T. Willard, 2015, Proximal algorithms in statistics
and machine learning, Statistical Science 30, 559â€“581.
50

Rapach, David, and Guofu Zhou, 2013, Forecasting stock returns. vol. 2 of handbook of economic
forecasting, 328 383.
Rapach, David E, Jack K Strauss, and Guofu Zhou, 2013, International stock return predictability:
what is the role of the united states?, The Journal of Finance 68, 1633â€“1662.
Ravikumar, Pradeep, John Lafferty, Han Liu, and Larry Wasserman, 2009, Sparse additive models,
Journal of the Royal Statistical Society. Series B (Statistical Methodology) 71, 1009â€“1030.
Rolnick, David, and Max Tegmark, 2018, The power of deeper networks for expressing natural
functions, in ICLR.
Rosenberg, Barr, 1974, Extra-market components of covariance in security returns, Journal of Financial and Quantitative Analysis 9, 263â€“274.
Schapire, Robert E., 1990, The strength of weak learnability, Machine Learning 5, 197â€“227.
Scornet, Erwan, GeÌrard Biau, and Jean-Philippe Vert, 2015, Consistency of random forests, Annals
of Statistics 43, 1716â€“1741.
Sirignano, Justin, Apaar Sadhwani, and Kay Giesecke, 2016, Deep learning for mortgage risk, Available at SSRN 2799443 .
Stock, James H., and Mark W. Watson, 2002, Forecasting using principal components from a large
number of predictors, Journal of American Statistical Association 97, 1167â€“1179.
Tibshirani, Robert, 2011, Regression shrinkage and selection via the lasso: a retrospective, Journal
of the Royal Statistical Society: Series B (Statistical Methodology) 73, 273â€“282.
Tukey, J. W., 1960, A survey of sampling from contaminated distributions, in I. Olkin, S. G. Ghurye,
W. Hoeffding, W. G. Madow, and H. B. Mann, eds., Contributions to probability and statistics:
Essays in Honor of Harold Hotelling (Stanford University Press).
Wager, Stefan, and Susan Athey, 2018, Estimation and inference of heterogeneous treatment effects
using random forests, Journal of the American Statistical Association 113, 1228â€“1242.
Wager, Stefan, Trevor Hastie, and Bradley Efron, 2014, Confidence intervals for random forests: The
jackknife and the infinitesimal jackknife, Journal of Machine Learning Research 15, 1625â€“1651.
Wainwright, Martin J., 2009, Sharp thresholds for high-dimensional and noisy sparsity recovery
using l1 -constrained quadratic programming (lasso), IEEE Transactions on Information Theory
55, 2183â€“2202.
Wang, Weichen, and Jianqing Fan, 2017, Asymptotics of empirical eigenstructure for high dimensional spiked covariance, Annals of Statistics 45, 1342â€“1374.
Welch, Ivo, and Amit Goyal, 2008, A Comprehensive Look at The Empirical Performance of Equity
Premium Prediction, Review of Financial Studies 21, 1455â€“1508.
West, Kenneth D., 2006, Forecast evaluation, in Graham Elliott, Cliver Granger, and Allan Timmermann, eds., Handbook of Economic Forecasting, volume 1, 99â€“134 (Elsevier).
White, Halbert, 1980, Using least squares to approximate unknown regression functions, International Economic Review 149â€“170.
51

Wilson, D. Randall, and Tony R. Martinez, 2003, The general inefficiency of batch training for
gradient descent learning, Neural networks 16, 1429â€“1451.
Yao, Jingtao, Yili Li, and Chew Lim Tan, 2000, Option price forecasting using neural networks,
Omega 28, 455â€“466.
Zhang, Cun-Hui, and Jian Huang, 2008, The sparsity and bias of the lasso selection in highdimensional linear regression, Annals of Statistics 36, 1567â€“1594.
Zhang, Tong, and Bin Yu, 2005, Boosting with early stopping: Convergence and consistency, Annals
of Statistics 33, 1538â€“1579.
Zou, Hui, and Trevor Hastie, 2005, Regularization and variable selection via the elastic net, Journal
of the Royal Statistical Society. Series B (Statistical Methodology) 67, 301â€“320.
Zou, Hui, and Hao Helen Zhang, 2009, On the adaptive elastic-net with a diverging number of
parameters, Annals of Statistics 37, 1733â€“1751.

52

Internet Appendix
A

Monte Carlo Simulations

To demonstrate the finite sample performance of all machine learning procedures, we simulate a
(latent) 3â€“factor model for excess returns rt+1 , for t = 1, 2, . . . , T :
ri,t+1 = g ? (zi,t ) + ei,t+1 ,

ei,t+1 = Î² i,t vt+1 + Îµi,t+1 ,

zi,t = (1, xt )0 âŠ— ci,t ,

Î² i,t = (ci1,t , ci2,t , ci3,t ),

where ct is an N Ã— Pc matrix of characteristics, vt+1 is a 3 Ã— 1 vector of factors, xt is a univariate
time series, and Îµt+1 is a N Ã— 1 vector of idiosyncratic errors. We choose vt+1 âˆ¼ N (0, 0.052 Ã— I3 ),
and Îµi,t+1 âˆ¼ t5 (0, 0.052 ), in which their variances are calibrated so that the average time series R2 is
40% and the average annualized volatility is 30%.
We simulate the panel of characteristics for each 1 â‰¤ i â‰¤ N and each 1 â‰¤ j â‰¤ Pc from the
following model:
cij,t =

2
CSrank(cÌ„ij,t ) âˆ’ 1,
N +1

cÌ„ij,t = Ïj cÌ„ij,tâˆ’1 + ij,t ,

(A.1)

where Ïj âˆ¼ U[0.9, 1], ij,t âˆ¼ N (0, 1 âˆ’ Ï2j ) and CSrank is Cross-Section rank function, so that the
characteristics feature some degree of persistence over time, yet is cross-sectionally normalized to be
within [âˆ’1, 1]. This matches our data cleaning procedure in the empirical study.
In addition, we simulate the time series xt from the following model:
xt = Ïxtâˆ’1 + ut ,

(A.2)

where ut âˆ¼ N (0, 1 âˆ’ Ï2 ), and Ï = 0.95 so that xt is highly persistent.
We consider two cases of g ? (Â·) functions:
where Î¸0 = (0.02, 0.02, 0.02)0 ;

(b) g ? (zi,t ) = c2i1,t , ci1,t Ã— ci2,t , sgn(ci3,t Ã— xt ) Î¸0 , where Î¸0 = (0.04, 0.03, 0.012)0 .

(a) g ? (zi,t ) =(ci1,t , ci2,t , ci3,t Ã— xt )Î¸0 ,

In both cases, g ? (Â·) only depends on 3 covariates, so there are only 3 non-zero entries in Î¸, denoted
as Î¸0 . Case (a) is simple and sparse linear model. Case (b) involves a nonlinear covariate c2i1,t , a
nonlinear and interaction term ci1,t Ã— ci2,t , and a discrete variable sgn(ci3,t Ã— xt ). We calibrate the
values of Î¸0 such that the cross-sectional R2 is 50%, and the predictive R2 is 5%.
Throughout, we fix N = 200, T = 180, and Px = 2, while comparing the cases of Pc = 100 and
Pc = 50, corresponding to P = 200 and 100, respectively, to demonstrate the effect of increasing
dimensionality.
For each Monte Carlo sample, we divide the whole time series into 3 consecutive subsamples of
equal length for training, validation, and testing, respectively. Specifically, we estimate each of the
two models in the training sample, using PLS, PCR, Ridge, Lasso, Elastic Net (ENet), generalized
53

Table A.1: Comparison of Predictive R2 s for Machine Learning Algorithms in Simulations
Model

(a)

Parameter
R2 (%)
OLS
OLS+H
PCR
PLS
Lasso
Lasso+H
Ridge
Ridge+H
ENet
ENet+H
GLM
GLM+H
RF
GBRT
GBRT+H
NN1
NN2
NN3
NN4
NN5
Oracle

(b)

Pc = 50

Pc = 100

Pc = 50

Pc = 100

IS

OOS

IS

OOS

IS

OOS

IS

OOS

7.50
7.48
2.69
6.24
6.04
6.00
6.46
6.42
6.04
6.00
5.91
5.85
8.34
7.08
7.16
6.53
6.55
6.47
6.47
6.41
6.22

1.14
1.25
0.90
3.48
4.26
4.26
3.89
3.91
4.26
4.26
4.11
4.12
3.35
3.35
3.45
4.37
4.42
4.34
4.31
4.27
5.52

8.19
8.16
1.70
6.19
6.08
6.03
6.67
6.61
6.08
6.03
5.94
5.88
8.23
7.02
7.11
6.72
6.72
6.67
6.66
6.55
6.22

-1.35
-1.15
0.43
2.82
4.25
4.25
3.39
3.42
4.25
4.25
4.08
4.09
3.30
3.33
3.37
4.28
4.26
4.27
4.24
4.14
5.52

3.44
3.43
0.65
1.02
1.36
1.32
1.66
1.63
1.35
1.32
3.38
3.32
8.05
6.51
6.47
5.61
6.22
6.03
5.94
5.81
5.86

-4.72
-4.60
0.02
-0.08
0.58
0.59
0.34
0.35
0.58
0.59
1.22
1.24
3.07
2.76
3.12
2.78
3.13
2.96
2.81
2.72
5.40

4.39
4.36
0.41
0.99
1.36
1.31
1.76
1.73
1.35
1.31
3.31
3.24
8.22
6.42
6.37
5.80
6.33
6.09
6.04
5.70
5.86

-7.75
-7.54
-0.01
-0.17
0.61
0.61
0.23
0.25
0.61
0.61
1.17
1.20
3.02
2.84
3.22
2.59
2.91
2.68
2.51
2.20
5.40

Note: In this table, we report the average in-sample (IS) and out-of-sample (OOS) R2 for models (a) and (b) using Ridge,
Lasso, Elastic Net (ENet), generalized linear model with group lasso (GLM), random forest (RF), gradient boosted
regression trees (GBRT), and five architectures of neural networks (NN1,...,NN5), respectively. â€œ+Hâ€ indicates the use
of Huber loss instead of the l2 loss. â€œOracleâ€ stands for using the true covariates in a pooled-OLS regression. We fix
N = 200, T = 180, and Px = 2, comparing Pc = 100 with Pc = 50. The number of Monte Carlo repetitions is 100.

linear model with group lasso (GLM), random forest (RF), gradient boosted regression trees (GBRT),
and the same five architectures of neural networks (NN1,...,NN5) we adopt for the empirical work,
respectively, then choose tuning parameters for each method in the validation sample, and calculate
the prediction errors in the testing sample. For benchmark, we also compare the pooled OLS with
all covariates and that using the oracle model.
We report the average R2 s both in-sample (IS) and out-of-sample (OOS) for each model and
each method over 100 Monte Carlo repetitions in Table A.1. Both IS and OOS R2 are relative
to the estimator based on the IS average. For model (a), Lasso, ENet and NNs deliver the best
and almost identical out-of-sample R2 . This is not surprising given that the true model is sparse
and linear in the input covariates. The advanced tree methods such as RF and GBRT tend to
overfit, so their performance is slightly worse. By contrast, for model (b), these methods clearly
dominate Lasso and ENet, because the latter cannot capture the nonlinearity in the model. GLM
is slightly better, but is dominated by NNs, RF, and GBRT. OLS is the worst in all settings, not
surprisingly. PLS outperforms PCR in the linear model (a), but is dominated in the nonlinear case.
When Pc increases, the IS R2 tends to increase whereas the out-of-sample R2 decreases. Hence,
the performance of all methods deteriorates as overfitting exacerbates. Using Huber loss improves
54

Table A.2: Comparison of Predictive R2 s for Alternative Prediction Horizons in Simulations
Model

(a)

Horizon

Quarter

R2 (%)
OLS
OLS+H
PCR
PLS
Lasso
Lasso+H
Ridge
Ridge+H
ENet
ENet+H
GLM
GLM+H
RF
GBRT
GBRT+H
NN1
NN2
NN3
NN4
NN5
Oracle

(b)

Halfyear

Annual

Quarter

Halfyear

Annual

IS

OOS

IS

OOS

IS

OOS

IS

OOS

IS

OOS

IS

OOS

18.84
18.82
3.86
15.12
14.10
14.01
15.76
15.68
14.08
13.99
13.90
13.79
17.56
15.98
15.70
15.68
15.56
15.45
15.49
15.19
14.37

-0.90
-0.76
0.91
6.56
10.33
10.32
7.81
7.84
10.33
10.32
9.40
9.42
8.11
8.94
8.78
9.99
9.96
9.98
9.91
9.82
12.72

27.67
27.66
5.50
21.52
20.42
20.30
23.26
23.15
20.49
20.37
21.02
20.88
25.24
22.68
22.84
23.04
22.72
22.66
22.32
22.14
20.73

0.19
0.31
1.32
8.40
14.68
14.67
10.67
10.69
14.69
14.68
13.53
13.56
11.86
13.27
13.45
14.07
14.00
13.94
14.06
13.85
18.15

35.40
35.38
7.58
26.46
25.06
24.85
29.27
29.13
25.06
24.85
27.15
26.99
31.04
28.68
29.07
29.62
28.90
28.59
28.59
28.22
25.42

-0.15
-0.09
1.39
8.14
16.76
16.74
11.65
11.65
16.69
16.67
15.36
15.40
14.32
15.06
15.29
15.58
16.01
16.10
15.97
15.92
21.56

10.03
10.00
0.90
1.91
3.10
3.03
4.07
4.00
3.10
3.02
7.61
7.48
15.52
12.39
12.12
13.25
13.29
13.11
13.20
13.00
10.91

-16.47
-16.27
-0.04
-0.42
1.17
1.19
0.43
0.45
1.15
1.17
2.46
2.51
5.91
5.87
5.87
5.36
5.76
5.57
5.56
5.24
10.28

15.02
14.99
1.30
1.73
4.03
3.91
5.66
5.56
4.07
3.95
10.79
10.59
20.53
15.85
16.00
17.95
17.95
17.50
17.90
17.15
13.61

-23.48
-23.32
-0.04
-0.33
1.12
1.15
0.44
0.46
1.14
1.18
2.88
2.93
7.11
6.90
7.13
6.29
6.78
6.63
6.52
6.19
12.75

20.19
20.15
1.71
2.78
4.87
4.66
6.72
6.56
4.80
4.60
13.07
12.77
22.48
18.08
18.20
20.68
20.10
20.31
19.67
18.86
13.04

-30.73
-30.66
-0.24
-0.80
0.40
0.48
0.00
0.04
0.41
0.48
1.63
1.71
6.05
5.99
6.17
5.32
5.43
5.27
5.20
5.08
11.52

Note: In this table, we report the average in-sample (IS) and out-of-sample (OOS) R2 s for models (a) and (b) using
Ridge, Lasso, Elastic Net (ENet), generalized linear model with group lasso (GLM), random forest (RF), gradient
boosted regression trees (GBRT), and five architectures of neural networks (NN1,...,NN5), respectively. â€œ+Hâ€ indicates
the use of Huber loss instead of the l2 loss. â€œOracleâ€ stands for using the true covariates in a pooled-OLS regression.
We fix N = 200, T = 180, Px = 2 and Pc = 100, comparing the performance of different horizons. The number of
Monte Carlo repetitions is 100.

the out-of-sample performance for almost all methods. RF, GBRT plus Huber loss remain the
best choices for the nonlinear model. The comparison among NNs demonstrates a stark trade-off
between model flexibility and implementation difficulty. Deeper models potentially allow for more
parsimonious representation of the data, but their objective functions are more involved to optimize.
For instance, the APG algorithm used in Elastic Net is not feasible for NNs, because its loss (as
a function of weight parameters) is non-convex. As shown in the table, shallower NNs tend to
outperform.
Table A.2 presents the same IS and OOS R2 s for prediction conducted for different horizons,
e.g., quarterly, half-yearly, and annually. We observe the usual increasing/hump-shape patterns of
R2 s against prediction horizons documented in the literature, which is driven by the persistence of
covariates. The relative performance across different models maintains the same.
Next, we report the average variable selection frequencies of 6 particular covariates and the
average of the remaining P âˆ’ 6 covariates for models (a) and (b) in Table A.3, using Lasso, Elastic
Net, and Group Lasso and their robust versions. We focus on these methods because they all impose
the l1 penalty and hence encourage variable selection. As expected, for model (a), the true covariates
55

Table A.3: Comparison of Average Variable Selection Frequencies in Simulations
Model (a)
Parameter

Method

ci1,t

ci2,t

ci3,t

ci1,t Ã— xt

ci2,t Ã— xt

ci3,t Ã— xt

Noise

Pc = 50

Lasso
Lasso+H
ENet
ENet+H
GLM
GLM+H

0.95
0.95
0.95
0.95
0.95
0.95

0.94
0.94
0.94
0.94
0.95
0.94

0.65
0.63
0.65
0.64
0.72
0.70

0.53
0.53
0.54
0.53
0.61
0.61

0.51
0.50
0.51
0.50
0.63
0.62

0.85
0.86
0.86
0.86
0.90
0.90

0.09
0.08
0.09
0.09
0.13
0.12

Pc = 100

Lasso
Lasso+H
ENet
ENet+H
GLM
GLM+H

0.95
0.95
0.95
0.95
0.95
0.95

0.94
0.94
0.94
0.94
0.94
0.94

0.65
0.63
0.65
0.64
0.72
0.69

0.52
0.53
0.53
0.53
0.58
0.55

0.49
0.49
0.49
0.49
0.61
0.60

0.85
0.86
0.86
0.86
0.90
0.90

0.06
0.06
0.06
0.06
0.09
0.09

Parameter

Method

ci1,t

ci2,t

ci3,t

ci1,t Ã— xt

ci2,t Ã— xt

ci3,t Ã— xt

Noise

Pc = 50

Lasso
Lasso+H
ENet
ENet+H
GLM
GLM+H

0.26
0.25
0.26
0.25
0.80
0.79

0.26
0.25
0.25
0.24
0.54
0.54

0.39
0.38
0.39
0.39
0.68
0.70

0.27
0.28
0.27
0.28
0.68
0.68

0.31
0.31
0.31
0.31
0.64
0.62

0.75
0.75
0.76
0.75
0.82
0.82

0.04
0.04
0.04
0.04
0.21
0.20

Pc = 100

Lasso
Lasso+H
ENet
ENet+H
GLM
GLM+H

0.25
0.24
0.25
0.24
0.80
0.79

0.25
0.24
0.25
0.24
0.52
0.48

0.37
0.36
0.37
0.37
0.67
0.67

0.25
0.26
0.25
0.26
0.65
0.66

0.31
0.31
0.31
0.31
0.57
0.56

0.75
0.75
0.76
0.75
0.81
0.81

0.02
0.02
0.02
0.02
0.14
0.13

Model (b)

Note: In this table, we report the average variable selection frequencies of 6 particular covariates for models (a) and (b)
(monthly horizon) using Lasso, Elastic Net (ENet), and generalized linear model with group lasso (GLM), respectively.
â€œ+Hâ€ indicates the use of Huber loss instead of the l2 loss. Column â€œNoiseâ€ reports the average selection frequency
of the remaining P âˆ’ 6 covariates. We fix N = 200, T = 180, and Px = 2, comparing Pc = 100 with Pc = 50. The
number of Monte Carlo repetitions is 100.

(ci1,t , ci2,t , ci3,t Ã— xt ) are selected in over 85% of the sample paths, whereas correlated yet redundant
covariates (ci3,t , ci1,t Ã— xt , ci2,t Ã— xt ) are also selected in around 60% of the samples. By contrast,
the remaining covariates are rarely selected. Although model selection mistakes are unavoidable,
perhaps due to the tension between variable selection and prediction or for finite sample issues,
the true covariates are part of the selected models with high probabilities. For model (b), while
no covariates are part of the true model, the 6 covariates we present are more relevant, and hence
selected substantially more frequently than the remaining P âˆ’ 6 ones.
Finally, we report the average VIPs of the 6 particular covariates and the average of the remaining
P âˆ’ 6 covariates for models (a) and (b) in Table A.4, using random forest (RF) and gradient boosted
regression trees (GBRT), along with neural networks. We find similar results for both models (a)
and (b) that the 6 covariates we present are substantially more important than the remaining P âˆ’ 6
56

Table A.4: Comparison of Average Variable Importance in Simulations
Model (a)
Parameter

Method

ci1,t

ci2,t

ci3,t

ci1,t Ã— xt

ci2,t Ã— xt

ci3,t Ã— xt

Noise

Pc = 50

RF
GBRT
GBRT+H
NN1
NN2
NN3
NN4
NN5

21.54
23.86
24.01
26.50
26.35
26.05
26.09
25.95

23.20
27.86
27.43
29.55
28.93
28.61
28.72
28.40

5.89
5.64
5.33
5.31
5.04
5.03
5.08
5.12

6.44
6.41
6.30
2.99
3.12
3.09
3.37
3.31

6.42
6.03
6.78
3.75
3.93
3.89
3.82
3.73

19.45
25.66
25.88
25.18
25.74
25.57
25.59
25.36

0.18
0.05
0.05
0.07
0.07
0.08
0.08
0.09

Pc = 100

RF
GBRT
GBRT+H
NN1
NN2
NN3
NN4
NN5

21.40
23.87
23.75
25.78
25.30
25.32
25.02
24.78

23.08
27.82
27.12
28.36
27.88
28.03
27.63
27.73

5.84
5.32
5.20
5.03
4.85
4.73
4.77
4.82

5.62
6.20
6.04
2.77
2.95
2.89
2.92
3.07

5.87
5.87
6.30
3.60
3.52
3.50
3.49
3.54

19.18
25.43
26.00
24.57
24.58
24.53
24.34
24.19

0.10
0.03
0.03
0.05
0.06
0.06
0.06
0.06

Parameter

Method

ci1,t

ci2,t

ci3,t

ci1,t Ã— xt

ci2,t Ã— xt

ci3,t Ã— xt

Noise

Pc = 50

RF
GBRT
GBRT+H
NN1
NN2
NN3
NN4
NN5

27.70
31.24
32.05
55.55
51.84
52.00
51.07
49.74

6.47
7.37
7.46
14.50
13.66
13.64
13.61
13.68

5.03
5.82
5.83
4.53
4.15
4.36
4.45
4.48

8.02
8.81
8.87
3.46
2.96
2.93
3.31
3.28

5.00
6.43
6.62
2.97
2.72
2.89
2.81
2.86

32.13
36.41
35.57
12.11
18.32
16.63
16.19
15.91

0.17
0.04
0.04
0.07
0.07
0.08
0.09
0.11

Pc = 100

RF
GBRT
GBRT+H
NN1
NN2
NN3
NN4
NN5

26.42
31.49
32.13
53.09
50.25
50.36
48.28
43.44

5.74
7.30
7.48
13.53
12.93
13.00
13.05
12.41

4.40
5.38
5.71
4.79
4.26
4.30
4.50
4.71

7.77
8.61
8.66
3.45
2.87
2.90
3.21
3.61

4.69
6.17
6.30
2.77
2.45
2.54
2.63
2.59

31.93
36.70
35.87
12.11
17.31
15.43
15.05
16.09

0.10
0.02
0.02
0.05
0.05
0.06
0.07
0.09

Model (b)

Note: In this table, we report the average variable importance of 6 particular covariates for models (a) and (b) (monthly
horizon) using random forest (RF), gradient boosted regression trees (GBRT), and five architectures of neural networks
(NN1,...,NN5), respectively. â€œ+Hâ€ indicates the use of Huber loss instead of the l2 loss. Column â€œNoiseâ€ reports the
average variable importance of the remaining P âˆ’ 6 covariates. We fix N = 200, T = 180, and Px = 2, comparing
Pc = 100 with Pc = 50. The number of Monte Carlo repetitions is 100.

ones. All methods work equally well.
Overall, the simulation results suggest that the machine learning methods are successful in singling out informative variables, even though highly correlated covariates are difficult to distinguish.
This is not surprising, as these methods are implemented to improve prediction, for which purpose
the best model often does not agree with the true model, in particular when covariates are highly

57

correlated.

B

Algorithms in Details

B.1

Lasso, Ridge, Elastic Net, and Group Lasso

We present the accelerated proximal algorithm (APG), see, e.g., Parikh and Boyd (2013) and Polson
et al. (2015)., which allows for efficient implementation of the elastic net, Lasso, Ridge regression,
and Group Lasso for both l2 and Huber losses. We rewrite their regularized objective functions as
L(Î¸; Â·) =

L(Î¸)
+ Ï†(Î¸; Â·) ,
|{z}
| {z }
Loss Function Penalty

(B.3)

where we omit the dependence on the tuning parameters. Specifically, we have

Ï†(Î¸; Â·) =

ï£±
P
ï£´
1 X 2
ï£´
ï£´
ï£´
Î»
Î¸j ,
ï£´
ï£´
2
ï£´
ï£´
j=1
ï£´
ï£´
ï£´
P
ï£´
X
ï£´
ï£´
ï£´
Î»
|Î¸j |,
ï£´
ï£²

Ridge;
Lasso;

j=1

P
P
X
ï£´
1 X 2
ï£´
ï£´
ï£´
Î¸j ,
Î»(1 âˆ’ Ï)
|Î¸j | + Î»Ï
ï£´
ï£´
2
ï£´
ï£´
j=1
j=1
ï£´
ï£´
P
ï£´
X
ï£´
ï£´
ï£´
ï£´
Î»
kÎ¸j k,
ï£´
ï£³

,

(B.4)

Elastic Net;
Group Lasso.

j=1

where in the Group Lasso case, Î¸ = (Î¸1 , Î¸2 , . . . , Î¸P ) is a K Ã— P matrix.
Proximal algorithms are a class of algorithms for solving convex optimization problems, in which
the base operation is evaluating the proximal operator of a function, ie., solving a small convex
optimization problem. In many cases, this smaller problem has a closed form solution. The proximal
operator is defined as:



1
2
proxÎ³f (Î¸) = argmin f (z) +
kz âˆ’ Î¸k .
2Î³
z
An important property of the proximal operator is that the minimizer of a convex function f (Â·)
is a fixed point of proxf (Â·), i.e., Î¸? minimizes f (Â·) if and only if
Î¸? = proxf (Î¸? ).
The proximal gradient algorithm is designed to minimize an objective function of the form (B.3),
where L(Î¸) is differentiable function of Î¸ but Ï†(Î¸; Â·) is not. Using properties of the proximal operator,

58

one can show that Î¸? minimizes (B.3), if and only if
Î¸? = proxÎ³Ï† (Î¸? âˆ’ Î³âˆ‡L(Î¸? )).
This result motivates the first two iteration steps in Algorithm 1. The third step inside the while
loop is a Nesterov momentum (Nesterov (1983)) adjustment that accelerates convergence.
The optimization problem requires the proximal operators of Ï†(Î¸; Â·)s in (B.4), which have closed
forms:

ï£±
Î¸
ï£´
ï£´
,
ï£´
ï£´
1
+
Î»Î³
ï£´
ï£´
ï£´
ï£²Î»S(Î¸, Î»Î³),
proxÎ³Ï† (Î¸) =
1
ï£´
ï£´
S(Î¸, (1 âˆ’ Ï)Î»Î³),
ï£´
ï£´
1
+
Î»Î³Ï
ï£´
ï£´
ï£´
ï£³(S(Î¸
e 1 , Î»Î³)| , S(Î¸
e 2 , Î»Î³)| , . . . , S(Î¸
e P , Î»Î³)| )| ,

Ridge;
Lasso;

,

Elastic Net;
Group Lasso.

e Âµ) are vector-valued functions, whose ith components are defined by:
where S(x, Âµ) and S(x,
ï£±
ï£´
ï£´
x âˆ’ Âµ, if xi > 0 and Âµ < |xi |;
ï£´
ï£² i
(S(x, Âµ))i = xi + Âµ, if xi < 0 and Âµ < |xi |; ,
ï£´
ï£´
ï£´
ï£³0,
if Âµ â‰¥ |xi |.

ï£±
ï£²x âˆ’ Âµ xi , if kx k > Âµ;
i
i
kxi k
e Âµ))i =
(S(x,
.
ï£³0,
if kxi k â‰¤ Âµ.

Note that S(x, Âµ) is the soft-thresholding operator, so the proximal algorithm is equivalent to
the coordinate descent algorithm in the case of l2 loss, see, e.g., Daubechies et al. (2004), Friedman
et al. (2007). The proximal framework we adopt here allows efficient implementation of Huber loss
and convergence acceleration.
Algorithm 1: Accelerated Proximal Gradient Method
Initialization: Î¸0 = 0, m = 0, Î³;
while Î¸m not converged do
Î¸Ì„ â† Î¸m âˆ’ Î³âˆ‡L(Î¸) |Î¸=Î¸m .
Î¸Ìƒ â† proxÎ³Ï† (Î¸Ì„).
m
Î¸m+1 â† Î¸Ìƒ + m+3
(Î¸Ìƒ âˆ’ Î¸m ).
m â† m + 1.
end
Result: The final parameter estimate is Î¸m .

59

B.2

Tree, Random Forest, and Gradient Boosted Tree

Algorithm 2 is a greedy algorithm, see, e.g., Breiman et al. (1984), to grow a complete binary
regression tree. Next, Algorithm 3 yields the random forest, e.g., Hastie et al. (2009). Finally,
Algorithm 4 delivers the gradient boosted tree (Friedman (2001)), for which we follow the version
written by BuÌˆhlmann and Hothorn (2007).
Algorithm 2: Classification and Regression Tree
Initialize the stump. C1 (0) denotes the range of all covariates, Cl (d) denote the l-th node of depth d.
for d from 1 to L do
for i in {Cl (d âˆ’ 1), l = 1, ..., 2dâˆ’1 } do
i) For each feature j = 1, 2, . . . , P , and each threshold level Î±, define a split as s = (j, Î±), which
divides Cl (d âˆ’ 1) into Clef t and Cright :
Clef t (s) = {zj â‰¤ Î±} âˆ© Cl (d âˆ’ 1);

Cright (s) = {zj > Î±} âˆ© Cl (d âˆ’ 1),

where zj denotes the jth covariate.
ii) Define the impurity function:
|Clef t |
|Cright |
H(Clef t ) +
H(Cright ), where
|C|
|C|
1 X
1 X
(ri,t+1 âˆ’ Î¸)2 , Î¸ =
ri,t+1 ,
H(C) =
|C|
|C|

L(C, Clef t , Cright ) =

zi,t âˆˆC

zi,t âˆˆC

and |C| denotes the number of observations in set C.
iii) Select the optimal split:
sâˆ— â† argmin L(C(s), Clef t (s), Cright (s)).
s

iv) Update the nodes:
C2lâˆ’1 (d) â† Clef t (sâˆ— ),

C2l (d) â† Cright (sâˆ— ).

end
end
Result: The output of a regression tree is given by:
L

g(zi,t ; Î¸, L) =

2
X

Î¸k 1 {zi,t âˆˆ Ck (L)} , where Î¸k =

k=1

1
|Ck (L)|

X

ri,t+1 .

zi,t âˆˆCk (L)

For a single binary complete regression tree T of depth L, the VIP for the covariate zj is
VIP(zj , T ) =

dâˆ’1
Lâˆ’1
X 2X

âˆ†im (Ci (d âˆ’ 1), C2iâˆ’1 (d), C2i (d)) 1{zj âˆˆ T (i, d)},

d=1 i=1

where T (i, d) represents the covariate on the i-th (internal) node of depth d, which splits Ci (d âˆ’ 1) into
two sub-regions {C2iâˆ’1 (d), C2i (d)}, and âˆ†im(Â·, Â·, Â·) is defined by:
âˆ†im (C, Clef t , Cright ) = H(C) âˆ’ L(C, Clef t , Cright ).

60

Algorithm 3: Random Forest
for b from 1 to B do
Generate Bootstrap samples {(zi,t , ri,t+1 ), (i, t) âˆˆ Bootstrap(b)} from the original dataset, for
which a tree is grown using Algorithm 2. At each step of splitting, use only a random subsample,
âˆš
say P , of all features. Write the resulting bth tree as:
L

gbb (zi,t ; b
Î¸b , L) =

2
X

(k)

Î¸b 1 {zi,t âˆˆ Ck (L)} .

k=1

end
Result: The final random forest output is given by the average of the outputs of all B trees.
gb(zi,t ; L, B) =

B
1 X
gbb (zi,t ; b
Î¸b , L).
B
b=1

Algorithm 4: Gradient Boosted Tree
Initialize the predictor as gb0 (Â·) = 0;
for b from 1 to B do
Compute for each i = 1, 2, . . . , N and t = 1, 2, . . . , T , the negative gradient of the loss function
l(Â·, Â·):a
Îµi,t+1 â† âˆ’

âˆ‚l(ri,t+1 , g)
| g=bgbâˆ’1 (zi,t ) .
âˆ‚g

Grow a (shallow) regression tree of depth L with dataset {(zi,t , Îµi,t+1 ) : âˆ€i, âˆ€t}
fbb (Â·) â† g(zi,t ; Î¸, L).
Update the model by
gbb (Â·) â† gbbâˆ’1 (Â·) + Î½ fbb (Â·),
where Î½ âˆˆ (0, 1] is a tuning parameter that controls the step length.
end
Result: The final model output is
gbB (zi,t ; B, Î½, L) =

B
X

Î½ fbb (Â·).

b=1

a

The typical choice of l(Â·, Â·) for regression is l2 or Huber loss, whereas for classification, it is more common to use
the following loss function:
l(d, g(Â·)) = log2 (1 + exp (âˆ’2(2d âˆ’ 1)g(Â·))) .

61

B.3

Neural Networks

It is common to fit the neural network using stochastic gradient descent (SGD), see, e.g., Goodfellow
et al. (2016). We adopt the adaptive moment estimation algorithm (Adam), an efficient version of the
SGD introduced by Kingma and Ba (2014). Adam computes adaptive learning rates for individual
parameters using estimates of first and second moments of the gradients. We denote the loss function
P
as L(Î¸; Â·) and write L(Î¸; Â·) = T1 Tt=1 Lt (Î¸; Â·), where Lt (Î¸; Â·) is the penalized cross-sectional average
prediction error at time t. At each step of training, a batch sent to the algorithm is randomly
sampled from the training dataset. Algorithm 6 is the early stopping algorithm that can be used
in combination with many optimization routines, including Adam. Algorithm 7 gives the BatchNormalization transform (Ioffe and Szegedy (2015)), which we apply to each activation after ReLU
transformation. Any neuron that previously receives a batch of x as the input now receives BNÎ³,Î² (x)
instead, where Î³ and Î² are additional parameters to be optimized.
Algorithm 5: Adam for Stochastic Gradient Descent (SGD)
Initialize the parameter vector Î¸0 . Set m0 = 0, v0 = 0, t = 0.
while Î¸t not converged do
t â† t + 1.
gt â† âˆ‡Î¸ Lt (Î¸; Â·) Î¸=Î¸tâˆ’1 .
mt â† Î² 1 mtâˆ’1 + (1 âˆ’ Î² 1 )gt .
vt â† Î² 2 vtâˆ’1 + (1 âˆ’ Î² 2 )gt gt .a
mÌ‚t â† mt /(1 âˆ’ (Î² 1 )t ).
vÌ‚t â† vt /(1 âˆ’ (Î² 2 )t ).
âˆš
Î¸t â† Î¸tâˆ’1 âˆ’ Î±mÌ‚t ( vÌ‚t + ).
end
Result: The final parameter estimate is Î¸t .
a

and

denote element-wise multiplication and division, respectively.

Algorithm 6: Early Stopping
Initialize j = 0,  = âˆž and select the patience parameter p.
while j < p do
Update Î¸ using the training algorithm (e.g., the steps inside the while loop of Algorithm 5 for h
steps).
Calculate the prediction error from the validation sample, denoted as 0 .
if 0 <  then
j â† 0.
 â† 0 .
Î¸0 â† Î¸.
else
j â† j + 1.
end
end
Result: The final parameter estimate is Î¸0 .

62

Algorithm 7: Batch Normalization (for one Activation over one Batch)
Input: Values of x for each activation over a batch B = {x1 , x2 , . . . , xN }.
N
1 X
ÂµB â†
xi
N i=1
N
1 X
(xi âˆ’ ÂµB )2
N i=1
xi âˆ’ Âµ
x
bi â† p 2 B
ÏƒB + 
yi â† Î³b
xi + Î² := BNÎ³,Î² (xi )
Result: {yi = BNÎ³,Î² (xi ) : i = 1, 2 . . . , N }.

Ïƒ 2B â†

C

Theoretical Properties of Machine Learning Models

In this section, we provide references on the asymptotic properties of machine learning methods
discussed in the main text. The references below are unavoidably selective and by no means complete.
We invite interested readers to consult references within the following papers.
For theoretical properties of lasso, see Knight and Fu (2000), Bickel et al. (2009), Meinshausen
and Yu (2009), Tibshirani (2011), Wainwright (2009), and Zhang and Huang (2008). And for elastic
net, see Zou and Hastie (2005), Zou and Zhang (2009), and Mol et al. (2009). For group Lasso
in linear models, see Lounici et al. (2011), and see Bach (2008) and Ravikumar et al. (2009) for
additive and nonparametric models. While most theoretical analysis in high-dimensional statistics
assume that data have sub-Gaussian or sub-exponential tails, Fan et al. (2017) provide a theoretical
justification of using Huberâ€™s loss function in the high-dimensional setting.
For dimension reduction techniques, there is a large literature in statistics on the asymptotic
behavior of PCA, e.g., Bai (1999), Johnstone (2001), Johnstone and Lu (2009), Paul (2007), Wang
and Fan (2017), and another large literature in econometrics focusing on the asymptotic theory of
PCA in modern factor analysis, e.g., Stock and Watson (2002), Bai and Ng (2002), and Bai and Ng
(2013). There are, however, fewer results on the asymptotic analysis of PCR and PLS in particular.
One can refer to Giglio and Xiu (2016) for the asymptotic theory of PCR in the context of risk
premia estimation, and Kelly and Pruitt (2013, 2015) for the theory of PLS with its application to
forecasting risk premia in financial markets.
A recent literature analyzes theoretical properties of random forests, see Biau (2012), Scornet
et al. (2015), Mentch and Hooker (2016), Wager et al. (2014), and Wager and Athey (2018). The
properties of gradient boosting, on the other hand, are well understood from the early work of e.g.,
Friedman et al. (2000b), BuÌˆhlmann and Yu (2003), Lugosi and Vayatis (2004), and Zhang and Yu
(2005) for both classification and regression problems. However, much work remains to be done to
fully take into account optimization and regularization algorithms that are essential to the desirable
performance of various boosting methods, e.g., the popular XGBoost system designed by Chen and
Guestrin (2016).
Likewise, theoretical properties of neural networks and deep learning are in large part underdeveloped (for an overview, see Fan et al., 2019). First, the approximation theory of neural networks
63

is far from complete. Although earlier work have established a universal approximation theory with
a single hidden layer network (e.g., Hornik et al., 1989), a recent line of work sheds light on the
distinction between depth and width of a multi-layer network. Eldan and Shamir (2016) formally
demonstrate that depthâ€”even if increased by one layerâ€”can be exponentially more valuable than
increasing width in standard feed-forward neural networks (see also Lin et al., 2017; Rolnick and
Tegmark, 2018).
Second, any theoretical understanding of neural networks should explicitly account for the modern optimization algorithms that, in combination with statistical analysis, are critical to their success.
But training a deep neural network typically involves a grab bag of algorithms, e.g., SGD, Adam,
batch normalization, skipping connections (He et al., 2016b), some of which rely on heuristic explanation without rigorous analysis. A promising recent strand of work Chizat and Bach (2018), Mei
et al. (2018), and Mei et al. (2019) approximate the evolution of network weight parameters in the
SDG algorithm for networks with a single hidden layer. They show that mean-field partial differential equations accurately describe this process as long as the number of hidden units is sufficiently
large. In summary, there remains much work to be done to establish theoretical properties of deep
learning.

D

Sample Splitting

We consider a number of sample splitting schemes studied in the forecast evaluation literature (see,
e.g., West, 2006). The â€œfixedâ€ scheme splits the data into training, validation, and testing samples.
It estimates the model once from the training and validation samples, and attempts to fit all points
in the testing sample using this fixed model estimate.
A common alternative to the fixed split scheme is a â€œrollingâ€ scheme, in which the training and
validation samples gradually shift forward in time to include more recent data, but holds the total
number of time periods in each training and validation sample fixed. For each rolling window, one refits the model from the prevailing training and validation samples, and tracks a modelâ€™s performance
in the remaining test data that has not been subsumed by the rolling windows. The result is a
sequence of performance evaluation measures corresponding to each rolling estimation window. This
has the benefit of leveraging more recent information for prediction relative to the fixed scheme.
The third is a â€œrecursiveâ€ performance evaluation scheme. Like the rolling approach, it gradually
includes more recent observations in the training and validation windows. But the recursive scheme
always retains the entire history in the training sample, thus its window size gradually increases.
The rolling and recursive schemes are computationally expensive, in particular for more complicated
models such as neural networks.
In our empirical exercise, we adopt a hybrid of these schemes by recursively increasing the training
sample, periodically refitting the entire model once per year, and making out-of-sample predictions
using the same fitted model over the subsequent year. Each time we refit, we increase the training
sample by a year, while maintaining a fixed size rolling sample for validation. We choose to not
cross-validate in order to maintain the temporal ordering of the data for prediction.
64

Table A.5: Hyperparameters For All Methods

Huber loss Î¾ =
99.9% quantile
Others

OLS-3
+H

PLS

PCR

ENet
+H

GLM
+H

RF

GBRT
+H

NN1 - NN5

X

-

-

X

X

-

X

-

K

K

Ï = 0.5
Î» âˆˆ (10âˆ’4 , 10âˆ’1 )

#Knots=3
Î» âˆˆ (10âˆ’4 , 10âˆ’1 )

Depth= 1 âˆ¼ 6
#Trees= 300
#Features in each split
âˆˆ {3, 5, 10, 20, 30, 50...}

Depth= 1 âˆ¼ 2
#Trees= 1 âˆ¼ 1000
Learning Rate
LRâˆˆ {0.01, 0.1}

L1 penalty
Î»1 âˆˆ (10âˆ’5 , 10âˆ’3 )
Learning Rate
LRâˆˆ {0.001, 0.01}
Batch Size=10000
Epochs=100
Patience=5
Adam Para.=Default
Ensemble=10

Note: The table describes the hyperparameters that we tune in each machine learning method.

E

Hyperparameter Tuning

Table A.5 describes the set of hyperparameters and their potential values used for tuning each
machine learning model.

F

Additional Tables and Figures

65

66

Acronym
absacc
acc
aeavol
age
agr
baspread
beta
betasq
bm
bm ia
cash
cashdebt
cashpr
cfp
cfp ia
chatoia
chcsho
chempia
chinv
chmom
chpmia
chtx
cinvest
convind
currat
depr
divi
divo
dolvol
dy
ear

Firm characteristic
Absolute accruals
Working capital accruals
Abnormal earnings announcement volume
# years since first Compustat coverage
Asset growth
Bid-ask spread
Beta
Beta squared
Book-to-market
Industry-adjusted book to market
Cash holdings
Cash flow to debt
Cash productivity
Cash flow to price ratio
Industry-adjusted cash flow to price ratio
Industry-adjusted change in asset turnover
Change in shares outstanding
Industry-adjusted change in employees
Change in inventory
Change in 6-month momentum
Industry-adjusted change in profit margin
Change in tax expense
Corporate investment
Convertible debt indicator
Current ratio
Depreciation / PP&E
Dividend initiation
Dividend omission
Dollar trading volume
Dividend to price
Earnings announcement return

Paperâ€™s author(s)
Bandyopadhyay, Huang & Wirjanto
Sloan
Lerman, Livnat & Mendenhall
Jiang, Lee & Zhang
Cooper, Gulen & Schill
Amihud & Mendelson
Fama & MacBeth
Fama & MacBeth
Rosenberg, Reid & Lanstein
Asness, Porter & Stevens
Palazzo
Ou & Penman
Chandrashekar & Rao
Desai, Rajgopal & Venkatachalam
Asness, Porter & Stevens
Soliman
Pontiff & Woodgate
Asness, Porter & Stevens
Thomas & Zhang
Gettleman & Marks
Soliman
Thomas & Zhang
Titman, Wei & Xie
Valta
Ou & Penman
Holthausen & Larcker
Michaely, Thaler & Womack
Michaely, Thaler & Womack
Chordia, Subrahmanyam & Anshuman
Litzenberger & Ramaswamy
Kishore, Brandt, Santa-Clara & Venkatachalam

Year,
2010,
1996,
2007,
2005,
2008,
1989,
1973,
1973,
1985,
2000,
2012,
1989,
2009,
2004,
2000,
2008,
2008,
1994,
2002,
2006,
2008,
2011,
2004,
2016,
1989,
1992,
1995,
1995,
2001,
1982,
2008,

Journal
WP
TAR
WP
RAS
JF
JF
JPE
JPE
JPM
WP
JFE
JAE
WP
TAR
WP
TAR
JF
WP
RAS
WP
TAR
JAR
JFQA
JFQA
JAE
JAE
JF
JF
JFE
JF
WP

Note: This table lists the characteristics we use in the empirical study. The data are collected in Green et al. (2017).

No.
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31

Table A.6: Details of the Characteristics
Data Source
Compustat
Compustat
Compustat+CRSP
Compustat
Compustat
CRSP
CRSP
CRSP
Compustat+CRSP
Compustat+CRSP
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
CRSP
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
CRSP
Compustat
Compustat+CRSP

Frequency
Annual
Annual
Quarterly
Annual
Annual
Monthly
Monthly
Monthly
Annual
Annual
Quarterly
Annual
Annual
Annual
Annual
Annual
Annual
Annual
Annual
Monthly
Annual
Quarterly
Quarterly
Annual
Annual
Annual
Annual
Annual
Monthly
Annual
Quarterly

67

No.
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62

Acronym
egr
ep
gma
grCAPX
grltnoa
herf
hire
idiovol
ill
indmom
invest
lev
lgr
maxret
mom12m
mom1m
mom36m
mom6m
ms
mvel1
mve ia
nincr
operprof
orgcap
pchcapx ia
pchcurrat
pchdepr
pchgm pchsale
pchquick
pchsale pchinvt
pchsale pchrect

Firm characteristic
Growth in common shareholder equity
Earnings to price
Gross profitability
Growth in capital expenditures
Growth in long term net operating assets
Industry sales concentration
Employee growth rate
Idiosyncratic return volatility
Illiquidity
Industry momentum
Capital expenditures and inventory
Leverage
Growth in long-term debt
Maximum daily return
12-month momentum
1-month momentum
36-month momentum
6-month momentum
Financial statement score
Size
Industry-adjusted size
Number of earnings increases
Operating profitability
Organizational capital
Industry adjusted % change in capital expenditures
% change in current ratio
% change in depreciation
% change in gross margin - % change in sales
% change in quick ratio
% change in sales - % change in inventory
% change in sales - % change in A/R

Paperâ€™s author(s)
Richardson, Sloan, Soliman & Tuna
Basu
Novy-Marx
Anderson & Garcia-Feijoo
Fairfield, Whisenant & Yohn
Hou & Robinson
Bazdresch, Belo & Lin
Ali, Hwang & Trombley
Amihud
Moskowitz & Grinblatt
Chen & Zhang
Bhandari
Richardson, Sloan, Soliman & Tuna
Bali, Cakici & Whitelaw
Jegadeesh
Jegadeesh & Titman
Jegadeesh & Titman
Jegadeesh & Titman
Mohanram
Banz
Asness, Porter & Stevens
Barth, Elliott & Finn
Fama & French
Eisfeldt & Papanikolaou
Abarbanell & Bushee
Ou & Penman
Holthausen & Larcker
Abarbanell & Bushee
Ou & Penman
Abarbanell & Bushee
Abarbanell & Bushee

Table A.6: Details of the Characteristics (Continued)
Year,
2005,
1977,
2013,
2006,
2003,
2006,
2014,
2003,
2002,
1999,
2010,
1988,
2005,
2011,
1990,
1993,
1993,
1993,
2005,
1981,
2000,
1999,
2015,
2013,
1998,
1989,
1992,
1998,
1989,
1998,
1998,

Journal
JAE
JF
JFE
JF
TAR
JF
JPE
JFE
JFM
JF
JF
JF
JAE
JFE
JF
JF
JF
JF
RAS
JFE
WP
JAR
JFE
JF
TAR
JAE
JAE
TAR
JAE
TAR
TAR

Data Source
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
CRSP
CRSP
CRSP
Compustat
Compustat
Compustat
CRSP
CRSP
CRSP
CRSP
CRSP
Compustat
CRSP
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat

Frequency
Annual
Annual
Annual
Annual
Annual
Annual
Annual
Monthly
Monthly
Monthly
Annual
Annual
Annual
Monthly
Monthly
Monthly
Monthly
Monthly
Quarterly
Monthly
Annual
Quarterly
Annual
Annual
Annual
Annual
Annual
Annual
Annual
Annual
Annual

68

No.
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94

Acronym
pchsale pchxsga
pchsaleinv
pctacc
pricedelay
ps
quick
rd
rd mve
rd sale
realestate
retvol
roaq
roavol
roeq
roic
rsup
salecash
saleinv
salerec
secured
securedind
sgr
sin
sp
std dolvol
std turn
stdacc
stdcf
tang
tb
turn
zerotrade

Firm characteristic
% change in sales - % change in SG&A
% change sales-to-inventory
Percent accruals
Price delay
Financial statements score
Quick ratio
R&D increase
R&D to market capitalization
R&D to sales
Real estate holdings
Return volatility
Return on assets
Earnings volatility
Return on equity
Return on invested capital
Revenue surprise
Sales to cash
Sales to inventory
Sales to receivables
Secured debt
Secured debt indicator
Sales growth
Sin stocks
Sales to price
Volatility of liquidity (dollar trading volume)
Volatility of liquidity (share turnover)
Accrual volatility
Cash flow volatility
Debt capacity/firm tangibility
Tax income to book income
Share turnover
Zero trading days

Paperâ€™s author(s)
Abarbanell & Bushee
Ou & Penman
Hafzalla, Lundholm & Van Winkle
Hou & Moskowitz
Piotroski
Ou & Penman
Eberhart, Maxwell & Siddique
Guo, Lev & Shi
Guo, Lev & Shi
Tuzel
Ang, Hodrick, Xing & Zhang
Balakrishnan, Bartov & Faurel
Francis, LaFond, Olsson & Schipper
Hou, Xue & Zhang
Brown & Rowe
Kama
Ou & Penman
Ou & Penman
Ou & Penman
Valta
Valta
Lakonishok, Shleifer & Vishny
Hong & Kacperczyk
Barbee, Mukherji, & Raines
Chordia, Subrahmanyam & Anshuman
Chordia, Subrahmanyam, &Anshuman
Bandyopadhyay, Huang & Wirjanto
Huang
Almeida & Campello
Lev & Nissim
Datar, Naik & Radcliffe
Liu

Table A.6: Details of the Characteristics (Continued)
Year,
1998,
1989,
2011,
2005,
2000,
1989,
2004,
2006,
2006,
2010,
2006,
2010,
2004,
2015,
2007,
2009,
1989,
1989,
1989,
2016,
2016,
1994,
2009,
1996,
2001,
2001,
2010,
2009,
2007,
2004,
1998,
2006,

Journal
TAR
JAE
TAR
RFS
JAR
JAE
JF
JBFA
JBFA
RFS
JF
JAE
TAR
RFS
WP
JBFA
JAE
JAE
JAE
JFQA
JFQA
JF
JFE
FAJ
JFE
JFE
WP
JEF
RFS
TAR
JFM
JFE

Data Source
Compustat
Compustat
Compustat
CRSP
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
CRSP
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
Compustat
CRSP
CRSP
Compustat
Compustat
Compustat
Compustat
CRSP
CRSP

Frequency
Annual
Annual
Annual
Monthly
Annual
Annual
Annual
Annual
Annual
Annual
Monthly
Quarterly
Quarterly
Quarterly
Annual
Quarterly
Annual
Annual
Annual
Annual
Annual
Annual
Annual
Annual
Monthly
Monthly
Quarterly
Quarterly
Annual
Annual
Monthly
Monthly

Table A.7: Implied Sharpe Ratio Improvements
OLS-3
+H

PLS

PCR

ENet
+H

GLM
+H

RF

GBRT
+H

NN1

NN2

NN3

NN4

NN5

-

-

-

0.08

0.08

0.14

0.15

0.11

0.12

0.20

0.17

0.12

0.05
0.01
0.02
-

0.00
0.15
0.03
0.06

0.10
0.02

0.03
0.08
0.08
0.06
0.02

0.07
0.06
0.04
0.08
0.03

0.14
0.14
0.13
0.11
0.14
0.09

0.12
0.13
0.13
0.05
0.21
0.04

0.09
0.11
0.15
0.14
0.01
0.06

0.10
0.12
0.13
0.13
0.09
0.06

0.15
0.16
0.17
0.14
0.10
0.07

0.13
0.13
0.18
0.13
0.08
0.06

0.11
0.12
0.14
0.12
0.10
0.07

-

0.12
0.09
0.04

0.08
0.00
0.01

0.09
0.04
0.08
0.00
0.04

0.04
0.09
0.05
0.04
0.03
0.03

0.10
0.20
0.11
0.10
0.16
0.07

0.05
0.23
0.08
0.06
0.22
0.00

0.11
0.16
0.08
0.09
0.06
0.06

0.10
0.18
0.08
0.09
0.11
0.06

0.14
0.21
0.14
0.10
0.12
0.08

0.12
0.18
0.14
0.09
0.10
0.06

0.10
0.17
0.11
0.09
0.12
0.07

Big Robust
Big Weak
Big Neutral
Small Robust
Small Weak
Small Neutral

0.03
0.04
-

0.15
0.04
0.17
0.01

0.12
0.11
-

0.06
0.10
0.06
0.00
-

0.04
0.12
0.02
0.08
-

0.11
0.14
0.14
0.07
0.17
0.06

0.03
0.19
0.12
0.02
0.22
-

0.08
0.19
0.11
0.02
0.13
0.01

0.08
0.19
0.13
0.05
0.15
0.03

0.13
0.21
0.15
0.06
0.16
0.04

0.10
0.17
0.15
0.05
0.15
0.03

0.08
0.17
0.13
0.05
0.15
0.04

Big Up
Big Down
Big Medium
Small Up
Small Down
Small Medium

0.01

0.08
0.03
0.08

0.06
0.02

0.06
0.05
0.13
0.03
0.06

0.11
0.03
0.00
0.04

0.11
0.13
0.22
0.07
0.23
0.12

0.08
0.08
0.25
0.00
0.22
0.11

0.07
0.04
0.19
0.01
0.13
0.11

0.07
0.08
0.20
0.01
0.14
0.11

0.10
0.12
0.24
0.02
0.17
0.12

0.10
0.10
0.22
0.02
0.15
0.10

0.09
0.10
0.18
0.03
0.16
0.10

S&P 500
Big Value
Big Growth
Big Neutral
Small Value
Small Growth
Small Neutral
Big Conservative
Big Aggressive
Big Neutral
Small Conservative
Small Aggressive
Small Neutral

Note: Improvement in annualized Sharpe ratio (SRâˆ— âˆ’ SR) implied by the full sample Sharpe ratio of each portfolio to2
2
gether with machine learning predictive Roos
from Table 5. Cases with negative Roos
imply a Sharpe ratio deterioration
and are omitted.

69

Figure A.1: Characteristic Importance over Time by NN3

16

15

20

14

20

13

20

12

20

11

20

10

20

09

20

08

20

07

20

06

20

05

20

04

20

03

20

02

20

01

20

00

20

99

20

98

19

97

19

96

19

95

19

94

19

93

19

92

19

91

19

90

19

89

19

88

19

19

19

87

mom1m
mvel1
mom12m
chmom
maxret
indmom
retvol
dolvol
sp
turn
agr
nincr
rd_mve
std_turn
mom6m
mom36m
ep
chcsho
securedind
idiovol
baspread
ill
age
convind
rd
depr
beta
betasq
cashpr
ps
zerotrade
dy
orgcap
bm
lgr
cashdebt
chinv
invest
lev
operprof
bm_ia
saleinv
egr
cfp
rd_sale
sgr
roaq
roic
sic2
mve_ia
ms
quick
herf
hire
pricedelay
salerec
roavol
roeq
grcapx
currat
cash
std_dolvol
acc
cfp_ia
grltnoa
gma
pctacc
absacc
salecash
secured
pchdepr
tang
pchcapx_ia
chempia
ear
pchsale_pchinvt
pchsaleinv
chtx
chpmia
chatoia
tb
aeavol
rsup
pchgm_pchsale
pchsale_pchxsga
cinvest
pchquick
pchsale_pchrect
realestate
pchcurrat
stdacc
stdcf
divi
divo
sin

Note: This figure describes how NN3 ranks the 94 stock-level characteristics and the industry dummy (sic2) in terms
of overall model contribution over 30 recursing training. Columns correspond to the year end of each of the 30 samples,
and color gradients within each column indicate the most influential (dark blue) to least influential (white) variables.
Characteristics are sorted in the same order of Figure 5.

70

Figure A.2: Variable Importance Using SSD of Dimopoulos et al. (1995)
mom1m
mvel1
maxret
chmom
mom12m
retvol
indmom
turn
nincr
dolvol
sp
idiovol
mom6m
ill
std_turn
securedind
ep
mom36m
zerotrade
baspread
beta
agr
betasq
dy
rd_mve
chcsho
ps
sic2
age
convind
depr
lgr
invest
cashpr
chinv
bm
saleinv
cashdebt
orgcap
lev
roic
pricedelay
bm_ia
operprof
mve_ia
cfp
rd
herf
sgr
salecash
std_dolvol
hire
salerec
gma
egr
rd_sale
quick
currat
ms
roaq
cfp_ia
acc
tang
roeq
tb
pchsaleinv
grcapx
chempia
roavol
pchsale_pchinvt
grltnoa
absacc
pchdepr
pctacc
chpmia
pchcurrat
pchcapx_ia
pchgm_pchsale
cash
chatoia
chtx
pchquick
ear
rsup
secured
aeavol
pchsale_pchxsga
cinvest
divo
pchsale_pchrect
stdacc
divi
stdcf
realestate
sin
PLS

PCR

ENet+H

GLM+H

RF

GBRT+H

NN1

NN2

NN3

NN4

NN5

Note:
Rankings of 94 stock-level characteristics and the industry dummy (sic2) in terms of SSD. Characteristics are ordered based on the sum of their ranks over all models, with the most influential characteristics on top and least
influential on bottom. Columns correspond to individual models, and color gradients within each column indicate the
most influential (dark blue) to least influential (white) variables.

71

Figure A.3: Characteristic Importance with Placebo Variables
mom1m
mvel1
chmom
maxret
mom12m
indmom
dolvol
securedind
sp
retvol
turn
nincr
idiovol
mom36m
std_turn
baspread
agr
rd_mve
mom6m
ep
dy
convind
ps
ill
chcsho
rd
depr
zerotrade
beta
age
betasq
orgcap
cashdebt
lgr
bm
lev
cashpr
chinv
invest
bm_ia
rd_sale
roic
saleinv
operprof
roavol
egr
pricedelay
ms
herf
cfp
sgr
hire
cash
roaq
salerec
salecash
mve_ia
gma
grcapx
currat
absacc
acc
quick
roeq
pchcapx_ia
grltnoa
cfp_ia
tang
secured
pctacc
std_dolvol
tb
chempia
aeavol
chpmia
chtx
rsup
pchsale_pchinvt
cinvest
realestate
noise5
pchsale_pchxsga
pchsaleinv
pchgm_pchsale
sic2
pchdepr
divo
pchquick
ear
chatoia
noise4
stdacc
stdcf
divi
pchcurrat
noise1
pchsale_pchrect
noise3
noise2
sin
PLS

PCR

ENet+H

GLM+H

RF

GBRT+H

NN1

NN2

NN3

NN4

NN5

Note: This figure describes how each model ranks the 94 stock-level characteristics, the industry dummy (sic2), and
five placebos in terms of overall model contribution. Columns correspond to individual models, and color gradients
within each column indicate the most influential (dark blue) to least influential (white) variables. Characteristics are
ordered based on the sum of their ranks over all models, with the most influential characteristics on top and least
influential on bottom.

72

Figure A.4: Stock/Macroeconomic Interactions
mom1m*bm
mom1m*C
mom1m*tbl
mom1m*dp
turn*ntis
maxret*ntis
retvol*tbl
chmom*bm
mvel1*tms
maxret*tbl
retvol*ntis
mom12m*tbl
mom1m*ntis
idiovol*tbl
mom12m*dp
indmom*tms
indmom*tbl
mvel1*C
nincr*bm
sp*tms
mom1m*ep
ill*ntis
mvel1*bm
indmom*bm
mvel1*dp
indmom*dp
chmom*tms
baspread*tbl
maxret*bm
mom1m*dfy
mom12m*C
dolvol*ep
nincr*dp
securedind*tbl
std_turn*dp
dolvol*dp
mom12m*ep
maxret*svar
retvol*bm
mom6m*dp
mvel1*ep
std_turn*C
mom6m*tbl
mom1m*svar
indmom*C
dolvol*C
nincr*tms
beta*ntis
chmom*dfy
mom6m*ep
mvel1*dfy
turn*tms
betasq*ntis
mom12m*ntis
mom36m*ntis
ep*tbl
zerotrade*bm
ill*tms
mvel1*ntis
turn*tbl
chmom*C
betasq*tbl
mom1m*tms
indmom*ep
nincr*ep
turn*dp
zerotrade*C
baspread*ntis
dy*bm
chmom*tbl
retvol*svar
ill*tbl
sp*dfy
zerotrade*dp
idiovol*bm
beta*tbl
securedind*ntis
mom12m*bm
turn*ep
std_turn*bm
mom12m*tms
mom12m*svar
std_turn*ep
chmom*dp
maxret*dp
nincr*tbl
nincr*ntis
std_turn*tms
age*tbl
maxret*ep
rd_mve*tms
mom6m*bm
dy*tms
securedind*dp
mom6m*ntis
idiovol*tms
mom6m*C
indmom*ntis
idiovol*ntis
betasq*tms
PLS

PCR

ENet+H

GLM+H

RF

GBRT+H

NN1

NN2

NN3

NN4

NN5

Note: Rankings of top 100 interactions between 94 stock-level stock characteristics and nine macro variables (including
a constant, denoted C). Interactions are ordered based on the sum of their ranks over all models, with the most
influential characteristics on top and least influential on bottom. Columns correspond to individual models, and color
gradients within each column indicate the most influential (dark blue) to least influential (white) interactions.

73

Figure A.5: Time Variation in Stock/Macroeconomic Interactions

19

87
19
88
19
89
19
90
19
91
19
92
19
93
19
94
19
95
19
96
19
97
19
98
19
99
20
00
20
01
20
02
20
03
20
04
20
05
20
06
20
07
20
08
20
09
20
10
20
11
20
12
20
13
20
14
20
15
20
16

mom1m*bm
ill*ntis
turn*ntis
mom1m*C
chmom*bm
dolvol*dp
mvel1*C
dolvol*C
mom1m*dp
retvol*tbl
idiovol*tbl
mvel1*bm
retvol*bm
dolvol*ep
retvol*ntis
mvel1*dp
maxret*tbl
mvel1*tms
maxret*ntis
std_turn*C
zerotrade*dp
zerotrade*C
std_turn*dp
turn*tms
nincr*bm
baspread*tbl
mom1m*tbl
sp*tms
mvel1*ep
mom1m*ep
ill*tms
maxret*bm
turn*dp
mom6m*dp
chmom*C
mom6m*tbl
beta*ntis
idiovol*bm
mom12m*tbl
nincr*tms
nincr*dp
turn*ep
mom36m*ntis
indmom*tbl
indmom*tms
ill*tbl
baspread*bm
mom1m*ntis
mom12m*dp
baspread*ntis
betasq*ntis
mom6m*ep
betasq*tbl
mvel1*ntis
zerotrade*bm
beta*tbl
chmom*dp
indmom*dp
securedind*tbl
chmom*tms
turn*C
std_turn*bm
idiovol*tms
mom6m*bm
zerotrade*ep
std_turn*ep
std_turn*tms
turn*tbl
beta*tms
indmom*bm
retvol*svar
maxret*svar
ill*dp
beta*bm
securedind*dp
nincr*ep
chmom*tbl
betasq*bm
nincr*ntis
dolvol*bm
dy*bm
retvol*ep
baspread*tms
age*tbl
ep*tbl
retvol*tms
mom12m*C
idiovol*ntis
securedind*ntis
idiovol*C
maxret*dp
betasq*tms
mom12m*ep
baspread*C
mom12m*ntis
mom6m*ntis
indmom*C
zerotrade*tbl
mom6m*C
mom12m*tms

Note: Rankings of top 100 interactions between 94 stock-level stock characteristics and nine macro variables (including
a constant, denoted C). The list of top 100 interactions is based on the analysis in Figure A.4. Color gradients indicate
the most influential (dark blue) to least influential (white) interactions in the NN3 model in each training sample (the
horizontal axis corresponds to the last year in each training sample).

74

Figure A.6: Characteristic Importance at Annual Horizon
mom1m
mvel1
mom12m
chmom
maxret
indmom
retvol
dolvol
sp
turn
agr
nincr
rd_mve
std_turn
mom6m
mom36m
ep
chcsho
securedind
idiovol
baspread
ill
age
convind
rd
depr
beta
betasq
cashpr
ps
zerotrade
dy
orgcap
bm
lgr
cashdebt
chinv
invest
lev
operprof
bm_ia
saleinv
egr
cfp
rd_sale
sgr
roaq
roic
sic2
mve_ia
ms
quick
herf
hire
pricedelay
salerec
roavol
roeq
grcapx
currat
cash
std_dolvol
acc
cfp_ia
grltnoa
gma
pctacc
absacc
salecash
secured
pchdepr
tang
pchcapx_ia
chempia
ear
pchsale_pchinvt
pchsaleinv
chtx
chpmia
chatoia
tb
aeavol
rsup
pchgm_pchsale
pchsale_pchxsga
cinvest
pchquick
pchsale_pchrect
realestate
pchcurrat
stdacc
stdcf
divi
divo
sin
ENet+H

GLM+H

RF

GBRT+H

NN1

NN2

NN3

NN4

NN5

Note: This figure describes how each model ranks the 94 stock-level characteristics and the industry dummy (sic2) in
terms of overall model contribution. Columns correspond to individual models, and color gradients within each column
indicate the most influential (dark blue) to least influential (white) variables. Characteristics are sorted in the same
order of Figure 5. The results are based on prediction at the annual horizon.

75

Table A.8: Annual Portfolio-level Out-of-Sample Predictive R2
OLS-3
+H

PLS

PCR

ENet
+H

GLM
+H

RF

GBRT
+H

NN1

NN2

NN3

NN4

NN5

S&P 500

-4.90

0.43

-7.17

0.26

2.07

8.80

7.28

9.99

12.02

15.68

15.30

13.15

Big Value
Big Growth
Big Neutral
Small Value
Small Growth
Small Neutral

1.83
-12.06
-3.83
4.31
2.49
-1.52

4.88
-6.92
3.09
10.81
2.87
5.21

-4.04
-10.22
-6.58
8.94
3.19
2.10

3.62
-2.13
1.19
8.41
0.21
2.29

0.49
2.44
1.24
4.31
0.03
2.29

9.50
7.14
8.52
8.05
6.20
4.18

5.86
6.93
6.91
3.75
2.13
1.78

8.76
7.47
8.31
7.24
3.96
6.46

8.54
11.06
11.51
6.37
5.52
5.55

12.42
11.67
14.60
7.48
6.84
6.68

9.95
13.37
12.92
6.60
2.60
3.69

7.56
10.03
9.95
4.81
7.23
6.14

Big Conservative
Big Aggressive
Big Neutral
Small Conservative
Small Aggressive
Small Neutral

-10.42
-1.65
-9.18
-0.38
3.33
-0.53

-2.42
1.89
-1.62
6.36
5.12
5.84

-9.77
-4.72
-9.42
5.01
2.88
3.52

-3.77
1.36
2.03
3.19
1.04
4.46

5.17
2.00
2.43
2.35
0.37
3.59

8.44
7.42
9.62
4.60
6.43
7.08

5.26
6.67
8.39
0.62
3.23
2.96

-1.31
11.00
10.88
5.31
2.50
8.41

8.64
11.74
13.03
5.39
4.50
7.13

9.65
13.08
15.61
5.97
5.50
8.68

12.47
11.27
15.75
4.22
1.47
5.77

6.09
10.67
13.56
4.71
6.56
8.47

Big Robust
Big Weak
Big Neutral
Small Robust
Small Weak
Small Neutral

-7.53
-3.40
-4.17
-2.37
3.88
3.00

-2.55
3.09
5.46
0.93
9.89
7.99

-9.18
-7.15
-4.57
-0.20
5.68
4.40

1.33
-1.02
-3.18
0.76
2.15
4.60

5.42
-1.12
-2.12
3.72
-1.11
3.58

7.61
9.62
6.24
0.41
7.53
9.21

6.60
7.62
4.47
-0.87
3.10
5.75

12.55
4.41
4.18
2.92
-0.48
10.03

12.04
9.95
6.23
3.67
1.53
7.39

13.92
11.39
9.47
4.47
2.96
9.82

15.29
11.73
3.70
0.86
1.61
7.06

13.35
8.40
2.95
4.19
1.08
9.09

Big Up
Big Down
Big Medium
Small Up
Small Down
Small Medium

-23.55
-4.66
6.26
-6.68
2.80
-2.92

-11.77
0.39
10.24
3.82
5.59
-0.49

-19.16
-2.79
7.36
0.71
4.84
-1.70

-5.11
-0.15
6.25
-2.83
2.87
-1.80

0.52
0.71
3.83
1.57
0.50
0.81

6.15
7.64
7.73
1.84
7.23
2.00

6.21
5.53
5.38
-0.19
3.49
-0.40

4.26
3.58
8.74
-4.22
3.24
-1.64

11.44
8.78
9.61
0.70
4.63
1.96

11.11
9.54
11.36
1.12
5.90
1.79

14.48
10.32
9.96
-1.42
3.28
0.51

10.62
6.79
6.22
2.83
5.22
3.49

SMB
HML
RMW
CMA
MOM

3.77
3.01
4.66
4.50
-27.52

4.23
-0.52
17.11
-1.52
-12.44

8.26
4.08
6.67
7.94
-5.62

4.22
-0.15
1.19
-9.01
-16.27

6.96
6.33
3.45
7.69
-8.06

6.54
7.02
3.51
1.73
-7.57

4.27
2.17
5.31
-8.36
-8.29

0.05
9.14
7.03
5.89
-12.78

1.31
8.09
5.03
7.27
-8.71

2.59
7.86
3.58
0.93
-7.35

4.33
3.97
0.61
-7.18
-6.45

4.45
3.63
0.90
-8.11
-6.74

Note: In this table, we report the out-of-sample predictive R2 s for 25 portfolios using OLS with size, book-to-market,
and momentum, OLS-3, PLS, PCR, elastic net (ENet), generalized linear model with group lasso (GLM), random forest
(RF), gradient boosted regression trees (GBRT), and five architectures of neural networks (NN1,...,NN5), respectively.
â€œ+Hâ€ indicates the use of Huber loss instead of the l2 loss. The 25 portfolios are 3 Ã— 2 size double-sorted portfolios
used in the construction of the Fama-French value, investment, and profitability factors, as well as momentum. The
results are based on prediction at the annual horizon.

76

Table A.9: Performance of Machine Learning Portfolios (Equally Weighted)
OLS-3+H

PLS

PCR

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Low(L)
2
3
4
5
6
7
8
9
High(H)

-0.14
0.17
0.35
0.49
0.63
0.75
0.88
1.03
1.22
1.60

0.11
0.35
0.44
0.63
0.73
0.83
0.75
0.80
1.14
1.45

7.99
6.81
6.09
5.61
5.24
4.88
4.73
4.72
4.73
5.21

0.05
0.18
0.25
0.39
0.49
0.59
0.55
0.59
0.83
0.96

-0.83
-0.20
0.12
0.39
0.62
0.84
1.06
1.32
1.67
2.38

-0.26
0.19
0.40
0.67
0.69
0.77
0.88
1.01
1.28
1.82

6.41
5.92
5.49
5.06
5.14
5.14
5.12
5.29
5.60
6.16

-0.14
0.11
0.25
0.46
0.47
0.52
0.60
0.66
0.79
1.02

-0.71
-0.11
0.19
0.42
0.63
0.81
1.01
1.23
1.52
2.12

-0.65
0.16
0.40
0.58
0.72
0.80
0.98
1.08
1.33
1.81

7.04
6.23
5.67
5.45
5.11
4.98
5.02
5.02
5.28
5.93

-0.32
0.09
0.25
0.37
0.49
0.55
0.68
0.75
0.88
1.06

H-L

1.73

1.34

5.59

0.83

3.21

2.08

4.89

1.47

2.83

2.45

4.51

1.89

ENet+H

GLM+H

RF

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Low(L)
2
3
4
5
6
7
8
9
High(H)

-0.04
0.27
0.44
0.59
0.73
0.87
1.01
1.17
1.36
1.72

-0.24
0.44
0.52
0.70
0.71
0.79
0.85
0.88
0.85
1.86

6.43
5.90
5.27
4.73
4.94
5.00
5.21
5.47
5.90
7.27

-0.13
0.26
0.34
0.51
0.49
0.55
0.56
0.56
0.50
0.89

-0.49
0.01
0.29
0.50
0.68
0.84
1.00
1.18
1.41
1.89

-0.50
0.32
0.56
0.61
0.72
0.78
0.78
0.89
1.25
1.81

6.81
5.80
5.46
5.22
5.11
5.12
5.06
5.14
5.80
6.57

-0.25
0.19
0.36
0.41
0.49
0.53
0.54
0.60
0.75
0.96

0.26
0.44
0.53
0.60
0.67
0.73
0.80
0.87
0.97
1.20

-0.48
0.24
0.55
0.62
0.66
0.77
0.74
0.99
1.22
1.90

7.16
5.67
5.36
5.15
5.11
5.13
5.10
5.29
5.67
7.03

-0.23
0.15
0.36
0.42
0.44
0.52
0.50
0.65
0.74
0.94

H-L

1.76

2.11

5.50

1.33

2.38

2.31

4.41

1.82

0.94

2.38

5.57

1.48

GBRT+H

NN1

NN2

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Low(L)
2
3
4
5
6
7
8
9
High(H)

-0.49
-0.16
0.02
0.17
0.33
0.46
0.59
0.72
0.88
1.19

-0.37
0.42
0.56
0.74
0.63
0.83
0.67
0.82
1.12
1.77

6.46
5.80
5.31
5.43
5.31
5.23
5.13
5.08
5.41
6.69

-0.20
0.25
0.36
0.47
0.41
0.55
0.45
0.56
0.72
0.92

-0.45
0.15
0.43
0.64
0.80
0.95
1.12
1.32
1.63
2.43

-0.78
0.22
0.47
0.64
0.80
0.85
0.84
0.88
1.17
2.13

7.43
6.24
5.55
5.00
4.76
4.63
4.66
4.95
5.62
7.34

-0.36
0.12
0.29
0.45
0.58
0.63
0.62
0.62
0.72
1.00

-0.32
0.20
0.43
0.59
0.72
0.84
0.97
1.14
1.41
2.25

-1.01
0.17
0.52
0.71
0.76
0.81
0.94
0.92
1.10
2.30

7.79
6.34
5.49
5.02
4.60
4.52
4.61
4.86
5.55
7.81

-0.45
0.09
0.33
0.49
0.57
0.62
0.70
0.66
0.69
1.02

H-L

1.68

2.14

4.28

1.73

2.89

2.91

4.72

2.13

2.57

3.31

4.92

2.33

NN3

NN4

NN5

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Low(L)
2
3
4
5
6
7
8
9
High(H)

-0.31
0.22
0.45
0.60
0.73
0.85
0.97
1.12
1.38
2.28

-0.92
0.16
0.44
0.66
0.77
0.81
0.86
0.93
1.18
2.35

7.94
6.46
5.40
4.83
4.58
4.47
4.62
4.82
5.51
8.11

-0.40
0.09
0.28
0.48
0.58
0.63
0.64
0.67
0.74
1.00

-0.19
0.29
0.49
0.62
0.72
0.81
0.91
1.04
1.28
2.16

-0.95
0.17
0.45
0.57
0.70
0.75
0.86
1.06
1.24
2.37

7.83
6.50
5.58
4.94
4.57
4.42
4.47
4.82
5.57
8.03

-0.42
0.09
0.28
0.40
0.53
0.59
0.67
0.76
0.77
1.02

-0.08
0.33
0.51
0.62
0.71
0.80
0.88
1.01
1.25
2.08

-0.83
0.24
0.53
0.59
0.68
0.76
0.88
0.95
1.17
2.27

7.92
6.64
5.65
4.91
4.56
4.43
4.60
4.90
5.60
7.95

-0.36
0.12
0.32
0.41
0.51
0.60
0.66
0.67
0.73
0.99

H-L

2.58

3.27

4.80

2.36

2.35

3.33

4.71

2.45

2.16

3.09

4.98

2.15

Note: Performance of equal-weight decile portfolios sorted on out-of-sample machine learning return forecasts. â€œPredâ€,
â€œAvgâ€, â€œStdâ€, and â€œSRâ€ report the predicted monthly returns for each decile, the average realized monthly returns,
their realized standard deviations, and annualized Sharpe ratios, respectively.

77

Table A.10: Performance of Machine Learning Portfolios (Equally Weighted, Excluding Microcaps)
OLS-3+H

PLS

PCR

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Low(L)
2
3
4
5
6
7
8
9
High(H)

-0.17
0.12
0.31
0.45
0.58
0.70
0.82
0.96
1.15
1.47

0.00
0.19
0.40
0.52
0.63
0.63
0.66
0.75
1.04
1.33

7.97
6.53
5.72
5.32
4.96
4.71
4.64
4.70
4.95
5.35

0.00
0.10
0.24
0.34
0.44
0.46
0.49
0.56
0.73
0.86

-0.88
-0.26
0.06
0.31
0.54
0.75
0.96
1.21
1.53
2.21

-0.33
0.27
0.35
0.54
0.66
0.70
0.82
0.85
1.02
1.33

6.59
5.83
5.41
5.16
5.01
4.97
4.71
5.12
5.32
5.87

-0.17
0.16
0.22
0.36
0.46
0.49
0.60
0.57
0.66
0.78

-0.72
-0.13
0.16
0.39
0.59
0.77
0.96
1.17
1.46
2.03

-0.50
0.16
0.36
0.52
0.63
0.71
0.76
0.95
1.09
1.47

7.04
6.14
5.52
5.21
4.94
4.83
4.80
4.84
5.14
5.83

-0.25
0.09
0.22
0.35
0.44
0.51
0.55
0.68
0.74
0.87

H-L

1.64

1.32

5.66

0.81

3.09

1.66

4.69

1.22

2.75

1.97

4.61

1.48

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Low(L)
2
3
4
5
6
7
8
9
High(H)

-0.05
0.25
0.42
0.56
0.69
0.82
0.96
1.11
1.30
1.65

-0.23
0.42
0.53
0.60
0.69
0.73
0.83
0.77
0.78
1.04

6.51
5.72
5.14
4.82
4.80
4.89
4.74
5.31
5.74
6.78

-0.12
0.26
0.36
0.43
0.50
0.52
0.61
0.50
0.47
0.53

-0.51
-0.03
0.25
0.45
0.63
0.79
0.95
1.12
1.34
1.79

-0.35
0.32
0.54
0.59
0.65
0.68
0.70
0.75
0.95
1.31

6.81
5.71
5.34
5.12
4.98
4.96
4.91
4.95
5.30
6.33

-0.18
0.20
0.35
0.40
0.45
0.48
0.49
0.53
0.62
0.72

0.27
0.44
0.52
0.59
0.66
0.72
0.78
0.85
0.92
1.09

-0.43
0.23
0.50
0.58
0.58
0.65
0.65
0.85
1.08
1.43

7.03
5.58
5.19
5.04
4.97
5.04
4.99
5.02
5.34
6.65

-0.21
0.15
0.33
0.40
0.41
0.45
0.45
0.58
0.70
0.74

H-L

1.70

1.27

4.90

0.90

2.30

1.65

4.44

1.29

0.81

1.86

5.25

1.22

ENet+H

GLM+H

GBRT+H

RF

NN1

NN2

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Low(L)
2
3
4
5
6
7
8
9
High(H)

-0.47
-0.15
0.02
0.17
0.32
0.45
0.57
0.69
0.84
1.10

-0.28
0.38
0.52
0.67
0.55
0.76
0.52
0.70
1.02
1.30

6.25
5.55
5.22
5.31
5.24
4.95
5.10
4.90
5.26
6.25

-0.15
0.24
0.34
0.44
0.36
0.54
0.35
0.50
0.67
0.72

-0.47
0.12
0.40
0.59
0.74
0.87
1.01
1.16
1.38
1.91

-0.76
0.20
0.48
0.63
0.72
0.85
0.87
0.85
1.00
1.29

7.48
6.36
5.54
5.01
4.76
4.61
4.60
4.68
5.13
6.25

-0.35
0.11
0.30
0.43
0.53
0.64
0.65
0.63
0.68
0.72

-0.33
0.19
0.41
0.56
0.68
0.79
0.89
1.02
1.19
1.68

-0.92
0.20
0.55
0.70
0.74
0.84
0.90
0.93
0.96
1.26

8.00
6.51
5.63
5.03
4.59
4.49
4.51
4.69
4.99
6.22

-0.40
0.10
0.34
0.48
0.56
0.65
0.69
0.68
0.67
0.70

H-L

1.57

1.58

3.86

1.42

2.38

2.05

4.50

1.58

2.01

2.18

4.74

1.60

NN3

NN4

NN5

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Pred

Avg

Std

SR

Low(L)
2
3
4
5
6
7
8
9
High(H)

-0.31
0.20
0.43
0.57
0.69
0.79
0.89
1.01
1.17
1.64

-0.82
0.16
0.46
0.66
0.76
0.79
0.87
0.91
1.00
1.37

8.18
6.55
5.51
4.86
4.63
4.44
4.48
4.71
5.02
6.34

-0.35
0.08
0.29
0.47
0.57
0.61
0.67
0.67
0.69
0.75

-0.19
0.28
0.47
0.59
0.68
0.76
0.84
0.94
1.07
1.52

-0.87
0.23
0.45
0.65
0.65
0.71
0.90
0.92
1.13
1.39

8.05
6.68
5.61
4.93
4.60
4.48
4.45
4.59
5.00
6.37

-0.38
0.12
0.28
0.45
0.49
0.55
0.70
0.70
0.78
0.75

-0.08
0.32
0.49
0.61
0.69
0.76
0.83
0.91
1.04
1.48

-0.75
0.22
0.51
0.58
0.69
0.76
0.84
0.92
1.02
1.36

8.11
6.75
5.70
4.98
4.55
4.43
4.45
4.70
5.10
6.34

-0.32
0.12
0.31
0.40
0.52
0.60
0.65
0.68
0.69
0.74

H-L

1.95

2.19

4.84

1.57

1.70

2.26

4.63

1.69

1.56

2.11

4.95

1.48

Note: In this table, we report the performance of prediction-sorted portfolios over the 30-year out-of-sample testing
period. All but tiny stocks (excluding stocks below 20th percentile on NYSE cap weights) are sorted into deciles based
on their predicted returns for the next month. Column â€œPredâ€, â€œAvgâ€, â€œStdâ€, and â€œSRâ€ provide the predicted monthly
returns for each decile, the average realized monthly returns, their standard deviations, and Sharpe ratios, respectively.
All portfolios are value weighted.

78

Table A.11: OLS Benchmark Models
R2
Model
OLS-3
OLS-7
OLS-15
RF
NN3

Stock
0.16
0.18
0.19

S&P 500
-0.22
0.24
0.68

0.33
0.40

1.37
1.80

Sharpe Ratio
Equal-weight
Value-weight
0.83
0.61
1.12
0.74
1.15
0.86
1.48
2.36

Description
mom12m, size, bm
OLS-3 plus acc, roaq, agr, egr
OLS-7 plus dy, mom36m, beta, retvol, turn, lev, sp

0.98
1.20

Note: In this table, we report the out-of-sample performance of three different OLS benchmark models recommended
by Lewellen (2015) with either three, seven, or 15 predictors. We report predictive R2 for the stock-level panel and the
S&P 500 index. We report long-short decile spread Sharpe ratios with equal-weight and value-weight formation. For
comparison, we also report the performance the NN3 and random forest models.

Figure A.7: Cumulative Return of Machine Learning Portfolios (Equally Weighted)
8

OLS-3+H

PLS

PCR

ENet+H

GLM+H

RF

GBRT+H

NN4

SP500-Rf

solid = long

dash = short

2008

2011

2014

Long Position

6
4
2

Short Position

0
2
4

1987

1990

1993

1996

1999

2002

2005

2016

Note: Cumulative log returns of portfolios sorted on out-of-sample machine learning return forecasts. The solid and
dash lines represent long (top decile) and short (bottom decile) positions, respectively. The shaded periods show NBER
recession dates. All portfolios are equally weighted.

79

